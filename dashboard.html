<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .workplace-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .workplace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
        }

        .workplace-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .workplace-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .workplace-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .schedule-content {
            display: none;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #117a8b;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-1px);
        }

        .schedule-form {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .schedule-display {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            text-align: center;
        }

        .shift {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift.work-study {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .shift.unfilled {
            border-color: #dc3545;
            background: #ffebee;
        }

        .worker-summary {
            margin-top: 2rem;
        }

        .worker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .worker-table th,
        .worker-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .worker-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .worker-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .workplace-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¢ Workplace Scheduler</h1>
        <div class="user-info">
            <span id="userEmail"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Workplace Selection -->
        <div class="workplace-section">
            <h2 class="section-title">Select Workplace</h2>
            <div class="workplace-grid" id="workplaceGrid">
                <div class="loading">Loading workplaces...</div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="schedule-content" id="scheduleContent">
            <div class="workplace-section">
                <h2 class="section-title">Schedule Management</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showGenerateForm()">üìÖ Generate New Schedule</button>
                    <button class="btn btn-success" onclick="viewCurrentSchedule()">üëÅÔ∏è View Current Schedule</button>
                    <button class="btn btn-info" onclick="viewHistory()">üìö Schedule History</button>
                    <button class="btn btn-warning" onclick="checkAvailability()">üîç Check Availability</button>
                </div>

                <!-- Generate Schedule Form -->
                <div class="schedule-form" id="generateForm" style="display: none;">
                    <h3>Generate New Schedule</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxHours">Max Hours per Worker</label>
                            <input type="number" id="maxHours" value="20" min="5" max="40">
                        </div>
                        <div class="form-group">
                            <label for="workersPerShift">Workers per Shift</label>
                            <input type="number" id="workersPerShift" value="2" min="1" max="5">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="generateSchedule()">üöÄ Generate Schedule</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Check Availability Form -->
                <div class="schedule-form" id="availabilityForm" style="display: none;">
                    <h3>Check Worker Availability</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availDay">Day</label>
                            <select id="availDay">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availStart">Start Time</label>
                            <input type="time" id="availStart">
                        </div>
                        <div class="form-group">
                            <label for="availEnd">End Time</label>
                            <input type="time" id="availEnd">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="findAvailable()">üîç Find Available Workers</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Schedule Display -->
                <div id="scheduleDisplay">
                    <div class="loading">Select an option above to get started.</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, where
        } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        // Firebase config
        const config = {
            apiKey: "AIzaSyBkkq4nPnmyfSOKtVLsO95rpAUsMDA1o0A",
            authDomain: "workplace-scheduler-ace38.firebaseapp.com",
            projectId: "workplace-scheduler-ace38",
            storageBucket: "workplace-scheduler-ace38.firebasestorage.app",
            messagingSenderId: "153631302747",
            appId: "1:153631302747:web:2c731351893dca19510b7e"
        };

        const app = initializeApp(config);
        const db = getFirestore(app);

        // Global state
        let selectedWorkplace = null;
        let workers = [];
        let hours = {};
        let currentSchedule = null;

        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // Utility functions
        const timeToHour = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h + (m / 60);
        };

        const hourToTime = (hour) => {
            const h = Math.floor(hour);
            const m = Math.round((hour - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            let [h, m] = timeStr.split(':').map(Number);
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m.toString().padStart(2, '0')} ${period}`;
        };

        // Parse availability text into structured format
        const parseAvailability = (availabilityText) => {
            const availability = {};
            if (!availabilityText) return availability;
            
            const blocks = availabilityText.split(',').map(s => s.trim());
            blocks.forEach(block => {
                const match = block.match(/(\w+)\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/i);
                if (match) {
                    const [, day, start, end] = match;
                    let dayName = day.charAt(0).toUpperCase() + day.slice(1).toLowerCase();
                    
                    const dayMap = {
                        'Mon': 'Monday', 'Tue': 'Tuesday', 'Wed': 'Wednesday',
                        'Thu': 'Thursday', 'Fri': 'Friday', 'Sat': 'Saturday', 'Sun': 'Sunday'
                    };
                    
                    dayName = dayMap[dayName] || dayName;
                    
                    if (!availability[dayName]) availability[dayName] = [];
                    
                    const startHour = timeToHour(start);
                    const endHour = timeToHour(end);
                    
                    availability[dayName].push({
                        start: start,
                        end: end,
                        startHour: startHour,
                        endHour: endHour
                    });
                }
            });
            
            return availability;
        };

        // Calculate total availability hours
        const calculateAvailabilityHours = (availability) => {
            let total = 0;
            Object.values(availability).forEach(slots => {
                slots.forEach(slot => {
                    total += slot.endHour - slot.startHour;
                });
            });
            return total;
        };

        // Check if worker is available during specific hours
        const isWorkerAvailable = (worker, day, startHour, endHour) => {
            const dayAvail = worker.availability[day] || [];
            return dayAvail.some(slot => slot.startHour <= startHour && endHour <= slot.endHour);
        };

        // Initialize and check auth
        window.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!user.email) {
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('userEmail').textContent = user.email;
            loadWorkplaces();
        });

        // Logout function
        window.logout = function() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        };

        // Load workplaces
        async function loadWorkplaces() {
            try {
                const snapshot = await getDocs(collection(db, 'workplaces'));
                let html = '';
                
                if (snapshot.empty) {
                    const defaults = [
                        { id: 'esports_lounge', name: 'üéÆ eSports Lounge' },
                        { id: 'esports_arena', name: 'üèüÔ∏è eSports Arena' },
                        { id: 'it_service_center', name: 'üíª IT Service Center' }
                    ];
                    
                    for (const wp of defaults) {
                        await initWorkplace(wp.id);
                        html += `<div class="workplace-card" onclick="selectWorkplace('${wp.id}')">
                            <h4>${wp.name}</h4>
                            <p>${wp.id}</p>
                        </div>`;
                    }
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const name = data.name || doc.id.replace('_', ' ').toUpperCase();
                        html += `<div class="workplace-card" onclick="selectWorkplace('${doc.id}')">
                            <h4>${name}</h4>
                            <p>${doc.id}</p>
                        </div>`;
                    });
                }
                
                document.getElementById('workplaceGrid').innerHTML = html;
            } catch (error) {
                console.error('Error loading workplaces:', error);
                document.getElementById('workplaceGrid').innerHTML = '<div class="error">Error loading workplaces</div>';
            }
        }

        // Initialize workplace
        async function initWorkplace(id) {
            try {
                const docRef = doc(db, 'workplaces', id);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    await addDoc(collection(db, 'workplaces'), {
                        name: id.replace('_', ' ').toUpperCase(),
                        created_at: new Date().toISOString(),
                        hours_of_operation: {
                            Monday: [{ start: "09:00", end: "17:00" }],
                            Tuesday: [{ start: "09:00", end: "17:00" }],
                            Wednesday: [{ start: "09:00", end: "17:00" }],
                            Thursday: [{ start: "09:00", end: "17:00" }],
                            Friday: [{ start: "09:00", end: "17:00" }],
                            Saturday: [{ start: "10:00", end: "16:00" }],
                            Sunday: [{ start: "12:00", end: "18:00" }]
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing workplace:', error);
            }
        }

        // Select workplace
        window.selectWorkplace = async function(id) {
            selectedWorkplace = id;
            
            // Update UI
            document.querySelectorAll('.workplace-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.workplace-card').classList.add('selected');
            
            document.getElementById('scheduleContent').style.display = 'block';
            
            // Load data
            await Promise.all([loadWorkers(), loadHours()]);
            hideAllForms();
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Select an option above to get started.</div>';
        };

        // Load workers for selected workplace
        async function loadWorkers() {
            try {
                const snapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                workers = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const availability = parseAvailability(data['Days & Times Available'] || '');
                    
                    workers.push({
                        id: doc.id,
                        first_name: data['First Name'] || 'Unknown',
                        last_name: data['Last Name'] || 'Worker',
                        email: data['Email'] || 'no-email',
                        work_study: data['Work Study'] === 'Yes',
                        availability,
                        totalHours: calculateAvailabilityHours(availability)
                    });
                });
                
                console.log(`Loaded ${workers.length} workers for ${selectedWorkplace}`);
            } catch (error) {
                console.error('Error loading workers:', error);
                workers = [];
            }
        }

        // Load hours for selected workplace
        async function loadHours() {
            try {
                const docRef = doc(db, 'workplaces', selectedWorkplace);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    hours = docSnap.data().hours_of_operation || {};
                } else {
                    hours = {};
                }
                
                console.log('Loaded hours for', selectedWorkplace, ':', hours);
            } catch (error) {
                console.error('Error loading hours:', error);
                hours = {};
            }
        }

        // Show/hide forms
        window.showGenerateForm = function() {
            hideAllForms();
            document.getElementById('generateForm').style.display = 'block';
        };

        window.checkAvailability = function() {
            hideAllForms();
            document.getElementById('availabilityForm').style.display = 'block';
        };

        window.hideAllForms = function() {
            document.querySelectorAll('.schedule-form').forEach(form => {
                form.style.display = 'none';
            });
        };

        // Generate schedule
        window.generateSchedule = async function() {
            if (workers.length === 0 || Object.keys(hours).length === 0) {
                alert('Need workers and operating hours to generate schedule.');
                return;
            }
            
            const maxHours = parseInt(document.getElementById('maxHours').value);
            const workersPerShift = parseInt(document.getElementById('workersPerShift').value);
            
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">üîÑ Generating schedule...</div>';
            
            try {
                const schedule = createOptimizedSchedule(maxHours, workersPerShift);
                const scheduleId = await saveSchedule(schedule);
                displaySchedule(schedule, false, scheduleId);
                hideAllForms();
            } catch (error) {
                console.error('Error generating schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error generating schedule: ' + error.message + '</div>';
            }
        };

        // Advanced schedule creation algorithm
        function createOptimizedSchedule(maxHours, workersPerShift) {
            const schedule = {};
            const workerHours = {};
            
            // Initialize worker hours
            workers.forEach(w => workerHours[w.email] = 0);
            
            // Phase 1: Assign work study students exactly 5 hours
            const workStudyWorkers = workers.filter(w => w.work_study);
            workStudyWorkers.forEach(worker => {
                assignWorkStudyHours(worker, schedule, workerHours);
            });
            
            // Phase 2: Fill remaining slots with regular workers
            const regularWorkers = workers.filter(w => !w.work_study);
            
            DAYS.forEach(day => {
                const dayHours = hours[day];
                if (!dayHours || dayHours.length === 0) return;
                
                if (!schedule[day]) schedule[day] = [];
                
                dayHours.forEach(period => {
                    fillDaySlots(day, period, schedule, regularWorkers, workerHours, maxHours, workersPerShift);
                });
                
                // Sort shifts by start time
                if (schedule[day]) {
                    schedule[day].sort((a, b) => timeToHour(a.start) - timeToHour(b.start));
                }
            });
            
            return schedule;
        }

        // Assign work study hours (exactly 5)
        function assignWorkStudyHours(worker, schedule, workerHours) {
            let assigned = 0;
            const target = 5;
            
            // Find all available time windows for this worker
            const availableSlots = findAvailableSlots(worker);
            
            // Try to assign 5 hours optimally
            const optimalAssignment = findOptimalWorkStudyAssignment(availableSlots, target);
            
            for (const assignment of optimalAssignment) {
                if (assigned >= target) break;
                
                const duration = Math.min(assignment.duration, target - assigned);
                if (duration >= 2) { // Minimum 2-hour shifts
                    const shift = {
                        start: hourToTime(assignment.start),
                        end: hourToTime(assignment.start + duration),
                        workers: [worker.first_name + ' ' + worker.last_name],
                        emails: [worker.email],
                        workStudy: true
                    };
                    
                    if (!schedule[assignment.day]) schedule[assignment.day] = [];
                    schedule[assignment.day].push(shift);
                    assigned += duration;
                    workerHours[worker.email] += duration;
                }
            }
        }

        // Find available slots for a worker
        function findAvailableSlots(worker) {
            const slots = [];
            
            Object.entries(worker.availability).forEach(([day, periods]) => {
                const dayHours = hours[day];
                if (!dayHours) return;
                
                dayHours.forEach(opHours => {
                    periods.forEach(avail => {
                        const start = Math.max(timeToHour(opHours.start), avail.startHour);
                        const end = Math.min(timeToHour(opHours.end), avail.endHour);
                        
                        if (end > start) {
                            slots.push({
                                day,
                                start,
                                end,
                                duration: end - start
                            });
                        }
                    });
                });
            });
            
            return slots.sort((a, b) => b.duration - a.duration);
        }

        // Find optimal work study assignment
        function findOptimalWorkStudyAssignment(windows, targetHours) {
            // Try perfect 5-hour single window
            for (const window of windows) {
                if (Math.abs(window.duration - targetHours) < 0.1) {
                    return [window];
                }
            }
            
            // Try preferred 3+2 hour combinations
            const preferredSplits = [
                { split1: 3, split2: 2 },
                { split1: 2, split2: 3 }
            ];
            
            for (const split of preferredSplits) {
                const combination = findHourCombination(windows, split.split1, split.split2);
                if (combination) {
                    return combination;
                }
            }
            
            // Try any combination that gets close to 5 hours
            return findBestHourCombination(windows, targetHours);
        }

        // Find specific hour combination
        function findHourCombination(windows, hours1, hours2) {
            for (let i = 0; i < windows.length; i++) {
                const window1 = windows[i];
                if (Math.abs(window1.duration - hours1) < 0.1) {
                    
                    for (let j = 0; j < windows.length; j++) {
                        if (i === j) continue;
                        const window2 = windows[j];
                        
                        if (Math.abs(window2.duration - hours2) < 0.1) {
                            return [window1, window2];
                        }
                    }
                }
            }
            return null;
        }

        // Find best combination of hours up to target
        function findBestHourCombination(windows, targetHours) {
            const sortedWindows = [...windows].sort((a, b) => b.duration - a.duration);
            let bestCombination = [];
            let bestTotal = 0;
            
            for (let i = 0; i < sortedWindows.length; i++) {
                let currentCombination = [sortedWindows[i]];
                let currentHours = sortedWindows[i].duration;
                
                if (currentHours > targetHours) continue;
                
                for (let j = 0; j < sortedWindows.length; j++) {
                    if (i === j) continue;
                    
                    const newTotal = currentHours + sortedWindows[j].duration;
                    if (newTotal <= targetHours) {
                        currentCombination.push(sortedWindows[j]);
                        currentHours = newTotal;
                    }
                }
                
                if (currentHours > bestTotal) {
                    bestCombination = currentCombination;
                    bestTotal = currentHours;
                }
            }
            
            return bestCombination;
        }

        // Fill day slots with regular workers
        function fillDaySlots(day, period, schedule, workers, workerHours, maxHours, workersPerShift) {
            const start = timeToHour(period.start);
            const end = timeToHour(period.end);
            
            // Find free time slots (not occupied by work study)
            const freeSlots = findFreeSlots(day, start, end, schedule[day] || []);
            
            freeSlots.forEach(slot => {
                fillTimeSlot(day, slot, schedule, workers, workerHours, maxHours, workersPerShift);
            });
        }

        // Find free time slots
        function findFreeSlots(day, start, end, existingShifts) {
            const slots = [{ start, end }];
            
            existingShifts.forEach(shift => {
                const shiftStart = timeToHour(shift.start);
                const shiftEnd = timeToHour(shift.end);
                
                const newSlots = [];
                slots.forEach(slot => {
                    if (slot.end <= shiftStart || slot.start >= shiftEnd) {
                        newSlots.push(slot);
                    } else {
                        if (slot.start < shiftStart) {
                            newSlots.push({ start: slot.start, end: shiftStart });
                        }
                        if (slot.end > shiftEnd) {
                            newSlots.push({ start: shiftEnd, end: slot.end });
                        }
                    }
                });
                slots.splice(0, slots.length, ...newSlots);
            });
            
            return slots.filter(slot => slot.end - slot.start >= 2);
        }

        // Fill time slot with workers
        function fillTimeSlot(day, slot, schedule, workers, workerHours, maxHours, workersPerShift) {
            let current = slot.start;
            
            while (current < slot.end) {
                const duration = Math.min(4, slot.end - current); // Max 4-hour shifts
                if (duration < 2) break;
                
                const shiftEnd = current + duration;
                
                // Find available workers
                const available = workers.filter(worker => {
                    if (workerHours[worker.email] + duration > maxHours) return false;
                    return isWorkerAvailable(worker, day, current, shiftEnd);
                });
                
                // Sort by current hours (fairness)
                available.sort((a, b) => workerHours[a.email] - workerHours[b.email]);
                
                const selected = available.slice(0, workersPerShift);
                
                const shift = {
                    start: hourToTime(current),
                    end: hourToTime(shiftEnd),
                    workers: selected.length > 0 ? selected.map(w => `${w.first_name} ${w.last_name}`) : ['Unfilled'],
                    emails: selected.map(w => w.email),
                    workStudy: false
                };
                
                if (!schedule[day]) schedule[day] = [];
                schedule[day].push(shift);
                
                selected.forEach(worker => {
                    workerHours[worker.email] += duration;
                });
                
                current = shiftEnd;
            }
        }

        // Save schedule to Firebase
        async function saveSchedule(schedule) {
            try {
                const scheduleData = {
                    days: schedule,
                    createdAt: new Date().toISOString(),
                    workplaceId: selectedWorkplace,
                    name: `${selectedWorkplace} Schedule ${new Date().toLocaleDateString()}`
                };
                
                const docRef = await addDoc(collection(db, 'workplaces', selectedWorkplace, 'schedules'), scheduleData);
                console.log('Schedule saved with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error saving schedule:', error);
                throw error;
            }
        }

        // View current schedule
        window.viewCurrentSchedule = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading current schedule...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const schedule = doc.data().days;
                    displaySchedule(schedule, true);
                } else {
                    document.getElementById('scheduleDisplay').innerHTML = '<div class="warning">No current schedule found. Generate a new one!</div>';
                }
            } catch (error) {
                console.error('Error loading current schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error loading schedule.</div>';
            }
        };

        // View schedule history
        window.viewHistory = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading schedule history...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                let html = '<div class="schedule-display"><h3>üìö Schedule History</h3>';
                
                if (snapshot.empty) {
                    html += '<p>No schedules found.</p>';
                } else {
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = new Date(data.createdAt).toLocaleDateString();
                        html += `
                            <div style="padding: 1rem; border: 1px solid #dee2e6; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${data.name || 'Schedule'}</strong><br>
                                    <small>Created: ${date}</small>
                                    ${index === 0 ? '<span style="color: #28a745; font-weight: bold;"> (Current)</span>' : ''}
                                </div>
                                <div>
                                    <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">View</button>
                                    ${index !== 0 ? `<button class="btn btn-success" onclick="publishSchedule('${doc.id}')">Make Current</button>` : ''}
                                    <button class="btn btn-danger" onclick="deleteSchedule('${doc.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error loading schedule history.</div>';
            }
        };

        // Find available workers
        window.findAvailable = function() {
            const day = document.getElementById('availDay').value;
            const start = document.getElementById('availStart').value;
            const end = document.getElementById('availEnd').value;
            
            if (!start || !end) {
                alert('Please enter both start and end times.');
                return;
            }
            
            const startHour = timeToHour(start);
            const endHour = timeToHour(end);
            
            if (endHour <= startHour) {
                alert('End time must be after start time.');
                return;
            }
            
            const available = workers.filter(worker => {
                return isWorkerAvailable(worker, day, startHour, endHour);
            });
            
            const workStudy = available.filter(w => w.work_study);
            const regular = available.filter(w => !w.work_study);
            
            let html = `
                <div class="schedule-display">
                    <h3>üîç Available Workers</h3>
                    <p><strong>${day} ${formatTime(start)} - ${formatTime(end)}</strong></p>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${available.length}</div>
                            <div class="stat-label">Total Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workStudy.length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regular.length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
            `;
            
            if (available.length === 0) {
                html += '<div class="warning">‚ùå No workers available during this time.</div>';
            } else {
                if (workStudy.length > 0) {
                    html += '<h4>üéì Work Study Students</h4>';
                    workStudy.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #28a745; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>${worker.email}</small>
                                </div>
                                <button class="btn btn-success" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
                
                if (regular.length > 0) {
                    html += '<h4>üë• Regular Workers</h4>';
                    regular.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #007bff; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>${worker.email}</small>
                                </div>
                                <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Display schedule
        function displaySchedule(schedule, isCurrent = false, scheduleId = null) {
            const workerHours = calculateWorkerHours(schedule);
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledShifts = Object.values(schedule).flat().filter(s => s.workers.includes('Unfilled')).length;
            
            let html = '<div class="schedule-display">';
            
            if (isCurrent) {
                html += '<div class="success">‚úÖ This is the current active schedule</div>';
            } else if (scheduleId) {
                html += `<button class="btn btn-success" onclick="publishSchedule('${scheduleId}')" style="width: 100%; margin-bottom: 1rem;">üì¢ Publish as Current Schedule</button>`;
            }
            
            // Stats
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${unfilledShifts}</div>
                        <div class="stat-label">Unfilled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(workerHours).length}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                </div>
            `;
            
            // Check work study issues
            const wsIssues = checkWorkStudyIssues(workerHours);
            if (wsIssues.length > 0) {
                html += '<div class="warning"><h5>‚ö†Ô∏è Work Study Issues</h5>';
                wsIssues.forEach(issue => {
                    html += `<p>${issue}</p>`;
                });
                html += '</div>';
            }
            
            // Schedule by day
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                html += `<div class="day-header">${day}</div>`;
                shifts.forEach(shift => {
                    const unfilled = shift.workers.includes('Unfilled');
                    const workStudy = shift.workStudy;
                    html += `
                        <div class="shift ${unfilled ? 'unfilled' : ''} ${workStudy ? 'work-study' : ''}">
                            <div>
                                <strong>${formatTime(shift.start)} - ${formatTime(shift.end)}</strong>
                                ${workStudy ? '<span style="color: #ffc107;"> (Work Study)</span>' : ''}
                            </div>
                            <div>${shift.workers.join(', ')}</div>
                        </div>
                    `;
                });
            });
            
            // Worker summary
            html += '<div class="worker-summary"><h4>Worker Hours Summary</h4>';
            html += '<table class="worker-table"><thead><tr><th>Worker</th><th>Hours</th><th>Status</th></tr></thead><tbody>';
            
            Object.entries(workerHours).forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWS = worker.work_study;
                let status = 'OK';
                let statusColor = '';
                
                if (isWS && hours !== 5) {
                    status = `WS Issue (${hours}h)`;
                    statusColor = 'color: #dc3545;';
                } else if (hours < 3) {
                    status = 'Low Hours';
                    statusColor = 'color: #ffc107;';
                }
                
                html += `
                    <tr>
                        <td>${name} ${isWS ? '<small>(WS)</small>' : ''}</td>
                        <td>${hours.toFixed(1)}</td>
                        <td style="${statusColor}">${status}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
        }

        // Calculate worker hours from schedule
        function calculateWorkerHours(schedule) {
            const hours = {};
            
            Object.values(schedule).forEach(shifts => {
                shifts.forEach(shift => {
                    const duration = timeToHour(shift.end) - timeToHour(shift.start);
                    shift.emails.forEach(email => {
                        hours[email] = (hours[email] || 0) + duration;
                    });
                });
            });
            
            return hours;
        }

        // Check work study issues
        function checkWorkStudyIssues(workerHours) {
            const issues = [];
            
            workers.forEach(worker => {
                if (worker.work_study) {
                    const hours = workerHours[worker.email] || 0;
                    if (hours !== 5) {
                        issues.push(`${worker.first_name} ${worker.last_name}: ${hours.toFixed(1)} hours (needs exactly 5)`);
                    }
                }
            });
            
            return issues;
        }

        // Contact worker
        window.contactWorker = function(email) {
            window.open(`mailto:${email}?subject=Work Schedule&body=Hello! We have a shift available.`);
        };

        // Publish schedule
        window.publishSchedule = async function(scheduleId) {
            if (confirm('Publish this schedule as the current active schedule?')) {
                try {
                    await updateDoc(doc(db, 'workplaces', selectedWorkplace), {
                        currentScheduleId: scheduleId,
                        updatedAt: new Date().toISOString()
                    });
                    
                    alert('‚úÖ Schedule published successfully!');
                    viewCurrentSchedule();
                } catch (error) {
                    console.error('Error publishing schedule:', error);
                    alert('‚ùå Error publishing schedule.');
                }
            }
        };

        // Delete schedule
        window.deleteSchedule = async function(scheduleId) {
            if (confirm('Delete this schedule? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                    alert('‚úÖ Schedule deleted.');
                    viewHistory();
                } catch (error) {
                    console.error('Error deleting schedule:', error);
                    alert('‚ùå Error deleting schedule.');
                }
            }
        };

        // View schedule by ID
        window.viewScheduleById = async function(scheduleId) {
            try {
                const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                if (docSnap.exists()) {
                    const schedule = docSnap.data().days;
                    displaySchedule(schedule, false, scheduleId);
                }
            } catch (error) {
                console.error('Error viewing schedule:', error);
            }
        };
    </script>
</body>
</html>
