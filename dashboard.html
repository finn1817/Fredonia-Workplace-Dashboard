<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: #28a745;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .user-badge {
            background: #17a2b8;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .workplace-section, .admin-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .admin-section {
            border: 2px solid #28a745;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .admin-title {
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .workplace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
        }

        .workplace-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .workplace-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .workplace-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .schedule-content {
            display: none;
        }

        .action-buttons, .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-admin { background: #28a745; color: white; }

        .btn:hover:not(:disabled) { 
            transform: translateY(-1px); 
            filter: brightness(1.1);
        }

        .btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
            /* display: none; */
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .hours-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .day-hours {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .day-hours h5 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* Simplified Hours Management Styles */
        .simplified-hours-container {
            max-width: 100%;
        }

        .hours-instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .hours-instructions ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .hours-instructions li {
            margin-bottom: 0.25rem;
        }

        .days-checkboxes {
            margin-bottom: 2rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-checkbox:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .day-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .day-checkbox label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .time-blocks-container {
            margin-bottom: 2rem;
        }

        .day-time-blocks {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .day-time-blocks h5 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .time-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 120px;
        }

        .time-input label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
            margin: 0;
        }

        .time-input input[type="time"] {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .hours-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .schedule-display {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            text-align: center;
        }

        .shift {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift.work-study {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .shift.unfilled {
            border-color: #dc3545;
            background: #ffebee;
        }

        .shift.coverage-gap {
            border-color: #ff5722;
            background: #ffebee;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 87, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
        }

        .shift-actions {
            display: flex;
            gap: 0.5rem;
        }

        .shift-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .worker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .worker-table th, .worker-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .worker-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .worker-table tr:hover {
            background: #f8f9fa;
        }

        .worker-actions {
            display: flex;
            gap: 0.5rem;
        }

        .worker-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
        }

        /* Announcements Styling */
        .announcements-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .announcement-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .announcement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .announcement-card.high-priority {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        }

        .announcement-card.medium-priority {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .announcement-card.low-priority {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .announcement-subject {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .announcement-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.high {
            background: #dc3545;
            color: white;
        }

        .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }

        .priority-badge.low {
            background: #28a745;
            color: white;
        }

        .announcement-message {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .announcement-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .announcement-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .print-only {
            display: none;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .schedule-display { box-shadow: none; }
            .btn { display: none !important; }
            .shift-actions { display: none !important; }
            body { background: white; }
            .header { background: #333 !important; }
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .workplace-grid { grid-template-columns: 1fr; }
            .action-buttons, .admin-buttons { flex-direction: column; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
            .modal-content { margin: 10% auto; width: 95%; }
        }

        .shift.forced-shift {
            border: 2.5px solid #e53935 !important;
            box-shadow: 0 0 0 2px #e5393533 !important;
            position: relative;
        }
        .shift.forced-shift::after {
            content: "!";
            color: #e53935;
            font-weight: bold;
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.2rem;
            background: #fff;
            border-radius: 50%;
            border: 1.5px solid #e53935;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        /* Shift Swap Request Cards */
        .swap-request-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .swap-request-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .swap-request-card.pending {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .swap-request-card.approved {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
        }

        .swap-request-card.denied {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .swap-request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .swap-request-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .swap-request-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .status-badge.approved {
            background: #28a745;
            color: white;
        }

        .status-badge.denied {
            background: #dc3545;
            color: white;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .status-badge.approved {
            background: #28a745;
            color: white;
        }

        .swap-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .swap-detail {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .swap-detail-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .swap-detail-value {
            font-weight: 600;
            color: #333;
        }

        .swap-reason {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .swap-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .swap-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Enhanced Management Interface Styles */
        .management-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 2rem;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        /* Role-based visibility classes */
        .admin-only {
            display: none;
        }

        .super-admin-only {
            display: none;
        }

        .workplace-admin-only {
            display: none;
        }

        /* Admin Management Styles */
        .admin-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-filters input,
        .admin-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .admin-filters input {
            flex: 1;
            min-width: 200px;
        }

        .admin-details {
            display: grid;
            gap: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .detail-row strong {
            color: #495057;
        }

        /* Status badges for different roles */
        .status-badge.super-admin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .status-badge.admin {
            background: linear-gradient(135deg, #4834d4, #686de0);
            color: white;
        }

        .status-badge.pending {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }

        /* Admin form styles */
        .admin-form-group {
            margin-bottom: 15px;
        }

        .admin-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .admin-form-group input,
        .admin-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .admin-form-group select[multiple] {
            height: 120px;
        }

        .admin-form-group small {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        .management-tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .management-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .management-tab:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        .management-content {
            display: none;
        }

        .management-content.active {
            display: block;
        }

        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }

        .management-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .management-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-box::before {
            content: "ğŸ”";
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .filter-dropdown {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            min-width: 150px;
        }

        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .enhanced-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .enhanced-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .enhanced-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #28a745;
            color: white;
        }

        .status-badge.suspended {
            background: #dc3545;
            color: white;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .work-study-badge {
            background: #17a2b8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .bulk-actions {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 2px solid #e9ecef;
        }

        .bulk-actions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .bulk-checkbox {
            margin-right: 0.5rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #e1e5e9;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .import-export-section {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .import-export-section h4 {
            margin-bottom: 1rem;
            color: #1976d2;
        }

        .file-upload-area {
            border: 2px dashed #2196f3;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: white;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #1976d2;
            background: #f8f9ff;
        }

        .file-upload-area.dragover {
            border-color: #1976d2;
            background: #e3f2fd;
        }

        .progress-container {
            margin-top: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .user-worker-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #667eea;
            text-decoration: none;
            font-size: 0.8rem;
        }

        .user-worker-link:hover {
            text-decoration: underline;
        }

        .no-link {
            color: #dc3545;
            font-size: 0.8rem;
        }

        .audit-trail {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .audit-trail h5 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .audit-entry {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.8rem;
        }

        .audit-entry:last-child {
            border-bottom: none;
        }

        .audit-timestamp {
            color: #666;
            font-size: 0.75rem;
        }

        /* Print Styles for Clean Schedule Printing */
        @media print {
            /* Hide all non-essential elements */
            .header, .sidebar, .modal, .btn, .notification, 
            .admin-controls, .user-controls, .workplace-selector,
            .form-container, .request-forms, .announcement-form,
            .email-change-form, .password-change-form {
                display: none !important;
            }

            /* Reset page margins and background */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                font-family: 'Arial', sans-serif !important;
                line-height: 1.4 !important;
            }

            /* Main container adjustments */
            .main-content {
                margin: 0 !important;
                padding: 20px !important;
                width: 100% !important;
                max-width: none !important;
            }

            /* Schedule container */
            .schedule-container {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                box-shadow: none !important;
                border: none !important;
            }

            /* Schedule header */
            .schedule-header {
                text-align: center !important;
                margin-bottom: 30px !important;
                padding: 20px 0 !important;
                border-bottom: 2px solid #333 !important;
            }

            .schedule-header h1 {
                font-size: 28px !important;
                margin: 0 0 10px 0 !important;
                color: #333 !important;
                font-weight: bold !important;
            }

            .schedule-header p {
                font-size: 16px !important;
                margin: 5px 0 !important;
                color: #666 !important;
            }

            /* Summary cards */
            .summary-cards {
                display: flex !important;
                justify-content: center !important;
                gap: 40px !important;
                margin-bottom: 30px !important;
                page-break-inside: avoid !important;
            }

            .summary-card {
                background: #f8f9fa !important;
                border: 2px solid #333 !important;
                border-radius: 8px !important;
                padding: 15px 25px !important;
                text-align: center !important;
                min-width: 150px !important;
            }

            .summary-card .number {
                font-size: 32px !important;
                font-weight: bold !important;
                color: #333 !important;
                margin-bottom: 5px !important;
            }

            .summary-card .label {
                font-size: 14px !important;
                color: #666 !important;
                text-transform: uppercase !important;
                font-weight: bold !important;
            }

            /* Schedule grid */
            .schedule-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 15px !important;
                margin: 0 !important;
            }

            /* Day columns */
            .day-column {
                background: white !important;
                border: 2px solid #333 !important;
                border-radius: 8px !important;
                padding: 15px !important;
                min-height: 200px !important;
                page-break-inside: avoid !important;
            }

            .day-header {
                text-align: center !important;
                font-size: 18px !important;
                font-weight: bold !important;
                color: #333 !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
                border-bottom: 1px solid #ccc !important;
                text-transform: uppercase !important;
            }

            /* Shifts */
            .shift {
                background: #f8f9fa !important;
                border: 1px solid #333 !important;
                border-radius: 6px !important;
                padding: 12px !important;
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
            }

            .shift:last-child {
                margin-bottom: 0 !important;
            }

            .shift-time {
                font-size: 14px !important;
                font-weight: bold !important;
                color: #333 !important;
                margin-bottom: 8px !important;
            }

            .shift-worker {
                font-size: 13px !important;
                color: #666 !important;
                font-weight: normal !important;
            }

            .shift.work-study {
                background: #e3f2fd !important;
                border-color: #2196f3 !important;
            }

            .shift.work-study .shift-time {
                color: #1976d2 !important;
            }

            /* Empty day styling */
            .day-column.empty {
                background: #f8f9fa !important;
                border-style: dashed !important;
                border-color: #ccc !important;
            }

            .day-column.empty .day-header {
                color: #999 !important;
            }

            /* Page breaks */
            .day-column {
                page-break-inside: avoid !important;
            }

            /* Footer */
            .print-footer {
                display: block !important;
                text-align: center !important;
                margin-top: 30px !important;
                padding-top: 20px !important;
                border-top: 1px solid #ccc !important;
                font-size: 12px !important;
                color: #666 !important;
            }

            .print-footer::before {
                content: "Generated on " attr(data-date) " | Workplace Scheduler Dashboard";
            }

            /* Hide all other elements */
            .schedule-container > *:not(.schedule-header):not(.summary-cards):not(.schedule-grid):not(.print-footer) {
                display: none !important;
            }

            /* Ensure proper spacing */
            .schedule-container {
                margin-bottom: 20px !important;
            }

            /* Force background colors to print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ¢ Workplace Scheduler</h1>
        <div class="user-info">
            <span id="userEmail"></span>
            <span id="adminBadge" class="admin-badge">ADMIN</span>
            <span id="userBadge" class="user-badge">USER</span>
            <button class="btn" id="myAccountBtn" style="background:#eee;color:#333;margin-right:0.5rem;">ğŸ‘¤ My Account</button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Admin Controls -->
        <div id="adminSection" class="admin-section" style="display: none;">
            <h2 class="section-title admin-title">ğŸ”§ Admin Controls</h2>
            <div class="admin-buttons">
                <button class="btn btn-admin" onclick="showManageHours()">â° Manage Hours</button>
                <button class="btn btn-admin" onclick="showManageWorkers()">ğŸ‘¥ Manage Workers</button>
                <button class="btn btn-admin" onclick="showAddWorker()">â• Add Worker</button>
                <button class="btn btn-admin" onclick="showImportWorkers()">ğŸ“¥ Import Workers</button>
                <button class="btn btn-warning" id="hourRequestsBtn" style="position:relative;">â° Hour Requests <span id="hourRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-info" id="viewMessagesBtn" style="position:relative;">ğŸ“¥ View Messages <span id="messagesBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-warning" id="timeOffRequestsBtn" style="position:relative;">ğŸ–ï¸ Time Off Requests <span id="timeOffRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-info" id="shiftSwapRequestsBtn" style="position:relative;">ğŸ”„ Shift Swap Requests <span id="shiftSwapRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-warning" id="emailChangeRequestsBtn" style="position:relative;">ğŸ“§ Email Change Requests <span id="emailChangeRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-danger" id="removeAllWorkersBtn">ğŸ—‘ï¸ Remove All Workers</button>
                <button class="btn btn-danger" id="cleanupSchedulesBtn">ğŸ§¹ Clean Up Old Schedules</button>
            </div>
        </div>

        <!-- Workplace Selection -->
        <div class="workplace-section">
            <h2 class="section-title">Select Workplace</h2>
            <div class="workplace-grid" id="workplaceGrid">
                <div class="workplace-card" onclick="selectWorkplace('esports_lounge')">
                    <h4>ğŸ® eSports Lounge</h4>
                    <p>esports_lounge</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('esports_arena')">
                    <h4>ğŸŸï¸ eSports Arena</h4>
                    <p>esports_arena</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('it_service_center')">
                    <h4>ğŸ’» IT Service Center</h4>
                    <p>it_service_center</p>
                </div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="schedule-content" id="scheduleContent">
            <div class="workplace-section">
                <h2 class="section-title">Schedule Management</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showGenerateForm()" id="generateBtn">ğŸ“… Generate New Schedule</button>
                    <button class="btn btn-success" onclick="viewCurrentSchedule()">ğŸ‘ï¸ View Current Schedule</button>
                    <button class="btn btn-info" onclick="viewHistory()">ğŸ“š Schedule History</button>
                    <button class="btn btn-warning" onclick="checkAvailability()">ğŸ” Check Availability</button>
                    <button class="btn btn-secondary" onclick="viewWorkers()" id="viewWorkersBtn">ğŸ‘¥ View Workers</button>
                    <button class="btn btn-info" onclick="showWhosWorkingNow()" id="whosWorkingNowBtn" style="display:none;">ğŸ•’ Who's Working Now?</button>
                    <button class="btn btn-secondary" onclick="printSchedule()" id="printScheduleBtn">ğŸ–¨ï¸ Print Schedule</button>
                </div>

                <!-- Generate Schedule Form -->
                <div class="form-section" id="generateForm">
                    <h3>Generate New Schedule</h3>
                    <div class="info">
                        <strong>ğŸ’¡ Schedule Generation Tips:</strong><br>
                        â€¢ Work study students automatically get exactly 5 hours<br>
                        â€¢ Algorithm ensures all operating hours are covered<br>
                        â€¢ Fair distribution based on worker availability<br>
                        â€¢ Unfilled shifts will be highlighted for attention
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxHours">Max Hours per Worker</label>
                            <input type="number" id="maxHours" value="20" min="5" max="40">
                        </div>
                        <div class="form-group">
                            <label for="workersPerShift">Workers per Shift</label>
                            <input type="number" id="workersPerShift" value="2" min="1" max="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minHours">Min Hours per Worker</label>
                            <input type="number" id="minHours" value="3" min="0" max="20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="ensureFullCoverage" checked>
                            Ensure complete coverage of all operating hours
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="generateSchedule()" id="generateScheduleBtn">ğŸš€ Generate Schedule</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Check Availability Form -->
                <div class="form-section" id="availabilityForm">
                    <h3>Check Worker Availability</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availDay">Day</label>
                            <select id="availDay">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availStart">Start Time</label>
                            <input type="time" id="availStart">
                        </div>
                        <div class="form-group">
                            <label for="availEnd">End Time</label>
                            <input type="time" id="availEnd">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="findAvailable()">ğŸ” Find Available Workers</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Schedule Display -->
                <div id="scheduleDisplay">
                    <div class="loading">Select an option above to get started.</div>
                </div>
            </div>
        </div>

        <!-- User Dashboard (non-admin) -->
        <div id="userDashboard" class="workplace-section" style="display:none; margin-bottom:2rem;">
            <h2 class="section-title">ğŸ‘¤ User Dashboard</h2>
            <div id="userWelcome" style="font-size:1.1rem; margin-bottom:1.5rem;"></div>
            <!-- Request Availability Change Button -->
            <button class="btn btn-info" id="requestAvailabilityBtn" style="margin-bottom:1.5rem;">âœï¸ Request Availability Change</button>
            <!-- Request Time Off Button -->
            <button class="btn btn-warning" id="requestTimeOffBtn" style="margin-bottom:1.5rem;">ğŸ–ï¸ Request Time Off</button>
            <!-- Request Shift Swap Button -->
            <button class="btn btn-info" id="requestShiftSwapBtn" style="margin-bottom:1.5rem;">ğŸ”„ Request Shift Swap</button>
            <!-- My Shift Swap Requests Button -->
            <button class="btn btn-info" id="myShiftSwapRequestsBtn" style="margin-bottom:1.5rem;">ğŸ“‹ My Swap Requests</button>
            <!-- Removed My Account section from here -->
            <div class="form-section" style="margin-bottom:1.5rem;">
                <h3>ğŸ“… My Assigned Shifts</h3>
                <div id="userShiftsPlaceholder" style="color:#888;">(Your assigned shifts will appear here.)</div>
            </div>
            <div class="form-section" style="margin-bottom:1.5rem;">
                <h3>â° Total Hours This Week</h3>
                <div id="userHoursPlaceholder" style="color:#888;">(Your total hours will appear here.)</div>
            </div>
            <div class="form-section" style="margin-bottom:1.5rem;">
                <h3>ğŸ—“ï¸ My Availability</h3>
                <div id="userAvailabilityPlaceholder" style="color:#888;">(Your availability will appear here.)</div>
            </div>
            <div class="form-section">
                <h3>âœ‰ï¸ Send a Message to Admins</h3>
                <textarea id="userMessageInput" rows="3" style="width:100%;border-radius:8px;padding:1rem;" placeholder="Type your message or question here..."></textarea>
                <button class="btn btn-info" id="sendUserMessageBtn" style="margin-top:0.5rem;">Send Message</button>
            </div>
        </div>
        <!-- Modal for Request Availability Change -->
        <div id="availabilityRequestModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>âœï¸ Request Availability Change</h3>
                    <span class="close" onclick="closeModal('availabilityRequestModal')">&times;</span>
                </div>
                <form id="availabilityRequestForm">
                    <div class="form-group">
                        <label for="requestName">Name</label>
                        <input type="text" id="requestName" required>
                    </div>
                    <div class="form-group">
                        <label for="requestEmail">Email</label>
                        <input type="email" id="requestEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="requestAvailability">Requested Availability</label>
                        <textarea id="requestAvailability" rows="3" required placeholder="e.g. Monday 9am-2pm, Tuesday 1pm-5pm"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success" id="submitAvailabilityRequestBtn">Submit Request</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('availabilityRequestModal')" style="margin-top:0.5rem;">Cancel</button>
                </form>
            </div>
        </div>
        <!-- Modal for Admin Hour Requests -->
        <div id="hourRequestsModal" class="modal">
            <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                <div class="modal-header">
                    <h3>â° Hour Change Requests</h3>
                    <span class="close" onclick="closeModal('hourRequestsModal')">&times;</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-info" onclick="filterRequests('all')" id="filterAllBtn">All Requests</button>
                    <button class="btn btn-warning" onclick="filterRequests('pending')" id="filterPendingBtn">Pending</button>
                    <button class="btn btn-success" onclick="filterRequests('resolved')" id="filterResolvedBtn">Resolved</button>
                </div>
                <div id="hourRequestsList" style="max-height: 60vh; overflow-y: auto;">
                    <div class="loading">Loading requests...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Hours -->
    <div id="hoursModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>â° Manage Hours of Operation</h3>
                <span class="close" onclick="closeModal('hoursModal')">&times;</span>
            </div>
            <div id="hoursModalContent">
                <div class="loading">Loading hours...</div>
            </div>
        </div>
    </div>

    <!-- Enhanced Modal for Manage Workers -->
    <div id="workersModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; width: 95%;">
            <div class="modal-header">
                <h3>ğŸ‘¥ Enhanced Worker & User Management</h3>
                <span class="close" onclick="closeModal('workersModal')">&times;</span>
            </div>
            <div id="workersModalContent">
                <div class="loading">Loading enhanced management interface...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Worker -->
    <div id="workerFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="workerFormTitle">â• Add Worker</h3>
                <span class="close" onclick="closeModal('workerFormModal')">&times;</span>
            </div>
            <form id="workerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerFirstName">First Name</label>
                        <input type="text" id="workerFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="workerLastName">Last Name</label>
                        <input type="text" id="workerLastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerEmail">Email</label>
                        <input type="email" id="workerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="workerWorkStudy">Work Study</label>
                        <select id="workerWorkStudy">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="workerAvailability">Availability (e.g., "Mon 09:00-17:00, Tue 10:00-16:00")</label>
                    <textarea id="workerAvailability" rows="3" placeholder="Mon 09:00-17:00, Tue 10:00-16:00, Wed 08:00-14:00"></textarea>
                    <small style="color: #666; font-style: italic;">Format: Day HH:MM-HH:MM, Day HH:MM-HH:MM</small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Save Worker</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('workerFormModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add a minimal modal to the HTML if not present -->
    <div id="editShiftModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Edit Shift</h3>
                <span class="close" onclick="closeModal('editShiftModal')">&times;</span>
            </div>
            <div id="editShiftModalBody"></div>
        </div>
    </div>

    <!-- Add modal for import feedback -->
    <div id="importWorkersModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3>Import Workers</h3>
          <span class="close" onclick="closeModal('importWorkersModal')">&times;</span>
        </div>
        <div id="importWorkersModalBody"></div>
      </div>
    </div>

    <!-- Add modal for Add Shift if not present -->
    <div id="addShiftModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Add New Shift</h3>
                <span class="close" onclick="closeModal('addShiftModal')">&times;</span>
            </div>
            <div id="addShiftModalBody"></div>
        </div>
    </div>

    <!-- Add Workplace Notes section below Schedule Management -->
    <div id="workplaceNotesSection" class="form-section" style="margin-top:1.5rem; display:none;">
        <h3>ï¿½ï¿½ Workplace Notes</h3>
        <div id="workplaceNotesContent"></div>
    </div>

    <!-- Enhanced Announcements Board -->
    <div id="announcementsSection" class="workplace-section" style="margin-top:1.5rem; display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>ğŸ“¢ Workplace Announcements</h3>
            <button class="btn btn-success" id="addAnnouncementBtn" style="display: none;">â• Add Announcement</button>
        </div>
        <div id="announcementsContent">
            <div class="loading">Loading announcements...</div>
        </div>
    </div>

    <!-- My Account Modal (for all users) -->
    <div id="myAccountModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>âš™ï¸ My Account</h3>
                <span class="close" onclick="closeModal('myAccountModal')">&times;</span>
            </div>
            <form id="userAccountFormModal" style="max-width: 500px; margin: 0 auto;">
                <div class="form-group">
                    <label for="accountFirstNameModal">First Name</label>
                    <input type="text" id="accountFirstNameModal" required>
                </div>
                <div class="form-group">
                    <label for="accountLastNameModal">Last Name</label>
                    <input type="text" id="accountLastNameModal" required>
                </div>
                <div class="form-group">
                    <label for="accountEmailModal">Email</label>
                    <input type="email" id="accountEmailModal" disabled style="background:#f1f3f4;">
                </div>
                <div class="form-group">
                    <label for="accountPhoneModal">Phone Number <span style="color:#888;">(optional)</span></label>
                    <input type="tel" id="accountPhoneModal" pattern="[0-9\-\+\(\) ]*">
                </div>
                <button type="button" class="btn btn-success" id="saveAccountBtnModal" style="margin-top:0.5rem;">Save Changes</button>
            </form>
            <hr style="margin:2rem 0;">
            <form id="userPasswordFormModal" style="max-width: 500px; margin: 0 auto;">
                <h4 style="margin-bottom:1rem;">ğŸ”’ Change Password</h4>
                <div class="form-group">
                    <label for="oldPasswordModal">Current Password</label>
                    <input type="password" id="oldPasswordModal" required>
                </div>
                <div class="form-group">
                    <label for="newPasswordModal">New Password</label>
                    <input type="password" id="newPasswordModal" required>
                </div>
                <div class="form-group">
                    <label for="confirmNewPasswordModal">Confirm New Password</label>
                    <input type="password" id="confirmNewPasswordModal" required>
                </div>
                <button type="button" class="btn btn-info" id="changePasswordBtnModal" style="margin-top:0.5rem;">Change Password</button>
            </form>
            
            <hr style="margin:2rem 0;">
            
            <form id="emailChangeRequestFormModal" style="max-width: 500px; margin: 0 auto;">
                <h4 style="margin-bottom:1rem;">ğŸ“§ Request Email Change</h4>
                <div class="info" style="margin-bottom:1rem; font-size:0.9rem;">
                    <strong>Note:</strong> Email change requests require admin approval. You can have up to 2 pending requests at a time.
                </div>
                <div class="form-group">
                    <label for="currentEmailModal">Current Email</label>
                    <input type="email" id="currentEmailModal" disabled style="background:#f1f3f4;">
                </div>
                <div class="form-group">
                    <label for="newEmailModal">New Email Address</label>
                    <input type="email" id="newEmailModal" required placeholder="Enter your new email address">
                </div>
                <div class="form-group">
                    <label for="emailChangeReasonModal">Reason for Change <span style="color:#888;">(optional)</span></label>
                    <textarea id="emailChangeReasonModal" rows="3" placeholder="Briefly explain why you need to change your email address..."></textarea>
                </div>
                <button type="button" class="btn btn-warning" id="submitEmailChangeRequestBtn" style="margin-top:0.5rem;">Submit Email Change Request</button>
            </form>
            
            <hr style="margin:2rem 0;">
            
            <div id="emailChangeRequestsHistoryModal" style="max-width: 500px; margin: 0 auto;">
                <h4 style="margin-bottom:1rem;">ğŸ“‹ Email Change Request History</h4>
                <div id="emailChangeRequestsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 1rem;">
                    <div class="loading">Loading your email change requests...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Admin Messages -->
    <div id="adminMessagesModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>ğŸ“¥ Messages to Admins</h3>
                <span class="close" onclick="closeModal('adminMessagesModal')">&times;</span>
            </div>
            <div id="adminMessagesList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading messages...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Request Time Off -->
    <div id="timeOffRequestModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ğŸ–ï¸ Request Time Off</h3>
                <span class="close" onclick="closeModal('timeOffRequestModal')">&times;</span>
            </div>
            <form id="timeOffRequestForm">
                <div class="form-group">
                    <label for="timeOffStartDate">Start Date</label>
                    <input type="date" id="timeOffStartDate" required>
                </div>
                <div class="form-group">
                    <label for="timeOffEndDate">End Date <span style="color:#888;">(optional)</span></label>
                    <input type="date" id="timeOffEndDate">
                    <small style="color: #666; font-style: italic;">Leave blank if requesting single day off</small>
                </div>
                <div class="form-group">
                    <label for="timeOffReason">Reason <span style="color:#888;">(optional)</span></label>
                    <textarea id="timeOffReason" rows="3" placeholder="Brief reason for time off request..."></textarea>
                </div>
                <button type="submit" class="btn btn-success" id="submitTimeOffRequestBtn">Submit Request</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('timeOffRequestModal')" style="margin-top:0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Modal for Admin Time Off Requests -->
    <div id="timeOffRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>ğŸ–ï¸ Time Off Requests</h3>
                <span class="close" onclick="closeModal('timeOffRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterTimeOffRequests('all')" id="filterTimeOffAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterTimeOffRequests('pending')" id="filterTimeOffPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterTimeOffRequests('approved')" id="filterTimeOffApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterTimeOffRequests('denied')" id="filterTimeOffDeniedBtn">Denied</button>
            </div>
            <div id="timeOffRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading time off requests...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Announcement -->
    <div id="announcementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="announcementModalTitle">ğŸ“¢ Add Announcement</h3>
                <span class="close" onclick="closeModal('announcementModal')">&times;</span>
            </div>
            <form id="announcementForm">
                <div class="form-group">
                    <label for="announcementSubject">Subject</label>
                    <input type="text" id="announcementSubject" required placeholder="Enter announcement subject...">
                </div>
                <div class="form-group">
                    <label for="announcementMessage">Message</label>
                    <textarea id="announcementMessage" rows="6" required placeholder="Enter announcement message..."></textarea>
                </div>
                <div class="form-group">
                    <label for="announcementPriority">Priority</label>
                    <select id="announcementPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" id="saveAnnouncementBtn">ğŸ’¾ Save Announcement</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('announcementModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Request Shift Swap -->
    <div id="shiftSwapRequestModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ğŸ”„ Request Shift Swap</h3>
                <span class="close" onclick="closeModal('shiftSwapRequestModal')">&times;</span>
            </div>
            <form id="shiftSwapRequestForm">
                <div class="form-group">
                    <label for="swapRequesterShiftDate">Your Shift Date</label>
                    <input type="date" id="swapRequesterShiftDate" required>
                </div>
                <div class="form-group">
                    <label for="swapRequesterShiftTime">Your Shift Time</label>
                    <select id="swapRequesterShiftTime" required>
                        <option value="">Select your shift time...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="swapTargetWorker">Swap with Worker</label>
                    <select id="swapTargetWorker" required>
                        <option value="">Select worker to swap with...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="swapTargetShiftDate">Their Shift Date</label>
                    <input type="date" id="swapTargetShiftDate" required>
                </div>
                <div class="form-group">
                    <label for="swapTargetShiftTime">Their Shift Time</label>
                    <select id="swapTargetShiftTime" required>
                        <option value="">Select their shift time...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="swapReason">Reason for Swap <span style="color:#888;">(optional)</span></label>
                    <textarea id="swapReason" rows="3" placeholder="Brief reason for the shift swap request..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" id="submitShiftSwapRequestBtn">ğŸ”„ Submit Swap Request</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('shiftSwapRequestModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Admin Shift Swap Requests -->
    <div id="shiftSwapRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>ğŸ”„ Shift Swap Requests</h3>
                <span class="close" onclick="closeModal('shiftSwapRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterShiftSwapRequests('all')" id="filterSwapAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterShiftSwapRequests('pending')" id="filterSwapPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterShiftSwapRequests('approved')" id="filterSwapApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterShiftSwapRequests('denied')" id="filterSwapDeniedBtn">Denied</button>
            </div>
            <div id="shiftSwapRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading shift swap requests...</div>
            </div>
        </div>
    </div>

    <!-- Modal for User Shift Swap Requests -->
    <div id="userShiftSwapRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>ğŸ“‹ My Shift Swap Requests</h3>
                <span class="close" onclick="closeModal('userShiftSwapRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterUserShiftSwapRequests('all')" id="filterUserSwapAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterUserShiftSwapRequests('pending')" id="filterUserSwapPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterUserShiftSwapRequests('approved')" id="filterUserSwapApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterUserShiftSwapRequests('denied')" id="filterUserSwapDeniedBtn">Denied</button>
            </div>
            <div id="userShiftSwapRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading your shift swap requests...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Admin Email Change Requests -->
    <div id="adminEmailChangeRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 80vh;">
            <div class="modal-header">
                <h3>ğŸ“§ Email Change Requests</h3>
                <span class="close" onclick="closeModal('adminEmailChangeRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterEmailChangeRequests('all')" id="filterEmailAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterEmailChangeRequests('pending')" id="filterEmailPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterEmailChangeRequests('approved')" id="filterEmailApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterEmailChangeRequests('denied')" id="filterEmailDeniedBtn">Denied</button>
                <button class="btn btn-secondary" onclick="exportEmailChangeRequests()" style="float: right;">ğŸ“¤ Export</button>
            </div>
            <div id="adminEmailChangeRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading email change requests...</div>
            </div>
        </div>
    </div>

    <!-- Add zod for schema validation -->
    <script src="https://cdn.jsdelivr.net/npm/zod@3.22.4/lib/index.umd.min.js"></script>

    <!-- Modal for Availability Format Error -->
    <div id="availabilityFormatModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3>âš ï¸ Invalid Availability Format</h3>
          <span class="close" onclick="closeModal('availabilityFormatModal')">&times;</span>
        </div>
        <div id="availabilityFormatModalBody">
          <div style="margin-bottom:1rem;">
            <strong>Please enter availability in the correct format:</strong><br>
            <span style="color:#333;">Day HH:MM-HH:MM, Day HH:MM-HH:MM</span><br>
            <span style="color:#888;">Examples: <br>Mon 09:00-17:00, Tue 10:00-16:00<br>Monday 08:00-12:00, Wednesday 13:00-17:00</span>
          </div>
          <textarea id="availabilityFormatModalInput" rows="3" style="width:100%;border-radius:8px;padding:1rem;"></textarea>
          <div id="availabilityFormatModalError" style="color:#c33;margin-top:0.5rem;"></div>
          <div style="margin-top:1rem;display:flex;gap:1rem;">
            <button class="btn btn-success" id="availabilityFormatModalTryBtn">Try Again</button>
            <button class="btn btn-secondary" onclick="closeModal('availabilityFormatModal')">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
        // Enhanced auth check and setup
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'index.html';
        }
        
        document.getElementById('userEmail').textContent = user.email;
        if (user.isAdmin) {
            document.getElementById('adminBadge').style.display = 'inline';
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('userBadge').style.display = 'none';
        } else {
            document.getElementById('adminBadge').style.display = 'none';
            document.getElementById('userBadge').style.display = 'inline';
            // Hide admin-only buttons for non-admin users
            document.getElementById('generateBtn').style.display = 'none';
        }

        // Firebase setup
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, setDoc, where
        } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        const workplaceConfig = {
            apiKey: "AIzaSyBkkq4nPnmyfSOKtVLsO95rpAUsMDA1o0A",
            authDomain: "workplace-scheduler-ace38.firebaseapp.com", 
            projectId: "workplace-scheduler-ace38",
            storageBucket: "workplace-scheduler-ace38.firebasestorage.app",
            messagingSenderId: "153631302747",
            appId: "1:153631302747:web:2c731351893dca19510b7e"
        };

        const authConfig = {
            apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
            authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
            projectId: "my-admin-dashboard-b9c89",
            storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
            messagingSenderId: "1001105953619",
            appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
            measurementId: "G-DGTX5YCKYF"
        };

        const workplaceApp = initializeApp(workplaceConfig);
        const authApp = initializeApp(authConfig, 'authApp');
        const db = getFirestore(workplaceApp);
        const authDb = getFirestore(authApp);

        // Global state
        let selectedWorkplace = null;
        let workers = [];
        let hours = {};
        let editingWorkerId = null;
        let schedule = {};
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let currentScheduleId = null; // <-- Track the current schedule doc ID

        // Enhanced utility functions
        const timeToHour = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            // Convert to 24-hour format for internal calculations
            return h + (m / 60);
        };

        const hourToTime = (hour) => {
            const h = Math.floor(hour);
            const m = Math.round((hour - h) * 60);
            // Handle hours >= 24 (overnight shifts)
            const adjustedHour = h >= 24 ? h - 24 : h;
            return `${adjustedHour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            let [h, m] = timeStr.split(':').map(Number);
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m.toString().padStart(2, '0')} ${period}`;
        };

        // Enhanced availability parsing
        const parseAvailability = (availabilityText) => {
            const availability = {};
            if (!availabilityText) return availability;
            
            const dayMap = {
                'sunday': 'Sunday', 'sun': 'Sunday',
                'monday': 'Monday', 'mon': 'Monday',
                'tuesday': 'Tuesday', 'tue': 'Tuesday',
                'wednesday': 'Wednesday', 'wed': 'Wednesday',
                'thursday': 'Thursday', 'thu': 'Thursday',
                'friday': 'Friday', 'fri': 'Friday',
                'saturday': 'Saturday', 'sat': 'Saturday'
            };
            
            const blocks = availabilityText.split(',').map(s => s.trim());
            blocks.forEach(block => {
                const match = block.match(/(\w+)\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/i);
                if (match) {
                    const [, dayRaw, start, end] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    
                    if (day) {
                        let startHour = timeToHour(start);
                        let endHour = timeToHour(end);
                        
                        if (endHour <= startHour) {
                            endHour += 24.0;
                        }
                        
                        if (!availability[day]) availability[day] = [];
                        
                        availability[day].push({
                            start: start,
                            end: end,
                            start_hour: startHour,
                            end_hour: endHour
                        });
                    }
                }
            });
            
            return availability;
        };

        const isWorkerAvailable = (worker, day, startHour, endHour) => {
            const dayAvail = worker.availability[day] || [];
            return dayAvail.some(slot => slot.start_hour <= startHour && endHour <= slot.end_hour);
        };

        // Enhanced loading state management
        const setLoading = (elementId, isLoading, originalText = '') => {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (isLoading) {
                element.classList.add('loading');
                element.disabled = true;
                element.setAttribute('data-original-text', element.textContent);
                element.textContent = 'ğŸ”„ Loading...';
            } else {
                element.classList.remove('loading');
                element.disabled = false;
                const original = element.getAttribute('data-original-text') || originalText;
                if (original) element.textContent = original;
            }
        };

        // Enhanced error handling
        const showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            notification.className = `${type} notification`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        };

        // Enhanced schedule validation
        const validateScheduleCoverage = (schedule, hoursOfOperation) => {
            const coverageGaps = [];
            const warnings = [];
            
            for (const [day, hours] of Object.entries(hoursOfOperation)) {
                for (const hour of hours) {
                    const opStart = timeToHour(hour.start);
                    const opEnd = timeToHour(hour.end);
                    
                    // Check if this time period is covered by any shift
                    const dayShifts = schedule[day] || [];
                    const coveredPeriods = [];
                    
                    dayShifts.forEach(shift => {
                        if (!shift.assigned.includes('Unfilled')) {
                            const shiftStart = timeToHour(shift.start);
                            const shiftEnd = timeToHour(shift.end);
                            coveredPeriods.push([shiftStart, shiftEnd]);
                        }
                    });
                    
                    // Sort covered periods
                    coveredPeriods.sort((a, b) => a[0] - b[0]);
                    
                    // Find gaps
                    let currentTime = opStart;
                    for (const [start, end] of coveredPeriods) {
                        if (start > currentTime) {
                            // There's a gap
                            coverageGaps.push({
                                day,
                                start: hourToTime(currentTime),
                                end: hourToTime(start),
                                duration: start - currentTime
                            });
                        }
                        currentTime = Math.max(currentTime, end);
                    }
                    
                    // Check if there's a gap at the end
                    if (currentTime < opEnd) {
                        coverageGaps.push({
                            day,
                            start: hourToTime(currentTime),
                            end: hourToTime(opEnd),
                            duration: opEnd - currentTime
                        });
                    }
                }
            }
            
            return { coverageGaps, warnings };
        };

        // Utility functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        const calculateAvailabilityHours = (worker) => {
            let totalHours = 0;
            for (const daySlots of Object.values(worker.availability || {})) {
                for (const slot of daySlots) {
                    totalHours += slot.end_hour - slot.start_hour;
                }
            }
            return totalHours;
        };

        const findOptimalShiftSplit = (windows, remainingHours, preferSplit = true) => {
            if (!windows || remainingHours <= 0) {
                return [];
            }
            
            const totalAvailable = windows.reduce((sum, [day, start, end]) => sum + (end - start), 0);
            if (totalAvailable < remainingHours) {
                return windows.map(([day, start, end]) => [day, start, end, end - start]);
            }
            
            if (preferSplit && remainingHours === 5.0) {
                for (let i = 0; i < windows.length; i++) {
                    const [day1, s1, e1] = windows[i];
                    if (2.8 <= (e1 - s1) && (e1 - s1) <= 3.2) {
                        for (let j = 0; j < windows.length; j++) {
                            if (i !== j) {
                                const [day2, s2, e2] = windows[j];
                                if (1.8 <= (e2 - s2) && (e2 - s2) <= 2.2) {
                                    return [
                                        [day1, s1, s1 + 3.0, 3.0],
                                        [day2, s2, s2 + 2.0, 2.0]
                                    ];
                                }
                            }
                        }
                    }
                }
            }
            
            const result = [];
            let remaining = remainingHours;
            const sortedWindows = [...windows].sort((a, b) => (a[2] - a[1]) - (b[2] - b[1]));
            
            for (const [day, start, end] of sortedWindows) {
                if (remaining <= 0) break;
                
                const windowDuration = end - start;
                const take = Math.min(windowDuration, remaining);
                result.push([day, start, start + take, take]);
                remaining -= take;
            }
            
            return result;
        };

        const checkWorkStudyAvailability = (wsWorkers, hoursOfOperation) => {
            const issues = [];
            
            for (const worker of wsWorkers) {
                let matchingHours = 0;
                
                for (const [day, ops] of Object.entries(hoursOfOperation)) {
                    for (const op of ops) {
                        let opStart = timeToHour(op.start);
                        let opEnd = timeToHour(op.end);
                        if (opEnd <= opStart) opEnd += 24;
                        
                        for (const a of worker.availability[day] || []) {
                            const overlapStart = Math.max(opStart, a.start_hour);
                            const overlapEnd = Math.min(opEnd, a.end_hour);
                            if (overlapEnd > overlapStart) {
                                matchingHours += (overlapEnd - overlapStart);
                            }
                        }
                    }
                }
                
                if (matchingHours < 5) {
                    issues.push([
                        worker,
                        `Only ${matchingHours.toFixed(1)} hours available during operating hours (needs 5)`
                    ]);
                }
            }
            
            return issues;
        };

        // Logout function
        window.logout = function() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        };

        // Enhanced scheduling algorithm with guaranteed coverage and work study protection
        const createShiftsFromAvailability = (hoursOfOperation, workersData, maxHoursPerWorker = 20, maxWorkersPerShift = 2, minHoursPerWorker = 3, ensureFullCoverage = true) => {
            console.log('Starting enhanced schedule generation with full coverage:', { hoursOfOperation, workersData, maxHoursPerWorker, maxWorkersPerShift, minHoursPerWorker, ensureFullCoverage });
            
            if (!hoursOfOperation || !workersData || workersData.length === 0) {
                console.warn('Missing data for schedule generation');
                return { schedule: {}, assignedHours: {}, lowHours: [], unassigned: [], altSols: {}, unfilledShifts: [], wsIssues: [], minHoursIssues: [], coverageGaps: [] };
            }

            // CRITICAL FIX: Initialize empty schedule and tracking
            const schedule = {};
            const unfilledShifts = [];
            const shiftLengths = [2, 3, 4, 5];
            const shuffledLengths = shuffleArray(shiftLengths);
            const assignedHours = {};
            const wsStatus = {};
            const availabilityHours = {};
            const forcedAssignments = [];
            
            // CRITICAL FIX: Initialize all workers with 0 hours
            workersData.forEach(w => {
                assignedHours[w.email] = 0;
                wsStatus[w.email] = w.work_study || false;
                availabilityHours[w.email] = calculateAvailabilityHours(w);
            });
            
            // CRITICAL FIX: Track which workers are already assigned to prevent double assignment
            const assignedWorkers = new Set();

            const wsWorkers = workersData.filter(w => wsStatus[w.email]);
            wsWorkers.sort((a, b) => availabilityHours[a.email] - availabilityHours[b.email]);

            const wsAvailabilityIssues = checkWorkStudyAvailability(wsWorkers, hoursOfOperation);
            const initialWsIssues = wsAvailabilityIssues.map(([w, issue]) => 
                `${w.first_name} ${w.last_name}: ${issue}`
            );

            // REMOVED: The early return logic that bypassed work study priority
            // Work study students MUST be prioritized regardless of other conditions

            // Phase 1: Work Study Allocation (exactly 5 hours each) - ENHANCED
            for (const w of wsWorkers) {
                const email = w.email;
                let remaining = 5.0;

                // Find all available windows for this work study student
                const windows = [];
                for (const [day, ops] of Object.entries(hoursOfOperation)) {
                    for (const op of ops) {
                        let opStart = timeToHour(op.start);
                        let opEnd = timeToHour(op.end);
                        if (opEnd <= opStart) opEnd += 24;

                        for (const a of w.availability[day] || []) {
                            const s = Math.max(opStart, a.start_hour);
                            const e = Math.min(opEnd, a.end_hour);
                            if (e > s) {
                                windows.push([day, s, e]);
                            }
                        }
                    }
                }

                // Enhanced algorithm to find exactly 5 hours
                const findWorkStudyShifts = (windows) => {
                    const shifts = [];
                    let totalAssigned = 0;
                    
                    // Sort windows by duration (longest first) to prefer longer shifts
                    const sortedWindows = [...windows].sort((a, b) => (b[1] - b[0]) - (a[1] - a[0]));
                    
                    // Try to find a single 5-hour window first
                    for (const [day, s, e] of sortedWindows) {
                        if (e - s >= 5 && totalAssigned === 0) {
                            return [[day, s, s + 5, 5]];
                        }
                    }
                    
                    // Try combinations to get exactly 5 hours
                    const combinations = [
                        [3, 2], [2, 3], [2.5, 2.5], [4, 1], [1, 4],
                        [2, 2, 1], [1, 2, 2], [2, 1, 2],
                        [1.5, 1.5, 2], [2, 1.5, 1.5], [1.5, 2, 1.5]
                    ];
                    
                    for (const combo of combinations) {
                        const tempShifts = [];
                        let tempTotal = 0;
                        const usedWindows = new Set();
                        
                        for (const targetHours of combo) {
                            let found = false;
                            for (let i = 0; i < sortedWindows.length; i++) {
                                if (usedWindows.has(i)) continue;
                                const [day, s, e] = sortedWindows[i];
                                const availableHours = e - s;
                                
                                if (availableHours >= targetHours) {
                                    tempShifts.push([day, s, s + targetHours, targetHours]);
                                    tempTotal += targetHours;
                                    usedWindows.add(i);
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) break;
                        }
                        
                        if (Math.abs(tempTotal - 5) < 0.1) {
                            return tempShifts;
                        }
                    }
                    
                    // If we can't get exactly 5, get as close as possible
                    let bestShifts = [];
                    let bestTotal = 0;
                    
                    for (const [day, s, e] of sortedWindows) {
                        const availableHours = e - s;
                        if (totalAssigned + availableHours <= 5) {
                            bestShifts.push([day, s, e, availableHours]);
                            totalAssigned += availableHours;
                        } else if (totalAssigned < 5) {
                            const remaining = 5 - totalAssigned;
                            if (availableHours >= remaining) {
                                bestShifts.push([day, s, s + remaining, remaining]);
                                totalAssigned = 5;
                            }
                        }
                        if (totalAssigned >= 5) break;
                    }
                    
                    return bestShifts;
                };

                const optimalShifts = findWorkStudyShifts(windows);

                // CRITICAL FIX: Assign the shifts found with proper tracking
                let assignedAny = false;
                for (const [day, start, end, duration] of optimalShifts) {
                    // CRITICAL FIX: Check if worker is already assigned to this time slot
                    const slotStart = hourToTime(start);
                    const slotEnd = hourToTime(end);
                    
                    // Check if this worker is already assigned to this exact time slot
                    const existingShifts = (schedule[day] || []).filter(s => 
                        s.start === slotStart && s.end === slotEnd && s.raw_assigned.includes(email)
                    );
                    
                    if (existingShifts.length > 0) {
                        console.warn(`âš ï¸ Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping duplicate assignment`);
                        continue;
                    }
                    
                    // Check if this slot is already full with other workers
                    const slotOccupancy = (schedule[day] || []).filter(s => 
                        s.start === slotStart && s.end === slotEnd
                    ).length;
                    
                    if (slotOccupancy < maxWorkersPerShift) {
                        if (!schedule[day]) schedule[day] = [];
                        
                        schedule[day].push({
                            start: slotStart,
                            end: slotEnd,
                            assigned: [`${w.first_name} ${w.last_name}`],
                            available: [`${w.first_name} ${w.last_name}`],
                            raw_assigned: [email],
                            all_available: [w],
                            is_work_study: true,
                            forced_shift: true // Mark as forced to ensure it's not overridden
                        });
                        
                        // CRITICAL FIX: Only add hours if not already assigned
                        if (!assignedWorkers.has(`${email}_${day}_${slotStart}_${slotEnd}`)) {
                            assignedHours[email] += duration;
                            assignedWorkers.add(`${email}_${day}_${slotStart}_${slotEnd}`);
                            console.log(`âœ… Work study assignment: ${w.first_name} ${w.last_name} assigned ${duration}h at ${slotStart}-${slotEnd} on ${day}`);
                        }
                        remaining -= duration;
                        assignedAny = true;
                    } else {
                        // If slot is full, try to find an alternative slot
                        console.warn(`Work study student ${w.first_name} ${w.last_name} could not be assigned to ${slotStart}-${slotEnd} (slot full), looking for alternatives...`);
                    }
                }
                
                // If we couldn't assign any shifts from optimal solution, try fallback assignment
                if (!assignedAny && remaining > 0.1) {
                    console.warn(`Work study student ${w.first_name} ${w.last_name} needs fallback assignment for ${remaining.toFixed(1)} hours`);
                    
                    // Find any available slots that can accommodate the remaining hours
                    for (const [day, ops] of Object.entries(hoursOfOperation)) {
                        if (remaining <= 0.1) break;
                        
                        for (const op of ops) {
                            if (remaining <= 0.1) break;
                            
                            let opStart = timeToHour(op.start);
                            let opEnd = timeToHour(op.end);
                            if (opEnd <= opStart) opEnd += 24;

                            for (const a of w.availability[day] || []) {
                                if (remaining <= 0.1) break;
                                
                                const s = Math.max(opStart, a.start_hour);
                                const e = Math.min(opEnd, a.end_hour);
                                if (e > s) {
                                    const availableDuration = e - s;
                                    const assignDuration = Math.min(availableDuration, remaining);
                                    
                                    // Check if this slot is available
                                    const slotStart = hourToTime(s);
                                    const slotEnd = hourToTime(s + assignDuration);
                                    const existingShifts = (schedule[day] || []).filter(shift => 
                                        shift.start === slotStart && shift.end === slotEnd
                                    );
                                    
                                    // CRITICAL FIX: Check for duplicate assignment
                                    if (assignedWorkers.has(`${email}_${day}_${slotStart}_${slotEnd}`)) {
                                        console.warn(`âš ï¸ Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping fallback assignment`);
                                        continue;
                                    }
                                    
                                    if (existingShifts.length < maxWorkersPerShift) {
                                        if (!schedule[day]) schedule[day] = [];
                                        
                                        schedule[day].push({
                                            start: slotStart,
                                            end: slotEnd,
                                            assigned: [`${w.first_name} ${w.last_name}`],
                                            available: [`${w.first_name} ${w.last_name}`],
                                            raw_assigned: [email],
                                            all_available: [w],
                                            is_work_study: true,
                                            forced_shift: true,
                                            fallback_assignment: true
                                        });
                                        
                                        // CRITICAL FIX: Only add hours if not already assigned
                                        if (!assignedWorkers.has(`${email}_${day}_${slotStart}_${slotEnd}`)) {
                                            assignedHours[email] += assignDuration;
                                            assignedWorkers.add(`${email}_${day}_${slotStart}_${slotEnd}`);
                                            console.log(`Fallback assignment: ${w.first_name} ${w.last_name} assigned ${assignDuration.toFixed(1)}h at ${slotStart}-${slotEnd}`);
                                        }
                                        remaining -= assignDuration;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Log if we couldn't assign exactly 5 hours
                if (Math.abs(remaining) > 0.1) {
                    console.error(`ğŸš¨ CRITICAL: Work study student ${w.first_name} ${w.last_name} assigned ${(5 - remaining).toFixed(1)} hours instead of 5 - INSUFFICIENT AVAILABILITY`);
                    
                    // LAST RESORT: Force assignment even if it means going over limits
                    console.warn(`ğŸ”„ LAST RESORT: Attempting forced assignment for ${w.first_name} ${w.last_name}`);
                    
                    for (const [day, ops] of Object.entries(hoursOfOperation)) {
                        if (remaining <= 0.1) break;
                        
                        for (const op of ops) {
                            if (remaining <= 0.1) break;
                            
                            let opStart = timeToHour(op.start);
                            let opEnd = timeToHour(op.end);
                            if (opEnd <= opStart) opEnd += 24;

                            for (const a of w.availability[day] || []) {
                                if (remaining <= 0.1) break;
                                
                                const s = Math.max(opStart, a.start_hour);
                                const e = Math.min(opEnd, a.end_hour);
                                if (e > s) {
                                    const availableDuration = e - s;
                                    const assignDuration = Math.min(availableDuration, remaining);
                                    
                                    // CRITICAL FIX: Force assignment with duplicate checking
                                    const slotStart = hourToTime(s);
                                    const slotEnd = hourToTime(s + assignDuration);
                                    
                                    // CRITICAL FIX: Check for duplicate assignment even in last resort
                                    if (assignedWorkers.has(`${email}_${day}_${slotStart}_${slotEnd}`)) {
                                        console.warn(`âš ï¸ Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping last resort assignment`);
                                        continue;
                                    }
                                    
                                    if (!schedule[day]) schedule[day] = [];
                                    
                                    schedule[day].push({
                                        start: slotStart,
                                        end: slotEnd,
                                        assigned: [`${w.first_name} ${w.last_name}`],
                                        available: [`${w.first_name} ${w.last_name}`],
                                        raw_assigned: [email],
                                        all_available: [w],
                                        is_work_study: true,
                                        forced_shift: true,
                                        last_resort_assignment: true
                                    });
                                    
                                    // CRITICAL FIX: Only add hours if not already assigned
                                    if (!assignedWorkers.has(`${email}_${day}_${slotStart}_${slotEnd}`)) {
                                        assignedHours[email] += assignDuration;
                                        assignedWorkers.add(`${email}_${day}_${slotStart}_${slotEnd}`);
                                        console.log(`LAST RESORT assignment: ${w.first_name} ${w.last_name} forced assigned ${assignDuration.toFixed(1)}h at ${slotStart}-${slotEnd}`);
                                    }
                                    remaining -= assignDuration;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (Math.abs(remaining) > 0.1) {
                        console.error(`ğŸš¨ FAILED: Work study student ${w.first_name} ${w.last_name} still has ${remaining.toFixed(1)} unassigned hours after last resort attempt`);
                    } else {
                        console.log(`âœ… SUCCESS: Work study student ${w.first_name} ${w.last_name} got exactly 5 hours after last resort assignment`);
                    }
                } else {
                    console.log(`âœ… Work study student ${w.first_name} ${w.last_name} successfully assigned exactly 5 hours`);
                }
            }

            // Phase 2: Enhanced Coverage Algorithm - Fill ALL operating hours
            const orderedDays = [...DAYS].sort();
            
            for (const day of orderedDays) {
                const ops = hoursOfOperation[day] || [];
                if (ops.length === 0) continue;
                
                if (!schedule[day]) schedule[day] = [];

                for (const op of ops) {
                    let opStart = timeToHour(op.start);
                    let opEnd = timeToHour(op.end);
                    if (opEnd <= opStart) opEnd += 24;

                    console.log(`Processing ${day}: ${op.start}-${op.end} (${opStart}-${opEnd} hours)`);
                    
                    // CRITICAL: Validate operating hours
                    if (opStart < 0 || opStart > 24 || opEnd < 0 || opEnd > 48) {
                        console.error(`âŒ Invalid operating hours for ${day}: ${opStart}-${opEnd}`);
                        continue;
                    }

                    // Create continuous coverage for entire operating period
                    if (ensureFullCoverage) {
                        // Calculate existing coverage
                        const existingShifts = schedule[day].map(s => ({
                            start: timeToHour(s.start),
                            end: timeToHour(s.end)
                        })).sort((a, b) => a.start - b.start);

                        // Merge overlapping shifts
                        const mergedShifts = [];
                        for (const shift of existingShifts) {
                            if (mergedShifts.length === 0 || mergedShifts[mergedShifts.length - 1].end < shift.start) {
                                mergedShifts.push(shift);
                            } else {
                                mergedShifts[mergedShifts.length - 1].end = Math.max(mergedShifts[mergedShifts.length - 1].end, shift.end);
                            }
                        }

                        // Find gaps that need to be filled
                        const gaps = [];
                        let currentTime = opStart;
                        
                        for (const shift of mergedShifts) {
                            if (shift.start > currentTime) {
                                gaps.push([currentTime, shift.start]);
                            }
                            currentTime = Math.max(currentTime, shift.end);
                        }
                        
                        if (currentTime < opEnd) {
                            gaps.push([currentTime, opEnd]);
                        }

                        // CRITICAL FIX: Filter out gaps where no workers are available at all
                        const validGaps = [];
                        for (const [gapStart, gapEnd] of gaps) {
                            // Check if any workers are available during this gap
                            let hasAvailableWorkers = false;
                            for (const worker of workersData) {
                                if (isWorkerAvailable(worker, day, gapStart, gapEnd)) {
                                    hasAvailableWorkers = true;
                                    break;
                                }
                            }
                            
                            if (hasAvailableWorkers) {
                                validGaps.push([gapStart, gapEnd]);
                                console.log(`âœ… Valid gap: ${hourToTime(gapStart)}-${hourToTime(gapEnd)} - workers available`);
                            } else {
                                console.log(`âŒ Invalid gap: ${hourToTime(gapStart)}-${hourToTime(gapEnd)} - no workers available, skipping`);
                            }
                        }

                        // Fill each gap
                        for (const [gapStart, gapEnd] of validGaps) {
                            console.log(`Filling gap: ${hourToTime(gapStart)}-${hourToTime(gapEnd)} (${gapStart}-${gapEnd} hours)`);
                            let cur = gapStart;
                            while (cur < gapEnd) {
                                const remainingTime = gapEnd - cur;
                                if (remainingTime < 2) {
                                    // Leave as a coverage gap, do not create a shift
                                    break;
                                }
                                const shiftLength = Math.min(Math.max(2, remainingTime), 4); // 2-4 hour shifts
                                const endShift = Math.min(cur + shiftLength, gapEnd);
                                const shiftDuration = endShift - cur;

                                // CRITICAL: Ensure shift stays within operating hours
                                let finalEndShift = endShift;
                                let finalDuration = shiftDuration;
                                
                                if (endShift > opEnd) {
                                    console.log(`âš ï¸ Shift would exceed operating hours (${hourToTime(endShift)} > ${hourToTime(opEnd)}), adjusting...`);
                                    finalEndShift = opEnd;
                                    finalDuration = finalEndShift - cur;
                                    
                                    if (finalDuration < 2) {
                                        console.log(`âš ï¸ Adjusted shift too short (${finalDuration.toFixed(1)}h), skipping`);
                                        break;
                                    }
                                }

                                // Find available workers for this gap
                                const availableWorkers = [];
                                
                                for (const x of workersData) {
                                    const xEmail = x.email;
                                    
                                    // Skip work study students who already have 5 hours
                                    if (wsStatus[xEmail] && assignedHours[xEmail] >= 5) continue;
                                    
                                    // CRITICAL: Never skip work study students with 0 hours - they MUST be assigned first
                                    if (wsStatus[xEmail] && assignedHours[xEmail] === 0) {
                                        console.warn(`ğŸš¨ CRITICAL: Work study student ${x.first_name} ${x.last_name} has 0 hours but is being considered for regular assignment - this should not happen!`);
                                        // Continue to include them in regular assignment as fallback
                                    }
                                    
                                    if (isWorkerAvailable(x, day, cur, finalEndShift) && 
                                        assignedHours[xEmail] + finalDuration <= maxHoursPerWorker) {
                                        availableWorkers.push(x);
                                    }
                                }

                                // CRITICAL FIX: Only create shifts if workers are actually available
                                if (availableWorkers.length === 0) {
                                    console.log(`âš ï¸ No workers available for ${hourToTime(cur)}-${hourToTime(endShift)}, skipping shift creation`);
                                    cur = endShift;
                                    continue;
                                }

                                // Sort by priority: work study students with 0 hours get absolute priority
                                availableWorkers.sort((a, b) => {
                                    const aIsWS = wsStatus[a.email];
                                    const bIsWS = wsStatus[b.email];
                                    const aHours = assignedHours[a.email] || 0;
                                    const bHours = assignedHours[b.email] || 0;
                                    
                                    // Work study students with 0 hours get absolute priority
                                    if (aIsWS && aHours === 0 && !bIsWS) return -1;
                                    if (bIsWS && bHours === 0 && !aIsWS) return 1;
                                    if (aIsWS && aHours === 0 && bIsWS && bHours === 0) {
                                        // Among work study students with 0 hours, sort by availability
                                        const ratioA = aHours / Math.max(availabilityHours[a.email], 1);
                                        const ratioB = bHours / Math.max(availabilityHours[b.email], 1);
                                        return ratioA - ratioB;
                                    }
                                    
                                    // Then work study students with less than 5 hours
                                    if (aIsWS && aHours < 5 && !bIsWS) return -1;
                                    if (bIsWS && bHours < 5 && !aIsWS) return 1;
                                    if (aIsWS && aHours < 5 && bIsWS && bHours < 5) {
                                        return aHours - bHours; // Fewer hours first
                                    }
                                    
                                    // Then regular workers with 0 hours
                                    if (!aIsWS && aHours === 0 && bIsWS) return -1;
                                    if (!bIsWS && bHours === 0 && aIsWS) return 1;
                                    if (!aIsWS && aHours === 0 && !bIsWS && bHours === 0) {
                                        const ratioA = aHours / Math.max(availabilityHours[a.email], 1);
                                        const ratioB = bHours / Math.max(availabilityHours[b.email], 1);
                                        return ratioA - ratioB;
                                    }
                                    
                                    // Finally, sort by fairness ratio
                                    const ratioA = assignedHours[a.email] / Math.max(availabilityHours[a.email], 1);
                                    const ratioB = assignedHours[b.email] / Math.max(availabilityHours[b.email], 1);
                                    return ratioA - ratioB;
                                });

                                const chosen = availableWorkers.slice(0, maxWorkersPerShift);

                                // CRITICAL FIX: Assign shifts with duplicate checking
                                for (const x of chosen) {
                                    const shiftStart = hourToTime(cur);
                                    const shiftEnd = hourToTime(finalEndShift);
                                    
                                    // CRITICAL FIX: Check for duplicate assignment
                                    if (assignedWorkers.has(`${x.email}_${day}_${shiftStart}_${shiftEnd}`)) {
                                        console.warn(`âš ï¸ Worker ${x.first_name} ${x.last_name} already assigned to ${shiftStart}-${shiftEnd}, skipping assignment`);
                                        continue;
                                    }
                                    
                                    // CRITICAL FIX: Only add hours if not already assigned
                                    if (!assignedWorkers.has(`${x.email}_${day}_${shiftStart}_${shiftEnd}`)) {
                                        assignedHours[x.email] += finalDuration;
                                        assignedWorkers.add(`${x.email}_${day}_${shiftStart}_${shiftEnd}`);
                                        console.log(`Creating shift: ${shiftStart}-${shiftEnd} for ${x.first_name} ${x.last_name}`);
                                    }
                                    
                                    schedule[day].push({
                                        start: shiftStart,
                                        end: shiftEnd,
                                        assigned: [`${x.first_name} ${x.last_name}`],
                                        available: availableWorkers.map(y => `${y.first_name} ${y.last_name}`),
                                        raw_assigned: [x.email],
                                        all_available: availableWorkers
                                    });
                                }

                                // Mark unfilled if we couldn't fill all positions
                                for (let i = 0; i < maxWorkersPerShift - chosen.length; i++) {
                                    unfilledShifts.push({
                                        day: day,
                                        start: hourToTime(cur),
                                        end: hourToTime(finalEndShift),
                                        start_hour: cur,
                                        end_hour: finalEndShift,
                                        isGap: true
                                    });
                                    
                                    schedule[day].push({
                                        start: hourToTime(cur),
                                        end: hourToTime(finalEndShift),
                                        assigned: ["âš ï¸ COVERAGE GAP"],
                                        available: availableWorkers.map(y => `${y.first_name} ${y.last_name}`),
                                        raw_assigned: [],
                                        all_available: availableWorkers,
                                        isGap: true
                                    });
                                }

                                cur = finalEndShift;
                            }
                        }
                    }
                }
            }

            // Validate coverage and generate reports
            const { coverageGaps } = validateScheduleCoverage(schedule, hoursOfOperation);

            // Build summaries
            const lowHours = workersData
                .filter(w => !wsStatus[w.email] && assignedHours[w.email] < 4)
                .map(w => `${w.first_name} ${w.last_name}`);
                
            const unassigned = workersData
                .filter(w => assignedHours[w.email] === 0)
                .map(w => `${w.first_name} ${w.last_name}`);

            // Enhanced work study validation and reporting
            const wsIssues = [
                ...initialWsIssues,
                ...workersData
                    .filter(w => wsStatus[w.email] && Math.abs(assignedHours[w.email] - 5) > 0.1)
                    .filter(w => !initialWsIssues.some(issue => 
                        issue.startsWith(`${w.first_name} ${w.last_name}:`)))
                    .map(w => {
                        const hours = assignedHours[w.email];
                        if (hours < 5) {
                            return `${w.first_name} ${w.last_name} (${hours.toFixed(1)}h) - INSUFFICIENT HOURS - Work study students MUST have exactly 5 hours`;
                        } else {
                            return `${w.first_name} ${w.last_name} (${hours.toFixed(1)}h) - OVER ASSIGNED - Work study students should have exactly 5 hours`;
                        }
                    })
            ];
            
            // Log work study assignment summary
            const wsSummary = workersData
                .filter(w => wsStatus[w.email])
                .map(w => `${w.first_name} ${w.last_name}: ${assignedHours[w.email].toFixed(1)}h`);
            
            console.log('Work Study Assignment Summary:', wsSummary);
            
            // Critical warning if any work study students don't have exactly 5 hours
            const wsWithIssues = workersData.filter(w => wsStatus[w.email] && Math.abs(assignedHours[w.email] - 5) > 0.1);
            if (wsWithIssues.length > 0) {
                console.error('ğŸš¨ CRITICAL: Work study students without exactly 5 hours:', 
                    wsWithIssues.map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`));
            }

            const minHoursIssues = workersData
                .filter(w => !wsStatus[w.email] && assignedHours[w.email] < minHoursPerWorker && assignedHours[w.email] > 0)
                .map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`);

            // Alternative solutions
            const altSols = {};
            for (const us of unfilledShifts) {
                const key = `${us.day} ${us.start}-${us.end}`;
                const sols = workersData.filter(w => {
                    return isWorkerAvailable(w, us.day, us.start_hour, us.end_hour) &&
                           assignedHours[w.email] + (us.end_hour - us.start_hour) <= maxHoursPerWorker * 1.2;
                });
                
                if (sols.length > 0) {
                    altSols[key] = sols.map(w => `${w.first_name} ${w.last_name}`);
                }
            }

            // After normal assignment and before validation/reporting:
            // Attempt to fill every unfilled shift with the closest available worker (least hours, prioritize zero hours)
            for (const us of unfilledShifts) {
                // Find eligible workers: have availability for this shift, not double-booked, not over max hours
                const eligible = workersData.filter(w => {
                    // Must have availability for this shift
                    if (!isWorkerAvailable(w, us.day, us.start_hour, us.end_hour)) return false;
                    
                    // Skip work study students who already have 5 hours (they should not be forced into additional shifts)
                    if (wsStatus[w.email] && assignedHours[w.email] >= 5) return false;
                    
                    // Not already assigned to an overlapping or adjacent shift
                    const assignedShifts = Object.values(schedule).flat().filter(s => (s.raw_assigned||[]).includes(w.email));
                    for (const s of assignedShifts) {
                        const sDay = s.day || Object.keys(schedule).find(d => schedule[d].includes(s));
                        if (sDay !== us.day) continue;
                        const sStart = timeToHour(s.start);
                        const sEnd = timeToHour(s.end);
                        // Overlap or adjacent
                        if (!(us.end_hour <= sStart || us.start_hour >= sEnd)) return false;
                        if (Math.abs(us.start_hour - sEnd) < 0.01 || Math.abs(us.end_hour - sStart) < 0.01) return false;
                    }
                    // Not over max hours
                    if ((assignedHours[w.email] || 0) + (us.end_hour - us.start_hour) > maxHoursPerWorker) return false;
                    return true;
                });
                
                // Enhanced prioritization: work study students with less than 5 hours get highest priority
                eligible.sort((a, b) => {
                    const aHours = assignedHours[a.email] || 0;
                    const bHours = assignedHours[b.email] || 0;
                    const aIsWS = wsStatus[a.email];
                    const bIsWS = wsStatus[b.email];
                    
                    // Work study students with less than 5 hours get highest priority
                    if (aIsWS && aHours < 5 && !bIsWS) return -1;
                    if (bIsWS && bHours < 5 && !aIsWS) return 1;
                    if (aIsWS && aHours < 5 && bIsWS && bHours < 5) {
                        // Among work study students, prioritize those with fewer hours
                        return aHours - bHours;
                    }
                    
                    // Then prioritize workers with zero hours
                    if (aHours === 0 && bHours > 0) return -1;
                    if (bHours === 0 && aHours > 0) return 1;
                    
                    // Finally, prioritize by least hours
                    return aHours - bHours;
                });
                
                if (eligible.length > 0) {
                    const chosen = eligible[0];
                    const shiftStart = hourToTime(us.start_hour);
                    const shiftEnd = hourToTime(us.end_hour);
                    
                    // CRITICAL FIX: Check for duplicate assignment
                    if (assignedWorkers.has(`${chosen.email}_${us.day}_${shiftStart}_${shiftEnd}`)) {
                        console.warn(`âš ï¸ Worker ${chosen.first_name} ${chosen.last_name} already assigned to ${shiftStart}-${shiftEnd}, skipping unfilled shift assignment`);
                        continue;
                    }
                    
                    // CRITICAL FIX: Only add hours if not already assigned
                    if (!assignedWorkers.has(`${chosen.email}_${us.day}_${shiftStart}_${shiftEnd}`)) {
                        assignedHours[chosen.email] = (assignedHours[chosen.email] || 0) + (us.end_hour - us.start_hour);
                        assignedWorkers.add(`${chosen.email}_${us.day}_${shiftStart}_${shiftEnd}`);
                    }
                    
                    if (!schedule[us.day]) schedule[us.day] = [];
                    schedule[us.day].push({
                        start: us.start,
                        end: us.end,
                        assigned: [`${chosen.first_name} ${chosen.last_name}`],
                        available: eligible.map(w => `${w.first_name} ${w.last_name}`),
                        raw_assigned: [chosen.email],
                        all_available: eligible,
                        forced: true
                    });
                    forcedAssignments.push({
                        day: us.day,
                        start: us.start,
                        end: us.end,
                        worker: `${chosen.first_name} ${chosen.last_name}`,
                        email: chosen.email
                    });
                }
            }

            // Final validation: Ensure work study students have exactly 5 hours
            const finalWsValidation = workersData
                .filter(w => wsStatus[w.email])
                .map(w => {
                    const hours = assignedHours[w.email];
                    if (Math.abs(hours - 5) > 0.1) {
                        console.error(`ğŸš¨ FINAL VALIDATION FAILED: ${w.first_name} ${w.last_name} has ${hours.toFixed(1)} hours instead of 5`);
                        return w;
                    }
                    return null;
                })
                .filter(Boolean);
            
            // EMERGENCY FIX: Force assign any work study students who still have 0 hours
            const unassignedWorkStudy = workersData.filter(w => wsStatus[w.email] && assignedHours[w.email] === 0);
            if (unassignedWorkStudy.length > 0) {
                console.error(`ğŸš¨ EMERGENCY: ${unassignedWorkStudy.length} work study students still have 0 hours! Force assigning...`);
                
                for (const w of unassignedWorkStudy) {
                    console.warn(`ğŸ”„ EMERGENCY: Force assigning ${w.first_name} ${w.last_name} to any available slot`);
                    
                    // Find ANY available slot and force assign
                    for (const [day, ops] of Object.entries(hoursOfOperation)) {
                        if (assignedHours[w.email] >= 5) break;
                        
                        for (const op of ops) {
                            if (assignedHours[w.email] >= 5) break;
                            
                            let opStart = timeToHour(op.start);
                            let opEnd = timeToHour(op.end);
                            if (opEnd <= opStart) opEnd += 24;

                            for (const a of w.availability[day] || []) {
                                if (assignedHours[w.email] >= 5) break;
                                
                                const s = Math.max(opStart, a.start_hour);
                                const e = Math.min(opEnd, a.end_hour);
                                if (e > s) {
                                    const availableDuration = e - s;
                                    const remainingNeeded = 5 - assignedHours[w.email];
                                    const assignDuration = Math.min(availableDuration, remainingNeeded);
                                    
                                    // Force create a shift regardless of existing coverage
                                    const slotStart = hourToTime(s);
                                    const slotEnd = hourToTime(s + assignDuration);
                                    
                                    if (!schedule[day]) schedule[day] = [];
                                    
                                    schedule[day].push({
                                        start: slotStart,
                                        end: slotEnd,
                                        assigned: [`${w.first_name} ${w.last_name}`],
                                        available: [`${w.first_name} ${w.last_name}`],
                                        raw_assigned: [w.email],
                                        all_available: [w],
                                        is_work_study: true,
                                        forced_shift: true,
                                        emergency_assignment: true
                                    });
                                    
                                    assignedHours[w.email] += assignDuration;
                                    console.log(`EMERGENCY assignment: ${w.first_name} ${w.last_name} force assigned ${assignDuration.toFixed(1)}h at ${slotStart}-${slotEnd}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (assignedHours[w.email] === 0) {
                        console.error(`ğŸš¨ FAILED: Could not assign ANY hours to work study student ${w.first_name} ${w.last_name} - NO AVAILABILITY MATCHES OPERATING HOURS`);
                    } else {
                        console.log(`âœ… SUCCESS: Emergency assignment gave ${w.first_name} ${w.last_name} ${assignedHours[w.email].toFixed(1)} hours`);
                    }
                }
            }
            
            if (finalWsValidation.length > 0) {
                console.error('ğŸš¨ CRITICAL: Work study validation failed. The following students do not have exactly 5 hours:', 
                    finalWsValidation.map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`));
            } else {
                console.log('âœ… Work study validation passed: All work study students have exactly 5 hours');
            }
            
            // CRITICAL FIX: Final validation to ensure no negative or excessive hours
            console.log('ğŸ” Performing final schedule validation...');
            const finalValidation = calculateAssignedHours(schedule);
            
            // Check for any critical issues
            const criticalIssues = [];
            Object.entries(finalValidation).forEach(([email, hours]) => {
                if (hours < 0) {
                    criticalIssues.push(`${email}: ${hours} hours (NEGATIVE!)`);
                } else if (hours > 25) {
                    criticalIssues.push(`${email}: ${hours} hours (EXCESSIVE!)`);
                }
            });
            
            if (criticalIssues.length > 0) {
                console.error('ğŸš¨ CRITICAL VALIDATION FAILED:', criticalIssues);
                console.error('ğŸš¨ SCHEDULE GENERATION FAILED - CRITICAL ISSUES DETECTED');
                
                // Return empty schedule to prevent saving corrupted data
                return {
                    schedule: {},
                    assignedHours: {},
                    lowHours: [],
                    unassigned: workersData.map(w => `${w.first_name} ${w.last_name}`),
                    altSols: {},
                    unfilledShifts: [],
                    wsIssues: ['CRITICAL: Schedule generation failed due to validation errors'],
                    minHoursIssues: [],
                    coverageGaps: [],
                    forcedAssignments: []
                };
            }
            
            console.log('âœ… Final validation passed - no critical issues detected');
            console.log('Enhanced schedule generation complete with coverage analysis');
            
            return {
                schedule,
                assignedHours: finalValidation, // Use the validated hours
                lowHours,
                unassigned,
                altSols,
                unfilledShifts,
                wsIssues,
                minHoursIssues,
                coverageGaps,
                forcedAssignments
            };
        };

        // Initialize workplaces with enhanced error handling
        async function initializeDefaultWorkplaces() {
            const workplaces = [
                { 
                    id: 'esports_lounge', 
                    name: 'ğŸ® eSports Lounge',
                    hours: {
                        Monday: [{ start: "09:00", end: "17:00" }],
                        Tuesday: [{ start: "09:00", end: "17:00" }],
                        Wednesday: [{ start: "09:00", end: "17:00" }],
                        Thursday: [{ start: "09:00", end: "17:00" }],
                        Friday: [{ start: "09:00", end: "17:00" }],
                        Saturday: [{ start: "10:00", end: "16:00" }],
                        Sunday: [{ start: "12:00", end: "18:00" }]
                    }
                },
                { 
                    id: 'esports_arena', 
                    name: 'ğŸŸï¸ eSports Arena',
                    hours: {
                        Monday: [{ start: "10:00", end: "20:00" }],
                        Tuesday: [{ start: "10:00", end: "20:00" }],
                        Wednesday: [{ start: "10:00", end: "20:00" }],
                        Thursday: [{ start: "10:00", end: "20:00" }],
                        Friday: [{ start: "10:00", end: "22:00" }],
                        Saturday: [{ start: "09:00", end: "22:00" }],
                        Sunday: [{ start: "11:00", end: "19:00" }]
                    }
                },
                { 
                    id: 'it_service_center', 
                    name: 'ğŸ’» IT Service Center',
                    hours: {
                        Monday: [{ start: "08:00", end: "16:00" }],
                        Tuesday: [{ start: "08:00", end: "16:00" }],
                        Wednesday: [{ start: "08:00", end: "16:00" }],
                        Thursday: [{ start: "08:00", end: "16:00" }],
                        Friday: [{ start: "08:00", end: "16:00" }],
                        Saturday: [{ start: "09:00", end: "15:00" }],
                        Sunday: [{ start: "10:00", end: "14:00" }]
                    }
                }
            ];

            for (const workplace of workplaces) {
                try {
                    const docRef = doc(db, 'workplaces', workplace.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        // Only create with default hours if workplace doesn't exist
                        await setDoc(docRef, {
                            name: workplace.name,
                            hours_of_operation: workplace.hours,
                            created_at: new Date().toISOString()
                        });
                        console.log(`Created workplace: ${workplace.id} with default hours`);
                    } else {
                        // Workplace exists - log the current hours for debugging
                        const currentData = docSnap.data();
                        console.log(`Workplace ${workplace.id} exists with hours:`, currentData.hours_of_operation);
                    }
                } catch (error) {
                    console.error(`Error checking ${workplace.id}:`, error);
                }
            }
        }

        initializeDefaultWorkplaces();

        // Enhanced workplace selection
        window.selectWorkplace = async function(id) {
            selectedWorkplace = id;
            
            document.querySelectorAll('.workplace-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.workplace-card').classList.add('selected');
            
            document.getElementById('scheduleContent').style.display = 'block';
            
            // Show loading state
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">ğŸ”„ Loading workplace data...</div>';
            
            try {
                await loadWorkplaceData();
                // await loadWorkplaceNotes(); // OLD NOTES FUNCTION REMOVED
                await loadAnnouncements(); // Load announcements
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">âœ… Ready! Select an option above to get started.</div>';
                hideAllForms();
                // document.getElementById('workplaceNotesSection').style.display = 'block'; // OLD NOTES SECTION REMOVED
                document.getElementById('announcementsSection').style.display = 'block'; // Show announcements section
            } catch (error) {
                console.error('Error loading workplace:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">âŒ Error loading workplace data. Please try again.</div>';
            }

            // At the end of selectWorkplace, after loading data and notes:
            if (!user.isAdmin) {
                await loadUserDashboard();
            }
        };

        // Enhanced data loading with better error handling
        async function loadWorkplaceData() {
            try {
                console.log(`Loading data for ${selectedWorkplace}`);
                
                setLoading('scheduleDisplay', true);
                
                // Load workers with timeout
                const workersPromise = getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                const workersSnapshot = await Promise.race([
                    workersPromise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                ]);
                
                workers = [];
                workersSnapshot.forEach(doc => {
                    try {
                        const data = doc.data();
                        const availability = parseAvailability(data['Days & Times Available'] || '');
                        
                        workers.push({
                            id: doc.id,
                            first_name: data['First Name'] || 'Unknown',
                            last_name: data['Last Name'] || 'Worker',
                            email: data['Email'] || 'no-email',
                            work_study: data['Work Study'] === 'Yes',
                            availability,
                            availability_text: data['Days & Times Available'] || ''
                        });
                    } catch (error) {
                        console.error('Error parsing worker data:', error);
                    }
                });

                // Load operating hours
                const workplaceDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace));
                if (workplaceDoc.exists()) {
                    hours = workplaceDoc.data().hours_of_operation || {};
                    console.log(`Loaded hours from database for ${selectedWorkplace}:`, hours);
                } else {
                    hours = {};
                    console.warn(`No workplace document found for ${selectedWorkplace}, using empty hours`);
                }

                console.log(`Loaded ${workers.length} workers and operating hours for ${selectedWorkplace}`);
                showNotification(`âœ… Loaded ${workers.length} workers for ${selectedWorkplace}`, 'success');
                
            } catch (error) {
                console.error('Error loading workplace data:', error);
                workers = [];
                hours = {};
                showNotification('âŒ Error loading workplace data', 'error');
                throw error;
            }
        }

        // OLD NOTES FUNCTION - REMOVED IN FAVOR OF ANNOUNCEMENTS
        // async function loadWorkplaceNotes() {
        //     const notesDiv = document.getElementById('workplaceNotesContent');
        //     if (!selectedWorkplace) {
        //         notesDiv.innerHTML = '<div class="info">No workplace selected.</div>';
        //         return;
        //     }
        //     const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace));
        //     const notes = docSnap.exists() && docSnap.data().notes ? docSnap.data().notes : '';
        //     if (user.isAdmin) {
        //         notesDiv.innerHTML = `<textarea id='workplaceNotesTextarea' rows='4' style='width:100%;border-radius:8px;padding:1rem;'>${notes}</textarea><button class='btn btn-success' id='saveNotesBtn' style='margin-top:0.5rem;'>ğŸ’¾ Save Notes</button>`;
        //         document.getElementById('saveNotesBtn').onclick = async function() {
        //             const newNotes = document.getElementById('workplaceNotesTextarea').value;
        //             await updateDoc(doc(db, 'workplaces', selectedWorkplace), 'notes', newNotes);
        //             showNotification('âœ… Notes updated!', 'success');
        //         };
        //     } else {
        //         notesDiv.innerHTML = `<div style='background:#f8f9fa;padding:1rem;border-radius:8px;'>${notes ? notes.replace(/\n/g, '<br>') : '<span style="color:#888;">No notes for this workplace.</span>'}</div>`;
        //     }
        // }

        // --- ENHANCED ANNOUNCEMENTS SYSTEM ---
        // Load and display announcements
        async function loadAnnouncements() {
            const announcementsDiv = document.getElementById('announcementsContent');
            const addBtn = document.getElementById('addAnnouncementBtn');
            
            if (!selectedWorkplace) {
                announcementsDiv.innerHTML = '<div class="info">No workplace selected.</div>';
                return;
            }

            try {
                // Show/hide add button for admins
                if (user.isAdmin) {
                    addBtn.style.display = 'inline-block';
                } else {
                    addBtn.style.display = 'none';
                }

                // Load announcements from Firestore
                const announcementsSnapshot = await getDocs(
                    collection(db, 'workplaces', selectedWorkplace, 'announcements')
                );

                if (announcementsSnapshot.empty) {
                    announcementsDiv.innerHTML = '<div class="info">No announcements yet.</div>';
                    return;
                }

                // Convert to array and sort by creation date (newest first)
                const announcements = [];
                announcementsSnapshot.forEach(doc => {
                    announcements.push({ id: doc.id, ...doc.data() });
                });
                announcements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Build announcements display
                let html = '<div class="announcements-grid">';
                
                announcements.forEach(announcement => {
                    const createdDate = new Date(announcement.createdAt).toLocaleDateString();
                    const priorityClass = announcement.priority || 'medium';
                    const priorityBadge = announcement.priority || 'medium';
                    
                    html += `
                        <div class="announcement-card ${priorityClass}-priority">
                            <div class="announcement-header">
                                <h4 class="announcement-subject">${announcement.subject}</h4>
                                <div class="announcement-meta">
                                    <span class="priority-badge ${priorityBadge}">${priorityBadge}</span>
                                    <span>${createdDate}</span>
                                    ${user.isAdmin ? `<span>by ${announcement.createdBy}</span>` : ''}
                                </div>
                            </div>
                            <div class="announcement-message">${announcement.message.replace(/\n/g, '<br>')}</div>
                            ${user.isAdmin ? `
                                <div class="announcement-actions">
                                    <button class="btn btn-info" onclick="editAnnouncement('${announcement.id}')">âœï¸ Edit</button>
                                    <button class="btn btn-danger" onclick="deleteAnnouncement('${announcement.id}')">ğŸ—‘ï¸ Delete</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                announcementsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcementsDiv.innerHTML = '<div class="error">Failed to load announcements.</div>';
            }
        }

        // Add announcement button handler
        if (user.isAdmin) {
            document.getElementById('addAnnouncementBtn').onclick = function() {
                document.getElementById('announcementModalTitle').textContent = 'ğŸ“¢ Add Announcement';
                document.getElementById('announcementSubject').value = '';
                document.getElementById('announcementMessage').value = '';
                document.getElementById('announcementPriority').value = 'medium';
                document.getElementById('announcementModal').style.display = 'block';
            };
        }

        // Announcement form submission
        const announcementForm = document.getElementById('announcementForm');
        announcementForm.onsubmit = async function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('announcementSubject').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const priority = document.getElementById('announcementPriority').value;
            
            if (!selectedWorkplace) {
                showNotification('âŒ Please select a workplace first', 'error');
                return;
            }
            
            if (!subject || !message) {
                showNotification('âŒ Subject and message are required', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'announcements'), {
                    subject,
                    message,
                    priority,
                    createdBy: user.email,
                    createdAt: new Date().toISOString(),
                    isActive: true
                });
                
                showNotification('âœ… Announcement created successfully!', 'success');
                closeModal('announcementModal');
                loadAnnouncements(); // Reload the announcements
                
            } catch (error) {
                console.error('Error creating announcement:', error);
                showNotification('âŒ Failed to create announcement', 'error');
            }
        };

        // Edit announcement
        window.editAnnouncement = async function(announcementId) {
            try {
                const announcementDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'announcements', announcementId));
                if (!announcementDoc.exists()) {
                    showNotification('âŒ Announcement not found', 'error');
                    return;
                }
                
                const announcement = announcementDoc.data();
                
                document.getElementById('announcementModalTitle').textContent = 'ğŸ“¢ Edit Announcement';
                document.getElementById('announcementSubject').value = announcement.subject;
                document.getElementById('announcementMessage').value = announcement.message;
                document.getElementById('announcementPriority').value = announcement.priority || 'medium';
                
                // Store the announcement ID for updating
                document.getElementById('announcementModal').setAttribute('data-edit-id', announcementId);
                document.getElementById('announcementModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading announcement for edit:', error);
                showNotification('âŒ Failed to load announcement', 'error');
            }
        };

        // Delete announcement
        window.deleteAnnouncement = async function(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement? This cannot be undone.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'announcements', announcementId));
                showNotification('âœ… Announcement deleted successfully!', 'success');
                loadAnnouncements(); // Reload the announcements
                
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showNotification('âŒ Failed to delete announcement', 'error');
            }
        };

        // Enhanced admin functions with permission checks
        window.showManageHours = async function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }

            if (!selectedWorkplace) {
                showNotification('âš ï¸ Please select a workplace first', 'warning');
                return;
            }

            await loadWorkplaceData();
            
            let html = `
                <div class="simplified-hours-container">
                    <div class="hours-instructions">
                        <p><strong>ğŸ“‹ Instructions:</strong></p>
                        <ul>
                            <li>âœ… Check the days you want to set hours for</li>
                            <li>â° Use the time inputs to set start and end times</li>
                            <li>â• Click "Add Time Block" to add multiple time periods per day</li>
                            <li>ğŸ—‘ï¸ Use the trash icon to remove time blocks</li>
                        </ul>
                    </div>
                    
                    <div class="days-checkboxes">
                        <h4>ğŸ“… Select Days</h4>
                        <div class="checkbox-grid">
            `;
            
            DAYS.forEach(day => {
                const dayHours = hours[day] || [];
                const isChecked = dayHours.length > 0 ? 'checked' : '';
                html += `
                    <div class="day-checkbox">
                        <input type="checkbox" id="day_${day}" ${isChecked} onchange="toggleDayHours('${day}')">
                        <label for="day_${day}">${day}</label>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="time-blocks-container">
                        <h4>â° Time Blocks</h4>
                        <div id="timeBlocksContainer">
            `;
            
            DAYS.forEach(day => {
                const dayHours = hours[day] || [];
                html += `<div id="timeBlocks_${day}" class="day-time-blocks" style="display: ${dayHours.length > 0 ? 'block' : 'none'};">`;
                html += `<h5>${day}</h5>`;
                
                if (dayHours.length === 0) {
                    html += `
                        <div class="time-block" data-day="${day}" data-index="0">
                            <div class="time-inputs">
                                <div class="time-input">
                                    <label>Start:</label>
                                    <input type="time" class="start-time" value="09:00">
                                    <small style="color: #666; font-size: 0.8rem;">9:00 AM</small>
                                </div>
                                <div class="time-input">
                                    <label>End:</label>
                                    <input type="time" class="end-time" value="17:00">
                                    <small style="color: #666; font-size: 0.8rem;">5:00 PM</small>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="removeTimeBlock('${day}', 0)" style="display: none;">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                } else {
                    dayHours.forEach((hourBlock, index) => {
                        html += `
                            <div class="time-block" data-day="${day}" data-index="${index}">
                                <div class="time-inputs">
                                    <div class="time-input">
                                        <label>Start:</label>
                                        <input type="time" class="start-time" value="${hourBlock.start}">
                                        <small style="color: #666; font-size: 0.8rem;">${formatTime(hourBlock.start)}</small>
                                    </div>
                                    <div class="time-input">
                                        <label>End:</label>
                                        <input type="time" class="end-time" value="${hourBlock.end}">
                                        <small style="color: #666; font-size: 0.8rem;">${formatTime(hourBlock.end)}</small>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="removeTimeBlock('${day}', ${index})">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                    <button class="btn btn-info btn-sm" onclick="addTimeBlock('${day}')">â• Add Time Block</button>
                </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="hours-actions">
                        <button class="btn btn-success" onclick="saveHours()" id="saveHoursBtn">ğŸ’¾ Save Hours</button>
                        <button class="btn btn-secondary" onclick="closeModal('hoursModal')">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('hoursModalContent').innerHTML = html;
            document.getElementById('hoursModal').style.display = 'block';
            
            // Add real-time AM/PM display updates
            addTimeDisplayListeners();
        };

        // Add real-time AM/PM display updates
        function addTimeDisplayListeners() {
            const timeInputs = document.querySelectorAll('.time-input input[type="time"]');
            timeInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const timeBlock = this.closest('.time-block');
                    const timeInput = this.closest('.time-input');
                    const smallElement = timeInput.querySelector('small');
                    if (smallElement) {
                        smallElement.textContent = formatTime(this.value);
                    }
                });
            });
        }

        // New simplified hours management functions
        window.toggleDayHours = function(day) {
            const checkbox = document.getElementById(`day_${day}`);
            const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
            
            if (checkbox.checked) {
                timeBlocksDiv.style.display = 'block';
            } else {
                timeBlocksDiv.style.display = 'none';
            }
        };

        window.addTimeBlock = function(day) {
            const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
            const existingBlocks = timeBlocksDiv.querySelectorAll('.time-block');
            const newIndex = existingBlocks.length;
            
            const newBlock = document.createElement('div');
            newBlock.className = 'time-block';
            newBlock.setAttribute('data-day', day);
            newBlock.setAttribute('data-index', newIndex);
            
            newBlock.innerHTML = `
                <div class="time-inputs">
                    <div class="time-input">
                        <label>Start:</label>
                        <input type="time" class="start-time" value="09:00">
                        <small style="color: #666; font-size: 0.8rem;">9:00 AM</small>
                    </div>
                    <div class="time-input">
                        <label>End:</label>
                        <input type="time" class="end-time" value="17:00">
                        <small style="color: #666; font-size: 0.8rem;">5:00 PM</small>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeTimeBlock('${day}', ${newIndex})">ğŸ—‘ï¸</button>
                </div>
            `;
            
            // Insert before the "Add Time Block" button
            const addButton = timeBlocksDiv.querySelector('button[onclick*="addTimeBlock"]');
            timeBlocksDiv.insertBefore(newBlock, addButton);
            
            // Add listeners to the new block
            const newInputs = newBlock.querySelectorAll('input[type="time"]');
            newInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const timeInput = this.closest('.time-input');
                    const smallElement = timeInput.querySelector('small');
                    if (smallElement) {
                        smallElement.textContent = formatTime(this.value);
                    }
                });
            });
        };

        window.removeTimeBlock = function(day, index) {
            const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
            const blocks = timeBlocksDiv.querySelectorAll('.time-block');
            
            if (blocks.length <= 1) {
                // Don't remove the last block, just hide the delete button
                const deleteBtn = timeBlocksDiv.querySelector(`[data-index="${index}"] .btn-danger`);
                if (deleteBtn) deleteBtn.style.display = 'none';
                return;
            }
            
            const blockToRemove = timeBlocksDiv.querySelector(`[data-index="${index}"]`);
            if (blockToRemove) {
                blockToRemove.remove();
            }
            
            // Reindex remaining blocks
            const remainingBlocks = timeBlocksDiv.querySelectorAll('.time-block');
            remainingBlocks.forEach((block, newIndex) => {
                block.setAttribute('data-index', newIndex);
                const deleteBtn = block.querySelector('.btn-danger');
                if (deleteBtn) {
                    deleteBtn.onclick = () => removeTimeBlock(day, newIndex);
                }
            });
        };

        window.saveHours = async function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }

            setLoading('saveHoursBtn', true);
            
            try {
                const newHours = {};
                let hasErrors = false;
                
                DAYS.forEach(day => {
                    const checkbox = document.getElementById(`day_${day}`);
                    if (!checkbox.checked) {
                        // Day not selected, skip
                        return;
                    }
                    
                    const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
                    const timeBlocks = timeBlocksDiv.querySelectorAll('.time-block');
                    const dayHours = [];
                    
                    timeBlocks.forEach(block => {
                        const startInput = block.querySelector('.start-time');
                        const endInput = block.querySelector('.end-time');
                        
                        if (startInput && endInput && startInput.value && endInput.value) {
                            const start = startInput.value;
                            const end = endInput.value;
                            
                            // Handle overnight shifts properly
                            let startHour = timeToHour(start);
                            let endHour = timeToHour(end);
                            
                            // If end time is earlier than start time, it's an overnight shift
                            if (endHour <= startHour) {
                                // This is valid for overnight shifts (e.g., 2 PM to 12 AM)
                                // The system will handle this correctly in scheduling
                                console.log(`âœ… Valid overnight shift for ${day}: ${start} to ${end}`);
                            }
                            
                            dayHours.push({ start, end });
                        }
                    });
                    
                    if (dayHours.length > 0) {
                        newHours[day] = dayHours;
                    }
                });
                
                if (hasErrors) {
                    setLoading('saveHoursBtn', false);
                    return;
                }
                
                await updateDoc(doc(db, 'workplaces', selectedWorkplace), {
                    hours_of_operation: newHours,
                    updated_at: new Date().toISOString(),
                    updated_by: user.email
                });
                
                hours = newHours;
                console.log(`Updated hours for ${selectedWorkplace}:`, newHours);
                showNotification('âœ… Hours updated successfully!', 'success');
                closeModal('hoursModal');
                
            } catch (error) {
                console.error('Error saving hours:', error);
                showNotification('âŒ Error saving hours', 'error');
            } finally {
                setLoading('saveHoursBtn', false);
            }
        };

        // Enhanced Worker & User Management System
        window.showManageWorkers = async function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }

            if (!selectedWorkplace) {
                showNotification('âš ï¸ Please select a workplace first', 'warning');
                return;
            }

            document.getElementById('workersModalContent').innerHTML = '<div class="loading">Loading enhanced management interface...</div>';
            document.getElementById('workersModal').style.display = 'block';
            
            await loadWorkplaceData();
            await loadAllUsers(); // Load users from auth database
            displayEnhancedManagementInterface();
        };

        // Load all users from auth database
        async function loadAllUsers() {
            try {
                const usersSnapshot = await getDocs(collection(authDb, 'users'));
                const allUsers = [];
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    allUsers.push({
                        id: doc.id,
                        email: userData.email,
                        firstName: userData.firstName || '',
                        lastName: userData.lastName || '',
                        isAdmin: userData.isAdmin || false,
                        phone: userData.phone || '',
                        status: userData.status || 'active',
                        createdAt: userData.createdAt || new Date().toISOString(),
                        lastLogin: userData.lastLogin || null
                    });
                });
                window.allUsers = allUsers;
            } catch (error) {
                console.error('Error loading users:', error);
                window.allUsers = [];
            }
        }

        // Enhanced Management Action Functions - Must be defined before displayEnhancedManagementInterface
        window.viewWorkerDetails = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }
            
            const linkedUser = window.allUsers?.find(u => u.email.toLowerCase() === worker.email.toLowerCase());
            
            const html = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>ğŸ‘¥ Worker Details</h3>
                        <span class="close" onclick="closeModal('workerDetailsModal')">&times;</span>
                    </div>
                    <div>
                        <p><strong>Name:</strong> ${worker.first_name} ${worker.last_name}</p>
                        <p><strong>Email:</strong> ${worker.email}</p>
                        <p><strong>Work Study:</strong> ${worker.work_study ? 'Yes' : 'No'}</p>
                        <p><strong>Availability:</strong> ${worker.availability_text || 'Not set'}</p>
                        <p><strong>User Account:</strong> ${linkedUser ? `Linked (${linkedUser.isAdmin ? 'Admin' : 'User'})` : 'No user account'}</p>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('workerDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'workerDetailsModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = html;
            modal.style.display = 'block';
        };

        window.editWorker = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }
            
            // Populate the existing worker form
            document.getElementById('workerFormTitle').textContent = 'âœï¸ Edit Worker';
            document.getElementById('workerFirstName').value = worker.first_name;
            document.getElementById('workerLastName').value = worker.last_name;
            document.getElementById('workerEmail').value = worker.email;
            document.getElementById('workerWorkStudy').value = worker.work_study ? 'Yes' : 'No';
            document.getElementById('workerAvailability').value = worker.availability_text || '';
            
            // Store the worker ID for updating
            document.getElementById('workerForm').setAttribute('data-worker-id', workerId);
            
            // Show the modal
            document.getElementById('workerFormModal').style.display = 'block';
        };

        window.deleteWorker = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${worker.first_name} ${worker.last_name}? This action cannot be undone.`)) {
                deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId))
                    .then(() => {
                        showNotification('âœ… Worker deleted successfully', 'success');
                        loadWorkplaceData();
                        displayEnhancedManagementInterface();
                    })
                    .catch(error => {
                        console.error('Error deleting worker:', error);
                        showNotification('âŒ Error deleting worker', 'error');
                    });
            }
        };

        window.showAddWorker = function() {
            // Reset the form
            document.getElementById('workerFormTitle').textContent = 'â• Add Worker';
            document.getElementById('workerForm').reset();
            document.getElementById('workerForm').removeAttribute('data-worker-id');
            
            // Show the modal
            document.getElementById('workerFormModal').style.display = 'block';
        };

        window.exportWorkers = function() {
            if (workers.length === 0) {
                showNotification('âŒ No workers to export', 'error');
                return;
            }
            
            // Create CSV content
            let csvContent = 'First Name,Last Name,Email,Work Study,Days & Time Available\n';
            
            workers.forEach(worker => {
                const firstName = `"${worker.first_name}"`;
                const lastName = `"${worker.last_name}"`;
                const email = `"${worker.email}"`;
                const workStudy = `"${worker.work_study ? 'Yes' : 'No'}"`;
                const availability = `"${worker.availability_text || ''}"`;
                
                csvContent += `${firstName},${lastName},${email},${workStudy},${availability}\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${selectedWorkplace}_workers_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ğŸ“„ Workers exported to CSV file', 'success');
        };

        window.showAddUser = function() {
            showNotification('ğŸ‘¤ Add User functionality coming in Phase 2', 'info');
        };

        window.exportUsers = function() {
            if (!window.allUsers || window.allUsers.length === 0) {
                showNotification('âŒ No users to export', 'error');
                return;
            }
            
            // Create CSV content
            let csvContent = 'First Name,Last Name,Email,Role,Status,Phone,Last Login\n';
            
            window.allUsers.forEach(user => {
                const firstName = `"${user.firstName}"`;
                const lastName = `"${user.lastName}"`;
                const email = `"${user.email}"`;
                const role = `"${user.isAdmin ? 'Admin' : 'User'}"`;
                const status = `"${user.status}"`;
                const phone = `"${user.phone || ''}"`;
                const lastLogin = `"${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}"`;
                
                csvContent += `${firstName},${lastName},${email},${role},${status},${phone},${lastLogin}\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `users_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ğŸ“„ Users exported to CSV file', 'success');
        };

        window.viewUserDetails = function(userId) {
            const user = window.allUsers?.find(u => u.id === userId);
            if (!user) {
                showNotification('âŒ User not found', 'error');
                return;
            }
            
            const linkedWorker = workers.find(w => w.email.toLowerCase() === user.email.toLowerCase());
            
            const html = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>ğŸ‘¤ User Details</h3>
                        <span class="close" onclick="closeModal('userDetailsModal')">&times;</span>
                    </div>
                    <div>
                        <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Role:</strong> ${user.isAdmin ? 'Admin' : 'User'}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                        <p><strong>Last Login:</strong> ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</p>
                        <p><strong>Worker Account:</strong> ${linkedWorker ? `Linked (${linkedWorker.work_study ? 'Work Study' : 'Regular'})` : 'No worker account'}</p>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('userDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'userDetailsModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = html;
            modal.style.display = 'block';
        };

        function displayEnhancedManagementInterface() {
            const html = `
                <div class="management-tabs">
                    <button class="management-tab active" onclick="switchManagementTab('workers', event)">ğŸ‘¥ Workers (${workers.length})</button>
                    <button class="management-tab" onclick="switchManagementTab('users', event)">ğŸ‘¤ Users (${window.allUsers?.length || 0})</button>
                    <button class="management-tab super-admin-only" onclick="switchManagementTab('admins', event)">ğŸ›¡ï¸ Admins</button>
                    <button class="management-tab" onclick="switchManagementTab('import', event)">ğŸ“¥ Import/Export</button>
                    <button class="management-tab" onclick="switchManagementTab('analytics', event)">ğŸ“Š Analytics</button>
                </div>

                <!-- Workers Management Tab -->
                <div id="workers-tab" class="management-content active">
                    ${generateWorkersTab()}
                </div>

                <!-- Users Management Tab -->
                <div id="users-tab" class="management-content">
                    ${generateUsersTab()}
                </div>

                <!-- Admins Management Tab -->
                <div id="admins-tab" class="management-content">
                    ${generateAdminsTab()}
                </div>

                <!-- Import/Export Tab -->
                <div id="import-tab" class="management-content">
                    ${generateImportExportTab()}
                </div>

                <!-- Analytics Tab -->
                <div id="analytics-tab" class="management-content">
                    ${generateAnalyticsTab()}
                </div>
            `;
            
            document.getElementById('workersModalContent').innerHTML = html;
        }

        window.switchManagementTab = function(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.management-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.management-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        };

        function generateWorkersTab() {
            const workStudyCount = workers.filter(w => w.work_study).length;
            const regularWorkers = workers.filter(w => !w.work_study).length;
            const linkedUsers = workers.filter(w => {
                return window.allUsers?.some(u => u.email.toLowerCase() === w.email.toLowerCase());
            }).length;

            return `
                <div class="management-header">
                    <div>
                        <h3>ğŸ‘¥ Worker Management</h3>
                        <p>Manage workers for ${selectedWorkplace}</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="showAddWorker()">â• Add Worker</button>
                        <button class="btn btn-info" onclick="exportWorkers()">ğŸ“¤ Export</button>
                    </div>
                </div>

                <div class="management-stats">
                    <div class="stat-card">
                        <div class="stat-number">${workers.length}</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${workStudyCount}</div>
                        <div class="stat-label">Work Study</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${regularWorkers}</div>
                        <div class="stat-label">Regular Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${linkedUsers}</div>
                        <div class="stat-label">Linked Users</div>
                    </div>
                </div>

                <div class="search-filter-section">
                    <div class="search-box">
                        <input type="text" id="workerSearch" placeholder="Search workers by name or email..." onkeyup="filterWorkers()">
                    </div>
                    <select class="filter-dropdown" id="workStudyFilter" onchange="filterWorkers()">
                        <option value="">All Workers</option>
                        <option value="work-study">Work Study Only</option>
                        <option value="regular">Regular Workers Only</option>
                    </select>
                    <select class="filter-dropdown" id="userLinkFilter" onchange="filterWorkers()">
                        <option value="">All Workers</option>
                        <option value="linked">Linked to User Account</option>
                        <option value="unlinked">Not Linked to User Account</option>
                    </select>
                </div>

                <div class="bulk-actions" id="workerBulkActions" style="display: none;">
                    <div class="bulk-actions-header">
                        <div>
                            <input type="checkbox" id="selectAllWorkers" onchange="toggleSelectAllWorkers()">
                            <label for="selectAllWorkers">Select All</label>
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-warning" onclick="bulkEditWorkers()">âœï¸ Bulk Edit</button>
                            <button class="btn btn-danger" onclick="bulkDeleteWorkers()">ğŸ—‘ï¸ Bulk Delete</button>
                        </div>
                    </div>
                </div>

                <div id="workersTableContainer">
                    ${generateWorkersTable()}
                </div>
            `;
        }

        function generateWorkersTable() {
            if (workers.length === 0) {
                return '<div class="warning">No workers found. Add your first worker to get started!</div>';
            }

            let html = `
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllWorkersCheckbox" onchange="toggleSelectAllWorkers()"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>User Account</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            workers.forEach(worker => {
                const linkedUser = window.allUsers?.find(u => u.email.toLowerCase() === worker.email.toLowerCase());
                const userLinkStatus = linkedUser ? 
                    `<a href="#" class="user-worker-link" onclick="viewUserDetails('${linkedUser.id}')">âœ… Linked (${linkedUser.isAdmin ? 'Admin' : 'User'})</a>` :
                    `<span class="no-link">âŒ No User Account</span>`;

                html += `
                    <tr>
                        <td><input type="checkbox" class="worker-checkbox" value="${worker.id}" onchange="updateBulkActions()"></td>
                        <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '<span class="work-study-badge">Work Study</span>' : 'Regular'}</td>
                        <td>${userLinkStatus}</td>
                        <td><small>${worker.availability_text || 'No availability set'}</small></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-info" onclick="viewWorkerDetails('${worker.id}')">ğŸ‘ï¸ View</button>
                                <button class="btn btn-warning" onclick="editWorker('${worker.id}')">âœï¸ Edit</button>
                                <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function generateAdminsTab() {
            const superAdminCount = window.allUsers?.filter(u => u.isSuperAdmin).length || 0;
            const workplaceAdminCount = window.allUsers?.filter(u => u.isAdmin && !u.isSuperAdmin).length || 0;
            const pendingAdmins = window.allUsers?.filter(u => (u.isAdmin || u.isSuperAdmin) && u.status === 'pending').length || 0;
            const activeAdmins = window.allUsers?.filter(u => (u.isAdmin || u.isSuperAdmin) && u.status === 'active').length || 0;

            return `
                <div class="management-header">
                    <div>
                        <h3>ğŸ›¡ï¸ Admin Management</h3>
                        <p>Manage admin users and their permissions</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="showAddAdmin()">â• Add Admin</button>
                        <button class="btn btn-info" onclick="exportAdmins()">ğŸ“¤ Export</button>
                    </div>
                </div>

                <div class="management-stats">
                    <div class="stat-card">
                        <div class="stat-number">${superAdminCount + workplaceAdminCount}</div>
                        <div class="stat-label">Total Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${superAdminCount}</div>
                        <div class="stat-label">Super Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${workplaceAdminCount}</div>
                        <div class="stat-label">Workplace Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${pendingAdmins}</div>
                        <div class="stat-label">Pending Approval</div>
                    </div>
                </div>

                <div class="search-filter-section">
                    <div class="search-box">
                        <input type="text" id="adminSearch" placeholder="Search admins by name or email..." onkeyup="filterAdmins()">
                    </div>
                    <select class="filter-dropdown" id="adminRoleFilter" onchange="filterAdmins()">
                        <option value="">All Roles</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="workplace_admin">Workplace Admin</option>
                        <option value="pending">Pending Approval</option>
                    </select>
                    <select class="filter-dropdown" id="adminStatusFilter" onchange="filterAdmins()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>

                <div id="adminsTableContainer">
                    ${generateAdminsTable()}
                </div>
            `;
        }

        function generateAdminsTable() {
            const adminUsers = window.allUsers?.filter(user => user.isAdmin || user.isSuperAdmin) || [];
            
            if (adminUsers.length === 0) {
                return '<div class="warning">No admin users found. Add your first admin to get started!</div>';
            }

            let html = `
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Assigned Workplaces</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            adminUsers.forEach(admin => {
                const roleBadge = admin.isSuperAdmin ? 
                    '<span class="status-badge super-admin">Super Admin</span>' : 
                    '<span class="status-badge admin">Workplace Admin</span>';
                
                const statusBadge = admin.status === 'active' ? 
                    '<span class="status-badge active">Active</span>' : 
                    '<span class="status-badge suspended">Suspended</span>';

                const assignedWorkplaces = admin.assignedWorkplaces?.map(wpId => {
                    const workplace = workplaces.find(wp => wp.id === wpId);
                    return workplace ? workplace.name : 'Unknown';
                }).join(', ') || 'None assigned';

                const lastLogin = admin.lastLogin ? new Date(admin.lastLogin).toLocaleDateString() : 'Never';

                html += `
                    <tr>
                        <td><strong>${admin.firstName} ${admin.lastName}</strong></td>
                        <td>${admin.email}</td>
                        <td>${roleBadge}</td>
                        <td>${assignedWorkplaces}</td>
                        <td>${statusBadge}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-info" onclick="viewAdminDetails('${admin.id}')">ğŸ‘ï¸ View</button>
                                <button class="btn btn-warning" onclick="editAdmin('${admin.id}')">âœï¸ Edit</button>
                                <button class="btn btn-secondary" onclick="toggleAdminStatus('${admin.id}')">${admin.status === 'active' ? 'â¸ï¸ Suspend' : 'â–¶ï¸ Activate'}</button>
                                <button class="btn btn-danger" onclick="deleteAdmin('${admin.id}')">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function generateUsersTab() {
            const adminCount = window.allUsers?.filter(u => u.isAdmin).length || 0;
            const regularUserCount = window.allUsers?.filter(u => !u.isAdmin).length || 0;
            const activeUsers = window.allUsers?.filter(u => u.status === 'active').length || 0;
            const suspendedUsers = window.allUsers?.filter(u => u.status === 'suspended').length || 0;

            return `
                <div class="management-header">
                    <div>
                        <h3>ğŸ‘¤ User Account Management</h3>
                        <p>Manage user accounts and permissions</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="showAddUser()">â• Add User</button>
                        <button class="btn btn-info" onclick="exportUsers()">ğŸ“¤ Export</button>
                    </div>
                </div>

                <div class="management-stats">
                    <div class="stat-card">
                        <div class="stat-number">${window.allUsers?.length || 0}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${adminCount}</div>
                        <div class="stat-label">Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${regularUserCount}</div>
                        <div class="stat-label">Regular Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${activeUsers}</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>

                <div class="search-filter-section">
                    <div class="search-box">
                        <input type="text" id="userSearch" placeholder="Search users by name or email..." onkeyup="filterUsers()">
                    </div>
                    <select class="filter-dropdown" id="userRoleFilter" onchange="filterUsers()">
                        <option value="">All Users</option>
                        <option value="admin">Admins Only</option>
                        <option value="user">Regular Users Only</option>
                    </select>
                    <select class="filter-dropdown" id="userStatusFilter" onchange="filterUsers()">
                        <option value="">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="suspended">Suspended Only</option>
                    </select>
                </div>

                <div class="bulk-actions" id="userBulkActions" style="display: none;">
                    <div class="bulk-actions-header">
                        <div>
                            <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()">
                            <label for="selectAllUsers">Select All</label>
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-warning" onclick="bulkEditUsers()">âœï¸ Bulk Edit</button>
                            <button class="btn btn-danger" onclick="bulkDeleteUsers()">ğŸ—‘ï¸ Bulk Delete</button>
                            <button class="btn btn-secondary" onclick="bulkSuspendUsers()">â¸ï¸ Bulk Suspend</button>
                        </div>
                    </div>
                </div>

                <div id="usersTableContainer">
                    ${generateUsersTable()}
                </div>
            `;
        }

        function generateUsersTable() {
            if (!window.allUsers || window.allUsers.length === 0) {
                return '<div class="warning">No users found.</div>';
            }

            let html = `
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllUsersCheckbox" onchange="toggleSelectAllUsers()"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Phone</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            window.allUsers.forEach(user => {
                const statusBadge = user.status === 'active' ? 
                    '<span class="status-badge active">Active</span>' : 
                    '<span class="status-badge suspended">Suspended</span>';
                
                const roleBadge = user.isAdmin ? 
                    '<span class="status-badge active">Admin</span>' : 
                    '<span class="status-badge pending">User</span>';

                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never';

                html += `
                    <tr>
                        <td><input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateUserBulkActions()"></td>
                        <td><strong>${user.firstName} ${user.lastName}</strong></td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${user.phone || '-'}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-info" onclick="viewUserDetails('${user.id}')">ğŸ‘ï¸ View</button>
                                <button class="btn btn-warning" onclick="editUser('${user.id}')">âœï¸ Edit</button>
                                <button class="btn btn-secondary" onclick="toggleUserStatus('${user.id}')">${user.status === 'active' ? 'â¸ï¸ Suspend' : 'â–¶ï¸ Activate'}</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function generateImportExportTab() {
            return `
                <div class="management-header">
                    <div>
                        <h3>ğŸ“¥ Import/Export Management</h3>
                        <p>Bulk import workers and export data</p>
                    </div>
                </div>

                <div class="import-export-section">
                    <h4>ğŸ“¥ Import Workers</h4>
                    <p>Upload an Excel file with worker data. The file should have these columns:</p>
                    <ul>
                        <li><strong>A:</strong> First Name</li>
                        <li><strong>B:</strong> Last Name</li>
                        <li><strong>C:</strong> Email</li>
                        <li><strong>D:</strong> Work Study (Y/N)</li>
                        <li><strong>E:</strong> Days & Time Available</li>
                    </ul>
                    
                    <div class="file-upload-area" onclick="document.getElementById('workerImportFile').click()">
                        <input type="file" id="workerImportFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleWorkerImport(event)">
                        <div>
                            <p>ğŸ“ Click to select file or drag and drop</p>
                            <p><small>Supported formats: Excel (.xlsx, .xls), CSV</small></p>
                        </div>
                    </div>
                    
                    <div id="importProgress" class="progress-container" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="importProgressFill"></div>
                        </div>
                        <p id="importStatus">Processing...</p>
                    </div>
                </div>

                <div class="import-export-section">
                    <h4>ğŸ“¤ Export Data</h4>
                    <div class="management-actions">
                        <button class="btn btn-info" onclick="exportWorkers()">ğŸ“¤ Export Workers</button>
                        <button class="btn btn-info" onclick="exportUsers()">ğŸ“¤ Export Users</button>
                        <button class="btn btn-info" onclick="exportSchedule()">ğŸ“¤ Export Current Schedule</button>
                        <button class="btn btn-info" onclick="exportAllData()">ğŸ“¤ Export All Data</button>
                    </div>
                </div>
            `;
        }

        function generateAnalyticsTab() {
            const totalWorkers = workers.length;
            const workStudyCount = workers.filter(w => w.work_study).length;
            const linkedUsers = workers.filter(w => {
                return window.allUsers?.some(u => u.email.toLowerCase() === w.email.toLowerCase());
            }).length;
            const unlinkedWorkers = totalWorkers - linkedUsers;

            return `
                <div class="management-header">
                    <div>
                        <h3>ğŸ“Š Analytics & Insights</h3>
                        <p>Data insights and performance metrics</p>
                    </div>
                </div>

                <div class="management-stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalWorkers}</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${workStudyCount}</div>
                        <div class="stat-label">Work Study (${totalWorkers > 0 ? Math.round(workStudyCount/totalWorkers*100) : 0}%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${linkedUsers}</div>
                        <div class="stat-label">Linked Users (${totalWorkers > 0 ? Math.round(linkedUsers/totalWorkers*100) : 0}%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${unlinkedWorkers}</div>
                        <div class="stat-label">Unlinked Workers</div>
                    </div>
                </div>

                <div class="management-actions">
                    <button class="btn btn-info" onclick="generateWorkplaceReport()">ğŸ“Š Generate Report</button>
                    <button class="btn btn-info" onclick="viewAuditLogs()">ğŸ“‹ View Audit Logs</button>
                    <button class="btn btn-info" onclick="exportAnalytics()">ğŸ“¤ Export Analytics</button>
                </div>

                <div class="audit-trail">
                    <h5>Recent Activity</h5>
                    <div class="audit-entry">
                        <div><strong>Worker Management:</strong> ${totalWorkers} workers managed</div>
                        <div class="audit-timestamp">Last updated: ${new Date().toLocaleString()}</div>
                    </div>
                    <div class="audit-entry">
                        <div><strong>User Accounts:</strong> ${window.allUsers?.length || 0} user accounts</div>
                        <div class="audit-timestamp">Last updated: ${new Date().toLocaleString()}</div>
                    </div>
                </div>
            `;
        }

        // Modal functions
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        // Enhanced worker management with validation
        window.showAddWorker = function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }

            editingWorkerId = null;
            document.getElementById('workerFormTitle').textContent = 'â• Add Worker';
            document.getElementById('workerForm').reset();
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        window.editWorker = function(workerId) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }

            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }

            editingWorkerId = workerId;
            document.getElementById('workerFormTitle').textContent = 'âœï¸ Edit Worker';
            
            document.getElementById('workerFirstName').value = worker.first_name;
            document.getElementById('workerLastName').value = worker.last_name;
            document.getElementById('workerEmail').value = worker.email;
            document.getElementById('workerWorkStudy').value = worker.work_study ? 'Yes' : 'No';
            document.getElementById('workerAvailability').value = worker.availability_text;
            
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        window.deleteWorker = async function(workerId) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }

            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;

            if (!confirm(`Are you sure you want to delete ${worker.first_name} ${worker.last_name}? This cannot be undone.`)) return;

            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId));
                showNotification('âœ… Worker deleted successfully!', 'success');
                await loadWorkplaceData();
                displayEnhancedManagementInterface();
            } catch (error) {
                console.error('Error deleting worker:', error);
                showNotification('âŒ Error deleting worker', 'error');
            }
        };

        // Enhanced worker form validation and submission
        const workerForm = document.getElementById('workerForm');
        workerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            const firstName = document.getElementById('workerFirstName').value.trim();
            const lastName = document.getElementById('workerLastName').value.trim();
            const email = document.getElementById('workerEmail').value.trim();
            const workStudy = document.getElementById('workerWorkStudy').value;
            let availability = document.getElementById('workerAvailability').value.trim();
            // Enhanced validation
            if (!firstName || !lastName) {
                showNotification('âŒ First and last name are required', 'error');
                return;
            }
            if (!email || !email.includes('@')) {
                showNotification('âŒ Valid email address is required', 'error');
                return;
            }
            // Check for duplicate email (excluding current worker if editing)
            const workerId = document.getElementById('workerForm').getAttribute('data-worker-id');
            const duplicateWorker = workers.find(w => 
                w.email.toLowerCase() === email.toLowerCase() && 
                w.id !== workerId
            );
            if (duplicateWorker) {
                showNotification('âŒ A worker with this email already exists', 'error');
                return;
            }
            // Validate availability format if provided
            if (availability) {
                // Split and check each block
                const blocks = availability.split(',').map(s => s.trim()).filter(Boolean);
                let errorMsg = '';
                const dayMap = {
                    'sunday': 'Sunday', 'sun': 'Sunday',
                    'monday': 'Monday', 'mon': 'Monday',
                    'tuesday': 'Tuesday', 'tue': 'Tuesday',
                    'wednesday': 'Wednesday', 'wed': 'Wednesday',
                    'thursday': 'Thursday', 'thu': 'Thursday',
                    'friday': 'Friday', 'fri': 'Friday',
                    'saturday': 'Saturday', 'sat': 'Saturday'
                };
                for (const block of blocks) {
                    const match = block.match(/(\w+)\s+(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/i);
                    if (!match) {
                        errorMsg = `Block "${block}" is not in the format Day HH:MM-HH:MM.`;
                        break;
                    }
                    const [, dayRaw, sh, sm, eh, em] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    if (!day) {
                        errorMsg = `Block "${block}" has an invalid day.`;
                        break;
                    }
                    const startHour = parseInt(sh, 10), startMin = parseInt(sm, 10);
                    let endHour = parseInt(eh, 10), endMin = parseInt(em, 10);
                    if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 || startMin < 0 || startMin > 59 || endMin < 0 || endMin > 59) {
                        errorMsg = `Block "${block}" has invalid hour or minute values.`;
                        break;
                    }
                    const startTotal = startHour * 60 + startMin;
                    let endTotal = endHour * 60 + endMin;
                    if (endHour === 0 && endMin === 0) endTotal = 24 * 60; // Treat 00:00 as 24:00
                    if (endTotal <= startTotal) {
                        errorMsg = `Block "${block}": end time must be after start time.`;
                        break;
                    }
                }
                if (errorMsg) {
                    showAvailabilityFormatModal(availability, (newVal) => {
                        document.getElementById('workerAvailability').value = newVal;
                        workerForm.dispatchEvent(new Event('submit', {cancelable: true, bubbles: false}));
                    }, errorMsg);
                    return;
                }
            }
            const submitBtn = document.querySelector('#workerForm button[type="submit"]');
            setLoading(submitBtn.id || 'submitBtn', true);
            const workerData = {
                'First Name': firstName,
                'Last Name': lastName,
                'Email': email,
                'Work Study': workStudy,
                'Days & Times Available': availability,
                'updated_at': new Date().toISOString(),
                'updated_by': user.email
            };
            try {
                const workerId = document.getElementById('workerForm').getAttribute('data-worker-id');
                if (workerId) {
                    await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId), workerData);
                    showNotification('âœ… Worker updated successfully!', 'success');
                } else {
                    workerData.created_at = new Date().toISOString();
                    workerData.created_by = user.email;
                    await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), workerData);
                    showNotification('âœ… Worker added successfully!', 'success');
                }
                closeModal('workerFormModal');
                await loadWorkplaceData();
                if (document.getElementById('workersModal').style.display === 'block') {
                    displayEnhancedManagementInterface();
                }
            } catch (error) {
                console.error('Error saving worker:', error);
                showNotification('âŒ Error saving worker', 'error');
            } finally {
                setLoading(submitBtn.id || 'submitBtn', false);
            }
        });
        // Modal logic for availability format error
        function showAvailabilityFormatModal(lastAttempt, onSuccess, errorMsg) {
            const modal = document.getElementById('availabilityFormatModal');
            const input = document.getElementById('availabilityFormatModalInput');
            const errorDiv = document.getElementById('availabilityFormatModalError');
            input.value = lastAttempt || '';
            errorDiv.textContent = errorMsg || '';
            modal.style.display = 'block';
            input.focus();
            document.getElementById('availabilityFormatModalTryBtn').onclick = function() {
                const val = input.value.trim();
                // Repeat the same validation as above
                const blocks = val.split(',').map(s => s.trim()).filter(Boolean);
                let errorMsg2 = '';
                const dayMap = {
                    'sunday': 'Sunday', 'sun': 'Sunday',
                    'monday': 'Monday', 'mon': 'Monday',
                    'tuesday': 'Tuesday', 'tue': 'Tuesday',
                    'wednesday': 'Wednesday', 'wed': 'Wednesday',
                    'thursday': 'Thursday', 'thu': 'Thursday',
                    'friday': 'Friday', 'fri': 'Friday',
                    'saturday': 'Saturday', 'sat': 'Saturday'
                };
                for (const block of blocks) {
                    const match = block.match(/(\w+)\s+(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/i);
                    if (!match) {
                        errorMsg2 = `Block "${block}" is not in the format Day HH:MM-HH:MM.`;
                        break;
                    }
                    const [, dayRaw, sh, sm, eh, em] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    if (!day) {
                        errorMsg2 = `Block "${block}" has an invalid day.`;
                        break;
                    }
                    const startHour = parseInt(sh, 10), startMin = parseInt(sm, 10);
                    let endHour = parseInt(eh, 10), endMin = parseInt(em, 10);
                    if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 || startMin < 0 || startMin > 59 || endMin < 0 || endMin > 59) {
                        errorMsg2 = `Block "${block}" has invalid hour or minute values.`;
                        break;
                    }
                    const startTotal = startHour * 60 + startMin;
                    let endTotal = endHour * 60 + endMin;
                    if (endHour === 0 && endMin === 0) endTotal = 24 * 60; // Treat 00:00 as 24:00
                    if (endTotal <= startTotal) {
                        errorMsg2 = `Block "${block}": end time must be after start time.`;
                        break;
                    }
                }
                if (errorMsg2) {
                    errorDiv.textContent = errorMsg2;
                    input.focus();
                    return;
                }
                modal.style.display = 'none';
                onSuccess(val);
            };
        }

        // Form display functions
        window.showGenerateForm = function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            hideAllForms();
            document.getElementById('generateForm').style.display = 'block';
        };

        window.checkAvailability = function() {
            hideAllForms();
            document.getElementById('availabilityForm').style.display = 'block';
        };

        window.hideAllForms = function() {
            document.querySelectorAll('#scheduleContent .form-section').forEach(form => {
                form.style.display = 'none';
            });
        };

        // Enhanced worker viewing
        window.viewWorkers = function() {
            if (workers.length === 0) {
                let html = `
                    <div class="schedule-display">
                        <h3>ğŸ‘¥ Workers for ${selectedWorkplace}</h3>
                        <div class="warning">
                            <strong>No workers found for this workplace.</strong><br>
                            Workers are required to generate schedules and check availability.
                        </div>
                `;
                
                if (user.isAdmin) {
                    html += '<button class="btn btn-success" onclick="showAddWorker()">â• Add First Worker</button>';
                } else {
                    html += '<div class="info">Contact an administrator to add workers.</div>';
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
                return;
            }

            const wsCount = workers.filter(w => w.work_study).length;
            const regularCount = workers.filter(w => !w.work_study).length;
            const workersWithAvailability = workers.filter(w => w.availability_text).length;

            let html = `
                <div class="schedule-display">
                    <h3>ğŸ‘¥ Workers for ${selectedWorkplace}</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${workers.length}</div>
                            <div class="stat-label">Total Workers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${wsCount}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regularCount}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workersWithAvailability}</div>
                            <div class="stat-label">With Availability</div>
                        </div>
                    </div>
            `;

            // Show warning if workers don't have availability
            if (workersWithAvailability < workers.length) {
                const missingCount = workers.length - workersWithAvailability;
                html += `
                    <div class="warning">
                        <strong>âš ï¸ ${missingCount} worker(s) don't have availability set.</strong><br>
                        Workers without availability cannot be scheduled. ${user.isAdmin ? 'Edit workers to add their availability.' : 'Contact an administrator to update worker availability.'}
                    </div>
                `;
            }

            html += `
                <table class="worker-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>Availability Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            workers.forEach(worker => {
                const availabilityStatus = worker.availability_text ? 
                    'âœ… Set' : 
                    '<span style="color: #dc3545;">âŒ Missing</span>';
                    
                html += `
                    <tr>
                        <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '<span style="color: #28a745;">âœ… Yes</span>' : 'âŒ No'}</td>
                        <td>${availabilityStatus}</td>
                        <td>
                            <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">ğŸ“§ Contact</button>
                            ${user.isAdmin ? `<button class="btn btn-warning" onclick="editWorker('${worker.id}')" style="margin-left: 0.5rem;">âœï¸ Edit</button>
                            <button class="btn btn-danger" onclick="removeWorker('${worker.id}')" style="margin-left: 0.5rem;">ğŸ—‘ï¸ Remove</button>` : ''}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            // Admin action buttons
            if (user.isAdmin) {
                html += `
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showAddWorker()">â• Add Worker</button>
                        <button class="btn btn-warning" onclick="showLastMinuteCheck()">ğŸš¨ Last Minute Check</button>
                        <button class="btn btn-info" onclick="showManageWorkers()">ğŸ‘¥ Manage Workers</button>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Enhanced schedule generation with comprehensive validation
        window.generateSchedule = async function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            if (!selectedWorkplace) {
                showNotification('âš ï¸ Please select a workplace first', 'warning');
                return;
            }
            if (workers.length === 0) {
                showNotification('âŒ No workers found. Add workers before generating a schedule.', 'error');
                return;
            }
            if (Object.keys(hours).length === 0) {
                showNotification('âŒ No operating hours configured. Set up hours of operation first.', 'error');
                return;
            }
            // Validate worker availability
            const workersWithAvailability = workers.filter(w => w.availability_text && Object.keys(w.availability).length > 0);
            if (workersWithAvailability.length === 0) {
                showNotification('âŒ No workers have availability set. Add worker availability before generating schedules.', 'error');
                return;
            }
            const maxHours = parseInt(document.getElementById('maxHours').value);
            const workersPerShift = parseInt(document.getElementById('workersPerShift').value);
            const minHours = parseInt(document.getElementById('minHours').value);
            const ensureFullCoverage = document.getElementById('ensureFullCoverage').checked;
            // Validation
            if (maxHours < 5 || maxHours > 40) {
                showNotification('âŒ Max hours must be between 5 and 40', 'error');
                return;
            }
            if (workersPerShift < 1 || workersPerShift > 5) {
                showNotification('âŒ Workers per shift must be between 1 and 5', 'error');
                return;
            }
            setLoading('generateScheduleBtn', true);
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">ğŸ”„ Generating optimized schedule...</div>';
            try {
                // Always use the best/fair logic: shuffle, prioritize work study, fair distribution
                let processedWorkers = shuffleArray([...workersWithAvailability]);
                processedWorkers.sort((a, b) => {
                    if (a.work_study && !b.work_study) return -1;
                    if (!a.work_study && b.work_study) return 1;
                    return calculateAvailabilityHours(a) - calculateAvailabilityHours(b);
                });
                // Generate schedule
                const result = createShiftsFromAvailability(
                    hours, 
                    processedWorkers,
                    maxHours,
                    workersPerShift,
                    minHours,
                    ensureFullCoverage
                );
                const {
                    schedule: generatedSchedule,
                    assignedHours,
                    lowHours,
                    unassigned,
                    altSols,
                    unfilledShifts,
                    wsIssues,
                    minHoursIssues,
                    coverageGaps,
                    forcedAssignments
                } = result;
                // Validate all shifts before saving
                for (const day of DAYS) {
                    for (const shift of (generatedSchedule[day] || [])) {
                        if (!validateShift(shift)) {
                            setLoading('generateScheduleBtn', false);
                            return;
                        }
                    }
                }
                schedule = generatedSchedule;
                await saveSchedule(schedule, 'default', {
                    maxHours,
                    workersPerShift,
                    minHours,
                    ensureFullCoverage,
                    workersCount: processedWorkers.length
                });
                if (unfilledShifts.length > 0 || wsIssues.length > 0 || minHoursIssues.length > 0 || coverageGaps.length > 0) {
                    showEnhancedIssuesDialog({
                        unfilledShifts,
                        wsIssues,
                        minHoursIssues,
                        coverageGaps,
                        altSols,
                        forcedAssignments
                    });
                }
                displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, false, coverageGaps);
                hideAllForms();
                showNotification('âœ… Schedule generated successfully! Use "Schedule History" to set it as current for workers.', 'success');
            } catch (error) {
                console.error('Error generating schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = `<div class="error">âŒ Error generating schedule: ${error.message}</div>`;
                showNotification('âŒ Failed to generate schedule', 'error');
            } finally {
                setLoading('generateScheduleBtn', false);
            }
        };

        // Enhanced schedule saving with metadata
        async function saveSchedule(schedule, variation, metadata = {}) {
            try {
                const scheduleData = {
                    days: schedule,
                    createdAt: new Date().toISOString(),
                    workplaceId: selectedWorkplace,
                    name: `${selectedWorkplace} Schedule ${new Date().toLocaleDateString()}`,
                    variation: variation,
                    generatedBy: user.email,
                    isCurrent: false, // New schedules are not automatically set as current
                    metadata: {
                        ...metadata,
                        version: '2.0',
                        totalShifts: Object.values(schedule).flat().length,
                        workersUsed: Object.values(schedule).flat()
                            .map(s => s.raw_assigned || [])
                            .flat()
                            .filter((email, index, arr) => arr.indexOf(email) === index).length
                    }
                };
                
                const docRef = await addDoc(collection(db, 'workplaces', selectedWorkplace, 'schedules'), scheduleData);
                currentScheduleId = docRef.id; // Set the current schedule ID to the newly created document
                console.log('Enhanced schedule saved to Firebase with ID:', currentScheduleId);
                return docRef.id;
            } catch (error) {
                console.error('Error saving schedule:', error);
                throw error;
            }
        }

        // Enhanced issues dialog with coverage gaps
        function showEnhancedIssuesDialog(issues) {
            const { unfilledShifts, wsIssues, minHoursIssues, coverageGaps, altSols, forcedAssignments } = issues;
            
            let html = '<div class="modal-content"><div class="modal-header"><h3>âš ï¸ Schedule Analysis & Issues</h3><span class="close" onclick="closeIssuesDialog()">&times;</span></div>';
            
            // Coverage gaps (critical)
            if (coverageGaps && coverageGaps.length > 0) {
                html += '<div class="error"><h4>ğŸš¨ Critical Coverage Gaps:</h4><ul>';
                coverageGaps.forEach(gap => {
                    html += `<li><strong>${gap.day}</strong> ${formatTime(gap.start)} - ${formatTime(gap.end)} (${gap.duration.toFixed(1)} hours uncovered)</li>`;
                });
                html += '</ul><p><strong>Action needed:</strong> These time periods have no worker coverage during operating hours.</p></div>';
            }
            
            // Forced assignments section
            if (forcedAssignments && forcedAssignments.length > 0) {
                html += '<div class="error"><h4>â— Forced Assignments (Closest Worker Assigned):</h4><ul>';
                forcedAssignments.forEach(fa => {
                    html += `<li><strong>${fa.day}</strong> ${formatTime(fa.start)} - ${formatTime(fa.end)}: ${fa.worker} <span style=\"color:#e53935;font-weight:bold;\">(FORCED)</span></li>`;
                });
                html += '</ul><p><strong>Warning:</strong> These shifts were filled by assigning the closest available worker (least hours, prioritized for fairness). Please review these assignments as they may not match worker preferences or may be less ideal.</p></div>';
            }
            
            // Work study issues
            if (wsIssues.length > 0) {
                html += '<div class="warning"><h4>ğŸ“ Work Study Issues:</h4><ul>';
                wsIssues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul><p><strong>Note:</strong> Work study students must have exactly 5 hours per week.</p></div>';
            }
            
            // Low hours issues
            if (minHoursIssues.length > 0) {
                html += '<div class="warning"><h4>â° Workers with Insufficient Hours:</h4><ul>';
                minHoursIssues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Unfilled shifts
            if (unfilledShifts.length > 0) {
                html += '<div class="error"><h4>âŒ Unfilled Shifts:</h4><ul>';
                unfilledShifts.forEach(shift => {
                    const key = `${shift.day} ${shift.start}-${shift.end}`;
                    html += `<li><strong>${key}</strong>`;
                    if (altSols[key] && altSols[key].length > 0) {
                        html += ` - <em>Potential alternatives:</em> ${altSols[key].join(', ')}`;
                    } else {
                        html += ' - <em>No available alternatives found</em>';
                    }
                    html += '</li>';
                });
                html += '</ul></div>';
            }
            
            // Success message if no major issues
            if (!coverageGaps?.length && !unfilledShifts.length && !wsIssues.length) {
                html += '<div class="success"><h4>âœ… Schedule Quality: Excellent</h4><p>No critical issues found. The schedule provides complete coverage with proper work study allocation.</p></div>';
            }
            
            html += '<div style="margin-top: 1rem;"><button class="btn btn-secondary" onclick="closeIssuesDialog()">Close Analysis</button></div></div>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.id = 'issuesModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            window.closeIssuesDialog = function() {
                document.body.removeChild(modal);
                delete window.closeIssuesDialog;
            };
        }

        // Enhanced schedule display with coverage analysis
        function displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, isCurrent = false, coverageGaps = []) {
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledShifts = Object.values(schedule).flat().filter(s => s.assigned.includes('Unfilled') || s.assigned.includes('COVERAGE GAP')).length;
            const filledShifts = totalShifts - unfilledShifts;
            const coveragePercentage = totalShifts > 0 ? ((filledShifts / totalShifts) * 100).toFixed(1) : 0;
            
            let html = '<div class="schedule-display">';
            
            // Print header for print view
            html += '<div class="print-only"><h2>ğŸ“… Schedule for ' + selectedWorkplace.replace('_', ' ').toUpperCase() + '</h2><p>Generated: ' + new Date().toLocaleDateString() + '</p></div>';
            
            if (isCurrent) {
                html += '<div class="success">âœ… This is the current active schedule that workers can see</div>';
            } else {
                html += '<div class="info">â„¹ï¸ This is a historical schedule. Use "Schedule History" to set a schedule as current for workers.</div>';
            }
            
            // Enhanced stats
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card" style="background: ${coveragePercentage >= 90 ? '#28a745' : coveragePercentage >= 75 ? '#ffc107' : '#dc3545'};">
                        <div class="stat-number">${coveragePercentage}%</div>
                        <div class="stat-label">Coverage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(assignedHours).length}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${coverageGaps.length}</div>
                        <div class="stat-label">Coverage Gaps</div>
                    </div>
                </div>
            `;
            
            // Show critical warnings
            if (coverageGaps.length > 0) {
                html += `<div class="error"><strong>ğŸš¨ ${coverageGaps.length} Critical Coverage Gap(s) Found!</strong><br>Some operating hours have no worker assigned. Check the schedule analysis for details.</div>`;
            }
            
            if (lowHours.length > 0) {
                html += `<div class="warning"><strong>Workers with less than minimum hours:</strong> ${lowHours.join(', ')}</div>`;
            }
            if (unassigned.length > 0) {
                html += `<div class="error"><strong>Workers with no hours:</strong> ${unassigned.join(', ')}</div>`;
            }
            
            // Display schedule by day with enhanced shift marking
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                html += `<div class="day-header">${day}</div>`;
                shifts.forEach((shift, index) => {
                    const unfilled = shift.assigned.includes('Unfilled');
                    const isGap = shift.assigned.includes('COVERAGE GAP') || shift.isGap;
                    const workStudy = shift.is_work_study || false;
                    const isForced = shift.forced === true;
                    
                    let shiftClass = 'shift';
                    if (isGap) shiftClass += ' coverage-gap';
                    else if (unfilled) shiftClass += ' unfilled';
                    else if (workStudy) shiftClass += ' work-study';
                    if (isForced) shiftClass += ' forced-shift';
                    
                    html += `
                        <div class="${shiftClass}">
                            <div>
                                <strong>${formatTime(shift.start)} - ${formatTime(shift.end)}</strong>
                                ${workStudy ? '<span style="color: #ffc107; margin-left: 0.5rem;">(Work Study)</span>' : ''}
                                ${isGap ? '<span style="color: #ff5722; margin-left: 0.5rem;">(CRITICAL GAP)</span>' : ''}
                                ${isForced ? '<span style="color: #e53935; margin-left: 0.5rem; font-weight: bold;">(FORCED)</span>' : ''}
                                <div style="margin-top: 0.25rem; font-size: 0.9rem;">
                                    ${shift.assigned.join(', ')}
                                </div>
                            </div>
                            ${user.isAdmin ? `
                            <div class="shift-actions no-print">
                                <button class="btn btn-warning" onclick="editShift('${day}', ${index})">âœï¸ Edit</button>
                                <button class="btn btn-danger" onclick="removeShift('${day}', ${index})">ğŸ—‘ï¸ Remove</button>
                                ${(unfilled || isGap) ? '<button class="btn btn-info" onclick="suggestAlternatives(\'' + day + '\', ' + index + ')">ğŸ’¡ Fix</button>' : ''}
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            });
            
            // Enhanced worker hours summary
            html += '<div style="margin-top: 2rem;"><h4>ğŸ“Š Worker Hours Summary</h4>';
            html += '<table class="worker-table"><thead><tr><th>Worker</th><th>Hours Assigned</th><th>Status</th><th class="no-print">Actions</th></tr></thead><tbody>';
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            
            workers.forEach(w => {
                if (!(w.email in assignedHours)) {
                    sortedWorkers.push([w.email, 0]);
                }
            });
            
            sortedWorkers.forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWS = worker.work_study;
                let status = 'âœ… Good';
                let statusColor = 'color: #28a745;';
                
                if (isWS && Math.abs(hours - 5) > 0.1) {
                    status = `âŒ WS Issue (${hours.toFixed(1)}h/5h)`;
                    statusColor = 'color: #dc3545;';
                } else if (!isWS && hours < 3 && hours > 0) {
                    status = 'âš ï¸ Low Hours';
                    statusColor = 'color: #ffc107;';
                } else if (hours === 0) {
                    status = 'âŒ Unassigned';
                    statusColor = 'color: #dc3545;';
                } else if (isWS && hours === 5) {
                    status = 'âœ… Perfect (WS)';
                    statusColor = 'color: #28a745;';
                }
                
                html += `
                    <tr>
                        <td><strong>${name}</strong> ${isWS ? '<small style="color: #ffc107;">(WS)</small>' : ''}</td>
                        <td>${hours.toFixed(1)} hours</td>
                        <td style="${statusColor}">${status}</td>
                        <td class="no-print"><button class="btn btn-primary" onclick="contactWorker('${email}')">ğŸ“§ Contact</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // Action buttons (admin vs user)
            if (user.isAdmin) {
                html += `
                    <div class="no-print" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="addNewShift()">â• Add Shift</button>
                        <button class="btn btn-info" onclick="emailSchedule()">ğŸ“§ Email Schedule</button>
                        <button class="btn btn-secondary" onclick="printSchedule()">ğŸ–¨ï¸ Print Schedule</button>
                        <button class="btn btn-warning" onclick="exportScheduleToExcel()">ğŸ“¤ Export Excel</button>
                        <button class="btn btn-info" onclick="analyzeSchedule()">ğŸ“Š Detailed Analysis</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="no-print" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="printSchedule()">ğŸ–¨ï¸ Print Schedule</button>
                        <button class="btn btn-info" onclick="emailSchedule()">ğŸ“§ Email Schedule</button>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Add print footer
            html += `<div class="print-footer" data-date="${new Date().toLocaleDateString()}"></div>`;
            
            document.getElementById('scheduleDisplay').innerHTML = html;
        }

        // Enhanced utility functions - Email, Export, Print, Analysis
        window.emailSchedule = function() {
            const scheduleElement = document.querySelector('.schedule-display');
            if (!scheduleElement) {
                showNotification('âŒ No schedule to email', 'error');
                return;
            }

            // Generate email content
            let emailBody = `Schedule for ${selectedWorkplace.replace('_', ' ').toUpperCase()}\n`;
            emailBody += `Generated: ${new Date().toLocaleDateString()}\n`;
            emailBody += `Generated by: ${user.email}\n\n`;
            
            // Add schedule by day
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                emailBody += `${day}:\n`;
                shifts.forEach(shift => {
                    const timeRange = `${formatTime(shift.start)} - ${formatTime(shift.end)}`;
                    const workers = shift.assigned.join(', ');
                    emailBody += `  ${timeRange}: ${workers}\n`;
                });
                emailBody += '\n';
            });
            
            // Add worker summary
            emailBody += 'Worker Hours Summary:\n';
            const assignedHours = calculateAssignedHours(schedule);
            Object.entries(assignedHours).forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (worker) {
                    emailBody += `  ${worker.first_name} ${worker.last_name}: ${hours.toFixed(1)} hours\n`;
                }
            });

            const subject = `Work Schedule - ${selectedWorkplace.replace('_', ' ')} - ${new Date().toLocaleDateString()}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            window.open(mailtoLink);
            showNotification('ğŸ“§ Email client opened with schedule', 'success');
        };

        window.exportScheduleToExcel = function() {
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('âŒ No schedule to export', 'error');
                return;
            }

            // Create CSV content
            let csvContent = 'Day,Start Time,End Time,Worker(s),Work Study,Duration\n';
            
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                shifts.forEach(shift => {
                    const startTime = formatTime(shift.start);
                    const endTime = formatTime(shift.end);
                    const workers = shift.assigned.join(' & ');
                    const isWorkStudy = shift.is_work_study ? 'Yes' : 'No';
                    const duration = (timeToHour(shift.end) - timeToHour(shift.start)).toFixed(1);
                    
                    csvContent += `"${day}","${startTime}","${endTime}","${workers}","${isWorkStudy}","${duration}"\n`;
                });
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${selectedWorkplace}_schedule_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ğŸ“„ Schedule exported to CSV file', 'success');
        };

        window.printSchedule = function() {
            // The print styles are now handled by the CSS @media print rules
            // Just trigger the print dialog
            window.print();
        };

        window.analyzeSchedule = function() {
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('âŒ No schedule to analyze', 'error');
                return;
            }

            const assignedHours = calculateAssignedHours(schedule);
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledCount = Object.values(schedule).flat().filter(s => 
                s.assigned.includes('Unfilled') || s.assigned.includes('COVERAGE GAP')
            ).length;
            
            // Calculate metrics
            const coverage = ((totalShifts - unfilledCount) / totalShifts * 100).toFixed(1);
            const avgHoursPerWorker = Object.values(assignedHours).length > 0 ? 
                (Object.values(assignedHours).reduce((a, b) => a + b, 0) / Object.values(assignedHours).length).toFixed(1) : 0;
            
            const wsWorkers = workers.filter(w => w.work_study);
            const wsWithCorrectHours = wsWorkers.filter(w => Math.abs(assignedHours[w.email] - 5) < 0.1).length;
            const wsCompliance = wsWorkers.length > 0 ? (wsWithCorrectHours / wsWorkers.length * 100).toFixed(1) : 100;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ğŸ“Š Schedule Analysis</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div style="padding: 1rem;">
                        <h4>Coverage Metrics</h4>
                        <div class="stats" style="margin-bottom: 1.5rem;">
                            <div class="stat-card">
                                <div class="stat-number">${coverage}%</div>
                                <div class="stat-label">Coverage Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${avgHoursPerWorker}</div>
                                <div class="stat-label">Avg Hours/Worker</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${wsCompliance}%</div>
                                <div class="stat-label">WS Compliance</div>
                            </div>
                        </div>
                        
                        <h4>Recommendations</h4>
                        <ul style="margin: 1rem 0;">
                            ${coverage < 90 ? '<li>ğŸ”´ <strong>Critical:</strong> Schedule has low coverage. Consider adjusting hours or recruiting more workers.</li>' : ''}
                            ${wsCompliance < 100 ? '<li>ğŸŸ¡ <strong>Work Study:</strong> Some work study students don\'t have exactly 5 hours.</li>' : ''}
                            ${unfilledCount > 0 ? '<li>ğŸ”´ <strong>Unfilled Shifts:</strong> ' + unfilledCount + ' shifts need workers assigned.</li>' : ''}
                            ${coverage >= 90 && wsCompliance == 100 && unfilledCount == 0 ? '<li>ğŸŸ¢ <strong>Excellent:</strong> Schedule meets all requirements!</li>' : ''}
                        </ul>
                        
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Enhanced current schedule viewing
        window.viewCurrentSchedule = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading current schedule...</div>';
                
                // First try to find a schedule marked as current
                const currentSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    where('isCurrent', '==', true)
                ));
                
                let currentDoc = null;
                if (!currentSnapshot.empty) {
                    currentDoc = currentSnapshot.docs[0];
                } else {
                    // Fallback to most recent schedule if no current is set
                    const snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        orderBy('createdAt', 'desc')
                    ));
                    
                    if (!snapshot.empty) {
                        currentDoc = snapshot.docs[0];
                    }
                }
                
                if (currentDoc) {
                    currentScheduleId = currentDoc.id; // <-- Track the ID
                    const scheduleData = currentDoc.data();
                    schedule = scheduleData.days;
                    
                    const assignedHours = calculateAssignedHours(schedule);
                    const lowHours = workers
                        .filter(w => !w.work_study && assignedHours[w.email] < 4)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    const unassigned = workers
                        .filter(w => assignedHours[w.email] === 0)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    
                    const { coverageGaps } = validateScheduleCoverage(schedule, hours);
                    displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, true, coverageGaps);
                } else {
                    document.getElementById('scheduleDisplay').innerHTML = `
                        <div class="schedule-display">
                            <div class="warning">
                                <h3>ğŸ“… No Current Schedule Found</h3>
                                <p>No schedules have been generated for this workplace yet.</p>
                                ${user.isAdmin ? '<button class="btn btn-primary" onclick="showGenerateForm()">ğŸ“… Generate First Schedule</button>' : '<p>Contact an administrator to generate a schedule.</p>'}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading current schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">âŒ Error loading schedule. Please try again.</div>';
            }
        };

        // Calculate assigned hours helper
        function calculateAssignedHours(schedule) {
            const assignedHours = {};
            
            Object.values(schedule).forEach(shifts => {
                shifts.forEach(shift => {
                    const duration = timeToHour(shift.end) - timeToHour(shift.start);
                    (shift.raw_assigned || []).forEach(email => {
                        assignedHours[email] = (assignedHours[email] || 0) + duration;
                    });
                });
            });
            
            return assignedHours;
        }

        // Enhanced history viewing
        window.viewHistory = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading schedule history...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                let html = '<div class="schedule-display"><h3>ğŸ“š Schedule History</h3>';
                
                if (snapshot.empty) {
                    html += `
                        <div class="info">
                            <h4>No Schedules Found</h4>
                            <p>No schedules have been generated for this workplace yet.</p>
                            ${user.isAdmin ? '<button class="btn btn-primary" onclick="showGenerateForm()">ğŸ“… Generate First Schedule</button>' : ''}
                        </div>
                    `;
                } else {
                    html += `<div class="info">Found ${snapshot.size} schedule(s)</div>`;
                    
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = new Date(data.createdAt).toLocaleDateString();
                        const time = new Date(data.createdAt).toLocaleTimeString();
                        const totalShifts = data.metadata?.totalShifts || 'Unknown';
                        const workersUsed = data.metadata?.workersUsed || 'Unknown';
                        
                        const actionButtons = user.isAdmin ? `
                            <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">ğŸ‘ï¸ View</button>
                            <button class="btn btn-success" onclick="setAsCurrentSchedule('${doc.id}')" ${data.isCurrent ? 'disabled' : ''}>${data.isCurrent ? 'âœ… Current' : 'ğŸ¯ Set as Current'}</button>
                            <button class="btn btn-danger" onclick="deleteSchedule('${doc.id}')">ğŸ—‘ï¸ Delete</button>
                        ` : `
                            <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">ğŸ‘ï¸ View</button>
                        `;
                        
                        html += `
                            <div style="padding: 1rem; border: 1px solid #dee2e6; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${data.name || 'Schedule'}</strong>
                                    ${data.isCurrent ? '<span style="color: #28a745; font-weight: bold;"> (Current)</span>' : ''}<br>
                                    <small>ğŸ“… ${date} at ${time} | ğŸ‘¤ ${data.generatedBy || 'Unknown'}</small><br>
                                    <small>ğŸ“Š ${totalShifts} shifts | ğŸ‘¥ ${workersUsed} workers | ğŸ”„ ${data.variation || 'balanced'}</small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    ${actionButtons}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">âŒ Error loading schedule history.</div>';
            }
        };

        // View schedule by ID
        window.viewScheduleById = async function(scheduleId) {
            try {
                const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                if (docSnap.exists()) {
                    currentScheduleId = docSnap.id; // <-- Track the ID
                    const scheduleData = docSnap.data();
                    schedule = scheduleData.days;
                    
                    const assignedHours = calculateAssignedHours(schedule);
                    const lowHours = workers
                        .filter(w => !w.work_study && assignedHours[w.email] < 4)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    const unassigned = workers
                        .filter(w => assignedHours[w.email] === 0)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    
                    const { coverageGaps } = validateScheduleCoverage(schedule, hours);
                    displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, scheduleData.isCurrent || false, coverageGaps);
                }
            } catch (error) {
                console.error('Error viewing schedule:', error);
                showNotification('âŒ Error loading schedule', 'error');
            }
        };

        // Delete schedule (admin only)
        window.deleteSchedule = async function(scheduleId) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            
            if (confirm('Delete this schedule? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                    showNotification('âœ… Schedule deleted', 'success');
                    viewHistory();
                } catch (error) {
                    console.error('Error deleting schedule:', error);
                    showNotification('âŒ Error deleting schedule', 'error');
                }
            }
        };

        // Set schedule as current (admin only)
        window.setAsCurrentSchedule = async function(scheduleId) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            
            if (confirm('Set this schedule as the current schedule for workers? This will replace any existing current schedule.')) {
                try {
                    // First, unset any existing current schedules
                    const existingCurrentSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        where('isCurrent', '==', true)
                    ));
                    
                    const batch = [];
                    existingCurrentSnapshot.forEach(doc => {
                        batch.push(updateDoc(doc.ref, { isCurrent: false }));
                    });
                    
                    // Set the new schedule as current
                    batch.push(updateDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId), {
                        isCurrent: true,
                        setAsCurrentAt: new Date().toISOString(),
                        setAsCurrentBy: user.email
                    }));
                    
                    await Promise.all(batch);
                    
                    showNotification('âœ… Schedule set as current successfully!', 'success');
                    viewHistory(); // Refresh the history view
                } catch (error) {
                    console.error('Error setting schedule as current:', error);
                    showNotification('âŒ Error setting schedule as current', 'error');
                }
            }
        };

        // Enhanced availability checking
        window.findAvailable = function() {
            const day = document.getElementById('availDay').value;
            const start = document.getElementById('availStart').value;
            const end = document.getElementById('availEnd').value;
            
            if (!start || !end) {
                showNotification('âš ï¸ Please enter both start and end times', 'warning');
                return;
            }
            
            const startHour = timeToHour(start);
            const endHour = timeToHour(end);
            
            // Handle overnight shifts properly (when end time is midnight or earlier than start time)
            if (endHour <= startHour && endHour !== 0) {
                showNotification('âŒ End time must be after start time', 'error');
                return;
            }
            
            // For overnight shifts (end time is midnight), we need to add 24 hours to end time for comparison
            const adjustedEndHour = endHour === 0 ? 24 : endHour;
            if (adjustedEndHour <= startHour) {
                showNotification('âŒ End time must be after start time', 'error');
                return;
            }
            
            const available = workers.filter(worker => {
                return isWorkerAvailable(worker, day, startHour, endHour);
            });
            
            const workStudy = available.filter(w => w.work_study);
            const regular = available.filter(w => !w.work_study);
            
            let html = `
                <div class="schedule-display">
                    <h3>ğŸ” Available Workers</h3>
                    <div class="info">
                        <strong>Search Criteria:</strong> ${day} ${formatTime(start)} - ${formatTime(end)}<br>
                        <strong>Duration:</strong> ${(endHour - startHour).toFixed(1)} hours
                    </div>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${available.length}</div>
                            <div class="stat-label">Total Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workStudy.length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regular.length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
            `;
            
            if (available.length === 0) {
                html += '<div class="warning">âŒ No workers are available during this time period.</div>';
            } else {
                if (workStudy.length > 0) {
                    html += '<h4>ğŸ“ Available Work Study Students</h4>';
                    workStudy.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #28a745; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>ğŸ“§ ${worker.email}</small>
                                </div>
                                <button class="btn btn-success" onclick="contactWorker('${worker.email}')">ğŸ“§ Contact</button>
                            </div>
                        `;
                    });
                }
                
                if (regular.length > 0) {
                    html += '<h4>ğŸ‘¥ Available Regular Workers</h4>';
                    regular.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #007bff; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>ğŸ“§ ${worker.email}</small>
                                </div>
                                <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">ğŸ“§ Contact</button>
                            </div>
                        `;
                    });
                }
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Enhanced contact worker function
        window.contactWorker = function(email) {
            const subject = `Work Schedule - ${selectedWorkplace.replace('_', ' ')}`;
            const body = `Hello!\n\nI'm reaching out regarding the work schedule for ${selectedWorkplace.replace('_', ' ')}.\n\nBest regards,\n${user.email}`;
            window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        };

        // Placeholder implementations for remaining features
        window.showLastMinuteCheck = function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            showNotification('ğŸš¨ Last minute check feature - Enhanced implementation coming soon!', 'info');
        };

        window.addNewShift = function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            // Build day options
            let dayOptions = DAYS.map(day => `<option value='${day}'>${day}</option>`).join('');
            let html = `<div class='form-group'><label>Day</label><select id='addShiftDay'><option value=''>Select Day</option>${dayOptions}</select></div>`;
            html += `<div class='form-row'><div class='form-group'><label>Start Time</label><input type='time' id='addShiftStart'></div><div class='form-group'><label>End Time</label><input type='time' id='addShiftEnd'></div></div>`;
            html += `<div class='form-group'><label><input type='checkbox' id='addShiftShowUnavailable'> Show unavailable workers</label></div>`;
            html += `<div class='form-group' id='addShiftWorkersGroup' style='display:none;'><label>Assign Worker(s)</label><select id='addShiftWorkers' multiple size='5'></select></div>`;
            html += `<div style='margin-top:1rem;'><button class='btn btn-success' id='saveAddShiftBtn'>Add Shift</button> <button class='btn btn-secondary' onclick="closeModal('addShiftModal')">Cancel</button></div>`;
            document.getElementById('addShiftModalBody').innerHTML = html;
            document.getElementById('addShiftModal').style.display = 'block';
            // Helper to update worker list
            function updateWorkerList() {
                const day = document.getElementById('addShiftDay').value;
                const start = document.getElementById('addShiftStart').value;
                const end = document.getElementById('addShiftEnd').value;
                const showUnavailable = document.getElementById('addShiftShowUnavailable').checked;
                const group = document.getElementById('addShiftWorkersGroup');
                const select = document.getElementById('addShiftWorkers');
                if (!day || !start || !end) {
                    group.style.display = 'none';
                    select.innerHTML = '';
                    return;
                }
                // Filter workers
                let filtered = workers;
                if (!showUnavailable) {
                    filtered = workers.filter(w => isWorkerAvailable(w, day, timeToHour(start), timeToHour(end)));
                }
                // Build options
                function formatAvail(w) {
                    return Object.entries(w.availability).map(([d, slots]) => `${d}: ${slots.map(s => formatTime(s.start) + '-' + formatTime(s.end)).join(', ')}`).join('; ');
                }
                select.innerHTML = workers.map(w => {
                    const available = isWorkerAvailable(w, day, timeToHour(start), timeToHour(end));
                    if (!showUnavailable && !available) return '';
                    return `<option value='${w.email}'${!available ? ' style="color:#aaa;"' : ''}>${w.first_name} ${w.last_name} (${formatAvail(w)}${!available ? ' - Unavailable' : ''})</option>`;
                }).join('');
                group.style.display = 'block';
            }
            document.getElementById('addShiftDay').onchange = updateWorkerList;
            document.getElementById('addShiftStart').oninput = updateWorkerList;
            document.getElementById('addShiftEnd').oninput = updateWorkerList;
            document.getElementById('addShiftShowUnavailable').onchange = updateWorkerList;
            // Save logic (unchanged)
            document.getElementById('saveAddShiftBtn').onclick = async function() {
                const day = document.getElementById('addShiftDay').value;
                const start = document.getElementById('addShiftStart').value;
                const end = document.getElementById('addShiftEnd').value;
                const selected = Array.from(document.getElementById('addShiftWorkers').selectedOptions).map(o => o.value);
                if (!day || !start || !end) {
                    showNotification('âŒ All fields are required', 'error');
                    return;
                }
                // Handle overnight shifts properly (when end time is midnight or earlier than start time)
                const startHour = timeToHour(start);
                const endHour = timeToHour(end);
                
                // If end time is midnight (00:00) or earlier than start time, it's an overnight shift
                if (endHour <= startHour && endHour !== 0) {
                    showNotification('âŒ End time must be after start time', 'error');
                    return;
                }
                
                // For overnight shifts (end time is midnight), we need to add 24 hours to end time for comparison
                const adjustedEndHour = endHour === 0 ? 24 : endHour;
                if (adjustedEndHour <= startHour) {
                    showNotification('âŒ End time must be after start time', 'error');
                    return;
                }
                if (selected.length === 0) {
                    showNotification('âŒ At least one worker must be assigned', 'error');
                    return;
                }
                // Validate within operating hours (handle overnight shifts)
                const opHours = (hours[day] && hours[day][0]) ? hours[day][0] : { start: '00:00', end: '23:59' };
                const opStartHour = timeToHour(opHours.start);
                const opEndHour = timeToHour(opHours.end);
                const shiftStartHour = timeToHour(start);
                const shiftEndHour = timeToHour(end);
                
                // For overnight shifts, adjust the end time
                const adjustedShiftEndHour = shiftEndHour === 0 ? 24 : shiftEndHour;
                const adjustedOpEndHour = opEndHour === 0 ? 24 : opEndHour;
                
                if (shiftStartHour < opStartHour || adjustedShiftEndHour > adjustedOpEndHour) {
                    showNotification(`âŒ Shift must be within operating hours: ${formatTime(opHours.start)} - ${formatTime(opHours.end)}`, 'error');
                    return;
                }
                // Add to in-memory schedule
                if (!schedule[day]) schedule[day] = [];
                const newAssigned = selected.map(email => {
                    const w = workers.find(x => x.email === email);
                    return w ? `${w.first_name} ${w.last_name}` : email;
                });
                schedule[day].push({
                    start,
                    end,
                    assigned: newAssigned,
                    available: newAssigned,
                    raw_assigned: selected,
                    all_available: workers.filter(w => selected.includes(w.email))
                });
                showNotification('âœ… Shift added (not yet saved to database)', 'success');
                closeModal('addShiftModal');
                displayEnhancedSchedule(schedule, calculateAssignedHours(schedule), [], [], false, []);
                // Save to Firestore
                if (currentScheduleId) {
                    const scheduleRef = doc(db, 'workplaces', selectedWorkplace, 'schedules', currentScheduleId);
                    await updateDoc(scheduleRef, {
                        days: schedule,
                        updated_at: new Date().toISOString(),
                        updated_by: user.email
                    });
                    showNotification('âœ… Shift added and saved to database!', 'success');
                } else {
                    showNotification('âš ï¸ Could not save to database: schedule ID not found', 'warning');
                }
            };
        };

        window.editShift = function(day, shiftIndex) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            // Find the shift
            const shift = (schedule[day] || [])[shiftIndex];
            if (!shift) {
                showNotification('âŒ Shift not found', 'error');
                return;
            }
            const maxWorkers = shift.raw_assigned ? shift.raw_assigned.length : 1;
            const assignedEmails = new Set(shift.raw_assigned || []);
            // Editable time fields
            const startVal = shift.start;
            const endVal = shift.end;
            // Get workplace operating hours for this day
            const opHours = (hours[day] && hours[day][0]) ? hours[day][0] : { start: '00:00', end: '23:59' };
            // Build worker lists
            const availableWorkers = workers.filter(w => isWorkerAvailable(w, day, timeToHour(startVal), timeToHour(endVal)));
            const unavailableWorkers = workers.filter(w => !isWorkerAvailable(w, day, timeToHour(startVal), timeToHour(endVal)));
            // Format availability in AM/PM
            function formatAvail(w) {
                return Object.entries(w.availability).map(([d, slots]) => `${d}: ${slots.map(s => formatTime(s.start) + '-' + formatTime(s.end)).join(', ')}`).join('; ');
            }
            let html = `<div><strong>Shift:</strong> ${day} <input type='time' id='editShiftStart' value='${startVal}'> - <input type='time' id='editShiftEnd' value='${endVal}'> <span style='font-size:0.9em;color:#888;'>(AM/PM shown below)</span></div>`;
            html += `<div style='margin: 1rem 0;'><strong>Assigned:</strong> <span id='editShiftAssignedCount'></span> / ${maxWorkers}</div>`;
            html += `<div><strong>Available Workers</strong></div><div>`;
            availableWorkers.forEach(w => {
                const checked = assignedEmails.has(w.email) ? 'checked' : '';
                html += `<label><input type='checkbox' name='editShiftWorker' value='${w.email}' ${checked}> ${w.first_name} ${w.last_name} <small>(${formatAvail(w)})</small></label><br>`;
            });
            html += `</div><div style='margin-top:0.5rem;'><strong>Unavailable Workers</strong></div><div>`;
            unavailableWorkers.forEach(w => {
                const checked = assignedEmails.has(w.email) ? 'checked' : '';
                html += `<label><input type='checkbox' name='editShiftWorker' value='${w.email}' ${checked}> ${w.first_name} ${w.last_name} <small>(${formatAvail(w)})</small></label><br>`;
            });
            html += `</div><div style='margin-top:1rem;'>
                <button class='btn btn-success' id='saveEditShiftBtn'>Save</button>
                <button class='btn btn-secondary' onclick="closeModal('editShiftModal')">Cancel</button>
            </div>`;
            document.getElementById('editShiftModalBody').innerHTML = html;
            document.getElementById('editShiftModal').style.display = 'block';
            // Selection logic
            function updateAssignedCount() {
                const checked = document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]:checked');
                document.getElementById('editShiftAssignedCount').textContent = checked.length;
                // Enforce max
                document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]').forEach(input => {
                    if (!input.checked && checked.length >= maxWorkers) input.disabled = true;
                    else input.disabled = false;
                });
            }
            document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]').forEach(input => {
                input.addEventListener('change', updateAssignedCount);
            });
            updateAssignedCount();
            // Save logic
            document.getElementById('saveEditShiftBtn').onclick = function() {
                const checked = Array.from(document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]:checked')).map(i => i.value);
                if (checked.length === 0) {
                    showNotification('âŒ At least one worker must be assigned', 'error');
                    return;
                }
                // Get new times
                const newStart = document.getElementById('editShiftStart').value;
                const newEnd = document.getElementById('editShiftEnd').value;
                if (!newStart || !newEnd) {
                    showNotification('âŒ Start and end times are required', 'error');
                    return;
                }
                // Handle overnight shifts properly (when end time is midnight or earlier than start time)
                const startHour = timeToHour(newStart);
                const endHour = timeToHour(newEnd);
                
                // If end time is midnight (00:00) or earlier than start time, it's an overnight shift
                if (endHour <= startHour && endHour !== 0) {
                    showNotification('âŒ End time must be after start time', 'error');
                    return;
                }
                
                // For overnight shifts (end time is midnight), we need to add 24 hours to end time for comparison
                const adjustedEndHour = endHour === 0 ? 24 : endHour;
                if (adjustedEndHour <= startHour) {
                    showNotification('âŒ End time must be after start time', 'error');
                    return;
                }
                // Validate within operating hours (handle overnight shifts)
                const opStartHour = timeToHour(opHours.start);
                const opEndHour = timeToHour(opHours.end);
                const shiftStartHour = timeToHour(newStart);
                const shiftEndHour = timeToHour(newEnd);
                
                // For overnight shifts, adjust the end time
                const adjustedShiftEndHour = shiftEndHour === 0 ? 24 : shiftEndHour;
                const adjustedOpEndHour = opEndHour === 0 ? 24 : opEndHour;
                
                if (shiftStartHour < opStartHour || adjustedShiftEndHour > adjustedOpEndHour) {
                    showNotification(`âŒ Shift must be within operating hours: ${formatTime(opHours.start)} - ${formatTime(opHours.end)}`, 'error');
                    return;
                }
                // Update in-memory schedule
                const newAssigned = checked.map(email => {
                    const w = workers.find(x => x.email === email);
                    return w ? `${w.first_name} ${w.last_name}` : email;
                });
                shift.assigned = newAssigned;
                shift.raw_assigned = checked;
                shift.all_available = workers.filter(w => checked.includes(w.email));
                shift.start = newStart;
                shift.end = newEnd;
                showNotification('âœ… Shift updated (not yet saved to database)', 'success');
                closeModal('editShiftModal');
                displayEnhancedSchedule(schedule, calculateAssignedHours(schedule), [], [], false, []);
                // Save to Firestore
                if (currentScheduleId) {
                    const scheduleRef = doc(db, 'workplaces', selectedWorkplace, 'schedules', currentScheduleId);
                    updateDoc(scheduleRef, {
                        days: schedule,
                        updated_at: new Date().toISOString(),
                        updated_by: user.email
                    }).then(() => {
                        showNotification('âœ… Shift changes saved to database!', 'success');
                    }).catch((err) => {
                        showNotification('âŒ Failed to save shift changes to database', 'error');
                        console.error('Error saving shift edit:', err);
                    });
                } else {
                    showNotification('âš ï¸ Could not save to database: schedule ID not found', 'warning');
                }
            };
        };

        window.suggestAlternatives = function(day, shiftIndex) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            showNotification('ğŸ’¡ Alternative suggestions feature - Enhanced implementation coming soon!', 'info');
        };

        // Test Firebase connection
        async function testConnection() {
            try {
                console.log('Testing Firestore connection...');
                const workplacesSnapshot = await getDocs(collection(db, 'workplaces'));
                console.log(`âœ… Connected! Found ${workplacesSnapshot.size} workplaces in database.`);
                showNotification('âœ… Database connection successful', 'success');
            } catch (error) {
                console.error('âŒ Connection test failed:', error);
                showNotification('âŒ Database connection failed', 'error');
            }
        }

        testConnection();

        // Debug function to check current hours
        window.debugHours = function() {
            console.log('=== CURRENT HOURS DEBUG ===');
            console.log('Selected workplace:', selectedWorkplace);
            console.log('Current hours object:', hours);
            console.log('Sunday hours:', hours.Sunday);
            if (hours.Sunday && hours.Sunday[0]) {
                console.log('Sunday start:', hours.Sunday[0].start);
                console.log('Sunday end:', hours.Sunday[0].end);
            }
            console.log('==========================');
        };

        // Add SheetJS via CDN
        if (!window.XLSX) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
          document.head.appendChild(script);
        }

        window.showImportWorkers = function() {
          if (!user.isAdmin) {
            showNotification('âŒ Admin access required', 'error');
            return;
          }
          if (!selectedWorkplace) {
            showNotification('âš ï¸ Please select a workplace first', 'warning');
            return;
          }
          document.getElementById('importWorkersModalBody').innerHTML = `
            <div style='margin-bottom:1rem;'>
              <strong>Select an Excel file (.xlsx) with columns: First Name, Last Name, Email, Work Study, Days & Time Available.</strong>
            </div>
            <input type='file' id='importWorkersFile' accept='.xlsx,.xls,.csv'>
            <div id='importWorkersProgress' style='margin-top:1rem;'></div>
          `;
          document.getElementById('importWorkersModal').style.display = 'block';
          document.getElementById('importWorkersFile').onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('importWorkersProgress').innerHTML = 'ğŸ”„ Reading file...';
            // Wait for SheetJS to load
            function waitForSheetJS() {
              return new Promise(resolve => {
                if (window.XLSX) resolve();
                else setTimeout(() => resolve(waitForSheetJS()), 100);
              });
            }
            await waitForSheetJS();
            const reader = new FileReader();
            reader.onload = async function(evt) {
              const data = evt.target.result;
              let workbook;
              try {
                workbook = XLSX.read(data, { type: 'binary' });
              } catch (err) {
                document.getElementById('importWorkersProgress').innerHTML = 'âŒ Failed to read file.';
                return;
              }
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
              if (!rows.length) {
                document.getElementById('importWorkersProgress').innerHTML = 'âŒ No data found in file.';
                return;
              }
              document.getElementById('importWorkersProgress').innerHTML = 'ğŸ”„ Checking for duplicates...';
              // Get existing worker emails
              const existingSnapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
              const existingEmails = new Set();
              existingSnapshot.forEach(doc => {
                const data = doc.data();
                if (data['Email']) existingEmails.add(data['Email'].toLowerCase());
              });
              // Prepare new workers
              const newWorkers = [];
              const skipped = [];
              for (const row of rows) {
                const email = (row['Email'] || '').toLowerCase();
                if (!email || existingEmails.has(email)) {
                  skipped.push(email);
                  continue;
                }
                newWorkers.push({
                  'First Name': row['First Name'] || '',
                  'Last Name': row['Last Name'] || '',
                  'Email': row['Email'] || '',
                  'Work Study': (row['Work Study'] || '').toUpperCase() === 'Y' ? 'Yes' : 'No',
                  'Days & Times Available': row['Days & Time Available'] || '',
                  created_at: new Date().toISOString(),
                  created_by: user.email
                });
              }
              document.getElementById('importWorkersProgress').innerHTML = `Found ${newWorkers.length} new workers, ${skipped.length} duplicates.`;
              if (newWorkers.length === 0) {
                document.getElementById('importWorkersProgress').innerHTML += '<br>Nothing to import.';
                return;
              }
              document.getElementById('importWorkersProgress').innerHTML += '<br>Importing...';
              // Add to Firestore
              let added = 0;
              for (const worker of newWorkers) {
                try {
                  await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), worker);
                  added++;
                } catch (err) {
                  // skip
                }
              }
              document.getElementById('importWorkersProgress').innerHTML += `<br>âœ… Imported ${added} workers!`;
              showNotification(`âœ… Imported ${added} workers, skipped ${skipped.length} duplicates.`, 'success');
              await loadWorkplaceData();
            };
            reader.readAsBinaryString(file);
          };
        };

        // Add removeShift function
        window.removeShift = async function(day, shiftIndex) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            const shift = (schedule[day] || [])[shiftIndex];
            if (!shift) {
                showNotification('âŒ Shift not found', 'error');
                return;
            }
            const confirmMsg = `Are you sure you want to delete the shift on ${day} from ${formatTime(shift.start)} to ${formatTime(shift.end)}?`;
            if (!confirm(confirmMsg)) return;
            // Remove from in-memory schedule
            schedule[day].splice(shiftIndex, 1);
            showNotification('ğŸ—‘ï¸ Shift removed (not yet saved to database)', 'success');
            displayEnhancedSchedule(schedule, calculateAssignedHours(schedule), [], [], false, []);
            // Save to Firestore
            if (currentScheduleId) {
                const scheduleRef = doc(db, 'workplaces', selectedWorkplace, 'schedules', currentScheduleId);
                await updateDoc(scheduleRef, {
                    days: schedule,
                    updated_at: new Date().toISOString(),
                    updated_by: user.email
                });
                showNotification('ğŸ—‘ï¸ Shift removed and saved to database!', 'success');
            } else {
                showNotification('âš ï¸ Could not save to database: schedule ID not found', 'warning');
            }
        };

        // On page load or user check, hide View Workers for non-admins
        if (!user.isAdmin) {
            document.getElementById('viewWorkersBtn').style.display = 'none';
        }

        // Add removeWorker function
        window.removeWorker = async function(workerId) {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;
            if (!confirm(`Are you sure you want to delete ${worker.first_name} ${worker.last_name} (${worker.email})? This cannot be undone.`)) return;
            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId));
                showNotification('âœ… Worker deleted successfully!', 'success');
                await loadWorkplaceData();
                viewWorkers();
            } catch (error) {
                console.error('Error deleting worker:', error);
                showNotification('âŒ Error deleting worker', 'error');
            }
        };

        // Show/hide Who's Working Now button for admins
        if (user.isAdmin) {
            document.getElementById('whosWorkingNowBtn').style.display = 'inline-block';
        }

        // Add showWhosWorkingNow function
        window.showWhosWorkingNow = function() {
            if (!user.isAdmin) {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('âŒ No schedule loaded. View the current schedule first.', 'error');
                return;
            }
            // Get current day and time
            const now = new Date();
            const day = DAYS[now.getDay() === 0 ? 6 : now.getDay() - 1]; // JS: 0=Sunday, our DAYS: 0=Monday
            const curHour = now.getHours() + now.getMinutes() / 60;
            const shifts = (schedule[day] || []).filter(shift => {
                const start = timeToHour(shift.start);
                const end = timeToHour(shift.end);
                return start <= curHour && curHour < end && shift.assigned && shift.assigned.length > 0 && !shift.assigned.includes('Unfilled') && !shift.assigned.includes('COVERAGE GAP');
            });
            let html = `<div class='modal-content'><div class='modal-header'><h3>ğŸ•’ Who's Working Now?</h3><span class='close' onclick="closeModal('whosWorkingNowModal')">&times;</span></div>`;
            if (shifts.length === 0) {
                html += `<div class='info'>No one is currently scheduled to work right now (${day}, ${formatTime(hourToTime(curHour))}).</div>`;
            } else {
                html += `<table class='worker-table'><thead><tr><th>Name</th><th>Shift Time</th><th>Actions</th></tr></thead><tbody>`;
                shifts.forEach(shift => {
                    shift.assigned.forEach(name => {
                        // Find worker email for contact button
                        const email = (workers.find(w => `${w.first_name} ${w.last_name}` === name) || {}).email || '';
                        html += `<tr><td><strong>${name}</strong></td><td>${formatTime(shift.start)} - ${formatTime(shift.end)}</td><td><button class='btn btn-primary' onclick="contactWorker('${email}')">ğŸ“§ Contact</button></td></tr>`;
                    });
                });
                html += `</tbody></table>`;
            }
            html += `<div style='margin-top:1rem;'><button class='btn btn-secondary' onclick="closeModal('whosWorkingNowModal')">Close</button></div></div>`;
            // Show modal
            let modal = document.getElementById('whosWorkingNowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'whosWorkingNowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = html;
            modal.style.display = 'block';
            window.closeModal = function(id) {
                const m = document.getElementById(id);
                if (m) m.style.display = 'none';
            };
        };

        // In the script, show/hide user dashboard for non-admins
        if (!user.isAdmin) {
            document.getElementById('userDashboard').style.display = 'block';
            document.getElementById('adminSection').style.display = 'none';
            // Set welcome message
            let welcomeName = '';
            if (user.firstName && user.lastName) {
                welcomeName = `${user.firstName} ${user.lastName}`;
            } else if (user.firstName) {
                welcomeName = user.firstName;
            } else {
                welcomeName = user.email || 'User';
            }
            document.getElementById('userWelcome').textContent = `Welcome, ${welcomeName}!`;
            // Removed pre-fill of old account form fields (no longer present)
        }

        // My Account modal logic for all users
        document.getElementById('myAccountBtn').onclick = function() {
            // Pre-fill modal fields with user info
            document.getElementById('accountFirstNameModal').value = user.firstName || '';
            document.getElementById('accountLastNameModal').value = user.lastName || '';
            document.getElementById('accountEmailModal').value = user.email || '';
            document.getElementById('accountPhoneModal').value = user.phone || '';
            document.getElementById('currentEmailModal').value = user.email || '';
            document.getElementById('myAccountModal').style.display = 'block';
            
            // Load email change requests history
            loadEmailChangeRequestsHistory();
        };
        
        // Save account changes handler
        document.getElementById('saveAccountBtnModal').onclick = async function() {
            const firstName = document.getElementById('accountFirstNameModal').value.trim();
            const lastName = document.getElementById('accountLastNameModal').value.trim();
            const phone = document.getElementById('accountPhoneModal').value.trim();
            
            // Validation
            if (!firstName || !lastName) {
                showNotification('âŒ First name and last name are required', 'error');
                return;
            }
            
            try {
                // Update user document in Firestore
                const userDocRef = doc(db, 'users', user.uid);
                await updateDoc(userDocRef, {
                    firstName: firstName,
                    lastName: lastName,
                    phone: phone
                });
                
                // Update local user object
                user.firstName = firstName;
                user.lastName = lastName;
                user.phone = phone;
                
                // Update localStorage
                localStorage.setItem('user', JSON.stringify(user));
                
                // Update welcome message if user is non-admin
                if (!user.isAdmin) {
                    let welcomeName = '';
                    if (user.firstName && user.lastName) {
                        welcomeName = `${user.firstName} ${user.lastName}`;
                    } else if (user.firstName) {
                        welcomeName = user.firstName;
                    } else {
                        welcomeName = user.email || 'User';
                    }
                    document.getElementById('userWelcome').textContent = `Welcome, ${welcomeName}!`;
                }
                
                showNotification('âœ… Account information updated successfully', 'success');
                document.getElementById('myAccountModal').style.display = 'none';
            } catch (error) {
                console.error('Error updating account:', error);
                showNotification('âŒ Failed to update account information', 'error');
            }
        };
        
        // Change password handler
        document.getElementById('changePasswordBtnModal').onclick = async function() {
            const oldPassword = document.getElementById('oldPasswordModal').value;
            const newPassword = document.getElementById('newPasswordModal').value;
            const confirmNewPassword = document.getElementById('confirmNewPasswordModal').value;
            
            // Validation
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showNotification('âŒ All password fields are required', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showNotification('âŒ New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('âŒ New password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                // First verify the old password by checking against stored password
                if (oldPassword !== user.password) {
                    showNotification('âŒ Current password is incorrect', 'error');
                    return;
                }
                
                // Use pre-initialized auth database
                
                // Update password in AUTH database using correct document ID
                const userDocRef = doc(authDb, 'users', user.uid);
                await updateDoc(userDocRef, {
                    password: newPassword
                });
                
                // Update local user object
                user.password = newPassword;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Clear password fields
                document.getElementById('oldPasswordModal').value = '';
                document.getElementById('newPasswordModal').value = '';
                document.getElementById('confirmNewPasswordModal').value = '';
                
                showNotification('âœ… Password changed successfully', 'success');
                document.getElementById('myAccountModal').style.display = 'none';
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('âŒ Failed to change password', 'error');
            }
        };

        // --- EMAIL CHANGE REQUEST SYSTEM ---
        
        // Submit email change request handler
        document.getElementById('submitEmailChangeRequestBtn').onclick = async function() {
            console.log('Email change request button clicked');
            
            const newEmail = document.getElementById('newEmailModal').value.trim();
            const reason = document.getElementById('emailChangeReasonModal').value.trim();
            
            console.log('New email:', newEmail);
            console.log('Reason:', reason);
            console.log('User:', user);
            
            // Validation
            if (!newEmail) {
                showNotification('âŒ New email address is required', 'error');
                return;
            }
            
            if (newEmail === user.email) {
                showNotification('âŒ New email must be different from current email', 'error');
                return;
            }
            
            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showNotification('âŒ Please enter a valid email address', 'error');
                return;
            }
            
            try {
                console.log('Starting email change request submission...');
                console.log('AuthDb:', authDb);
                
                // Use email as userId if uid is not available
                const userId = user.uid || user.email;
                
                // Check if user already has 2 pending requests (try both userId and currentEmail)
                let pendingRequestsQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    where('userId', '==', userId),
                    where('status', '==', 'pending')
                );
                console.log('Pending requests query created for userId:', userId);
                
                let pendingSnapshot = await getDocs(pendingRequestsQuery);
                console.log('Pending requests count by userId:', pendingSnapshot.size);
                
                // If no results by userId, try currentEmail
                if (pendingSnapshot.empty && user.email) {
                    console.log('No pending requests by userId, trying currentEmail...');
                    pendingRequestsQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        where('currentEmail', '==', user.email),
                        where('status', '==', 'pending')
                    );
                    pendingSnapshot = await getDocs(pendingRequestsQuery);
                    console.log('Pending requests count by currentEmail:', pendingSnapshot.size);
                }
                
                if (pendingSnapshot.size >= 2) {
                    showNotification('âŒ You already have 2 pending email change requests. Please wait for admin approval.', 'error');
                    return;
                }
                
                // Check if this exact request already exists (try both userId and currentEmail)
                let existingRequestQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    where('userId', '==', userId),
                    where('requestedEmail', '==', newEmail),
                    where('status', '==', 'pending')
                );
                let existingSnapshot = await getDocs(existingRequestQuery);
                
                // If no results by userId, try currentEmail
                if (existingSnapshot.empty && user.email) {
                    existingRequestQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        where('currentEmail', '==', user.email),
                        where('requestedEmail', '==', newEmail),
                        where('status', '==', 'pending')
                    );
                    existingSnapshot = await getDocs(existingRequestQuery);
                }
                
                if (!existingSnapshot.empty) {
                    showNotification('âŒ You already have a pending request for this email address', 'error');
                    return;
                }
                
                console.log('Creating email change request...');
                
                // Create email change request
                await addDoc(collection(authDb, 'emailChangeRequests'), {
                    userId: userId,
                    currentEmail: user.email,
                    requestedEmail: newEmail,
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    reviewedBy: null,
                    reviewedAt: null,
                    adminNotes: null
                });
                
                console.log('Email change request created successfully');
                
                // Clear form
                document.getElementById('newEmailModal').value = '';
                document.getElementById('emailChangeReasonModal').value = '';
                
                showNotification('âœ… Email change request submitted successfully! Admin approval required.', 'success');
                
                // Reload history
                loadEmailChangeRequestsHistory();
                
            } catch (error) {
                console.error('Error submitting email change request:', error);
                console.error('Error details:', error.message, error.stack);
                showNotification('âŒ Failed to submit email change request', 'error');
            }
        };
        
        // Load email change requests history
        async function loadEmailChangeRequestsHistory() {
            console.log('Loading email change requests history...');
            console.log('User:', user);
            console.log('User email:', user.email);
            console.log('User uid:', user.uid);
            
            const listDiv = document.getElementById('emailChangeRequestsList');
            if (!listDiv) {
                console.error('emailChangeRequestsList element not found');
                return;
            }
            
            listDiv.innerHTML = '<div class="loading">Loading your email change requests...</div>';
            
            try {
                console.log('AuthDb:', authDb);
                
                // Use email as userId if uid is not available
                const userId = user.uid || user.email;
                console.log('Using userId:', userId);
                
                // Also try querying by currentEmail as a fallback
                let requestsQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    where('userId', '==', userId)
                );
                console.log('Requests query created for userId:', userId);
                
                let snapshot = await getDocs(requestsQuery);
                console.log('Snapshot received, size:', snapshot.size);
                
                // If no results found by userId, try searching by currentEmail
                if (snapshot.empty && user.email) {
                    console.log('No results by userId, trying currentEmail...');
                    requestsQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        where('currentEmail', '==', user.email)
                    );
                    snapshot = await getDocs(requestsQuery);
                    console.log('Snapshot by currentEmail, size:', snapshot.size);
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No email change requests found.</div>';
                    return;
                }
                
                // Sort by createdAt in descending order (newest first)
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const dateA = new Date(a.data().createdAt);
                    const dateB = new Date(b.data().createdAt);
                    return dateB - dateA;
                });
                
                let html = '';
                sortedDocs.forEach(doc => {
                    const data = doc.data();
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong>${data.requestedEmail}</strong>
                                <span class="status-badge ${statusBadgeClass}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                    ${data.status}
                                </span>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                                Requested: ${new Date(data.createdAt).toLocaleDateString()}
                            </div>
                            ${data.reason ? `<div style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Reason:</strong> ${data.reason}</div>` : ''}
                            ${data.status !== 'pending' ? `
                                <div style="font-size: 0.9rem; color: #666;">
                                    ${data.status === 'approved' ? 'âœ… Approved' : 'âŒ Denied'} by ${data.reviewedBy || 'Admin'} on ${data.reviewedAt ? new Date(data.reviewedAt).toLocaleDateString() : 'Unknown'}
                                </div>
                                ${data.adminNotes ? `<div style="font-size: 0.9rem; margin-top: 0.5rem;"><strong>Admin Notes:</strong> ${data.adminNotes}</div>` : ''}
                            ` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                console.log('Email change requests history loaded successfully');
                
            } catch (error) {
                console.error('Error loading email change requests:', error);
                console.error('Error details:', error.message, error.stack);
                listDiv.innerHTML = '<div class="error">Failed to load email change requests.</div>';
            }
        }

        // --- AVAILABILITY REQUESTS FEATURE ---
        // User: Open modal
        if (!user.isAdmin) {
            document.getElementById('requestAvailabilityBtn').onclick = function() {
                document.getElementById('requestName').value = user.firstName || '';
                document.getElementById('requestEmail').value = user.email || '';
                document.getElementById('requestAvailability').value = '';
                document.getElementById('availabilityRequestModal').style.display = 'block';
            };
            
            // User: Open time off request modal
            document.getElementById('requestTimeOffBtn').onclick = function() {
                // Set default start date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('timeOffStartDate').value = today;
                document.getElementById('timeOffEndDate').value = '';
                document.getElementById('timeOffReason').value = '';
                document.getElementById('timeOffRequestModal').style.display = 'block';
            };
            
            // User: Open shift swap request modal
            document.getElementById('requestShiftSwapBtn').onclick = function() {
                console.log('Shift swap button clicked!');
                console.log('Selected workplace:', selectedWorkplace);
                console.log('User:', user);
                
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                openShiftSwapRequestModal();
            };
        }
        // User: Submit request
        const availabilityRequestForm = document.getElementById('availabilityRequestForm');
        availabilityRequestForm.onsubmit = async function(e) {
            e.preventDefault();
            const name = document.getElementById('requestName').value.trim();
            const email = document.getElementById('requestEmail').value.trim();
            const requestedAvailability = document.getElementById('requestAvailability').value.trim();
            if (!selectedWorkplace) {
                showNotification('âŒ Please select a workplace first', 'error');
                return;
            }
            if (!name || !email || !requestedAvailability) {
                showNotification('âŒ All fields are required', 'error');
                return;
            }
            try {
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'availability_requests'), {
                    name,
                    email,
                    requestedAvailability,
                    status: 'pending',
                    submittedAt: new Date().toISOString(),
                });
                showNotification('âœ… Request submitted! Admins will review your request.', 'success');
                closeModal('availabilityRequestModal');
            } catch (error) {
                showNotification('âŒ Failed to submit request', 'error');
            }
        };
        
        // User: Submit time off request
        const timeOffRequestForm = document.getElementById('timeOffRequestForm');
        timeOffRequestForm.onsubmit = async function(e) {
            e.preventDefault();
            const startDate = document.getElementById('timeOffStartDate').value;
            const endDate = document.getElementById('timeOffEndDate').value;
            const reason = document.getElementById('timeOffReason').value.trim();
            
            if (!selectedWorkplace) {
                showNotification('âŒ Please select a workplace first', 'error');
                return;
            }
            if (!startDate) {
                showNotification('âŒ Start date is required', 'error');
                return;
            }
            
            // If no end date provided, use start date
            const finalEndDate = endDate || startDate;
            
            // Validate dates
            if (new Date(finalEndDate) < new Date(startDate)) {
                showNotification('âŒ End date cannot be before start date', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'), {
                    fromEmail: user.email,
                    fromName: `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email,
                    startDate,
                    endDate: finalEndDate,
                    reason,
                    status: 'pending',
                    submittedAt: new Date().toISOString(),
                });
                showNotification('âœ… Time off request submitted! Admins will review your request.', 'success');
                closeModal('timeOffRequestModal');
            } catch (error) {
                console.error('Error submitting time off request:', error);
                showNotification('âŒ Failed to submit time off request', 'error');
            }
        };
        
        // Admin: Hour Requests button logic
        if (user.isAdmin) {
            document.getElementById('hourRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('hourRequestsModal').style.display = 'block';
                loadHourRequests('all'); // Start with all requests
            };
            
            // Admin: Time Off Requests button logic
            document.getElementById('timeOffRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('timeOffRequestsModal').style.display = 'block';
                loadTimeOffRequests('all'); // Start with all requests
            };
            
            // Admin: Shift Swap Requests button logic
            document.getElementById('shiftSwapRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('shiftSwapRequestsModal').style.display = 'block';
                loadShiftSwapRequests();
            };
        }
        // Function to load hour requests for admin
        async function loadHourRequests(filter = 'all') {
            const listDiv = document.getElementById('hourRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading requests...</div>';
            
            try {
                let snapshot;
                if (filter === 'pending') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                        where('status', '==', 'pending')
                    ));
                } else if (filter === 'resolved') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                        where('status', '==', 'resolved')
                    ));
                } else {
                    // Load all requests
                    snapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'availability_requests'));
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="info">No ${filter} requests found.</div>`;
                    if (filter === 'all' || filter === 'pending') {
                        document.getElementById('hourRequestsBadge').style.display = 'none';
                    }
                    return;
                }
                
                // Sort by submitted date (newest first)
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                
                let html = `
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Requested Availability</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Reviewed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                requests.forEach(request => {
                    const submittedDate = new Date(request.submittedAt).toLocaleString();
                    const reviewedDate = request.reviewedAt ? new Date(request.reviewedAt).toLocaleString() : '-';
                    const statusBadge = request.status === 'pending' ? 
                        '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:0.8em;">Pending</span>' :
                        '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Resolved</span>';
                    
                    const actions = request.status === 'pending' ? 
                        `<button class='btn btn-success' onclick='markRequestReviewed("${request.id}")' style='margin-right:0.5rem;'>Mark as Reviewed</button>
                         <button class='btn btn-danger' onclick='deleteRequest("${request.id}")'>Delete</button>` :
                        `<button class='btn btn-danger' onclick='deleteRequest("${request.id}")'>Delete</button>`;
                    
                    html += `
                        <tr>
                            <td><strong>${request.name}</strong></td>
                            <td>${request.email}</td>
                            <td style="max-width: 300px; word-wrap: break-word;">${request.requestedAvailability}</td>
                            <td>${statusBadge}</td>
                            <td><small>${submittedDate}</small></td>
                            <td><small>${reviewedDate}</small></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                
                // Update badge based on pending requests
                if (filter === 'all' || filter === 'pending') {
                    const pendingSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                        where('status', '==', 'pending')
                    ));
                    document.getElementById('hourRequestsBadge').style.display = pendingSnapshot.empty ? 'none' : 'inline-block';
                }
                
            } catch (error) {
                console.error('Error loading requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load requests.</div>';
            }
        }
        // Mark request as reviewed
        window.markRequestReviewed = async function(requestId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'availability_requests', requestId), { status: 'resolved', reviewedAt: new Date().toISOString(), reviewedBy: user.email });
                showNotification('âœ… Request marked as reviewed.', 'success');
                loadHourRequests('all'); // Reload with current filter
            } catch (error) {
                showNotification('âŒ Failed to update request', 'error');
            }
        };

        // Delete request
        window.deleteRequest = async function(requestId) {
            if (confirm('Are you sure you want to delete this request? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'availability_requests', requestId));
                    showNotification('âœ… Request deleted.', 'success');
                    loadHourRequests('all'); // Reload with current filter
                } catch (error) {
                    showNotification('âŒ Failed to delete request', 'error');
                }
            }
        };

        // Filter requests
        window.filterRequests = function(filter) {
            // Update button styles
            document.getElementById('filterAllBtn').className = filter === 'all' ? 'btn btn-info active' : 'btn btn-info';
            document.getElementById('filterPendingBtn').className = filter === 'pending' ? 'btn btn-warning active' : 'btn btn-warning';
            document.getElementById('filterResolvedBtn').className = filter === 'resolved' ? 'btn btn-success active' : 'btn btn-success';
            
            loadHourRequests(filter);
        };
        // Badge update on workplace select
        async function updateHourRequestsBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('hourRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }
        // Call badge update on workplace select
        const origSelectWorkplace = window.selectWorkplace;
        window.selectWorkplace = async function(id) {
            await origSelectWorkplace(id);
            updateHourRequestsBadge();
            updateTimeOffRequestsBadge();
        };

        // --- TIME OFF REQUESTS FEATURE ---
        // Function to load time off requests for admin
        async function loadTimeOffRequests(filter = 'all') {
            const listDiv = document.getElementById('timeOffRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading time off requests...</div>';
            
            try {
                let snapshot;
                if (filter === 'pending') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'pending')
                    ));
                } else if (filter === 'approved') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'approved')
                    ));
                } else if (filter === 'denied') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'denied')
                    ));
                } else {
                    // Load all requests
                    snapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'));
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="info">No ${filter} time off requests found.</div>`;
                    if (filter === 'all' || filter === 'pending') {
                        document.getElementById('timeOffRequestsBadge').style.display = 'none';
                    }
                    return;
                }
                
                // Sort by submitted date (newest first)
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                
                let html = `
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Worker Name/Email</th>
                                <th>Time Off Period</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Reviewed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                requests.forEach(request => {
                    const submittedDate = new Date(request.submittedAt).toLocaleString();
                    const reviewedDate = request.reviewedAt ? new Date(request.reviewedAt).toLocaleString() : '-';
                    
                    // Format time off period
                    const startDate = new Date(request.startDate).toLocaleDateString();
                    const endDate = new Date(request.endDate).toLocaleDateString();
                    const timeOffPeriod = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
                    
                    // Status badge
                    let statusBadge;
                    if (request.status === 'pending') {
                        statusBadge = '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:0.8em;">Pending</span>';
                    } else if (request.status === 'approved') {
                        statusBadge = '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Approved</span>';
                    } else {
                        statusBadge = '<span style="background:#dc3545;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Denied</span>';
                    }
                    
                    // Actions
                    let actions = '';
                    if (request.status === 'pending') {
                        actions = `
                            <button class='btn btn-success' onclick='approveTimeOffRequest("${request.id}")' style='margin-right:0.5rem;'>Approve</button>
                            <button class='btn btn-danger' onclick='denyTimeOffRequest("${request.id}")' style='margin-right:0.5rem;'>Deny</button>
                            <button class='btn btn-secondary' onclick='deleteTimeOffRequest("${request.id}")'>Delete</button>
                        `;
                    } else {
                        actions = `<button class='btn btn-secondary' onclick='deleteTimeOffRequest("${request.id}")'>Delete</button>`;
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${request.fromName}</strong><br><small>${request.fromEmail}</small></td>
                            <td><strong>${timeOffPeriod}</strong></td>
                            <td style="max-width: 200px; word-wrap: break-word;">${request.reason || '<em>No reason provided</em>'}</td>
                            <td>${statusBadge}</td>
                            <td><small>${submittedDate}</small></td>
                            <td><small>${reviewedDate}</small></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                
                // Update badge based on pending requests
                if (filter === 'all' || filter === 'pending') {
                    const pendingSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'pending')
                    ));
                    document.getElementById('timeOffRequestsBadge').style.display = pendingSnapshot.empty ? 'none' : 'inline-block';
                }
                
            } catch (error) {
                console.error('Error loading time off requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load time off requests.</div>';
            }
        }

        // Approve time off request
        window.approveTimeOffRequest = async function(requestId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'time_off_requests', requestId), { 
                    status: 'approved', 
                    reviewedAt: new Date().toISOString(), 
                    reviewedBy: user.email 
                });
                showNotification('âœ… Time off request approved.', 'success');
                loadTimeOffRequests('all'); // Reload with current filter
            } catch (error) {
                showNotification('âŒ Failed to approve request', 'error');
            }
        };

        // Deny time off request
        window.denyTimeOffRequest = async function(requestId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'time_off_requests', requestId), { 
                    status: 'denied', 
                    reviewedAt: new Date().toISOString(), 
                    reviewedBy: user.email 
                });
                showNotification('âŒ Time off request denied.', 'success');
                loadTimeOffRequests('all'); // Reload with current filter
            } catch (error) {
                showNotification('âŒ Failed to deny request', 'error');
            }
        };

        // Delete time off request
        window.deleteTimeOffRequest = async function(requestId) {
            if (confirm('Are you sure you want to delete this time off request? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'time_off_requests', requestId));
                    showNotification('âœ… Time off request deleted.', 'success');
                    loadTimeOffRequests('all'); // Reload with current filter
                } catch (error) {
                    showNotification('âŒ Failed to delete request', 'error');
                }
            }
        };

        // Filter time off requests
        window.filterTimeOffRequests = function(filter) {
            // Update button styles
            document.getElementById('filterTimeOffAllBtn').className = filter === 'all' ? 'btn btn-info active' : 'btn btn-info';
            document.getElementById('filterTimeOffPendingBtn').className = filter === 'pending' ? 'btn btn-warning active' : 'btn btn-warning';
            document.getElementById('filterTimeOffApprovedBtn').className = filter === 'approved' ? 'btn btn-success active' : 'btn btn-success';
            document.getElementById('filterTimeOffDeniedBtn').className = filter === 'denied' ? 'btn btn-danger active' : 'btn btn-danger';
            
            loadTimeOffRequests(filter);
        };

        // Badge update for time off requests
        async function updateTimeOffRequestsBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('timeOffRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }

        // Open shift swap request modal and populate data
        async function openShiftSwapRequestModal() {
            console.log('openShiftSwapRequestModal called');
            console.log('selectedWorkplace:', selectedWorkplace);
            
            if (!selectedWorkplace) return;
            
            try {
                // Load current schedule to get available shifts (same approach as loadUserDashboard)
                let currentSchedule = null;
                let currentScheduleId = null;
                
                const currentSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    where('isCurrent', '==', true)
                ));
                
                if (!currentSnapshot.empty) {
                    currentSchedule = currentSnapshot.docs[0].data();
                    currentScheduleId = currentSnapshot.docs[0].id;
                } else {
                    // Fallback to most recent schedule
                    const recentSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        orderBy('createdAt', 'desc')
                    ));
                    if (!recentSnapshot.empty) {
                        currentSchedule = recentSnapshot.docs[0].data();
                        currentScheduleId = recentSnapshot.docs[0].id;
                    }
                }
                
                if (!currentSchedule) {
                    showNotification('âŒ No schedule found. Please generate a schedule first.', 'error');
                    return;
                }
                
                console.log('DEBUG: Found schedule:', currentSchedule);
                console.log('DEBUG: Schedule ID:', currentScheduleId);
                
                // Populate requester's shifts (shifts assigned to current user)
                const requesterShifts = [];
                for (const [day, shifts] of Object.entries(currentSchedule.days)) {
                    shifts.forEach((shift, index) => {
                        if (shift.raw_assigned && shift.raw_assigned.includes(user.email)) {
                            requesterShifts.push({
                                day,
                                date: getDateForDay(day),
                                time: `${shift.start}-${shift.end}`,
                                shiftIndex: index
                            });
                        }
                    });
                }
                
                // Populate target workers (all workers except current user)
                const targetWorkers = workers.filter(w => w.email !== user.email);
                
                // Populate form dropdowns
                const requesterTimeSelect = document.getElementById('swapRequesterShiftTime');
                const targetWorkerSelect = document.getElementById('swapTargetWorker');
                
                requesterTimeSelect.innerHTML = '<option value="">Select your shift time...</option>';
                requesterShifts.forEach(shift => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(shift);
                    option.textContent = `${shift.day} ${shift.date} - ${shift.time}`;
                    requesterTimeSelect.appendChild(option);
                });
                
                targetWorkerSelect.innerHTML = '<option value="">Select worker to swap with...</option>';
                targetWorkers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.email;
                    option.textContent = `${worker.first_name} ${worker.last_name} (${worker.email})`;
                    targetWorkerSelect.appendChild(option);
                });
                
                // Add event listener to populate target worker's shifts when selected
                targetWorkerSelect.addEventListener('change', function() {
                    const selectedWorkerEmail = this.value;
                    const targetShiftTimeSelect = document.getElementById('swapTargetShiftTime');
                    
                    if (!selectedWorkerEmail) {
                        targetShiftTimeSelect.innerHTML = '<option value="">Select their shift time...</option>';
                        return;
                    }
                    
                    // Find shifts for the selected worker
                    const targetWorkerShifts = [];
                    for (const [day, shifts] of Object.entries(currentSchedule.days)) {
                        shifts.forEach((shift, index) => {
                            if (shift.raw_assigned && shift.raw_assigned.includes(selectedWorkerEmail)) {
                                targetWorkerShifts.push({
                                    day,
                                    date: getDateForDay(day),
                                    time: `${shift.start}-${shift.end}`,
                                    shiftIndex: index
                                });
                            }
                        });
                    }
                    
                    // Populate the target shift time dropdown
                    targetShiftTimeSelect.innerHTML = '<option value="">Select their shift time...</option>';
                    targetWorkerShifts.forEach(shift => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(shift);
                        option.textContent = `${shift.day} ${shift.date} - ${shift.time}`;
                        targetShiftTimeSelect.appendChild(option);
                    });
                    
                    console.log('DEBUG: Found shifts for', selectedWorkerEmail, ':', targetWorkerShifts);
                });
                
                // Set default dates
                const today = new Date();
                document.getElementById('swapRequesterShiftDate').value = today.toISOString().split('T')[0];
                document.getElementById('swapTargetShiftDate').value = today.toISOString().split('T')[0];
                
                document.getElementById('shiftSwapRequestModal').style.display = 'block';
                
            } catch (error) {
                showNotification('âŒ Failed to load schedule data', 'error');
            }
        }

        // Helper function to get date for a day of the week
        function getDateForDay(dayName) {
            const today = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const targetDay = days.indexOf(dayName);
            const currentDay = today.getDay();
            const daysToAdd = (targetDay - currentDay + 7) % 7;
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysToAdd);
            return targetDate.toISOString().split('T')[0];
        }

        // Helper function to get day name from date
        function getDayFromDate(dateString) {
            const date = new Date(dateString);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        // After loadWorkplaceData, add:
        async function loadUserDashboard() {
            if (user.isAdmin || !selectedWorkplace) return;
            const userEmail = user.email.trim().toLowerCase();
            console.log('DEBUG: userEmail:', userEmail);
            console.log('DEBUG: selectedWorkplace:', selectedWorkplace);
            try {
                // Find current schedule
                let scheduleData = null;
                const currentSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    where('isCurrent', '==', true)
                ));
                if (!currentSnapshot.empty) {
                    scheduleData = currentSnapshot.docs[0].data();
                } else {
                    // Fallback to most recent
                    const recentSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        orderBy('createdAt', 'desc')
                    ));
                    if (!recentSnapshot.empty) {
                        scheduleData = recentSnapshot.docs[0].data();
                    }
                }
                console.log('DEBUG: scheduleData:', scheduleData);
                let myShiftsByDay = {};
                let totalHours = 0;
                if (scheduleData && scheduleData.days) {
                    // Find user's shifts
                    for (const day of DAYS) {
                        const shifts = scheduleData.days[day] || [];
                        myShiftsByDay[day] = shifts.filter(shift => {
                            if (!shift.raw_assigned || !Array.isArray(shift.raw_assigned)) return false;
                            return shift.raw_assigned.some(email => 
                                email && email.trim().toLowerCase() === userEmail
                            );
                        });
                        // Calculate hours for this day
                        myShiftsByDay[day].forEach(shift => {
                            if (shift.start && shift.end) {
                                const startHour = timeToHour(shift.start);
                                const endHour = timeToHour(shift.end);
                                totalHours += (endHour - startHour);
                            }
                        });
                    }
                }
                console.log('DEBUG: myShiftsByDay:', myShiftsByDay);
                console.log('DEBUG: totalHours:', totalHours);
                // Build shifts display
                let shiftsHtml = '';
                let hasShifts = false;
                for (const day of DAYS) {
                    const shifts = myShiftsByDay[day] || [];
                    if (shifts.length > 0) {
                        hasShifts = true;
                        shiftsHtml += `<div style='margin-bottom:0.5rem;'><strong>${day}</strong><ul style='margin:0.5em 0 0 1.5em;padding:0;'>`;
                        shifts.forEach(shift => {
                            shiftsHtml += `<li>${formatTime(shift.start)} - ${formatTime(shift.end)}</li>`;
                        });
                        shiftsHtml += '</ul></div>';
                    }
                }
                if (!hasShifts) {
                    shiftsHtml = '<div style="color:#888;">You have no assigned shifts for the current schedule.</div>';
                }
                // Update display
                document.getElementById('userShiftsPlaceholder').innerHTML = shiftsHtml;
                document.getElementById('userHoursPlaceholder').innerHTML = `<strong>${totalHours.toFixed(1)}</strong> hours assigned this week.`;
                // Show the dashboard
                document.getElementById('userDashboard').style.display = 'block';
                console.log('User dashboard should now be visible');
            } catch (error) {
                console.error('Error loading user dashboard:', error);
                document.getElementById('userShiftsPlaceholder').innerHTML = '<div style="color:#888;">Error loading your shifts.</div>';
                document.getElementById('userHoursPlaceholder').innerHTML = '<div style="color:#888;">Error calculating hours.</div>';
                document.getElementById('userDashboard').style.display = 'block';
                console.log('User dashboard shown due to error');
            }
        }

        // 3. Send message to admins (non-admins only)
        if (!user.isAdmin) {
            document.getElementById('sendUserMessageBtn').onclick = async function() {
                const message = document.getElementById('userMessageInput').value.trim();
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                if (!message) {
                    showNotification('âŒ Please enter a message', 'error');
                    return;
                }
                try {
                    await addDoc(collection(db, 'workplaces', selectedWorkplace, 'admin_messages'), {
                        fromEmail: user.email,
                        fromName: (user.firstName && user.lastName) ? `${user.firstName} ${user.lastName}` : user.email,
                        message,
                        sentAt: new Date().toISOString(),
                        status: 'unread'
                    });
                    showNotification('âœ… Message sent to admins!', 'success');
                    document.getElementById('userMessageInput').value = '';
                } catch (error) {
                    showNotification('âŒ Failed to send message', 'error');
                }
            };
        }
        // 4. Admin: View Messages button logic
        if (user.isAdmin) {
            document.getElementById('viewMessagesBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('adminMessagesModal').style.display = 'block';
                loadAdminMessages();
            };
        }
        // 5. Load admin messages for admin
        async function loadAdminMessages() {
            const listDiv = document.getElementById('adminMessagesList');
            listDiv.innerHTML = '<div class="loading">Loading messages...</div>';
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'admin_messages'),
                    orderBy('sentAt', 'desc')
                ));
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No messages found.</div>';
                    document.getElementById('messagesBadge').style.display = 'none';
                    return;
                }
                let html = `<table class="worker-table"><thead><tr><th>From</th><th>Email</th><th>Message</th><th>Sent</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const sentDate = new Date(data.sentAt).toLocaleString();
                    const statusBadge = data.status === 'unread' ? '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:0.8em;">Unread</span>' : '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Read</span>';
                    if (data.status === 'unread') unreadCount++;
                    html += `<tr><td><strong>${data.fromName || ''}</strong></td><td>${data.fromEmail || ''}</td><td style="max-width: 350px; word-wrap: break-word;">${data.message || ''}</td><td><small>${sentDate}</small></td><td>${statusBadge}</td><td>`;
                    if (data.status === 'unread') {
                        html += `<button class='btn btn-success' onclick='markMessageRead("${doc.id}")' style='margin-right:0.5rem;'>Mark as Read</button>`;
                    }
                    html += `<button class='btn btn-danger' onclick='deleteAdminMessage("${doc.id}")'>Delete</button></td></tr>`;
                });
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                document.getElementById('messagesBadge').style.display = unreadCount > 0 ? 'inline-block' : 'none';
            } catch (error) {
                listDiv.innerHTML = '<div class="error">Failed to load messages.</div>';
            }
        }
        // 6. Mark message as read
        window.markMessageRead = async function(messageId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'admin_messages', messageId), { status: 'read' });
                showNotification('âœ… Message marked as read.', 'success');
                loadAdminMessages();
            } catch (error) {
                showNotification('âŒ Failed to update message', 'error');
            }
        };
        // 7. Delete admin message
        window.deleteAdminMessage = async function(messageId) {
            if (confirm('Are you sure you want to delete this message? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'admin_messages', messageId));
                    showNotification('âœ… Message deleted.', 'success');
                    loadAdminMessages();
                } catch (error) {
                    showNotification('âŒ Failed to delete message', 'error');
                }
            }
        };
        // 8. Badge update on workplace select
        async function updateMessagesBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'admin_messages'),
                    where('status', '==', 'unread')
                ));
                document.getElementById('messagesBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }
        // 9. Call badge update on workplace select
        const origSelectWorkplaceMsgs = window.selectWorkplace;
        window.selectWorkplace = async function(id) {
            await origSelectWorkplaceMsgs(id);
            updateHourRequestsBadge();
            updateMessagesBadge();
            updateEmailChangeRequestsBadge();
        };

        // Remove All Workers button logic (admin only)
        if (user.isAdmin) {
            document.getElementById('removeAllWorkersBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                if (!confirm('Are you sure you want to delete ALL workers from this workplace? This cannot be undone!')) return;
                try {
                    const workersSnap = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                    let deleteCount = 0;
                    for (const docSnap of workersSnap.docs) {
                        await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', docSnap.id));
                        deleteCount++;
                    }
                    showNotification(`âœ… Deleted ${deleteCount} workers from ${selectedWorkplace}.`, 'success');
                    await loadWorkplaceData();
                } catch (error) {
                    showNotification('âŒ Failed to delete all workers', 'error');
                }
            };
        }

        // --- ADMIN EMAIL CHANGE REQUESTS MANAGEMENT ---
        
        // Email change requests button handler (admin only)
        if (user.isAdmin) {
            document.getElementById('emailChangeRequestsBtn').onclick = function() {
                document.getElementById('adminEmailChangeRequestsModal').style.display = 'block';
                loadAdminEmailChangeRequests();
            };
        }
        
        // Load admin email change requests
        async function loadAdminEmailChangeRequests(filter = 'all') {
            const listDiv = document.getElementById('adminEmailChangeRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading email change requests...</div>';
            
            try {
                // Use pre-initialized auth database
                
                let requestsQuery;
                if (filter === 'all') {
                    requestsQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        orderBy('createdAt', 'desc')
                    );
                } else {
                    requestsQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        where('status', '==', filter),
                        orderBy('createdAt', 'desc')
                    );
                }
                
                const snapshot = await getDocs(requestsQuery);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No email change requests found.</div>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0;">${data.currentEmail} â†’ ${data.requestedEmail}</h4>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        <strong>User ID:</strong> ${data.userId}<br>
                                        <strong>Requested:</strong> ${new Date(data.createdAt).toLocaleString()}
                                    </div>
                                </div>
                                <span class="status-badge ${statusBadgeClass}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                    ${data.status}
                                </span>
                            </div>
                            ${data.reason ? `<div style="font-size: 0.9rem; margin-bottom: 1rem;"><strong>Reason:</strong> ${data.reason}</div>` : ''}
                            ${data.status !== 'pending' ? `
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                                    ${data.status === 'approved' ? 'âœ… Approved' : 'âŒ Denied'} by ${data.reviewedBy || 'Admin'} on ${data.reviewedAt ? new Date(data.reviewedAt).toLocaleString() : 'Unknown'}
                                </div>
                                ${data.adminNotes ? `<div style="font-size: 0.9rem; margin-bottom: 1rem;"><strong>Admin Notes:</strong> ${data.adminNotes}</div>` : ''}
                            ` : ''}
                            ${data.status === 'pending' ? `
                                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                    <button class="btn btn-success" onclick="approveEmailChangeRequest('${doc.id}', '${data.userId}', '${data.currentEmail}', '${data.requestedEmail}')">âœ… Approve</button>
                                    <button class="btn btn-danger" onclick="denyEmailChangeRequest('${doc.id}', '${data.userId}')">âŒ Deny</button>
                                    <button class="btn btn-info" onclick="addAdminNotes('${doc.id}')">ğŸ“ Add Notes</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading admin email change requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load email change requests.</div>';
            }
        }
        
        // Filter email change requests
        window.filterEmailChangeRequests = function(filter) {
            loadAdminEmailChangeRequests(filter);
        };
        
        // Approve email change request
        window.approveEmailChangeRequest = async function(requestId, userId, currentEmail, newEmail) {
            if (!confirm(`Are you sure you want to approve this email change from ${currentEmail} to ${newEmail}?`)) {
                return;
            }
            
            try {
                // Use pre-initialized auth database
                
                // Update the request status
                const requestRef = doc(authDb, 'emailChangeRequests', requestId);
                await updateDoc(requestRef, {
                    status: 'approved',
                    reviewedBy: user.email,
                    reviewedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // Update user email in AUTH database
                const userRef = doc(authDb, 'users', userId);
                await updateDoc(userRef, {
                    email: newEmail
                });
                
                // Update user email in all workplace databases
                const workplaces = ['esports_lounge', 'esports_arena', 'it_service_center'];
                for (const workplace of workplaces) {
                    try {
                        // Update worker records
                        const workersQuery = query(
                            collection(db, 'workplaces', workplace, 'workers'),
                            where('Email', '==', currentEmail)
                        );
                        const workersSnapshot = await getDocs(workersQuery);
                        
                        for (const workerDoc of workersSnapshot.docs) {
                            await updateDoc(workerDoc.ref, {
                                Email: newEmail
                            });
                        }
                        
                        // Update any other collections that reference the email
                        // (schedules, requests, etc.)
                        const collectionsToUpdate = ['schedules', 'hourRequests', 'timeOffRequests', 'shiftSwaps', 'admin_messages'];
                        
                        for (const collectionName of collectionsToUpdate) {
                            try {
                                const collectionRef = collection(db, 'workplaces', workplace, collectionName);
                                const snapshot = await getDocs(collectionRef);
                                
                                for (const docSnapshot of snapshot.docs) {
                                    const data = docSnapshot.data();
                                    let needsUpdate = false;
                                    const updateData = {};
                                    
                                    // Check if any field contains the old email
                                    Object.keys(data).forEach(key => {
                                        if (typeof data[key] === 'string' && data[key] === currentEmail) {
                                            updateData[key] = newEmail;
                                            needsUpdate = true;
                                        }
                                    });
                                    
                                    if (needsUpdate) {
                                        await updateDoc(docSnapshot.ref, updateData);
                                    }
                                }
                            } catch (error) {
                                console.warn(`Error updating ${collectionName} in ${workplace}:`, error);
                            }
                        }
                    } catch (error) {
                        console.warn(`Error updating workplace ${workplace}:`, error);
                    }
                }
                
                showNotification('âœ… Email change approved and updated across all databases', 'success');
                loadAdminEmailChangeRequests();
                
            } catch (error) {
                console.error('Error approving email change request:', error);
                showNotification('âŒ Failed to approve email change request', 'error');
            }
        };
        
        // Deny email change request
        window.denyEmailChangeRequest = async function(requestId, userId) {
            const notes = prompt('Please provide a reason for denying this request (optional):');
            
            try {
                // Use pre-initialized auth database
                
                // Update the request status
                const requestRef = doc(authDb, 'emailChangeRequests', requestId);
                await updateDoc(requestRef, {
                    status: 'denied',
                    reviewedBy: user.email,
                    reviewedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    adminNotes: notes || null
                });
                
                showNotification('âŒ Email change request denied', 'success');
                loadAdminEmailChangeRequests();
                
            } catch (error) {
                console.error('Error denying email change request:', error);
                showNotification('âŒ Failed to deny email change request', 'error');
            }
        };
        
        // Add admin notes
        window.addAdminNotes = async function(requestId) {
            const notes = prompt('Enter admin notes:');
            if (!notes) return;
            
            try {
                // Use pre-initialized auth database
                
                const requestRef = doc(authDb, 'emailChangeRequests', requestId);
                await updateDoc(requestRef, {
                    adminNotes: notes,
                    updatedAt: new Date().toISOString()
                });
                
                showNotification('âœ… Admin notes added', 'success');
                loadAdminEmailChangeRequests();
                
            } catch (error) {
                console.error('Error adding admin notes:', error);
                showNotification('âŒ Failed to add admin notes', 'error');
            }
        };
        
        // Export email change requests
        window.exportEmailChangeRequests = async function() {
            try {
                // Use pre-initialized auth database
                
                const requestsQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    orderBy('createdAt', 'desc')
                );
                const snapshot = await getDocs(requestsQuery);
                
                let csvContent = 'User ID,Current Email,Requested Email,Reason,Status,Created At,Reviewed By,Reviewed At,Admin Notes\n';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    csvContent += `"${data.userId}","${data.currentEmail}","${data.requestedEmail}","${data.reason || ''}","${data.status}","${data.createdAt}","${data.reviewedBy || ''}","${data.reviewedAt || ''}","${data.adminNotes || ''}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `email_change_requests_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('ğŸ“„ Email change requests exported to CSV', 'success');
                
            } catch (error) {
                console.error('Error exporting email change requests:', error);
                showNotification('âŒ Failed to export email change requests', 'error');
            }
        };
        
        // Update email change requests badge
        async function updateEmailChangeRequestsBadge() {
            if (!user.isAdmin) return;
            try {
                // Use pre-initialized auth database
                
                const snapshot = await getDocs(query(
                    collection(authDb, 'emailChangeRequests'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('emailChangeRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }
        // Clean Up Old Schedules button logic (admin only)
        if (user.isAdmin) {
            document.getElementById('cleanupSchedulesBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                if (!confirm('WARNING: This will permanently delete all schedules older than 6 months (unless they have a retainUntil date in the future). Are you sure you want to continue?')) return;
                try {
                    const now = new Date();
                    const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                    const schedulesSnap = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'schedules'));
                    let deleteCount = 0;
                    for (const docSnap of schedulesSnap.docs) {
                        const data = docSnap.data();
                        const createdAt = data.createdAt ? new Date(data.createdAt) : null;
                        const retainUntil = data.retainUntil ? new Date(data.retainUntil) : null;
                        if (createdAt && createdAt < sixMonthsAgo && (!retainUntil || retainUntil < now)) {
                            await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', docSnap.id));
                            deleteCount++;
                        }
                    }
                    showNotification(`âœ… Deleted ${deleteCount} old schedules from ${selectedWorkplace}.`, 'success');
                    viewHistory();
                } catch (error) {
                    showNotification('âŒ Failed to clean up old schedules', 'error');
                }
            };
        }

        // Simple shift validation without Zod dependency
        function validateShift(shift) {
            try {
                // Basic validation without external dependencies
                if (!shift.start || !shift.end) {
                    throw new Error('Start and end times are required');
                }
                
                // Check time format (HH:MM)
                const timeRegex = /^\d{2}:\d{2}$/;
                if (!timeRegex.test(shift.start) || !timeRegex.test(shift.end)) {
                    throw new Error('Invalid time format. Use HH:MM format');
                }
                
                // Check that end is after start
                const startHour = timeToHour(shift.start);
                const endHour = timeToHour(shift.end);
                if (endHour <= startHour && endHour !== 0) { // Allow midnight (00:00)
                    throw new Error('End time must be after start time');
                }
                
                // Check required fields
                if (!shift.assigned || !Array.isArray(shift.assigned) || shift.assigned.length === 0) {
                    throw new Error('At least one assigned worker is required');
                }
                
                if (!shift.raw_assigned || !Array.isArray(shift.raw_assigned) || shift.raw_assigned.length === 0) {
                    throw new Error('Raw assigned data is required');
                }
                
                return true;
            } catch (err) {
                console.error('Shift validation error:', err.message);
                return false;
            }
        }

        // --- SHIFT SWAP REQUEST SYSTEM ---



        // 4. Handle shift swap request form submission
        document.getElementById('shiftSwapRequestForm').addEventListener('submit', async function(e) {
            try {
                console.log('DEBUG: Form submission started');
                e.preventDefault();
                
                console.log('DEBUG: Getting form values...');
                const requesterShiftData = JSON.parse(document.getElementById('swapRequesterShiftTime').value || '{}');
                const targetWorkerEmail = document.getElementById('swapTargetWorker').value;
                const targetShiftDate = document.getElementById('swapTargetShiftDate').value;
                const targetShiftTime = document.getElementById('swapTargetShiftTime').value;
                const reason = document.getElementById('swapReason').value.trim();
                
                console.log('DEBUG: Form values:', { requesterShiftData, targetWorkerEmail, targetShiftDate, targetShiftTime, reason });
                
                if (!requesterShiftData.day || !targetWorkerEmail || !targetShiftDate || !targetShiftTime) {
                    showNotification('âŒ Please fill in all required fields', 'error');
                    return;
                }
            
            try {
                console.log('DEBUG: Submitting shift swap request...');
                console.log('DEBUG: Workplace:', selectedWorkplace);
                console.log('DEBUG: User:', user.email);
                
                // Get target worker data directly from Firestore
                console.log('DEBUG: Getting worker data for:', targetWorkerEmail);
                const workersSnap = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                const targetWorker = workersSnap.docs.find(doc => doc.data().Email === targetWorkerEmail);
                const targetWorkerName = targetWorker ? 
                    `${targetWorker.data()['First Name']} ${targetWorker.data()['Last Name']}` : 
                    targetWorkerEmail;
                console.log('DEBUG: Target worker name:', targetWorkerName);
                
                // Create shift swap request
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'), {
                    requesterId: user.uid || user.email,
                    requesterName: (user.firstName && user.lastName) ? `${user.firstName} ${user.lastName}` : user.email,
                    requesterEmail: user.email,
                    requesterShift: {
                        day: requesterShiftData.day,
                        date: requesterShiftData.date,
                        time: requesterShiftData.time,
                        shiftIndex: requesterShiftData.shiftIndex
                    },
                    targetWorkerId: targetWorkerEmail,
                    targetWorkerName: targetWorkerName,
                    targetWorkerEmail: targetWorkerEmail,
                    targetWorkerShift: {
                        date: targetShiftDate,
                        time: targetShiftTime
                    },
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email
                });
                
                console.log('DEBUG: Shift swap request saved successfully!');
                showNotification('âœ… Shift swap request submitted successfully!', 'success');
                closeModal('shiftSwapRequestModal');
                document.getElementById('shiftSwapRequestForm').reset();
                
            } catch (error) {
                console.error('DEBUG: Error submitting shift swap request:', error);
                showNotification('âŒ Failed to submit shift swap request', 'error');
            }
        } catch (outerError) {
            console.error('DEBUG: Outer error in form submission:', outerError);
            showNotification('âŒ Form submission failed', 'error');
        }
        });

        // 5. Load and display shift swap requests
        async function loadShiftSwapRequests() {
            const listDiv = document.getElementById('shiftSwapRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading shift swap requests...</div>';
            
            try {
                // Clean up expired requests first
                await cleanupExpiredShiftSwapRequests();
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                    orderBy('createdAt', 'desc')
                ));
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No shift swap requests found.</div>';
                    document.getElementById('shiftSwapRequestsBadge').style.display = 'none';
                    return;
                }
                
                let html = '';
                let pendingCount = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'pending') pendingCount++;
                    
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div class="swap-request-card ${statusClass}">
                            <div class="swap-request-header">
                                <h4 class="swap-request-title">ğŸ”„ Shift Swap Request</h4>
                                <div class="swap-request-meta">
                                    <span class="status-badge ${statusBadgeClass}">${data.status}</span>
                                    <small>${new Date(data.createdAt).toLocaleDateString()}</small>
                                </div>
                            </div>
                            
                            <div class="swap-details">
                                <div class="swap-detail">
                                    <div class="swap-detail-label">From:</div>
                                    <div class="swap-detail-value">${data.requesterName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">To:</div>
                                    <div class="swap-detail-value">${data.targetWorkerName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Requester's Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            const [start, end] = data.requesterShift.time.split('-');
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                        } catch (e) {
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${data.requesterShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Target's Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            // Check if time is a JSON string and parse it
                                            const timeData = typeof data.targetWorkerShift.time === 'string' && data.targetWorkerShift.time.startsWith('{') 
                                                ? JSON.parse(data.targetWorkerShift.time) 
                                                : data.targetWorkerShift.time;
                                            
                                            if (typeof timeData === 'object' && timeData.time) {
                                                // Format the time properly
                                                const [start, end] = timeData.time.split('-');
                                                return `${timeData.day} ${timeData.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                            } else {
                                                // Simple time string
                                                return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                            }
                                        } catch (e) {
                                            return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                            </div>
                            
                            ${data.reason ? `<div class="swap-reason">ğŸ’¬ Reason: ${data.reason}</div>` : ''}
                            
                            ${data.deleteAfter ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>ğŸ—‘ï¸ Will be deleted on ${new Date(data.deleteAfter).toLocaleDateString()}</span>
                                ${data.requesterEmail === user.email ? `<button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">ğŸ—‘ï¸ Delete Now</button>` : ''}
                            </div>` : ''}
                            
                            ${!data.deleteAfter && data.requesterEmail === user.email ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>ğŸ—‘ï¸ No automatic deletion scheduled</span>
                                <button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">ğŸ—‘ï¸ Delete Now</button>
                            </div>` : ''}
                            
                            ${user.isAdmin && data.status === 'pending' ? `
                                <div class="swap-actions">
                                    <button class="btn btn-success" onclick="approveShiftSwap('${doc.id}')">âœ… Approve</button>
                                    <button class="btn btn-danger" onclick="denyShiftSwap('${doc.id}')">âŒ Deny</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                document.getElementById('shiftSwapRequestsBadge').style.display = pendingCount > 0 ? 'inline-block' : 'none';
                
            } catch (error) {
                listDiv.innerHTML = '<div class="error">Failed to load shift swap requests.</div>';
            }
        }

        // 6. Filter shift swap requests
        window.filterShiftSwapRequests = function(status) {
            const buttons = ['filterSwapAllBtn', 'filterSwapPendingBtn', 'filterSwapApprovedBtn', 'filterSwapDeniedBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.className = btn.className.replace(' btn-primary', ' btn-info');
            });
            
            document.getElementById(`filterSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className = 
                document.getElementById(`filterSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className.replace(' btn-info', ' btn-primary');
            
            loadShiftSwapRequests(status);
        };

        // 7. Approve shift swap request
        window.approveShiftSwap = async function(swapId) {
            if (!confirm('Are you sure you want to approve this shift swap? This will automatically update the schedule.')) return;
            
            try {
                // Get the swap request data
                const swapDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId));
                const swapData = swapDoc.data();
                
                if (!swapData) {
                    showNotification('âŒ Swap request not found', 'error');
                    return;
                }
                
                // Get current schedule
                const scheduleSnap = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc'),
                    where('isCurrent', '==', true)
                ));
                
                if (scheduleSnap.empty) {
                    showNotification('âŒ No current schedule found', 'error');
                    return;
                }
                
                const scheduleDoc = scheduleSnap.docs[0];
                const scheduleData = scheduleDoc.data();
                
                // Update the schedule by swapping the workers
                const updatedSchedule = { ...scheduleData.days };
                
                // Remove requester from their shift and add target worker
                const requesterShift = updatedSchedule[swapData.requesterShift.day][swapData.requesterShift.shiftIndex];
                requesterShift.raw_assigned = requesterShift.raw_assigned.filter(email => email !== swapData.requesterEmail);
                requesterShift.raw_assigned.push(swapData.targetWorkerEmail);
                
                // Find target worker's shift and swap them
                const targetDay = getDayFromDate(swapData.targetWorkerShift.date);
                if (targetDay && updatedSchedule[targetDay]) {
                    for (let i = 0; i < updatedSchedule[targetDay].length; i++) {
                        const shift = updatedSchedule[targetDay][i];
                        if (shift.raw_assigned && shift.raw_assigned.includes(swapData.targetWorkerEmail)) {
                            shift.raw_assigned = shift.raw_assigned.filter(email => email !== swapData.targetWorkerEmail);
                            shift.raw_assigned.push(swapData.requesterEmail);
                            break;
                        }
                    }
                }
                
                // Update the schedule in Firestore
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleDoc.id), {
                    days: updatedSchedule,
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email
                });
                
                // Update the swap request status
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId), {
                    status: 'approved',
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email,
                    deleteAfter: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // Delete in 7 days
                });
                
                showNotification('âœ… Shift swap approved and schedule updated! Request will be automatically deleted in 7 days.', 'success');
                loadShiftSwapRequests();
                
            } catch (error) {
                showNotification('âŒ Failed to approve shift swap', 'error');
            }
        };

        // 8. Deny shift swap request
        window.denyShiftSwap = async function(swapId) {
            if (!confirm('Are you sure you want to deny this shift swap request?')) return;
            
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId), {
                    status: 'denied',
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email,
                    deleteAfter: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // Delete in 7 days
                });
                
                showNotification('âŒ Shift swap request denied. Request will be automatically deleted in 7 days.', 'info');
                loadShiftSwapRequests();
                
            } catch (error) {
                showNotification('âŒ Failed to deny shift swap request', 'error');
            }
        };



        // 11. Update shift swap requests badge
        async function updateShiftSwapRequestsBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('shiftSwapRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }

        // 12. User: My Shift Swap Requests button logic
        if (!user.isAdmin) {
            document.getElementById('myShiftSwapRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('âŒ Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('userShiftSwapRequestsModal').style.display = 'block';
                loadUserShiftSwapRequests();
            };
        }

        // 13. Load user's own shift swap requests
        async function loadUserShiftSwapRequests(filter = 'all') {
            const listDiv = document.getElementById('userShiftSwapRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading your shift swap requests...</div>';
            
            try {
                // Clean up expired requests first
                await cleanupExpiredShiftSwapRequests();
                
                let snapshot;
                if (filter === 'pending') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email),
                        where('status', '==', 'pending')
                    ));
                } else if (filter === 'approved') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email),
                        where('status', '==', 'approved')
                    ));
                } else if (filter === 'denied') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email),
                        where('status', '==', 'denied')
                    ));
                } else {
                    // Load all user's requests
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email)
                    ));
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="info">No ${filter} shift swap requests found.</div>`;
                    return;
                }
                
                let html = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div class="swap-request-card ${statusClass}">
                            <div class="swap-request-header">
                                <h4 class="swap-request-title">ğŸ”„ Shift Swap Request</h4>
                                <div class="swap-request-meta">
                                    <span class="status-badge ${statusBadgeClass}">${data.status}</span>
                                    <small>${new Date(data.createdAt).toLocaleDateString()}</small>
                                </div>
                            </div>
                            
                            <div class="swap-details">
                                <div class="swap-detail">
                                    <div class="swap-detail-label">From:</div>
                                    <div class="swap-detail-value">${data.requesterName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">To:</div>
                                    <div class="swap-detail-value">${data.targetWorkerName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Your Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            const [start, end] = data.requesterShift.time.split('-');
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                        } catch (e) {
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${data.requesterShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Their Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            // Check if time is a JSON string and parse it
                                            const timeData = typeof data.targetWorkerShift.time === 'string' && data.targetWorkerShift.time.startsWith('{') 
                                                ? JSON.parse(data.targetWorkerShift.time) 
                                                : data.targetWorkerShift.time;
                                            
                                            if (typeof timeData === 'object' && timeData.time) {
                                                // Format the time properly
                                                const [start, end] = timeData.time.split('-');
                                                return `${timeData.day} ${timeData.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                            } else {
                                                // Simple time string
                                                return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                            }
                                        } catch (e) {
                                            return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                            </div>
                            
                            ${data.reason ? `<div class="swap-reason">ğŸ’¬ Reason: ${data.reason}</div>` : ''}
                            
                            ${data.deleteAfter ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>ğŸ—‘ï¸ Will be deleted on ${new Date(data.deleteAfter).toLocaleDateString()}</span>
                                ${data.requesterEmail === user.email ? `<button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">ğŸ—‘ï¸ Delete Now</button>` : ''}
                            </div>` : ''}
                            
                            ${!data.deleteAfter && data.requesterEmail === user.email ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>ğŸ—‘ï¸ No automatic deletion scheduled</span>
                                <button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">ğŸ—‘ï¸ Delete Now</button>
                            </div>` : ''}
                            
                            ${data.status !== 'pending' && data.updatedBy ? 
                                `<div class="swap-review">Reviewed by: ${data.updatedBy} on ${new Date(data.updatedAt).toLocaleDateString()}</div>` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                listDiv.innerHTML = '<div class="error">Failed to load your shift swap requests.</div>';
            }
        }

        // 14. Filter user shift swap requests
        window.filterUserShiftSwapRequests = function(status) {
            const buttons = ['filterUserSwapAllBtn', 'filterUserSwapPendingBtn', 'filterUserSwapApprovedBtn', 'filterUserSwapDeniedBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.className = btn.className.replace(' btn-primary', ' btn-info');
            });
            
            document.getElementById(`filterUserSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className = 
                document.getElementById(`filterUserSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className.replace(' btn-info', ' btn-primary');
            
            loadUserShiftSwapRequests(status);
        };

        // 15. Cleanup expired shift swap requests
        async function cleanupExpiredShiftSwapRequests() {
            if (!selectedWorkplace) return;
            
            try {
                const now = new Date().toISOString();
                const expiredSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                    where('deleteAfter', '<=', now)
                ));
                
                if (!expiredSnapshot.empty) {
                    const deletePromises = expiredSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    console.log(`Cleaned up ${expiredSnapshot.size} expired shift swap requests`);
                }
            } catch (error) {
                console.error('Error cleaning up expired shift swap requests:', error);
            }
        }

        // 16. Update badge when workplace is selected
        const origSelectWorkplaceSwap = window.selectWorkplace;
        window.selectWorkplace = async function(id) {
            await origSelectWorkplaceSwap(id);
            await cleanupExpiredShiftSwapRequests(); // Clean up expired requests
            updateShiftSwapRequestsBadge();
        };

        // 17. Manual delete shift swap request (for requesters)
        window.deleteMyShiftSwapRequest = async function(swapId) {
            if (!confirm('Are you sure you want to delete this shift swap request? This will permanently remove it for both you and the worker you requested to swap with. This action cannot be undone.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId));
                showNotification('âœ… Shift swap request deleted successfully', 'success');
                
                // Reload the appropriate list based on which modal is open
                if (document.getElementById('userShiftSwapRequestsModal').style.display === 'block') {
                    loadUserShiftSwapRequests();
                } else if (document.getElementById('shiftSwapRequestsModal').style.display === 'block') {
                    loadShiftSwapRequests();
                }
                
            } catch (error) {
                console.error('Error deleting shift swap request:', error);
                showNotification('âŒ Failed to delete shift swap request', 'error');
            }
        };

        // 18. Set up periodic cleanup (every hour)
        setInterval(async () => {
            if (selectedWorkplace) {
                await cleanupExpiredShiftSwapRequests();
            }
        }, 60 * 60 * 1000); // Run every hour

        // Enhanced Management Helper Functions - Global Scope
        window.filterWorkers = function() {
            const searchTerm = document.getElementById('workerSearch')?.value.toLowerCase() || '';
            const workStudyFilter = document.getElementById('workStudyFilter')?.value || '';
            const userLinkFilter = document.getElementById('userLinkFilter')?.value || '';
            
            const filteredWorkers = workers.filter(worker => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    worker.first_name.toLowerCase().includes(searchTerm) ||
                    worker.last_name.toLowerCase().includes(searchTerm) ||
                    worker.email.toLowerCase().includes(searchTerm);
                
                // Work study filter
                const matchesWorkStudy = !workStudyFilter || 
                    (workStudyFilter === 'work-study' && worker.work_study) ||
                    (workStudyFilter === 'regular' && !worker.work_study);
                
                // User link filter
                const linkedUser = window.allUsers?.find(u => u.email.toLowerCase() === worker.email.toLowerCase());
                const matchesUserLink = !userLinkFilter ||
                    (userLinkFilter === 'linked' && linkedUser) ||
                    (userLinkFilter === 'unlinked' && !linkedUser);
                
                return matchesSearch && matchesWorkStudy && matchesUserLink;
            });
            
            // Update table with filtered results
            updateWorkersTable(filteredWorkers);
        };

        window.filterUsers = function() {
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('userRoleFilter')?.value || '';
            const statusFilter = document.getElementById('userStatusFilter')?.value || '';
            
            const filteredUsers = window.allUsers?.filter(user => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    user.firstName.toLowerCase().includes(searchTerm) ||
                    user.lastName.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm);
                
                // Role filter
                const matchesRole = !roleFilter || 
                    (roleFilter === 'admin' && user.isAdmin) ||
                    (roleFilter === 'user' && !user.isAdmin);
                
                // Status filter
                const matchesStatus = !statusFilter || user.status === statusFilter;
                
                return matchesSearch && matchesRole && matchesStatus;
            }) || [];
            
            // Update table with filtered results
            updateUsersTable(filteredUsers);
        };

        window.updateWorkersTable = function(filteredWorkers = workers) {
            const container = document.getElementById('workersTableContainer');
            if (!container) return;
            
            if (filteredWorkers.length === 0) {
                container.innerHTML = '<div class="warning">No workers found matching your criteria.</div>';
                return;
            }

            let html = `
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllWorkersCheckbox" onchange="toggleSelectAllWorkers()"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>User Account</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredWorkers.forEach(worker => {
                const linkedUser = window.allUsers?.find(u => u.email.toLowerCase() === worker.email.toLowerCase());
                const userLinkStatus = linkedUser ? 
                    `<a href="#" class="user-worker-link" onclick="viewUserDetails('${linkedUser.id}')">âœ… Linked (${linkedUser.isAdmin ? 'Admin' : 'User'})</a>` :
                    `<span class="no-link">âŒ No User Account</span>`;

                html += `
                    <tr>
                        <td><input type="checkbox" class="worker-checkbox" value="${worker.id}" onchange="updateBulkActions()"></td>
                        <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '<span class="work-study-badge">Work Study</span>' : 'Regular'}</td>
                        <td>${userLinkStatus}</td>
                        <td><small>${worker.availability_text || 'No availability set'}</small></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-info" onclick="viewWorkerDetails('${worker.id}')">ğŸ‘ï¸ View</button>
                                <button class="btn btn-warning" onclick="editWorker('${worker.id}')">âœï¸ Edit</button>
                                <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        };

        window.updateUsersTable = function(filteredUsers = window.allUsers || []) {
            const container = document.getElementById('usersTableContainer');
            if (!container) return;
            
            if (filteredUsers.length === 0) {
                container.innerHTML = '<div class="warning">No users found matching your criteria.</div>';
                return;
            }

            let html = `
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllUsersCheckbox" onchange="toggleSelectAllUsers()"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Phone</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredUsers.forEach(user => {
                const statusBadge = user.status === 'active' ? 
                    '<span class="status-badge active">Active</span>' : 
                    '<span class="status-badge suspended">Suspended</span>';
                
                const roleBadge = user.isAdmin ? 
                    '<span class="status-badge active">Admin</span>' : 
                    '<span class="status-badge pending">User</span>';

                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never';

                html += `
                    <tr>
                        <td><input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateUserBulkActions()"></td>
                        <td><strong>${user.firstName} ${user.lastName}</strong></td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${user.phone || '-'}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-info" onclick="viewUserDetails('${user.id}')">ğŸ‘ï¸ View</button>
                                <button class="btn btn-warning" onclick="editUser('${user.id}')">âœï¸ Edit</button>
                                <button class="btn btn-secondary" onclick="toggleUserStatus('${user.id}')">${user.status === 'active' ? 'â¸ï¸ Suspend' : 'â–¶ï¸ Activate'}</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        };

        // Bulk Actions Functions - Global Scope
        window.updateBulkActions = function() {
            const checkboxes = document.querySelectorAll('.worker-checkbox:checked');
            const bulkActions = document.getElementById('workerBulkActions');
            
            if (checkboxes.length > 0) {
                bulkActions.style.display = 'block';
            } else {
                bulkActions.style.display = 'none';
            }
        };

        window.updateUserBulkActions = function() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const bulkActions = document.getElementById('userBulkActions');
            
            if (checkboxes.length > 0) {
                bulkActions.style.display = 'block';
            } else {
                bulkActions.style.display = 'none';
            }
        };

        window.toggleSelectAllWorkers = function() {
            const selectAll = document.getElementById('selectAllWorkersCheckbox');
            const checkboxes = document.querySelectorAll('.worker-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActions();
        };

        window.toggleSelectAllUsers = function() {
            const selectAll = document.getElementById('selectAllUsersCheckbox');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateUserBulkActions();
        };

        // Export Functions
        window.exportWorkers = function() {
            const csvContent = generateWorkersCSV();
            downloadCSV(csvContent, `workers_${selectedWorkplace}_${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportUsers = function() {
            const csvContent = generateUsersCSV();
            downloadCSV(csvContent, `users_${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportSchedule = function() {
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('âŒ No schedule loaded to export', 'error');
                return;
            }
            const csvContent = generateScheduleCSV();
            downloadCSV(csvContent, `schedule_${selectedWorkplace}_${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportAllData = function() {
            const csvContent = generateAllDataCSV();
            downloadCSV(csvContent, `all_data_${selectedWorkplace}_${new Date().toISOString().split('T')[0]}.csv`);
        };

        function generateWorkersCSV() {
            const headers = ['First Name', 'Last Name', 'Email', 'Work Study', 'Days & Times Available'];
            const rows = workers.map(worker => [
                worker.first_name,
                worker.last_name,
                worker.email,
                worker.work_study ? 'Yes' : 'No',
                worker.availability_text || ''
            ]);
            
            return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        }

        function generateUsersCSV() {
            const headers = ['First Name', 'Last Name', 'Email', 'Role', 'Status', 'Phone', 'Last Login'];
            const rows = window.allUsers?.map(user => [
                user.firstName,
                user.lastName,
                user.email,
                user.isAdmin ? 'Admin' : 'User',
                user.status,
                user.phone || '',
                user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'
            ]) || [];
            
            return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        }

        function generateScheduleCSV() {
            const headers = ['Day', 'Start Time', 'End Time', 'Assigned Workers', 'Work Study'];
            const rows = [];
            
            Object.entries(schedule).forEach(([day, shifts]) => {
                shifts.forEach(shift => {
                    rows.push([
                        day,
                        shift.start,
                        shift.end,
                        shift.assigned?.join(', ') || 'Unfilled',
                        shift.is_work_study ? 'Yes' : 'No'
                    ]);
                });
            });
            
            return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        }

        function generateAllDataCSV() {
            return `Workers Data:\n${generateWorkersCSV()}\n\nUsers Data:\n${generateUsersCSV()}\n\nSchedule Data:\n${generateScheduleCSV()}`;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ========================================
        // PHASE 2: SUPER ADMIN vs WORKPLACE ADMIN SYSTEM
        // ========================================
        
        // Role-based access control
        const USER_ROLES = {
            SUPER_ADMIN: 'super_admin',
            WORKPLACE_ADMIN: 'workplace_admin',
            USER: 'user'
        };

        // Current user role (will be set during login)
        let currentUserRole = USER_ROLES.USER;
        let currentUserWorkplaces = [];

        // Check if user has permission for specific action
        window.hasPermission = function(action, workplaceId = null) {
            switch(currentUserRole) {
                case USER_ROLES.SUPER_ADMIN:
                    return true; // Super admin has all permissions
                case USER_ROLES.WORKPLACE_ADMIN:
                    // Workplace admin can only manage their assigned workplaces
                    if (workplaceId && !currentUserWorkplaces.includes(workplaceId)) {
                        return false;
                    }
                    // Workplace admin permissions
                    const workplaceAdminActions = [
                        'manage_workers', 'view_schedule', 'edit_schedule', 
                        'manage_users', 'view_reports', 'export_data'
                    ];
                    return workplaceAdminActions.includes(action);
                case USER_ROLES.USER:
                    // Regular user permissions
                    const userActions = ['view_schedule', 'view_own_profile'];
                    return userActions.includes(action);
                default:
                    return false;
            }
        };

        // Get workplaces user can manage
        window.getUserWorkplaces = function() {
            if (currentUserRole === USER_ROLES.SUPER_ADMIN) {
                return workplaces; // Super admin can see all workplaces
            } else if (currentUserRole === USER_ROLES.WORKPLACE_ADMIN) {
                return workplaces.filter(wp => currentUserWorkplaces.includes(wp.id));
            }
            return [];
        };

        // Initialize user role and permissions
        window.initializeUserRole = function(user) {
            if (user.isSuperAdmin) {
                currentUserRole = USER_ROLES.SUPER_ADMIN;
                currentUserWorkplaces = workplaces.map(wp => wp.id);
            } else if (user.isAdmin) {
                currentUserRole = USER_ROLES.WORKPLACE_ADMIN;
                currentUserWorkplaces = user.assignedWorkplaces || [];
            } else {
                currentUserRole = USER_ROLES.USER;
                currentUserWorkplaces = [];
            }
            
            // Update UI based on permissions
            updateUIForUserRole();
        };

        // Update UI elements based on user role
        window.updateUIForUserRole = function() {
            // Hide/show admin features
            const adminElements = document.querySelectorAll('.admin-only');
            const superAdminElements = document.querySelectorAll('.super-admin-only');
            const workplaceAdminElements = document.querySelectorAll('.workplace-admin-only');
            
            adminElements.forEach(el => {
                el.style.display = (currentUserRole === USER_ROLES.SUPER_ADMIN || currentUserRole === USER_ROLES.WORKPLACE_ADMIN) ? '' : 'none';
            });
            
            superAdminElements.forEach(el => {
                el.style.display = (currentUserRole === USER_ROLES.SUPER_ADMIN) ? '' : 'none';
            });
            
            workplaceAdminElements.forEach(el => {
                el.style.display = (currentUserRole === USER_ROLES.WORKPLACE_ADMIN) ? '' : 'none';
            });

            // Update workplace selector
            updateWorkplaceSelector();
        };

        // Update workplace selector based on user permissions
        window.updateWorkplaceSelector = function() {
            const selector = document.getElementById('workplaceSelector');
            if (!selector) return;

            const userWorkplaces = getUserWorkplaces();
            
            // Clear current options
            selector.innerHTML = '';
            
            if (currentUserRole === USER_ROLES.SUPER_ADMIN) {
                // Super admin sees all workplaces
                workplaces.forEach(workplace => {
                    const option = document.createElement('option');
                    option.value = workplace.id;
                    option.textContent = workplace.name;
                    selector.appendChild(option);
                });
            } else if (currentUserRole === USER_ROLES.WORKPLACE_ADMIN) {
                // Workplace admin sees only their assigned workplaces
                userWorkplaces.forEach(workplaceId => {
                    const workplace = workplaces.find(wp => wp.id === workplaceId);
                    if (workplace) {
                        const option = document.createElement('option');
                        option.value = workplace.id;
                        option.textContent = workplace.name;
                        selector.appendChild(option);
                    }
                });
            }

            // Set default selection
            if (userWorkplaces.length > 0) {
                selector.value = userWorkplaces[0];
                selectedWorkplace = userWorkplaces[0];
                loadWorkplaceData();
            }
        };

        // Admin Management Functions
        window.showAdminManagement = function() {
            if (!hasPermission('manage_admins')) {
                showNotification('âŒ You do not have permission to manage admins', 'error');
                return;
            }

            const modal = document.getElementById('adminManagementModal');
            if (modal) {
                modal.style.display = 'block';
                loadAdminUsers();
            }
        };

        window.loadAdminUsers = function() {
            const container = document.getElementById('adminUsersContainer');
            if (!container) return;

            const adminUsers = window.allUsers?.filter(user => user.isAdmin || user.isSuperAdmin) || [];
            
            let html = `
                <div class="admin-management-header">
                    <h3>Admin Users Management</h3>
                    <button class="btn btn-primary" onclick="showAddAdmin()">â• Add New Admin</button>
                </div>
                <div class="admin-filters">
                    <input type="text" id="adminSearch" placeholder="Search admins..." onkeyup="filterAdmins()">
                    <select id="adminRoleFilter" onchange="filterAdmins()">
                        <option value="">All Roles</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="workplace_admin">Workplace Admin</option>
                        <option value="pending">Pending Approval</option>
                    </select>
                </div>
                <div id="adminUsersTableContainer">
            `;

            if (adminUsers.length === 0) {
                html += '<div class="warning">No admin users found.</div>';
            } else {
                html += `
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Assigned Workplaces</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                adminUsers.forEach(admin => {
                    const roleBadge = admin.isSuperAdmin ? 
                        '<span class="status-badge super-admin">Super Admin</span>' : 
                        '<span class="status-badge admin">Workplace Admin</span>';
                    
                    const statusBadge = admin.status === 'active' ? 
                        '<span class="status-badge active">Active</span>' : 
                        '<span class="status-badge suspended">Suspended</span>';

                    const assignedWorkplaces = admin.assignedWorkplaces?.map(wpId => {
                        const workplace = workplaces.find(wp => wp.id === wpId);
                        return workplace ? workplace.name : 'Unknown';
                    }).join(', ') || 'None assigned';

                    const lastLogin = admin.lastLogin ? new Date(admin.lastLogin).toLocaleDateString() : 'Never';

                    html += `
                        <tr>
                            <td><strong>${admin.firstName} ${admin.lastName}</strong></td>
                            <td>${admin.email}</td>
                            <td>${roleBadge}</td>
                            <td>${assignedWorkplaces}</td>
                            <td>${statusBadge}</td>
                            <td>${lastLogin}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-info" onclick="viewAdminDetails('${admin.id}')">ğŸ‘ï¸ View</button>
                                    <button class="btn btn-warning" onclick="editAdmin('${admin.id}')">âœï¸ Edit</button>
                                    <button class="btn btn-secondary" onclick="toggleAdminStatus('${admin.id}')">${admin.status === 'active' ? 'â¸ï¸ Suspend' : 'â–¶ï¸ Activate'}</button>
                                    <button class="btn btn-danger" onclick="deleteAdmin('${admin.id}')">ğŸ—‘ï¸ Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
            }

            html += '</div>';
            container.innerHTML = html;
        };

        window.showAddAdmin = function() {
            const modal = document.getElementById('addAdminModal');
            if (modal) {
                modal.style.display = 'block';
                
                // Populate workplace options
                const workplaceSelect = document.getElementById('adminWorkplaces');
                if (workplaceSelect) {
                    workplaceSelect.innerHTML = '';
                    workplaces.forEach(workplace => {
                        const option = document.createElement('option');
                        option.value = workplace.id;
                        option.textContent = workplace.name;
                        workplaceSelect.appendChild(option);
                    });
                }
            }
        };

        window.createAdmin = function() {
            const form = document.getElementById('addAdminForm');
            const formData = new FormData(form);
            
            const adminData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                role: formData.get('role'),
                assignedWorkplaces: formData.getAll('workplaces'),
                status: 'pending', // New admins start as pending
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.id || 'system'
            };

            // Validate data
            if (!adminData.firstName || !adminData.lastName || !adminData.email) {
                showNotification('âŒ Please fill in all required fields', 'error');
                return;
            }

            // Check if email already exists
            if (window.allUsers?.find(u => u.email.toLowerCase() === adminData.email.toLowerCase())) {
                showNotification('âŒ User with this email already exists', 'error');
                return;
            }

            // Add to Firestore
            const adminRef = db.collection('users').doc();
            adminRef.set({
                ...adminData,
                id: adminRef.id,
                isAdmin: adminData.role === 'workplace_admin',
                isSuperAdmin: adminData.role === 'super_admin'
            }).then(() => {
                showNotification('âœ… Admin user created successfully', 'success');
                document.getElementById('addAdminModal').style.display = 'none';
                form.reset();
                loadAdminUsers();
                loadUsers(); // Refresh users list
            }).catch(error => {
                console.error('Error creating admin:', error);
                showNotification('âŒ Error creating admin user', 'error');
            });
        };

        // Admin Action Functions
        window.viewAdminDetails = function(adminId) {
            const admin = window.allUsers?.find(u => u.id === adminId);
            if (!admin) {
                showNotification('âŒ Admin not found', 'error');
                return;
            }

            const assignedWorkplaces = admin.assignedWorkplaces?.map(wpId => {
                const workplace = workplaces.find(wp => wp.id === wpId);
                return workplace ? workplace.name : 'Unknown';
            }).join(', ') || 'None assigned';

            const modal = document.getElementById('adminDetailsModal');
            if (modal) {
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>ğŸ‘ï¸ Admin Details</h2>
                            <span class="close" onclick="this.parentElement.parentElement.parentElement.style.display='none'">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="admin-details">
                                <div class="detail-row">
                                    <strong>Name:</strong> ${admin.firstName} ${admin.lastName}
                                </div>
                                <div class="detail-row">
                                    <strong>Email:</strong> ${admin.email}
                                </div>
                                <div class="detail-row">
                                    <strong>Phone:</strong> ${admin.phone || 'Not provided'}
                                </div>
                                <div class="detail-row">
                                    <strong>Role:</strong> ${admin.isSuperAdmin ? 'Super Admin' : 'Workplace Admin'}
                                </div>
                                <div class="detail-row">
                                    <strong>Assigned Workplaces:</strong> ${assignedWorkplaces}
                                </div>
                                <div class="detail-row">
                                    <strong>Status:</strong> ${admin.status}
                                </div>
                                <div class="detail-row">
                                    <strong>Created:</strong> ${admin.createdAt ? new Date(admin.createdAt).toLocaleDateString() : 'Unknown'}
                                </div>
                                <div class="detail-row">
                                    <strong>Last Login:</strong> ${admin.lastLogin ? new Date(admin.lastLogin).toLocaleDateString() : 'Never'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                modal.style.display = 'block';
            }
        };

        window.editAdmin = function(adminId) {
            const admin = window.allUsers?.find(u => u.id === adminId);
            if (!admin) {
                showNotification('âŒ Admin not found', 'error');
                return;
            }

            // Populate edit form
            document.getElementById('editAdminId').value = adminId;
            document.getElementById('editAdminFirstName').value = admin.firstName;
            document.getElementById('editAdminLastName').value = admin.lastName;
            document.getElementById('editAdminEmail').value = admin.email;
            document.getElementById('editAdminPhone').value = admin.phone || '';
            document.getElementById('editAdminRole').value = admin.isSuperAdmin ? 'super_admin' : 'workplace_admin';
            
            // Populate workplace assignments
            const workplaceSelect = document.getElementById('editAdminWorkplaces');
            if (workplaceSelect) {
                workplaceSelect.innerHTML = '';
                workplaces.forEach(workplace => {
                    const option = document.createElement('option');
                    option.value = workplace.id;
                    option.textContent = workplace.name;
                    option.selected = admin.assignedWorkplaces?.includes(workplace.id) || false;
                    workplaceSelect.appendChild(option);
                });
            }

            // Show edit modal
            document.getElementById('editAdminModal').style.display = 'block';
        };

        window.updateAdmin = function() {
            const form = document.getElementById('editAdminForm');
            const formData = new FormData(form);
            
            const adminId = formData.get('adminId');
            const adminData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                role: formData.get('role'),
                assignedWorkplaces: formData.getAll('workplaces'),
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.id || 'system'
            };

            // Validate data
            if (!adminData.firstName || !adminData.lastName || !adminData.email) {
                showNotification('âŒ Please fill in all required fields', 'error');
                return;
            }

            // Update in Firestore
            db.collection('users').doc(adminId).update({
                ...adminData,
                isAdmin: adminData.role === 'workplace_admin',
                isSuperAdmin: adminData.role === 'super_admin'
            }).then(() => {
                showNotification('âœ… Admin updated successfully', 'success');
                document.getElementById('editAdminModal').style.display = 'none';
                loadAdminUsers();
                loadUsers(); // Refresh users list
            }).catch(error => {
                console.error('Error updating admin:', error);
                showNotification('âŒ Error updating admin', 'error');
            });
        };

        window.toggleAdminStatus = function(adminId) {
            const admin = window.allUsers?.find(u => u.id === adminId);
            if (!admin) {
                showNotification('âŒ Admin not found', 'error');
                return;
            }

            const newStatus = admin.status === 'active' ? 'suspended' : 'active';
            const action = newStatus === 'active' ? 'activated' : 'suspended';

            db.collection('users').doc(adminId).update({
                status: newStatus,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.id || 'system'
            }).then(() => {
                showNotification(`âœ… Admin ${action} successfully`, 'success');
                loadAdminUsers();
                loadUsers(); // Refresh users list
            }).catch(error => {
                console.error('Error updating admin status:', error);
                showNotification('âŒ Error updating admin status', 'error');
            });
        };

        window.deleteAdmin = function(adminId) {
            const admin = window.allUsers?.find(u => u.id === adminId);
            if (!admin) {
                showNotification('âŒ Admin not found', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete admin ${admin.firstName} ${admin.lastName}? This action cannot be undone.`)) {
                db.collection('users').doc(adminId).delete().then(() => {
                    showNotification('âœ… Admin deleted successfully', 'success');
                    loadAdminUsers();
                    loadUsers(); // Refresh users list
                }).catch(error => {
                    console.error('Error deleting admin:', error);
                    showNotification('âŒ Error deleting admin', 'error');
                });
            }
        };

        window.filterAdmins = function() {
            const searchTerm = document.getElementById('adminSearch')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('adminRoleFilter')?.value || '';
            const statusFilter = document.getElementById('adminStatusFilter')?.value || '';
            
            const adminUsers = window.allUsers?.filter(user => user.isAdmin || user.isSuperAdmin) || [];
            const filteredAdmins = adminUsers.filter(admin => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    admin.firstName.toLowerCase().includes(searchTerm) ||
                    admin.lastName.toLowerCase().includes(searchTerm) ||
                    admin.email.toLowerCase().includes(searchTerm);
                
                // Role filter
                const matchesRole = !roleFilter || 
                    (roleFilter === 'super_admin' && admin.isSuperAdmin) ||
                    (roleFilter === 'workplace_admin' && admin.isAdmin && !admin.isSuperAdmin) ||
                    (roleFilter === 'pending' && admin.status === 'pending');
                
                // Status filter
                const matchesStatus = !statusFilter || admin.status === statusFilter;
                
                return matchesSearch && matchesRole && matchesStatus;
            });
            
            // Update table with filtered results
            updateAdminsTable(filteredAdmins);
        };

        window.updateAdminsTable = function(filteredAdmins) {
            const container = document.getElementById('adminsTableContainer');
            if (!container) return;
            
            if (filteredAdmins.length === 0) {
                container.innerHTML = '<div class="warning">No admins found matching your criteria.</div>';
                return;
            }

            let html = `
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Assigned Workplaces</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredAdmins.forEach(admin => {
                const roleBadge = admin.isSuperAdmin ? 
                    '<span class="status-badge super-admin">Super Admin</span>' : 
                    '<span class="status-badge admin">Workplace Admin</span>';
                
                const statusBadge = admin.status === 'active' ? 
                    '<span class="status-badge active">Active</span>' : 
                    '<span class="status-badge suspended">Suspended</span>';

                const assignedWorkplaces = admin.assignedWorkplaces?.map(wpId => {
                    const workplace = workplaces.find(wp => wp.id === wpId);
                    return workplace ? workplace.name : 'Unknown';
                }).join(', ') || 'None assigned';

                const lastLogin = admin.lastLogin ? new Date(admin.lastLogin).toLocaleDateString() : 'Never';

                html += `
                    <tr>
                        <td><strong>${admin.firstName} ${admin.lastName}</strong></td>
                        <td>${admin.email}</td>
                        <td>${roleBadge}</td>
                        <td>${assignedWorkplaces}</td>
                        <td>${statusBadge}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-info" onclick="viewAdminDetails('${admin.id}')">ğŸ‘ï¸ View</button>
                                <button class="btn btn-warning" onclick="editAdmin('${admin.id}')">âœï¸ Edit</button>
                                <button class="btn btn-secondary" onclick="toggleAdminStatus('${admin.id}')">${admin.status === 'active' ? 'â¸ï¸ Suspend' : 'â–¶ï¸ Activate'}</button>
                                <button class="btn btn-danger" onclick="deleteAdmin('${admin.id}')">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        };

        window.exportAdmins = function() {
            const adminUsers = window.allUsers?.filter(user => user.isAdmin || user.isSuperAdmin) || [];
            const csvContent = generateAdminsCSV(adminUsers);
            downloadCSV(csvContent, `admins_${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.generateAdminsCSV = function(adminUsers) {
            const headers = ['First Name', 'Last Name', 'Email', 'Role', 'Assigned Workplaces', 'Status', 'Created', 'Last Login'];
            const rows = adminUsers.map(admin => {
                const assignedWorkplaces = admin.assignedWorkplaces?.map(wpId => {
                    const workplace = workplaces.find(wp => wp.id === wpId);
                    return workplace ? workplace.name : 'Unknown';
                }).join('; ') || 'None assigned';

                return [
                    admin.firstName,
                    admin.lastName,
                    admin.email,
                    admin.isSuperAdmin ? 'Super Admin' : 'Workplace Admin',
                    assignedWorkplaces,
                    admin.status,
                    admin.createdAt ? new Date(admin.createdAt).toLocaleDateString() : 'Unknown',
                    admin.lastLogin ? new Date(admin.lastLogin).toLocaleDateString() : 'Never'
                ];
            });
            
            return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        };

        // User Management Functions
        window.showAddUser = function() {
            showNotification('ğŸ‘¤ Add User functionality coming in Phase 2', 'info');
        };

        window.viewUserDetails = function(userId) {
            const user = window.allUsers?.find(u => u.id === userId);
            if (!user) {
                showNotification('âŒ User not found', 'error');
                return;
            }
            
            const html = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>ğŸ‘¤ User Details</h3>
                        <span class="close" onclick="closeModal('userDetailsModal')">&times;</span>
                    </div>
                    <div>
                        <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Role:</strong> ${user.isAdmin ? 'Admin' : 'User'}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                        <p><strong>Created:</strong> ${new Date(user.createdAt).toLocaleDateString()}</p>
                        <p><strong>Last Login:</strong> ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</p>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('userDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'userDetailsModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = html;
            modal.style.display = 'block';
        };

        window.viewWorkerDetails = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }
            
            const linkedUser = window.allUsers?.find(u => u.email.toLowerCase() === worker.email.toLowerCase());
            
            const html = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>ğŸ‘¥ Worker Details</h3>
                        <span class="close" onclick="closeModal('workerDetailsModal')">&times;</span>
                    </div>
                    <div>
                        <p><strong>Name:</strong> ${worker.first_name} ${worker.last_name}</p>
                        <p><strong>Email:</strong> ${worker.email}</p>
                        <p><strong>Work Study:</strong> ${worker.work_study ? 'Yes' : 'No'}</p>
                        <p><strong>Availability:</strong> ${worker.availability_text || 'Not set'}</p>
                        <p><strong>User Account:</strong> ${linkedUser ? `Linked (${linkedUser.isAdmin ? 'Admin' : 'User'})` : 'No user account'}</p>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('workerDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'workerDetailsModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = html;
            modal.style.display = 'block';
        };

        window.editWorker = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }
            
            // Populate the existing worker form
            document.getElementById('workerFormTitle').textContent = 'âœï¸ Edit Worker';
            document.getElementById('workerFirstName').value = worker.first_name;
            document.getElementById('workerLastName').value = worker.last_name;
            document.getElementById('workerEmail').value = worker.email;
            document.getElementById('workerWorkStudy').value = worker.work_study ? 'Yes' : 'No';
            document.getElementById('workerAvailability').value = worker.availability_text || '';
            
            // Store the worker ID for updating
            document.getElementById('workerForm').setAttribute('data-worker-id', workerId);
            
            // Show the modal
            document.getElementById('workerFormModal').style.display = 'block';
        };

        window.deleteWorker = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('âŒ Worker not found', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${worker.first_name} ${worker.last_name}? This action cannot be undone.`)) {
                deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId))
                    .then(() => {
                        showNotification('âœ… Worker deleted successfully', 'success');
                        loadWorkplaceData();
                        displayEnhancedManagementInterface();
                    })
                    .catch(error => {
                        console.error('Error deleting worker:', error);
                        showNotification('âŒ Error deleting worker', 'error');
                    });
            }
        };

        window.showAddWorker = function() {
            // Reset the form
            document.getElementById('workerFormTitle').textContent = 'â• Add Worker';
            document.getElementById('workerForm').reset();
            document.getElementById('workerForm').removeAttribute('data-worker-id');
            
            // Show the modal
            document.getElementById('workerFormModal').style.display = 'block';
        };



        // Placeholder functions for Phase 2
        window.editUser = function(userId) {
            showNotification('ğŸ‘¤ Edit User functionality coming in Phase 2', 'info');
        };

        window.deleteUser = function(userId) {
            showNotification('ğŸ‘¤ Delete User functionality coming in Phase 2', 'info');
        };

        window.toggleUserStatus = function(userId) {
            showNotification('ğŸ‘¤ User Status management coming in Phase 2', 'info');
        };

        window.bulkEditWorkers = function() {
            showNotification('ğŸ‘¥ Bulk Edit Workers functionality coming in Phase 2', 'info');
        };

        window.bulkDeleteWorkers = function() {
            showNotification('ğŸ‘¥ Bulk Delete Workers functionality coming in Phase 2', 'info');
        };

        window.bulkEditUsers = function() {
            showNotification('ğŸ‘¤ Bulk Edit Users functionality coming in Phase 2', 'info');
        };

        window.bulkDeleteUsers = function() {
            showNotification('ğŸ‘¤ Bulk Delete Users functionality coming in Phase 2', 'info');
        };

        window.bulkSuspendUsers = function() {
            showNotification('ğŸ‘¤ Bulk Suspend Users functionality coming in Phase 2', 'info');
        };

        window.generateWorkplaceReport = function() {
            showNotification('ğŸ“Š Report generation coming in Phase 4', 'info');
        };

        window.viewAuditLogs = function() {
            showNotification('ğŸ“‹ Audit logs coming in Phase 3', 'info');
        };

        window.exportAnalytics = function() {
            showNotification('ğŸ“¤ Analytics export coming in Phase 4', 'info');
        };

        // Enhanced import function
        window.handleWorkerImport = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const progressContainer = document.getElementById('importProgress');
            const progressFill = document.getElementById('importProgressFill');
            const statusText = document.getElementById('importStatus');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            statusText.textContent = 'Reading file...';

            try {
                // Read the file
                const text = await file.text();
                const rows = text.split('\n').map(row => row.split(',').map(cell => cell.trim().replace(/"/g, '')));
                
                progressFill.style.width = '25%';
                statusText.textContent = 'Processing data...';

                // Validate header
                const expectedHeaders = ['First Name', 'Last Name', 'Email', 'Work Study', 'Days & Time Available'];
                const headers = rows[0];
                
                if (!headers || headers.length < 5) {
                    throw new Error('Invalid file format. Expected 5 columns: First Name, Last Name, Email, Work Study, Days & Time Available');
                }

                progressFill.style.width = '50%';
                statusText.textContent = 'Validating workers...';

                // Process rows (skip header)
                const newWorkers = [];
                const errors = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 5 || !row[0] || !row[1] || !row[2]) continue; // Skip empty rows
                    
                    const [firstName, lastName, email, workStudy, availability] = row;
                    
                    // Validate email
                    if (!email.includes('@')) {
                        errors.push(`Row ${i + 1}: Invalid email format`);
                        continue;
                    }
                    
                    // Check for duplicates
                    const existingWorker = workers.find(w => w.email.toLowerCase() === email.toLowerCase());
                    if (existingWorker) {
                        errors.push(`Row ${i + 1}: Worker with email ${email} already exists`);
                        continue;
                    }
                    
                    newWorkers.push({
                        'First Name': firstName,
                        'Last Name': lastName,
                        'Email': email,
                        'Work Study': workStudy.toUpperCase() === 'Y' ? 'Yes' : 'No',
                        'Days & Times Available': availability || '',
                        created_at: new Date().toISOString(),
                        created_by: user.email
                    });
                }

                progressFill.style.width = '75%';
                statusText.textContent = 'Saving to database...';

                // Save to database
                let added = 0;
                for (const worker of newWorkers) {
                    try {
                        await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), worker);
                        added++;
                    } catch (error) {
                        errors.push(`Failed to add ${worker['First Name']} ${worker['Last Name']}: ${error.message}`);
                    }
                }

                progressFill.style.width = '100%';
                statusText.textContent = 'Import complete!';

                // Show results
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    if (added > 0) {
                        showNotification(`âœ… Successfully imported ${added} workers!`, 'success');
                        loadWorkplaceData();
                        displayEnhancedManagementInterface();
                    }
                    if (errors.length > 0) {
                        showNotification(`âš ï¸ Import completed with ${errors.length} errors. Check console for details.`, 'warning');
                        console.log('Import errors:', errors);
                    }
                }, 1000);

            } catch (error) {
                progressContainer.style.display = 'none';
                showNotification(`âŒ Import failed: ${error.message}`, 'error');
                console.error('Import error:', error);
            }
        };

        // ========================================
        // ADMIN MANAGEMENT MODALS
        // ========================================
        
        // Add Admin Modal
        const addAdminModal = document.createElement('div');
        addAdminModal.id = 'addAdminModal';
        addAdminModal.className = 'modal';
        addAdminModal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>â• Add New Admin</h2>
                    <span class="close" onclick="document.getElementById('addAdminModal').style.display='none'">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm" onsubmit="event.preventDefault(); createAdmin();">
                        <div class="admin-form-group">
                            <label for="adminFirstName">First Name *</label>
                            <input type="text" id="adminFirstName" name="firstName" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="adminLastName">Last Name *</label>
                            <input type="text" id="adminLastName" name="lastName" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="adminEmail">Email *</label>
                            <input type="email" id="adminEmail" name="email" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="adminPhone">Phone</label>
                            <input type="tel" id="adminPhone" name="phone">
                        </div>
                        <div class="admin-form-group">
                            <label for="adminRole">Role *</label>
                            <select id="adminRole" name="role" required onchange="toggleWorkplaceAssignment()">
                                <option value="">Select Role</option>
                                <option value="workplace_admin">Workplace Admin</option>
                                <option value="super_admin">Super Admin</option>
                            </select>
                        </div>
                        <div class="admin-form-group" id="workplaceAssignmentGroup" style="display: none;">
                            <label for="adminWorkplaces">Assigned Workplaces</label>
                            <select id="adminWorkplaces" name="workplaces" multiple>
                                <!-- Workplaces will be populated dynamically -->
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple workplaces</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('addAdminModal').style.display='none'">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Admin</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(addAdminModal);

        // Edit Admin Modal
        const editAdminModal = document.createElement('div');
        editAdminModal.id = 'editAdminModal';
        editAdminModal.className = 'modal';
        editAdminModal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>âœï¸ Edit Admin</h2>
                    <span class="close" onclick="document.getElementById('editAdminModal').style.display='none'">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editAdminForm" onsubmit="event.preventDefault(); updateAdmin();">
                        <input type="hidden" id="editAdminId" name="adminId">
                        <div class="admin-form-group">
                            <label for="editAdminFirstName">First Name *</label>
                            <input type="text" id="editAdminFirstName" name="firstName" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="editAdminLastName">Last Name *</label>
                            <input type="text" id="editAdminLastName" name="lastName" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="editAdminEmail">Email *</label>
                            <input type="email" id="editAdminEmail" name="email" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="editAdminPhone">Phone</label>
                            <input type="tel" id="editAdminPhone" name="phone">
                        </div>
                        <div class="admin-form-group">
                            <label for="editAdminRole">Role *</label>
                            <select id="editAdminRole" name="role" required onchange="toggleEditWorkplaceAssignment()">
                                <option value="">Select Role</option>
                                <option value="workplace_admin">Workplace Admin</option>
                                <option value="super_admin">Super Admin</option>
                            </select>
                        </div>
                        <div class="admin-form-group" id="editWorkplaceAssignmentGroup" style="display: none;">
                            <label for="editAdminWorkplaces">Assigned Workplaces</label>
                            <select id="editAdminWorkplaces" name="workplaces" multiple>
                                <!-- Workplaces will be populated dynamically -->
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple workplaces</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('editAdminModal').style.display='none'">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Admin</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(editAdminModal);

        // Admin Details Modal
        const adminDetailsModal = document.createElement('div');
        adminDetailsModal.id = 'adminDetailsModal';
        adminDetailsModal.className = 'modal';
        document.body.appendChild(adminDetailsModal);

        // Helper functions for admin modals
        window.toggleWorkplaceAssignment = function() {
            const role = document.getElementById('adminRole').value;
            const workplaceGroup = document.getElementById('workplaceAssignmentGroup');
            
            if (role === 'workplace_admin') {
                workplaceGroup.style.display = 'block';
                // Populate workplaces
                const workplaceSelect = document.getElementById('adminWorkplaces');
                if (workplaceSelect) {
                    workplaceSelect.innerHTML = '';
                    workplaces.forEach(workplace => {
                        const option = document.createElement('option');
                        option.value = workplace.id;
                        option.textContent = workplace.name;
                        workplaceSelect.appendChild(option);
                    });
                }
            } else {
                workplaceGroup.style.display = 'none';
            }
        };

        window.toggleEditWorkplaceAssignment = function() {
            const role = document.getElementById('editAdminRole').value;
            const workplaceGroup = document.getElementById('editWorkplaceAssignmentGroup');
            
            if (role === 'workplace_admin') {
                workplaceGroup.style.display = 'block';
                // Populate workplaces
                const workplaceSelect = document.getElementById('editAdminWorkplaces');
                if (workplaceSelect) {
                    workplaceSelect.innerHTML = '';
                    workplaces.forEach(workplace => {
                        const option = document.createElement('option');
                        option.value = workplace.id;
                        option.textContent = workplace.name;
                        workplaceSelect.appendChild(option);
                    });
                }
            } else {
                workplaceGroup.style.display = 'none';
            }
        };
    </script>
</body>
</html>