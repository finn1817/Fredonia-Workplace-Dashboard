<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: #28a745;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .workplace-section, .admin-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .admin-section {
            border: 2px solid #28a745;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .admin-title {
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .workplace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
        }

        .workplace-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .workplace-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .workplace-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .schedule-content {
            display: none;
        }

        .action-buttons, .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-admin { background: #28a745; color: white; }

        .btn:hover { transform: translateY(-1px); }

        .form-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .hours-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .day-hours {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .day-hours h5 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .schedule-display {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            text-align: center;
        }

        .shift {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift.work-study {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .shift.unfilled {
            border-color: #dc3545;
            background: #ffebee;
        }

        .worker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .worker-table th, .worker-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .worker-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .worker-table tr:hover {
            background: #f8f9fa;
        }

        .worker-actions {
            display: flex;
            gap: 0.5rem;
        }

        .worker-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .workplace-grid { grid-template-columns: 1fr; }
            .action-buttons, .admin-buttons { flex-direction: column; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
            .modal-content { margin: 10% auto; width: 95%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¢ Workplace Scheduler</h1>
        <div class="user-info">
            <span id="userEmail"></span>
            <span id="adminBadge" class="admin-badge">ADMIN</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Admin Controls -->
        <div id="adminSection" class="admin-section" style="display: none;">
            <h2 class="section-title admin-title">üîß Admin Controls</h2>
            <div class="admin-buttons">
                <button class="btn btn-admin" onclick="showManageHours()">‚è∞ Manage Hours</button>
                <button class="btn btn-admin" onclick="showManageWorkers()">üë• Manage Workers</button>
                <button class="btn btn-admin" onclick="showAddWorker()">‚ûï Add Worker</button>
            </div>
        </div>

        <!-- Workplace Selection -->
        <div class="workplace-section">
            <h2 class="section-title">Select Workplace</h2>
            <div class="workplace-grid" id="workplaceGrid">
                <div class="workplace-card" onclick="selectWorkplace('esports_lounge')">
                    <h4>üéÆ eSports Lounge</h4>
                    <p>esports_lounge</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('esports_arena')">
                    <h4>üèüÔ∏è eSports Arena</h4>
                    <p>esports_arena</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('it_service_center')">
                    <h4>üíª IT Service Center</h4>
                    <p>it_service_center</p>
                </div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="schedule-content" id="scheduleContent">
            <div class="workplace-section">
                <h2 class="section-title">Schedule Management</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showGenerateForm()">üìÖ Generate New Schedule</button>
                    <button class="btn btn-success" onclick="viewCurrentSchedule()">üëÅÔ∏è View Current Schedule</button>
                    <button class="btn btn-info" onclick="viewHistory()">üìö Schedule History</button>
                    <button class="btn btn-warning" onclick="checkAvailability()">üîç Check Availability</button>
                    <button class="btn btn-secondary" onclick="viewWorkers()">üë• View Workers</button>
                </div>

                <!-- Generate Schedule Form -->
                <div class="form-section" id="generateForm" style="display: none;">
                    <h3>Generate New Schedule</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxHours">Max Hours per Worker</label>
                            <input type="number" id="maxHours" value="20" min="5" max="40">
                        </div>
                        <div class="form-group">
                            <label for="workersPerShift">Workers per Shift</label>
                            <input type="number" id="workersPerShift" value="2" min="1" max="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleVariation">Schedule Variation</label>
                            <select id="scheduleVariation">
                                <option value="balanced">Balanced Distribution</option>
                                <option value="random">Random Assignment</option>
                                <option value="work_study_first">Work Study Priority</option>
                                <option value="fair_rotation">Fair Rotation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="shiftLength">Preferred Shift Length</label>
                            <select id="shiftLength">
                                <option value="flexible">Flexible (2-4 hours)</option>
                                <option value="short">Short (2-3 hours)</option>
                                <option value="long">Long (3-4 hours)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="generateSchedule()">üöÄ Generate Schedule</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Check Availability Form -->
                <div class="form-section" id="availabilityForm" style="display: none;">
                    <h3>Check Worker Availability</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availDay">Day</label>
                            <select id="availDay">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availStart">Start Time</label>
                            <input type="time" id="availStart">
                        </div>
                        <div class="form-group">
                            <label for="availEnd">End Time</label>
                            <input type="time" id="availEnd">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="findAvailable()">üîç Find Available Workers</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Schedule Display -->
                <div id="scheduleDisplay">
                    <div class="loading">Select an option above to get started.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Hours -->
    <div id="hoursModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚è∞ Manage Hours of Operation</h3>
                <span class="close" onclick="closeModal('hoursModal')">&times;</span>
            </div>
            <div id="hoursModalContent">
                <div class="loading">Loading hours...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Workers -->
    <div id="workersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• Manage Workers</h3>
                <span class="close" onclick="closeModal('workersModal')">&times;</span>
            </div>
            <div id="workersModalContent">
                <div class="loading">Loading workers...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Worker -->
    <div id="workerFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="workerFormTitle">‚ûï Add Worker</h3>
                <span class="close" onclick="closeModal('workerFormModal')">&times;</span>
            </div>
            <form id="workerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerFirstName">First Name</label>
                        <input type="text" id="workerFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="workerLastName">Last Name</label>
                        <input type="text" id="workerLastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerEmail">Email</label>
                        <input type="email" id="workerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="workerWorkStudy">Work Study</label>
                        <select id="workerWorkStudy">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="workerAvailability">Availability (e.g., "Mon 09:00-17:00, Tue 10:00-16:00")</label>
                    <textarea id="workerAvailability" rows="3" placeholder="Mon 09:00-17:00, Tue 10:00-16:00, Wed 08:00-14:00"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success">üíæ Save Worker</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('workerFormModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Check auth and setup
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'index.html';
        }
        
        document.getElementById('userEmail').textContent = user.email;
        if (user.isAdmin) {
            document.getElementById('adminBadge').style.display = 'inline';
            document.getElementById('adminSection').style.display = 'block';
        }

        // Firebase setup
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, setDoc
        } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        const workplaceConfig = {
            apiKey: "AIzaSyBkkq4nPnmyfSOKtVLsO95rpAUsMDA1o0A",
            authDomain: "workplace-scheduler-ace38.firebaseapp.com", 
            projectId: "workplace-scheduler-ace38",
            storageBucket: "workplace-scheduler-ace38.firebasestorage.app",
            messagingSenderId: "153631302747",
            appId: "1:153631302747:web:2c731351893dca19510b7e"
        };

        const workplaceApp = initializeApp(workplaceConfig);
        const db = getFirestore(workplaceApp);

        // Global state
        let selectedWorkplace = null;
        let workers = [];
        let hours = {};
        let editingWorkerId = null;
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // Utility functions
        const timeToHour = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h + (m / 60);
        };

        const hourToTime = (hour) => {
            const h = Math.floor(hour);
            const m = Math.round((hour - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            let [h, m] = timeStr.split(':').map(Number);
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m.toString().padStart(2, '0')} ${period}`;
        };

        const parseAvailability = (availabilityText) => {
            const availability = {};
            if (!availabilityText) return availability;
            
            const blocks = availabilityText.split(',').map(s => s.trim());
            blocks.forEach(block => {
                const match = block.match(/(\w+)\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/i);
                if (match) {
                    const [, day, start, end] = match;
                    let dayName = day.charAt(0).toUpperCase() + day.slice(1).toLowerCase();
                    
                    const dayMap = {
                        'Mon': 'Monday', 'Tue': 'Tuesday', 'Wed': 'Wednesday',
                        'Thu': 'Thursday', 'Fri': 'Friday', 'Sat': 'Saturday', 'Sun': 'Sunday'
                    };
                    
                    dayName = dayMap[dayName] || dayName;
                    
                    if (!availability[dayName]) availability[dayName] = [];
                    
                    availability[dayName].push({
                        start: start,
                        end: end,
                        startHour: timeToHour(start),
                        endHour: timeToHour(end)
                    });
                }
            });
            
            return availability;
        };

        const isWorkerAvailable = (worker, day, startHour, endHour) => {
            const dayAvail = worker.availability[day] || [];
            return dayAvail.some(slot => slot.startHour <= startHour && endHour <= slot.endHour);
        };

        // Initialize default workplaces with basic hours
        async function initializeDefaultWorkplaces() {
            const workplaces = [
                { 
                    id: 'esports_lounge', 
                    name: 'üéÆ eSports Lounge',
                    hours: {
                        Monday: [{ start: "09:00", end: "17:00" }],
                        Tuesday: [{ start: "09:00", end: "17:00" }],
                        Wednesday: [{ start: "09:00", end: "17:00" }],
                        Thursday: [{ start: "09:00", end: "17:00" }],
                        Friday: [{ start: "09:00", end: "17:00" }],
                        Saturday: [{ start: "10:00", end: "16:00" }],
                        Sunday: [{ start: "12:00", end: "18:00" }]
                    }
                },
                { 
                    id: 'esports_arena', 
                    name: 'üèüÔ∏è eSports Arena',
                    hours: {
                        Monday: [{ start: "10:00", end: "20:00" }],
                        Tuesday: [{ start: "10:00", end: "20:00" }],
                        Wednesday: [{ start: "10:00", end: "20:00" }],
                        Thursday: [{ start: "10:00", end: "20:00" }],
                        Friday: [{ start: "10:00", end: "22:00" }],
                        Saturday: [{ start: "09:00", end: "22:00" }],
                        Sunday: [{ start: "11:00", end: "19:00" }]
                    }
                },
                { 
                    id: 'it_service_center', 
                    name: 'üíª IT Service Center',
                    hours: {
                        Monday: [{ start: "08:00", end: "16:00" }],
                        Tuesday: [{ start: "08:00", end: "16:00" }],
                        Wednesday: [{ start: "08:00", end: "16:00" }],
                        Thursday: [{ start: "08:00", end: "16:00" }],
                        Friday: [{ start: "08:00", end: "16:00" }],
                        Saturday: [{ start: "09:00", end: "15:00" }],
                        Sunday: [{ start: "10:00", end: "14:00" }]
                    }
                }
            ];

            for (const workplace of workplaces) {
                try {
                    const docRef = doc(db, 'workplaces', workplace.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        await setDoc(docRef, {
                            name: workplace.name,
                            hours_of_operation: workplace.hours,
                            created_at: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.error(`Error creating ${workplace.id}:`, error);
                }
            }
        }

        initializeDefaultWorkplaces();

        // Logout function
        window.logout = function() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        };

        // Select workplace
        window.selectWorkplace = async function(id) {
            selectedWorkplace = id;
            
            document.querySelectorAll('.workplace-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.workplace-card').classList.add('selected');
            
            document.getElementById('scheduleContent').style.display = 'block';
            
            await loadWorkplaceData();
            
            hideAllForms();
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Select an option above to get started.</div>';
        };

        // Load workplace data
        async function loadWorkplaceData() {
            try {
                console.log(`Loading data for ${selectedWorkplace}`);
                
                // Load workers
                const workersSnapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                workers = [];
                
                workersSnapshot.forEach(doc => {
                    const data = doc.data();
                    const availability = parseAvailability(data['Days & Times Available'] || '');
                    
                    workers.push({
                        id: doc.id,
                        first_name: data['First Name'] || 'Unknown',
                        last_name: data['Last Name'] || 'Worker',
                        email: data['Email'] || 'no-email',
                        work_study: data['Work Study'] === 'Yes',
                        availability,
                        availability_text: data['Days & Times Available'] || ''
                    });
                });

                // Load operating hours
                const workplaceDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace));
                if (workplaceDoc.exists()) {
                    hours = workplaceDoc.data().hours_of_operation || {};
                } else {
                    hours = {};
                }

                console.log(`Loaded ${workers.length} workers and operating hours for ${selectedWorkplace}`);
                
            } catch (error) {
                console.error('Error loading workplace data:', error);
                workers = [];
                hours = {};
            }
        }

        // Modal functions
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        // Admin: Manage Hours
        window.showManageHours = async function() {
            if (!user.isAdmin) {
                alert('Admin access required');
                return;
            }

            if (!selectedWorkplace) {
                alert('Please select a workplace first');
                return;
            }

            await loadWorkplaceData();
            
            let html = '<div class="hours-grid">';
            
            DAYS.forEach(day => {
                const dayHours = hours[day] || [{ start: "09:00", end: "17:00" }];
                html += `
                    <div class="day-hours">
                        <h5>${day}</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Start Time</label>
                                <input type="time" id="start_${day}" value="${dayHours[0]?.start || '09:00'}">
                            </div>
                            <div class="form-group">
                                <label>End Time</label>
                                <input type="time" id="end_${day}" value="${dayHours[0]?.end || '17:00'}">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button class="btn btn-success" onclick="saveHours()">üíæ Save Hours</button>';
            
            document.getElementById('hoursModalContent').innerHTML = html;
            document.getElementById('hoursModal').style.display = 'block';
        };

        // Save hours
        window.saveHours = async function() {
            try {
                const newHours = {};
                
                DAYS.forEach(day => {
                    const start = document.getElementById(`start_${day}`).value;
                    const end = document.getElementById(`end_${day}`).value;
                    
                    if (start && end) {
                        newHours[day] = [{ start, end }];
                    }
                });
                
                await updateDoc(doc(db, 'workplaces', selectedWorkplace), {
                    hours_of_operation: newHours,
                    updated_at: new Date().toISOString()
                });
                
                hours = newHours;
                alert('‚úÖ Hours updated successfully!');
                closeModal('hoursModal');
                
            } catch (error) {
                console.error('Error saving hours:', error);
                alert('‚ùå Error saving hours');
            }
        };

        // Admin: Manage Workers
        window.showManageWorkers = async function() {
            if (!user.isAdmin) {
                alert('Admin access required');
                return;
            }

            if (!selectedWorkplace) {
                alert('Please select a workplace first');
                return;
            }

            await loadWorkplaceData();
            displayWorkersInModal();
        };

        function displayWorkersInModal() {
            let html = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-success" onclick="showAddWorker()">‚ûï Add New Worker</button>
                </div>
                <table class="worker-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            workers.forEach(worker => {
                html += `
                    <tr>
                        <td>${worker.first_name} ${worker.last_name}</td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '‚úÖ Yes' : '‚ùå No'}</td>
                        <td><small>${worker.availability_text}</small></td>
                        <td>
                            <div class="worker-actions">
                                <button class="btn btn-warning" onclick="editWorker('${worker.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            document.getElementById('workersModalContent').innerHTML = html;
            document.getElementById('workersModal').style.display = 'block';
        }

        // Add Worker
        window.showAddWorker = function() {
            if (!user.isAdmin) {
                alert('Admin access required');
                return;
            }

            editingWorkerId = null;
            document.getElementById('workerFormTitle').textContent = '‚ûï Add Worker';
            document.getElementById('workerForm').reset();
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        // Edit Worker
        window.editWorker = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;

            editingWorkerId = workerId;
            document.getElementById('workerFormTitle').textContent = '‚úèÔ∏è Edit Worker';
            
            document.getElementById('workerFirstName').value = worker.first_name;
            document.getElementById('workerLastName').value = worker.last_name;
            document.getElementById('workerEmail').value = worker.email;
            document.getElementById('workerWorkStudy').value = worker.work_study ? 'Yes' : 'No';
            document.getElementById('workerAvailability').value = worker.availability_text;
            
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        // Delete Worker
        window.deleteWorker = async function(workerId) {
            if (!confirm('Are you sure you want to delete this worker?')) return;

            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId));
                alert('‚úÖ Worker deleted successfully!');
                await loadWorkplaceData();
                displayWorkersInModal();
            } catch (error) {
                console.error('Error deleting worker:', error);
                alert('‚ùå Error deleting worker');
            }
        };

        // Save Worker (Add/Edit)
        document.getElementById('workerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const workerData = {
                'First Name': document.getElementById('workerFirstName').value,
                'Last Name': document.getElementById('workerLastName').value,
                'Email': document.getElementById('workerEmail').value,
                'Work Study': document.getElementById('workerWorkStudy').value,
                'Days & Times Available': document.getElementById('workerAvailability').value,
                'updated_at': new Date().toISOString()
            };

            try {
                if (editingWorkerId) {
                    // Update existing worker
                    await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', editingWorkerId), workerData);
                    alert('‚úÖ Worker updated successfully!');
                } else {
                    // Add new worker
                    workerData.created_at = new Date().toISOString();
                    await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), workerData);
                    alert('‚úÖ Worker added successfully!');
                }
                
                closeModal('workerFormModal');
                await loadWorkplaceData();
                
            } catch (error) {
                console.error('Error saving worker:', error);
                alert('‚ùå Error saving worker');
            }
        });

        // Show/hide forms
        window.showGenerateForm = function() {
            hideAllForms();
            document.getElementById('generateForm').style.display = 'block';
        };

        window.checkAvailability = function() {
            hideAllForms();
            document.getElementById('availabilityForm').style.display = 'block';
        };

        window.hideAllForms = function() {
            document.querySelectorAll('.form-section').forEach(form => {
                form.style.display = 'none';
            });
        };

        // View Workers
        window.viewWorkers = function() {
            if (workers.length === 0) {
                document.getElementById('scheduleDisplay').innerHTML = `
                    <div class="schedule-display">
                        <h3>üë• Workers for ${selectedWorkplace}</h3>
                        <div class="warning">No workers found for this workplace.</div>
                        ${user.isAdmin ? '<button class="btn btn-success" onclick="showAddWorker()">‚ûï Add First Worker</button>' : ''}
                    </div>
                `;
                return;
            }

            let html = `
                <div class="schedule-display">
                    <h3>üë• Workers for ${selectedWorkplace}</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${workers.length}</div>
                            <div class="stat-label">Total Workers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workers.filter(w => w.work_study).length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workers.filter(w => !w.work_study).length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Work Study</th>
                                <th>Availability</th>
                                <th>Contact</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            workers.forEach(worker => {
                html += `
                    <tr>
                        <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '<span style="color: #28a745;">‚úÖ Yes</span>' : '‚ùå No'}</td>
                        <td><small>${worker.availability_text}</small></td>
                        <td><button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Generate schedule with variations
        window.generateSchedule = async function() {
            if (!selectedWorkplace) {
                alert('Please select a workplace first.');
                return;
            }

            if (workers.length === 0) {
                alert('No workers found for this workplace. Please add workers first.');
                return;
            }

            if (Object.keys(hours).length === 0) {
                alert('No operating hours configured for this workplace.');
                return;
            }

            const maxHours = parseInt(document.getElementById('maxHours').value);
            const workersPerShift = parseInt(document.getElementById('workersPerShift').value);
            const variation = document.getElementById('scheduleVariation').value;
            const shiftLength = document.getElementById('shiftLength').value;
            
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">üîÑ Generating schedule...</div>';
            
            try {
                const schedule = createVariedSchedule(maxHours, workersPerShift, variation, shiftLength);
                await saveSchedule(schedule, variation);
                displaySchedule(schedule, false);
                hideAllForms();
            } catch (error) {
                console.error('Error generating schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = `<div class="error">Error generating schedule: ${error.message}</div>`;
            }
        };

        // Create varied schedules
        function createVariedSchedule(maxHours, workersPerShift, variation, shiftLength) {
            const schedule = {};
            const workerHours = {};
            
            workers.forEach(w => workerHours[w.email] = 0);
            
            // Determine shift lengths based on preference
            const getShiftLength = (start, end) => {
                const maxTime = end - start;
                switch (shiftLength) {
                    case 'short':
                        return Math.min(3, Math.max(2, maxTime));
                    case 'long':
                        return Math.min(4, Math.max(3, maxTime));
                    default: // flexible
                        return Math.min(4, Math.max(2, maxTime));
                }
            };

            DAYS.forEach(day => {
                const dayHours = hours[day];
                if (!dayHours || dayHours.length === 0) return;
                
                if (!schedule[day]) schedule[day] = [];
                
                dayHours.forEach(period => {
                    const start = timeToHour(period.start);
                    const end = timeToHour(period.end);
                    
                    let current = start;
                    while (current < end) {
                        const shiftDuration = getShiftLength(current, end);
                        const shiftEnd = Math.min(current + shiftDuration, end);
                        
                        if (shiftEnd - current < 2) break;
                        
                        // Get available workers
                        const available = workers.filter(worker => {
                            const remainingHours = maxHours - (workerHours[worker.email] || 0);
                            const duration = shiftEnd - current;
                            
                            if (remainingHours < duration) return false;
                            return isWorkerAvailable(worker, day, current, shiftEnd);
                        });
                        
                        // Apply different selection strategies
                        let selected = [];
                        const duration = shiftEnd - current;
                        
                        switch (variation) {
                            case 'random':
                                // Shuffle and take first N
                                const shuffled = [...available].sort(() => Math.random() - 0.5);
                                selected = shuffled.slice(0, workersPerShift);
                                break;
                                
                            case 'work_study_first':
                                // Prioritize work study students
                                const workStudy = available.filter(w => w.work_study);
                                const regular = available.filter(w => !w.work_study);
                                workStudy.sort((a, b) => (workerHours[a.email] || 0) - (workerHours[b.email] || 0));
                                regular.sort((a, b) => (workerHours[a.email] || 0) - (workerHours[b.email] || 0));
                                selected = [...workStudy, ...regular].slice(0, workersPerShift);
                                break;
                                
                            case 'fair_rotation':
                                // Ensure fair distribution based on total hours worked
                                available.sort((a, b) => {
                                    const hoursA = workerHours[a.email] || 0;
                                    const hoursB = workerHours[b.email] || 0;
                                    // Add some randomness to break ties
                                    return hoursA - hoursB + (Math.random() - 0.5) * 0.1;
                                });
                                selected = available.slice(0, workersPerShift);
                                break;
                                
                            default: // balanced
                                // Balance work study and fairness
                                available.sort((a, b) => {
                                    if (a.work_study && !b.work_study) return -1;
                                    if (!a.work_study && b.work_study) return 1;
                                    const hoursA = workerHours[a.email] || 0;
                                    const hoursB = workerHours[b.email] || 0;
                                    return hoursA - hoursB;
                                });
                                selected = available.slice(0, workersPerShift);
                        }
                        
                        // Update hours
                        selected.forEach(worker => {
                            workerHours[worker.email] = (workerHours[worker.email] || 0) + duration;
                        });
                        
                        const shift = {
                            start: hourToTime(current),
                            end: hourToTime(shiftEnd),
                            workers: selected.length > 0 ? selected.map(w => `${w.first_name} ${w.last_name}`) : ['Unfilled'],
                            emails: selected.map(w => w.email),
                            workStudy: selected.some(w => w.work_study)
                        };
                        
                        schedule[day].push(shift);
                        current = shiftEnd;
                    }
                });
                
                if (schedule[day]) {
                    schedule[day].sort((a, b) => timeToHour(a.start) - timeToHour(b.start));
                }
            });
            
            return schedule;
        }

        // Save schedule
        async function saveSchedule(schedule, variation) {
            try {
                const scheduleData = {
                    days: schedule,
                    createdAt: new Date().toISOString(),
                    workplaceId: selectedWorkplace,
                    name: `${selectedWorkplace} Schedule ${new Date().toLocaleDateString()}`,
                    variation: variation,
                    generatedBy: user.email
                };
                
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'schedules'), scheduleData);
                console.log('Schedule saved');
            } catch (error) {
                console.error('Error saving schedule:', error);
                throw error;
            }
        }

        // View current schedule
        window.viewCurrentSchedule = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading current schedule...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const schedule = doc.data().days;
                    displaySchedule(schedule, true);
                } else {
                    document.getElementById('scheduleDisplay').innerHTML = '<div class="warning">No current schedule found. Generate a new one!</div>';
                }
            } catch (error) {
                console.error('Error loading current schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error loading schedule.</div>';
            }
        };

        // View history
        window.viewHistory = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading schedule history...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                let html = '<div class="schedule-display"><h3>üìö Schedule History</h3>';
                
                if (snapshot.empty) {
                    html += '<p>No schedules found.</p>';
                } else {
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = new Date(data.createdAt).toLocaleDateString();
                        const time = new Date(data.createdAt).toLocaleTimeString();
                        html += `
                            <div style="padding: 1rem; border: 1px solid #dee2e6; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${data.name || 'Schedule'}</strong><br>
                                    <small>Created: ${date} at ${time}</small><br>
                                    <small>Variation: ${data.variation || 'balanced'} | By: ${data.generatedBy || 'Unknown'}</small>
                                    ${index === 0 ? '<span style="color: #28a745; font-weight: bold;"> (Current)</span>' : ''}
                                </div>
                                <div>
                                    <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">View</button>
                                    <button class="btn btn-danger" onclick="deleteSchedule('${doc.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error loading schedule history.</div>';
            }
        };

        // Find available workers
        window.findAvailable = function() {
            const day = document.getElementById('availDay').value;
            const start = document.getElementById('availStart').value;
            const end = document.getElementById('availEnd').value;
            
            if (!start || !end) {
                alert('Please enter both start and end times.');
                return;
            }
            
            const startHour = timeToHour(start);
            const endHour = timeToHour(end);
            
            if (endHour <= startHour) {
                alert('End time must be after start time.');
                return;
            }
            
            const available = workers.filter(worker => {
                return isWorkerAvailable(worker, day, startHour, endHour);
            });
            
            const workStudy = available.filter(w => w.work_study);
            const regular = available.filter(w => !w.work_study);
            
            let html = `
                <div class="schedule-display">
                    <h3>üîç Available Workers</h3>
                    <p><strong>${day} ${formatTime(start)} - ${formatTime(end)}</strong></p>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${available.length}</div>
                            <div class="stat-label">Total Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workStudy.length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regular.length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
            `;
            
            if (available.length === 0) {
                html += '<div class="warning">‚ùå No workers available during this time.</div>';
            } else {
                if (workStudy.length > 0) {
                    html += '<h4>üéì Work Study Students</h4>';
                    workStudy.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #28a745; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>${worker.email}</small>
                                </div>
                                <button class="btn btn-success" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
                
                if (regular.length > 0) {
                    html += '<h4>üë• Regular Workers</h4>';
                    regular.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #007bff; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>${worker.email}</small>
                                </div>
                                <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Display schedule
        function displaySchedule(schedule, isCurrent = false) {
            const workerHours = calculateWorkerHours(schedule);
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledShifts = Object.values(schedule).flat().filter(s => s.workers.includes('Unfilled')).length;
            
            let html = '<div class="schedule-display">';
            
            if (isCurrent) {
                html += '<div class="success">‚úÖ This is the current active schedule</div>';
            }
            
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${unfilledShifts}</div>
                        <div class="stat-label">Unfilled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(workerHours).length}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                </div>
            `;
            
            const wsIssues = checkWorkStudyIssues(workerHours);
            if (wsIssues.length > 0) {
                html += '<div class="warning"><h5>‚ö†Ô∏è Work Study Issues</h5>';
                wsIssues.forEach(issue => {
                    html += `<p>${issue}</p>`;
                });
                html += '</div>';
            }
            
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                html += `<div class="day-header">${day}</div>`;
                shifts.forEach(shift => {
                    const unfilled = shift.workers.includes('Unfilled');
                    const workStudy = shift.workStudy;
                    html += `
                        <div class="shift ${unfilled ? 'unfilled' : ''} ${workStudy ? 'work-study' : ''}">
                            <div>
                                <strong>${formatTime(shift.start)} - ${formatTime(shift.end)}</strong>
                                ${workStudy ? '<span style="color: #ffc107;"> (Work Study)</span>' : ''}
                            </div>
                            <div>${shift.workers.join(', ')}</div>
                        </div>
                    `;
                });
            });
            
            html += '<div class="worker-summary"><h4>Worker Hours Summary</h4>';
            html += '<table class="worker-table"><thead><tr><th>Worker</th><th>Hours</th><th>Status</th></tr></thead><tbody>';
            
            Object.entries(workerHours).forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWS = worker.work_study;
                let status = 'OK';
                let statusColor = '';
                
                if (isWS && Math.abs(hours - 5) > 0.1) {
                    status = `WS Issue (${hours.toFixed(1)}h)`;
                    statusColor = 'color: #dc3545;';
                } else if (hours < 3) {
                    status = 'Low Hours';
                    statusColor = 'color: #ffc107;';
                }
                
                html += `
                    <tr>
                        <td>${name} ${isWS ? '<small>(WS)</small>' : ''}</td>
                        <td>${hours.toFixed(1)}</td>
                        <td style="${statusColor}">${status}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div></div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
        }

        function calculateWorkerHours(schedule) {
            const hours = {};
            
            Object.values(schedule).forEach(shifts => {
                shifts.forEach(shift => {
                    const duration = timeToHour(shift.end) - timeToHour(shift.start);
                    shift.emails.forEach(email => {
                        hours[email] = (hours[email] || 0) + duration;
                    });
                });
            });
            
            return hours;
        }

        function checkWorkStudyIssues(workerHours) {
            const issues = [];
            
            workers.forEach(worker => {
                if (worker.work_study) {
                    const hours = workerHours[worker.email] || 0;
                    if (Math.abs(hours - 5) > 0.1) {
                        issues.push(`${worker.first_name} ${worker.last_name}: ${hours.toFixed(1)} hours (needs exactly 5)`);
                    }
                }
            });
            
            return issues;
        }

        window.contactWorker = function(email) {
            window.open(`mailto:${email}?subject=Work Schedule&body=Hello! We have a shift available.`);
        };

        window.deleteSchedule = async function(scheduleId) {
            if (confirm('Delete this schedule? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                    alert('‚úÖ Schedule deleted.');
                    viewHistory();
                } catch (error) {
                    console.error('Error deleting schedule:', error);
                    alert('‚ùå Error deleting schedule.');
                }
            }
        };

        window.viewScheduleById = async function(scheduleId) {
            try {
                const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                if (docSnap.exists()) {
                    const schedule = docSnap.data().days;
                    displaySchedule(schedule, false);
                }
            } catch (error) {
                console.error('Error viewing schedule:', error);
            }
        };
    </script>
</body>
</html>
