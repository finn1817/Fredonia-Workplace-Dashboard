<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: #28a745;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .workplace-section, .admin-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .admin-section {
            border: 2px solid #28a745;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .admin-title {
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .workplace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
        }

        .workplace-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .workplace-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .workplace-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .schedule-content {
            display: none;
        }

        .action-buttons, .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-admin { background: #28a745; color: white; }

        .btn:hover { 
            transform: translateY(-1px); 
            filter: brightness(1.1);
        }

        .form-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
            display: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .hours-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .day-hours {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .day-hours h5 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .schedule-display {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            text-align: center;
        }

        .shift {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift.work-study {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .shift.unfilled {
            border-color: #dc3545;
            background: #ffebee;
        }

        .shift-actions {
            display: flex;
            gap: 0.5rem;
        }

        .shift-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .worker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .worker-table th, .worker-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .worker-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .worker-table tr:hover {
            background: #f8f9fa;
        }

        .worker-actions {
            display: flex;
            gap: 0.5rem;
        }

        .worker-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .workplace-grid { grid-template-columns: 1fr; }
            .action-buttons, .admin-buttons { flex-direction: column; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
            .modal-content { margin: 10% auto; width: 95%; }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üè¢ Workplace Scheduler</h1>
        <div class="user-info">
            <span id="userEmail"></span>
            <span id="adminBadge" class="admin-badge">ADMIN</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Admin Controls -->
        <div id="adminSection" class="admin-section" style="display: none;">
            <h2 class="section-title admin-title">üîß Admin Controls</h2>
            <div class="admin-buttons">
                <button class="btn btn-admin" onclick="showManageHours()">‚è∞ Manage Hours</button>
                <button class="btn btn-admin" onclick="showManageWorkers()">üë• Manage Workers</button>
                <button class="btn btn-admin" onclick="showAddWorker()">‚ûï Add Worker</button>
            </div>
        </div>

        <!-- Workplace Selection -->
        <div class="workplace-section">
            <h2 class="section-title">Select Workplace</h2>
            <div class="workplace-grid" id="workplaceGrid">
                <div class="workplace-card" onclick="selectWorkplace('esports_lounge')">
                    <h4>üéÆ eSports Lounge</h4>
                    <p>esports_lounge</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('esports_arena')">
                    <h4>üèüÔ∏è eSports Arena</h4>
                    <p>esports_arena</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('it_service_center')">
                    <h4>üíª IT Service Center</h4>
                    <p>it_service_center</p>
                </div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="schedule-content" id="scheduleContent">
            <div class="workplace-section">
                <h2 class="section-title">Schedule Management</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showGenerateForm()">üìÖ Generate New Schedule</button>
                    <button class="btn btn-success" onclick="viewCurrentSchedule()">üëÅÔ∏è View Current Schedule</button>
                    <button class="btn btn-info" onclick="viewHistory()">üìö Schedule History</button>
                    <button class="btn btn-warning" onclick="checkAvailability()">üîç Check Availability</button>
                    <button class="btn btn-secondary" onclick="viewWorkers()">üë• View Workers</button>
                </div>

                <!-- Generate Schedule Form -->
                <div class="form-section" id="generateForm">
                    <h3>Generate New Schedule</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxHours">Max Hours per Worker</label>
                            <input type="number" id="maxHours" value="20" min="5" max="40">
                        </div>
                        <div class="form-group">
                            <label for="workersPerShift">Workers per Shift</label>
                            <input type="number" id="workersPerShift" value="2" min="1" max="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minHours">Min Hours per Worker</label>
                            <input type="number" id="minHours" value="3" min="0" max="20">
                        </div>
                        <div class="form-group">
                            <label for="scheduleVariation">Schedule Variation</label>
                            <select id="scheduleVariation">
                                <option value="balanced">Balanced Distribution</option>
                                <option value="random">Random Assignment</option>
                                <option value="work_study_first">Work Study Priority</option>
                                <option value="fair_rotation">Fair Rotation</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="shiftLength">Preferred Shift Length</label>
                        <select id="shiftLength">
                            <option value="flexible">Flexible (2-4 hours)</option>
                            <option value="short">Short (2-3 hours)</option>
                            <option value="long">Long (3-4 hours)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="generateSchedule()">üöÄ Generate Schedule</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Check Availability Form -->
                <div class="form-section" id="availabilityForm">
                    <h3>Check Worker Availability</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availDay">Day</label>
                            <select id="availDay">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availStart">Start Time</label>
                            <input type="time" id="availStart">
                        </div>
                        <div class="form-group">
                            <label for="availEnd">End Time</label>
                            <input type="time" id="availEnd">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="findAvailable()">üîç Find Available Workers</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Schedule Display -->
                <div id="scheduleDisplay">
                    <div class="loading">Select an option above to get started.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Hours -->
    <div id="hoursModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚è∞ Manage Hours of Operation</h3>
                <span class="close" onclick="closeModal('hoursModal')">&times;</span>
            </div>
            <div id="hoursModalContent">
                <div class="loading">Loading hours...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Workers -->
    <div id="workersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• Manage Workers</h3>
                <span class="close" onclick="closeModal('workersModal')">&times;</span>
            </div>
            <div id="workersModalContent">
                <div class="loading">Loading workers...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Worker -->
    <div id="workerFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="workerFormTitle">‚ûï Add Worker</h3>
                <span class="close" onclick="closeModal('workerFormModal')">&times;</span>
            </div>
            <form id="workerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerFirstName">First Name</label>
                        <input type="text" id="workerFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="workerLastName">Last Name</label>
                        <input type="text" id="workerLastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerEmail">Email</label>
                        <input type="email" id="workerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="workerWorkStudy">Work Study</label>
                        <select id="workerWorkStudy">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="workerAvailability">Availability (e.g., "Mon 09:00-17:00, Tue 10:00-16:00")</label>
                    <textarea id="workerAvailability" rows="3" placeholder="Mon 09:00-17:00, Tue 10:00-16:00, Wed 08:00-14:00"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success">üíæ Save Worker</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('workerFormModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Check auth and setup
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'index.html';
        }
        
        document.getElementById('userEmail').textContent = user.email;
        if (user.isAdmin) {
            document.getElementById('adminBadge').style.display = 'inline';
            document.getElementById('adminSection').style.display = 'block';
        }

        // Firebase setup
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, setDoc
        } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        const workplaceConfig = {
            apiKey: "AIzaSyBkkq4nPnmyfSOKtVLsO95rpAUsMDA1o0A",
            authDomain: "workplace-scheduler-ace38.firebaseapp.com", 
            projectId: "workplace-scheduler-ace38",
            storageBucket: "workplace-scheduler-ace38.firebasestorage.app",
            messagingSenderId: "153631302747",
            appId: "1:153631302747:web:2c731351893dca19510b7e"
        };

        const workplaceApp = initializeApp(workplaceConfig);
        const db = getFirestore(workplaceApp);

        // Global state
        let selectedWorkplace = null;
        let workers = [];
        let hours = {};
        let editingWorkerId = null;
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // Utility functions from parser.py
        const timeToHour = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h + (m / 60);
        };

        const hourToTime = (hour) => {
            const h = Math.floor(hour);
            const m = Math.round((hour - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            let [h, m] = timeStr.split(':').map(Number);
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m.toString().padStart(2, '0')} ${period}`;
        };

        // Enhanced availability parsing from parser.py
        const parseAvailability = (availabilityText) => {
            const availability = {};
            if (!availabilityText) return availability;
            
            const dayMap = {
                'sunday': 'Sunday', 'sun': 'Sunday',
                'monday': 'Monday', 'mon': 'Monday',
                'tuesday': 'Tuesday', 'tue': 'Tuesday',
                'wednesday': 'Wednesday', 'wed': 'Wednesday',
                'thursday': 'Thursday', 'thu': 'Thursday',
                'friday': 'Friday', 'fri': 'Friday',
                'saturday': 'Saturday', 'sat': 'Saturday'
            };
            
            const blocks = availabilityText.split(',').map(s => s.trim());
            blocks.forEach(block => {
                const match = block.match(/(\w+)\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/i);
                if (match) {
                    const [, dayRaw, start, end] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    
                    if (day) {
                        let startHour = timeToHour(start);
                        let endHour = timeToHour(end);
                        
                        // Handle overnight shifts
                        if (endHour <= startHour) {
                            endHour += 24.0;
                        }
                        
                        if (!availability[day]) availability[day] = [];
                        
                        availability[day].push({
                            start: start,
                            end: end,
                            start_hour: startHour,
                            end_hour: endHour
                        });
                    }
                }
            });
            
            return availability;
        };

        const isWorkerAvailable = (worker, day, startHour, endHour) => {
            const dayAvail = worker.availability[day] || [];
            return dayAvail.some(slot => slot.start_hour <= startHour && endHour <= slot.end_hour);
        };

        // Advanced scheduling functions from scheduler.py
        const overlaps = (s1, e1, s2, e2) => {
            return Math.max(s1, s2) < Math.min(e1, e2);
        };

        const calculateAvailabilityHours = (worker) => {
            let totalHours = 0;
            for (const daySlots of Object.values(worker.availability || {})) {
                for (const slot of daySlots) {
                    totalHours += slot.end_hour - slot.start_hour;
                }
            }
            return totalHours;
        };

        const findOptimalShiftSplit = (windows, remainingHours, preferSplit = true) => {
            if (!windows || remainingHours <= 0) {
                return [];
            }
            
            const totalAvailable = windows.reduce((sum, [day, start, end]) => sum + (end - start), 0);
            if (totalAvailable < remainingHours) {
                return windows.map(([day, start, end]) => [day, start, end, end - start]);
            }
            
            // Check for perfect 3+2 or 2+3 splits for work study
            if (preferSplit && remainingHours === 5.0) {
                for (let i = 0; i < windows.length; i++) {
                    const [day1, s1, e1] = windows[i];
                    if (2.8 <= (e1 - s1) && (e1 - s1) <= 3.2) { // ~3 hours
                        for (let j = 0; j < windows.length; j++) {
                            if (i !== j) {
                                const [day2, s2, e2] = windows[j];
                                if (1.8 <= (e2 - s2) && (e2 - s2) <= 2.2) { // ~2 hours
                                    return [
                                        [day1, s1, s1 + 3.0, 3.0],
                                        [day2, s2, s2 + 2.0, 2.0]
                                    ];
                                }
                            }
                        }
                    }
                }
            }
            
            // Default allocation
            const result = [];
            let remaining = remainingHours;
            const sortedWindows = [...windows].sort((a, b) => (a[2] - a[1]) - (b[2] - b[1]));
            
            for (const [day, start, end] of sortedWindows) {
                if (remaining <= 0) break;
                
                const windowDuration = end - start;
                const take = Math.min(windowDuration, remaining);
                result.push([day, start, start + take, take]);
                remaining -= take;
            }
            
            return result;
        };

        const checkWorkStudyAvailability = (wsWorkers, hoursOfOperation) => {
            const issues = [];
            
            for (const worker of wsWorkers) {
                let matchingHours = 0;
                
                for (const [day, ops] of Object.entries(hoursOfOperation)) {
                    for (const op of ops) {
                        let opStart = timeToHour(op.start);
                        let opEnd = timeToHour(op.end);
                        if (opEnd <= opStart) opEnd += 24;
                        
                        for (const a of worker.availability[day] || []) {
                            const overlapStart = Math.max(opStart, a.start_hour);
                            const overlapEnd = Math.min(opEnd, a.end_hour);
                            if (overlapEnd > overlapStart) {
                                matchingHours += (overlapEnd - overlapStart);
                            }
                        }
                    }
                }
                
                if (matchingHours < 5) {
                    issues.push([
                        worker,
                        `Only ${matchingHours.toFixed(1)} hours available during operating hours (needs 5)`
                    ]);
                }
            }
            
            return issues;
        };

        // Initialize default workplaces
        async function initializeDefaultWorkplaces() {
            const workplaces = [
                { 
                    id: 'esports_lounge', 
                    name: 'üéÆ eSports Lounge',
                    hours: {
                        Monday: [{ start: "09:00", end: "17:00" }],
                        Tuesday: [{ start: "09:00", end: "17:00" }],
                        Wednesday: [{ start: "09:00", end: "17:00" }],
                        Thursday: [{ start: "09:00", end: "17:00" }],
                        Friday: [{ start: "09:00", end: "17:00" }],
                        Saturday: [{ start: "10:00", end: "16:00" }],
                        Sunday: [{ start: "12:00", end: "18:00" }]
                    }
                },
                { 
                    id: 'esports_arena', 
                    name: 'üèüÔ∏è eSports Arena',
                    hours: {
                        Monday: [{ start: "10:00", end: "20:00" }],
                        Tuesday: [{ start: "10:00", end: "20:00" }],
                        Wednesday: [{ start: "10:00", end: "20:00" }],
                        Thursday: [{ start: "10:00", end: "20:00" }],
                        Friday: [{ start: "10:00", end: "22:00" }],
                        Saturday: [{ start: "09:00", end: "22:00" }],
                        Sunday: [{ start: "11:00", end: "19:00" }]
                    }
                },
                { 
                    id: 'it_service_center', 
                    name: 'üíª IT Service Center',
                    hours: {
                        Monday: [{ start: "08:00", end: "16:00" }],
                        Tuesday: [{ start: "08:00", end: "16:00" }],
                        Wednesday: [{ start: "08:00", end: "16:00" }],
                        Thursday: [{ start: "08:00", end: "16:00" }],
                        Friday: [{ start: "08:00", end: "16:00" }],
                        Saturday: [{ start: "09:00", end: "15:00" }],
                        Sunday: [{ start: "10:00", end: "14:00" }]
                    }
                }
            ];

            for (const workplace of workplaces) {
                try {
                    const docRef = doc(db, 'workplaces', workplace.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        await setDoc(docRef, {
                            name: workplace.name,
                            hours_of_operation: workplace.hours,
                            created_at: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.error(`Error creating ${workplace.id}:`, error);
                }
            }
        }

        initializeDefaultWorkplaces();

        // Logout function
        window.logout = function() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        };

        // Advanced scheduling algorithm from scheduler.py
        const createShiftsFromAvailability = (hoursOfOperation, workersData, maxHoursPerWorker = 20, maxWorkersPerShift = 2, minHoursPerWorker = 3) => {
            console.log('Starting schedule generation with:', { hoursOfOperation, workersData, maxHoursPerWorker, maxWorkersPerShift, minHoursPerWorker });
            
            if (!hoursOfOperation || !workersData || workersData.length === 0) {
                console.warn('Missing data for schedule generation');
                return { schedule: {}, assignedHours: {}, lowHours: [], unassigned: [], altSols: {}, unfilledShifts: [], wsIssues: [], minHoursIssues: [] };
            }

            // Initialize data structures
            const schedule = {};
            const unfilledShifts = [];
            const shiftLengths = [2, 3, 4, 5];
            
            // Shuffle for randomness
            const shuffleArray = (array) => {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };
            
            const shuffledLengths = shuffleArray(shiftLengths);

            // Track hours for each worker
            const assignedHours = {};
            const wsStatus = {};
            const availabilityHours = {};
            
            workersData.forEach(w => {
                assignedHours[w.email] = 0;
                wsStatus[w.email] = w.work_study || false;
                availabilityHours[w.email] = calculateAvailabilityHours(w);
            });

            // Sort work study workers by availability
            const wsWorkers = workersData.filter(w => wsStatus[w.email]);
            wsWorkers.sort((a, b) => availabilityHours[a.email] - availabilityHours[b.email]);

            // Check work study availability issues
            const wsAvailabilityIssues = checkWorkStudyAvailability(wsWorkers, hoursOfOperation);
            const initialWsIssues = wsAvailabilityIssues.map(([w, issue]) => 
                `${w.first_name} ${w.last_name}: ${issue}`
            );

            console.log('Work study availability issues:', initialWsIssues);

            // Phase 1: Allocate exactly 5 hours to each work-study student
            for (const w of wsWorkers) {
                const email = w.email;
                let remaining = 5.0;

                // Gather intersection windows
                const windows = [];
                for (const [day, ops] of Object.entries(hoursOfOperation)) {
                    for (const op of ops) {
                        let opStart = timeToHour(op.start);
                        let opEnd = timeToHour(op.end);
                        if (opEnd <= opStart) opEnd += 24;

                        for (const a of w.availability[day] || []) {
                            const s = Math.max(opStart, a.start_hour);
                            const e = Math.min(opEnd, a.end_hour);
                            if (e > s) {
                                windows.push([day, s, e]);
                            }
                        }
                    }
                }

                // Find optimal shift splits
                const optimalShifts = findOptimalShiftSplit(windows, remaining, true);

                // Apply optimal shifts
                for (const [day, start, end, duration] of optimalShifts) {
                    const slotStart = hourToTime(start);
                    const slotEnd = hourToTime(end);
                    
                    // Check existing shifts in this time slot
                    const existingShifts = (schedule[day] || []).filter(s => 
                        s.start === slotStart && s.end === slotEnd
                    );
                    
                    if (existingShifts.length < maxWorkersPerShift) {
                        if (!schedule[day]) schedule[day] = [];
                        
                        schedule[day].push({
                            start: slotStart,
                            end: slotEnd,
                            assigned: [`${w.first_name} ${w.last_name}`],
                            available: [`${w.first_name} ${w.last_name}`],
                            raw_assigned: [email],
                            all_available: [w],
                            is_work_study: true
                        });
                        
                        assignedHours[email] += duration;
                        remaining -= duration;
                    }
                }

                if (remaining > 0) {
                    console.warn(`Work-study ${w.first_name} ${w.last_name} only got ${(5-remaining).toFixed(1)}h out of 5h`);
                }
            }

            // Phase 2: Fill remaining slots with regular workers
            const orderedDays = [...DAYS].sort();
            
            for (const day of orderedDays) {
                const ops = hoursOfOperation[day] || [];
                if (ops.length === 0) continue;
                
                if (!schedule[day]) schedule[day] = [];

                for (const op of ops) {
                    let opStart = timeToHour(op.start);
                    let opEnd = timeToHour(op.end);
                    if (opEnd <= opStart) opEnd += 24;

                    // Calculate free slots
                    let freeSlots = [[opStart, opEnd]];
                    
                    for (const blk of schedule[day]) {
                        const s1 = timeToHour(blk.start);
                        const e1 = timeToHour(blk.end);
                        const newFree = [];
                        
                        for (const [s0, e0] of freeSlots) {
                            if (e0 <= s1 || s0 >= e1) {
                                newFree.push([s0, e0]);
                            } else {
                                if (s0 < s1) newFree.push([s0, s1]);
                                if (e0 > e1) newFree.push([e1, e0]);
                            }
                        }
                        
                        freeSlots = newFree;
                    }

                    // Sort by duration (shortest first)
                    freeSlots.sort((a, b) => (a[1] - a[0]) - (b[1] - b[0]));

                    // Fill each free slot
                    for (const [s0, e0] of freeSlots) {
                        if ((e0 - s0) < 2) continue;
                        
                        const validLengths = shuffledLengths.filter(l => l <= (e0 - s0));
                        if (validLengths.length === 0) continue;
                        
                        let cur = s0;
                        while (cur < e0) {
                            const availableLengths = validLengths.filter(l => cur + l <= e0);
                            if (availableLengths.length === 0) break;
                            
                            const length = availableLengths[Math.floor(Math.random() * availableLengths.length)];
                            const endShift = Math.min(cur + length, e0);
                            const shiftDuration = endShift - cur;

                            // Find available workers
                            const availableWorkers = [];
                            
                            for (const x of workersData) {
                                const xEmail = x.email;
                                
                                // Skip work study who already have their 5 hours
                                if (wsStatus[xEmail] && assignedHours[xEmail] >= 5) continue;
                                
                                // Skip work study who haven't been scheduled in phase 1
                                if (wsStatus[xEmail] && assignedHours[xEmail] === 0) continue;
                                
                                // Check availability and hour limits
                                if (isWorkerAvailable(x, day, cur, endShift) && 
                                    assignedHours[xEmail] + shiftDuration <= maxHoursPerWorker) {
                                    availableWorkers.push(x);
                                }
                            }

                            // Calculate fairness scores
                            const fairnessScore = (worker) => {
                                const wEmail = worker.email;
                                const availHours = Math.max(availabilityHours[wEmail] || 1, 1);
                                const assigned = assignedHours[wEmail] || 0;
                                const ratio = assigned / availHours;
                                return [ratio, Math.random()]; // Add randomness for tie-breaking
                            };

                            // Sort by fairness (lowest ratio first)
                            availableWorkers.sort((a, b) => {
                                const [ratioA, randA] = fairnessScore(a);
                                const [ratioB, randB] = fairnessScore(b);
                                if (ratioA !== ratioB) return ratioA - ratioB;
                                return randA - randB;
                            });

                            const chosen = availableWorkers.slice(0, maxWorkersPerShift);

                            // Assign hours to chosen workers
                            for (const x of chosen) {
                                assignedHours[x.email] += shiftDuration;
                            }

                            // Create shifts for each chosen worker
                            for (const x of chosen) {
                                schedule[day].push({
                                    start: hourToTime(cur),
                                    end: hourToTime(endShift),
                                    assigned: [`${x.first_name} ${x.last_name}`],
                                    available: availableWorkers.map(y => `${y.first_name} ${y.last_name}`),
                                    raw_assigned: [x.email],
                                    all_available: availableWorkers
                                });
                            }

                            // Mark unfilled slots
                            for (let i = 0; i < maxWorkersPerShift - chosen.length; i++) {
                                unfilledShifts.push({
                                    day: day,
                                    start: hourToTime(cur),
                                    end: hourToTime(endShift),
                                    start_hour: cur,
                                    end_hour: endShift
                                });
                                
                                schedule[day].push({
                                    start: hourToTime(cur),
                                    end: hourToTime(endShift),
                                    assigned: ["Unfilled"],
                                    available: availableWorkers.map(y => `${y.first_name} ${y.last_name}`),
                                    raw_assigned: [],
                                    all_available: availableWorkers
                                });
                            }

                            cur = endShift;
                        }
                    }
                }
            }

            // Build summaries
            const lowHours = workersData
                .filter(w => !wsStatus[w.email] && assignedHours[w.email] < 4)
                .map(w => `${w.first_name} ${w.last_name}`);
                
            const unassigned = workersData
                .filter(w => assignedHours[w.email] === 0)
                .map(w => `${w.first_name} ${w.last_name}`);

            const wsIssues = [
                ...initialWsIssues,
                ...workersData
                    .filter(w => wsStatus[w.email] && assignedHours[w.email] !== 5)
                    .filter(w => !initialWsIssues.some(issue => 
                        issue.startsWith(`${w.first_name} ${w.last_name}:`)))
                    .map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email]}h)`)
            ];

            const minHoursIssues = workersData
                .filter(w => !wsStatus[w.email] && assignedHours[w.email] < minHoursPerWorker)
                .map(w => `${w.first_name} ${w.last_name}`);

            // Alternative solutions for unfilled shifts
            const altSols = {};
            for (const us of unfilledShifts) {
                const key = `${us.day} ${us.start}-${us.end}`;
                const sols = workersData.filter(w => {
                    return isWorkerAvailable(w, us.day, us.start_hour, us.end_hour) &&
                           assignedHours[w.email] + (us.end_hour - us.start_hour) <= maxHoursPerWorker * 1.5;
                });
                
                if (sols.length > 0) {
                    altSols[key] = sols.map(w => `${w.first_name} ${w.last_name}`);
                }
            }

            console.log('Schedule generation complete');
            
            return {
                schedule,
                assignedHours,
                lowHours,
                unassigned,
                altSols,
                unfilledShifts,
                wsIssues,
                minHoursIssues
            };
        };

// Select workplace
        window.selectWorkplace = async function(id) {
            selectedWorkplace = id;
            
            document.querySelectorAll('.workplace-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.workplace-card').classList.add('selected');
            
            document.getElementById('scheduleContent').style.display = 'block';
            
            await loadWorkplaceData();
            
            hideAllForms();
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Select an option above to get started.</div>';
        };

        // Load workplace data
        async function loadWorkplaceData() {
            try {
                console.log(`Loading data for ${selectedWorkplace}`);
                
                // Load workers
                const workersSnapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                workers = [];
                
                workersSnapshot.forEach(doc => {
                    const data = doc.data();
                    const availability = parseAvailability(data['Days & Times Available'] || '');
                    
                    workers.push({
                        id: doc.id,
                        first_name: data['First Name'] || 'Unknown',
                        last_name: data['Last Name'] || 'Worker',
                        email: data['Email'] || 'no-email',
                        work_study: data['Work Study'] === 'Yes',
                        availability,
                        availability_text: data['Days & Times Available'] || ''
                    });
                });

                // Load operating hours
                const workplaceDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace));
                if (workplaceDoc.exists()) {
                    hours = workplaceDoc.data().hours_of_operation || {};
                } else {
                    hours = {};
                }

                console.log(`Loaded ${workers.length} workers and operating hours for ${selectedWorkplace}`);
                
            } catch (error) {
                console.error('Error loading workplace data:', error);
                workers = [];
                hours = {};
            }
        }

        // Modal functions
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        // Admin: Manage Hours
        window.showManageHours = async function() {
            if (!user.isAdmin) {
                alert('Admin access required');
                return;
            }

            if (!selectedWorkplace) {
                alert('Please select a workplace first');
                return;
            }

            await loadWorkplaceData();
            
            let html = '<div class="hours-grid">';
            
            DAYS.forEach(day => {
                const dayHours = hours[day] || [{ start: "09:00", end: "17:00" }];
                html += `
                    <div class="day-hours">
                        <h5>${day}</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Start Time</label>
                                <input type="time" id="start_${day}" value="${dayHours[0]?.start || '09:00'}">
                            </div>
                            <div class="form-group">
                                <label>End Time</label>
                                <input type="time" id="end_${day}" value="${dayHours[0]?.end || '17:00'}">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button class="btn btn-success" onclick="saveHours()">üíæ Save Hours</button>';
            
            document.getElementById('hoursModalContent').innerHTML = html;
            document.getElementById('hoursModal').style.display = 'block';
        };

        // Save hours
        window.saveHours = async function() {
            try {
                const newHours = {};
                
                DAYS.forEach(day => {
                    const start = document.getElementById(`start_${day}`).value;
                    const end = document.getElementById(`end_${day}`).value;
                    
                    if (start && end) {
                        newHours[day] = [{ start, end }];
                    }
                });
                
                await updateDoc(doc(db, 'workplaces', selectedWorkplace), {
                    hours_of_operation: newHours,
                    updated_at: new Date().toISOString()
                });
                
                hours = newHours;
                alert('‚úÖ Hours updated successfully!');
                closeModal('hoursModal');
                
            } catch (error) {
                console.error('Error saving hours:', error);
                alert('‚ùå Error saving hours');
            }
        };

        // Admin: Manage Workers
        window.showManageWorkers = async function() {
            if (!user.isAdmin) {
                alert('Admin access required');
                return;
            }

            if (!selectedWorkplace) {
                alert('Please select a workplace first');
                return;
            }

            await loadWorkplaceData();
            displayWorkersInModal();
        };

        function displayWorkersInModal() {
            let html = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-success" onclick="showAddWorker()">‚ûï Add New Worker</button>
                </div>
                <table class="worker-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            workers.forEach(worker => {
                html += `
                    <tr>
                        <td>${worker.first_name} ${worker.last_name}</td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '‚úÖ Yes' : '‚ùå No'}</td>
                        <td><small>${worker.availability_text}</small></td>
                        <td>
                            <div class="worker-actions">
                                <button class="btn btn-warning" onclick="editWorker('${worker.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            document.getElementById('workersModalContent').innerHTML = html;
            document.getElementById('workersModal').style.display = 'block';
        }

        // Add Worker
        window.showAddWorker = function() {
            if (!user.isAdmin) {
                alert('Admin access required');
                return;
            }

            editingWorkerId = null;
            document.getElementById('workerFormTitle').textContent = '‚ûï Add Worker';
            document.getElementById('workerForm').reset();
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        // Edit Worker
        window.editWorker = function(workerId) {
            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;

            editingWorkerId = workerId;
            document.getElementById('workerFormTitle').textContent = '‚úèÔ∏è Edit Worker';
            
            document.getElementById('workerFirstName').value = worker.first_name;
            document.getElementById('workerLastName').value = worker.last_name;
            document.getElementById('workerEmail').value = worker.email;
            document.getElementById('workerWorkStudy').value = worker.work_study ? 'Yes' : 'No';
            document.getElementById('workerAvailability').value = worker.availability_text;
            
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        // Delete Worker
        window.deleteWorker = async function(workerId) {
            if (!confirm('Are you sure you want to delete this worker?')) return;

            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId));
                alert('‚úÖ Worker deleted successfully!');
                await loadWorkplaceData();
                displayWorkersInModal();
            } catch (error) {
                console.error('Error deleting worker:', error);
                alert('‚ùå Error deleting worker');
            }
        };

        // Save Worker (Add/Edit)
        document.getElementById('workerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const workerData = {
                'First Name': document.getElementById('workerFirstName').value,
                'Last Name': document.getElementById('workerLastName').value,
                'Email': document.getElementById('workerEmail').value,
                'Work Study': document.getElementById('workerWorkStudy').value,
                'Days & Times Available': document.getElementById('workerAvailability').value,
                'updated_at': new Date().toISOString()
            };

            try {
                if (editingWorkerId) {
                    // Update existing worker
                    await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', editingWorkerId), workerData);
                    alert('‚úÖ Worker updated successfully!');
                } else {
                    // Add new worker
                    workerData.created_at = new Date().toISOString();
                    await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), workerData);
                    alert('‚úÖ Worker added successfully!');
                }
                
                closeModal('workerFormModal');
                await loadWorkplaceData();
                
            } catch (error) {
                console.error('Error saving worker:', error);
                alert('‚ùå Error saving worker');
            }
        });

        // Show/hide forms
        window.showGenerateForm = function() {
            hideAllForms();
            document.getElementById('generateForm').style.display = 'block';
        };

        window.checkAvailability = function() {
            hideAllForms();
            document.getElementById('availabilityForm').style.display = 'block';
        };

        window.hideAllForms = function() {
            document.querySelectorAll('.form-section').forEach(form => {
                form.style.display = 'none';
            });
        };

        // View Workers
        window.viewWorkers = function() {
            if (workers.length === 0) {
                document.getElementById('scheduleDisplay').innerHTML = `
                    <div class="schedule-display">
                        <h3>üë• Workers for ${selectedWorkplace}</h3>
                        <div class="warning">No workers found for this workplace.</div>
                        ${user.isAdmin ? '<button class="btn btn-success" onclick="showAddWorker()">‚ûï Add First Worker</button>' : ''}
                    </div>
                `;
                return;
            }

            let html = `
                <div class="schedule-display">
                    <h3>üë• Workers for ${selectedWorkplace}</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${workers.length}</div>
                            <div class="stat-label">Total Workers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workers.filter(w => w.work_study).length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workers.filter(w => !w.work_study).length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Work Study</th>
                                <th>Availability</th>
                                <th>Contact</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            workers.forEach(worker => {
                html += `
                    <tr>
                        <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '<span style="color: #28a745;">‚úÖ Yes</span>' : '‚ùå No'}</td>
                        <td><small>${worker.availability_text}</small></td>
                        <td><button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Generate schedule with advanced algorithm
        window.generateSchedule = async function() {
            if (!selectedWorkplace) {
                alert('Please select a workplace first.');
                return;
            }

            if (workers.length === 0) {
                alert('No workers found for this workplace. Please add workers first.');
                return;
            }

            if (Object.keys(hours).length === 0) {
                alert('No operating hours configured for this workplace.');
                return;
            }

            const maxHours = parseInt(document.getElementById('maxHours').value);
            const workersPerShift = parseInt(document.getElementById('workersPerShift').value);
            const minHours = parseInt(document.getElementById('minHours').value);
            const variation = document.getElementById('scheduleVariation').value;
            const shiftLength = document.getElementById('shiftLength').value;
            
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">üîÑ Generating schedule...</div>';
            
            try {
                // Apply variation-specific modifications to worker data
                let processedWorkers = [...workers];
                
                switch (variation) {
                    case 'random':
                        processedWorkers = shuffleArray(processedWorkers);
                        break;
                    case 'work_study_first':
                        processedWorkers.sort((a, b) => {
                            if (a.work_study && !b.work_study) return -1;
                            if (!a.work_study && b.work_study) return 1;
                            return 0;
                        });
                        break;
                    case 'fair_rotation':
                        processedWorkers.sort((a, b) => {
                            return calculateAvailabilityHours(a) - calculateAvailabilityHours(b);
                        });
                        break;
                    default: // balanced
                        processedWorkers.sort((a, b) => {
                            if (a.work_study && !b.work_study) return -1;
                            if (!a.work_study && b.work_study) return 1;
                            return calculateAvailabilityHours(a) - calculateAvailabilityHours(b);
                        });
                }
                
                // Generate schedule using the advanced algorithm
                const result = createShiftsFromAvailability(
                    hours, 
                    processedWorkers,
                    maxHours,
                    workersPerShift,
                    minHours
                );
                
                const {
                    schedule,
                    assignedHours,
                    lowHours,
                    unassigned,
                    altSols,
                    unfilledShifts,
                    wsIssues,
                    minHoursIssues
                } = result;

                await saveSchedule(schedule, variation);
                
                // Show issues if any
                if (unfilledShifts.length > 0 || wsIssues.length > 0 || minHoursIssues.length > 0) {
                    showIssuesDialog({
                        unfilledShifts,
                        wsIssues,
                        minHoursIssues,
                        altSols
                    });
                }

                // Display the generated schedule
                displaySchedule(schedule, assignedHours, lowHours, unassigned, false);
                hideAllForms();
                
            } catch (error) {
                console.error('Error generating schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = `<div class="error">Error generating schedule: ${error.message}</div>`;
            }
        };

        // Save schedule to Firebase
        async function saveSchedule(schedule, variation) {
            try {
                const scheduleData = {
                    days: schedule,
                    createdAt: new Date().toISOString(),
                    workplaceId: selectedWorkplace,
                    name: `${selectedWorkplace} Schedule ${new Date().toLocaleDateString()}`,
                    variation: variation,
                    generatedBy: user.email
                };
                
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'schedules'), scheduleData);
                console.log('Schedule saved to Firebase');
            } catch (error) {
                console.error('Error saving schedule:', error);
                throw error;
            }
        }

        // Show issues dialog
        function showIssuesDialog(issues) {
            const { unfilledShifts, wsIssues, minHoursIssues, altSols } = issues;
            
            let html = '<div class="modal-content"><div class="modal-header"><h3>‚ö†Ô∏è Schedule Issues</h3><span class="close" onclick="closeIssuesDialog()">&times;</span></div>';
            
            if (wsIssues.length > 0) {
                html += '<div class="warning"><h4>Work Study Issues:</h4><ul>';
                wsIssues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (minHoursIssues.length > 0) {
                html += '<div class="warning"><h4>Workers with Insufficient Hours:</h4><ul>';
                minHoursIssues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (unfilledShifts.length > 0) {
                html += '<div class="error"><h4>Unfilled Shifts:</h4><ul>';
                unfilledShifts.forEach(shift => {
                    const key = `${shift.day} ${shift.start}-${shift.end}`;
                    html += `<li>${key}`;
                    if (altSols[key]) {
                        html += ` - Alternatives: ${altSols[key].join(', ')}`;
                    }
                    html += '</li>';
                });
                html += '</ul></div>';
            }
            
            html += '<button class="btn btn-secondary" onclick="closeIssuesDialog()">Close</button></div>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.id = 'issuesModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            window.closeIssuesDialog = function() {
                document.body.removeChild(modal);
                delete window.closeIssuesDialog;
            };
        }

        // View current schedule
        window.viewCurrentSchedule = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading current schedule...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const scheduleData = doc.data();
                    const schedule = scheduleData.days;
                    
                    // Calculate assigned hours
                    const assignedHours = calculateAssignedHours(schedule);
                    const lowHours = workers
                        .filter(w => !w.work_study && assignedHours[w.email] < 4)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    const unassigned = workers
                        .filter(w => assignedHours[w.email] === 0)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    
                    displaySchedule(schedule, assignedHours, lowHours, unassigned, true);
                } else {
                    document.getElementById('scheduleDisplay').innerHTML = '<div class="warning">No current schedule found. Generate a new one!</div>';
                }
            } catch (error) {
                console.error('Error loading current schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error loading schedule.</div>';
            }
        };

        // Calculate assigned hours from schedule
        function calculateAssignedHours(schedule) {
            const assignedHours = {};
            
            Object.values(schedule).forEach(shifts => {
                shifts.forEach(shift => {
                    const duration = timeToHour(shift.end) - timeToHour(shift.start);
                    (shift.raw_assigned || []).forEach(email => {
                        assignedHours[email] = (assignedHours[email] || 0) + duration;
                    });
                });
            });
            
            return assignedHours;
        }

        // View schedule history
        window.viewHistory = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading schedule history...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                let html = '<div class="schedule-display"><h3>üìö Schedule History</h3>';
                
                if (snapshot.empty) {
                    html += '<p>No schedules found.</p>';
                } else {
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = new Date(data.createdAt).toLocaleDateString();
                        const time = new Date(data.createdAt).toLocaleTimeString();
                        html += `
                            <div style="padding: 1rem; border: 1px solid #dee2e6; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${data.name || 'Schedule'}</strong><br>
                                    <small>Created: ${date} at ${time}</small><br>
                                    <small>Variation: ${data.variation || 'balanced'} | By: ${data.generatedBy || 'Unknown'}</small>
                                    ${index === 0 ? '<span style="color: #28a745; font-weight: bold;"> (Current)</span>' : ''}
                                </div>
                                <div>
                                    <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">View</button>
                                    <button class="btn btn-danger" onclick="deleteSchedule('${doc.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">Error loading schedule history.</div>';
            }
        };

        // View schedule by ID
        window.viewScheduleById = async function(scheduleId) {
            try {
                const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                if (docSnap.exists()) {
                    const scheduleData = docSnap.data();
                    const schedule = scheduleData.days;
                    
                    const assignedHours = calculateAssignedHours(schedule);
                    const lowHours = workers
                        .filter(w => !w.work_study && assignedHours[w.email] < 4)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    const unassigned = workers
                        .filter(w => assignedHours[w.email] === 0)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    
                    displaySchedule(schedule, assignedHours, lowHours, unassigned, false);
                }
            } catch (error) {
                console.error('Error viewing schedule:', error);
            }
        };

        // Delete schedule
        window.deleteSchedule = async function(scheduleId) {
            if (confirm('Delete this schedule? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                    alert('‚úÖ Schedule deleted.');
                    viewHistory();
                } catch (error) {
                    console.error('Error deleting schedule:', error);
                    alert('‚ùå Error deleting schedule.');
                }
            }
        };

        // Display schedule with enhanced functionality
        function displaySchedule(schedule, assignedHours, lowHours, unassigned, isCurrent = false) {
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledShifts = Object.values(schedule).flat().filter(s => s.assigned.includes('Unfilled')).length;
            
            let html = '<div class="schedule-display">';
            
            if (isCurrent) {
                html += '<div class="success">‚úÖ This is the current active schedule</div>';
            }
            
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${unfilledShifts}</div>
                        <div class="stat-label">Unfilled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(assignedHours).length}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                </div>
            `;
            
            // Show warnings for low hours and unassigned workers
            if (lowHours.length > 0) {
                html += `<div class="warning"><strong>Workers with less than 4 hours:</strong> ${lowHours.join(', ')}</div>`;
            }
            if (unassigned.length > 0) {
                html += `<div class="error"><strong>Workers with no hours:</strong> ${unassigned.join(', ')}</div>`;
            }
            
            // Display schedule by day
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                html += `<div class="day-header">${day}</div>`;
                shifts.forEach((shift, index) => {
                    const unfilled = shift.assigned.includes('Unfilled');
                    const workStudy = shift.is_work_study || false;
                    
                    html += `
                        <div class="shift ${unfilled ? 'unfilled' : ''} ${workStudy ? 'work-study' : ''}">
                            <div>
                                <strong>${formatTime(shift.start)} - ${formatTime(shift.end)}</strong>
                                ${workStudy ? '<span style="color: #ffc107; margin-left: 0.5rem;">(Work Study)</span>' : ''}
                                <div style="margin-top: 0.25rem; font-size: 0.9rem;">
                                    ${shift.assigned.join(', ')}
                                </div>
                            </div>
                            <div class="shift-actions">
                                <button class="btn btn-warning" onclick="editShift('${day}', ${index})">‚úèÔ∏è Edit</button>
                                ${unfilled ? '<button class="btn btn-info" onclick="suggestAlternatives(\'' + day + '\', ' + index + ')">üí° Suggest</button>' : ''}
                            </div>
                        </div>
                    `;
                });
            });
            
            // Worker hours summary
            html += '<div style="margin-top: 2rem;"><h4>Worker Hours Summary</h4>';
            html += '<table class="worker-table"><thead><tr><th>Worker</th><th>Hours</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            
            // Add workers with 0 hours
            workers.forEach(w => {
                if (!(w.email in assignedHours)) {
                    sortedWorkers.push([w.email, 0]);
                }
            });
            
            sortedWorkers.forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWS = worker.work_study;
                let status = 'OK';
                let statusColor = '';
                
                if (isWS && Math.abs(hours - 5) > 0.1) {
                    status = `WS Issue (${hours.toFixed(1)}h)`;
                    statusColor = 'color: #dc3545;';
                } else if (hours < 3) {
                    status = 'Low Hours';
                    statusColor = 'color: #ffc107;';
                } else if (hours === 0) {
                    status = 'Unassigned';
                    statusColor = 'color: #dc3545;';
                }
                
                html += `
                    <tr>
                        <td>${name} ${isWS ? '<small>(WS)</small>' : ''}</td>
                        <td>${hours.toFixed(1)}</td>
                        <td style="${statusColor}">${status}</td>
                        <td><button class="btn btn-primary" onclick="contactWorker('${email}')">üìß Contact</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // Action buttons
            html += `
                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="saveCurrentSchedule()">üíæ Save Schedule</button>
                    <button class="btn btn-info" onclick="emailSchedule()">üìß Email Schedule</button>
                    <button class="btn btn-secondary" onclick="printSchedule()">üñ®Ô∏è Print Schedule</button>
                    <button class="btn btn-warning" onclick="exportSchedule()">üì§ Export Excel</button>
                </div>
            `;
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
        }

        // Edit shift functionality
        window.editShift = function(day, shiftIndex) {
            const shift = schedule[day][shiftIndex];
            // Implementation for editing shifts would go here
            alert('Shift editing functionality - to be implemented');
        };

        // Suggest alternatives for unfilled shifts
        window.suggestAlternatives = function(day, shiftIndex) {
            const shift = schedule[day][shiftIndex];
            // Implementation for suggesting alternatives would go here
            alert('Alternative suggestions - to be implemented');
        };

        // Find available workers
        window.findAvailable = function() {
            const day = document.getElementById('availDay').value;
            const start = document.getElementById('availStart').value;
            const end = document.getElementById('availEnd').value;
            
            if (!start || !end) {
                alert('Please enter both start and end times.');
                return;
            }
            
            const startHour = timeToHour(start);
            const endHour = timeToHour(end);
            
            if (endHour <= startHour) {
                alert('End time must be after start time.');
                return;
            }
            
            const available = workers.filter(worker => {
                return isWorkerAvailable(worker, day, startHour, endHour);
            });
            
            const workStudy = available.filter(w => w.work_study);
            const regular = available.filter(w => !w.work_study);
            
            let html = `
                <div class="schedule-display">
                    <h3>üîç Available Workers</h3>
                    <p><strong>${day} ${formatTime(start)} - ${formatTime(end)}</strong></p>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${available.length}</div>
                            <div class="stat-label">Total Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workStudy.length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regular.length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
            `;
            
            if (available.length === 0) {
                html += '<div class="warning">‚ùå No workers available during this time.</div>';
            } else {
                if (workStudy.length > 0) {
                    html += '<h4>üéì Work Study Students</h4>';
                    workStudy.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #28a745; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>${worker.email}</small>
                                </div>
                                <button class="btn btn-success" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
                
                if (regular.length > 0) {
                    html += '<h4>üë• Regular Workers</h4>';
                    regular.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #007bff; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>${worker.email}</small>
                                </div>
                                <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Utility functions
        window.contactWorker = function(email) {
            window.open(`mailto:${email}?subject=Work Schedule&body=Hello! We have a shift available.`);
        };

        window.saveCurrentSchedule = function() {
            alert('Save functionality - integrated with Firebase automatically');
        };

        window.emailSchedule = function() {
            alert('Email schedule functionality - to be implemented');
        };

        window.printSchedule = function() {
            window.print();
        };

        window.exportSchedule = function() {
            alert('Excel export functionality - to be implemented');
        };

        // Utility function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Test connection and initialize
        async function testConnection() {
            try {
                console.log('Testing Firestore connection...');
                const workplacesSnapshot = await getDocs(collection(db, 'workplaces'));
                console.log(`Connected! Found ${workplacesSnapshot.size} workplaces in database.`);
            } catch (error) {
                console.error('Connection test failed:', error);
            }
        }

        testConnection();
    </script>
</body>
</html>

