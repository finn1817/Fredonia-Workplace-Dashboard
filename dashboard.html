<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: #28a745;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .user-badge {
            background: #17a2b8;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .workplace-section, .admin-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .admin-section {
            border: 2px solid #28a745;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .admin-title {
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .workplace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
        }

        .workplace-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .workplace-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .workplace-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .schedule-content {
            display: none;
        }

        .action-buttons, .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-admin { background: #28a745; color: white; }

        .btn:hover:not(:disabled) { 
            transform: translateY(-1px); 
            filter: brightness(1.1);
        }
        
        /* Enhanced worker list styling */
        .available-worker {
            background-color: #f8fff8;
            border-color: #28a745 !important;
        }
        
        .unavailable-worker {
            background-color: #fff8f8;
            border-color: #dc3545 !important;
        }
        
        .available-worker:hover {
            background-color: #e8f5e8;
        }
        
        .unavailable-worker:hover {
            background-color: #f5e8e8;
        }
        
        /* Clean Add Shift Modal Styling */
        .add-shift-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            height: 80vh;
        }
        
        .add-shift-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 280px;
        }
        
        .add-shift-form .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .add-shift-form .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        .form-actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-actions .btn {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .add-shift-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .schedule-info {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #007bff;
            line-height: 1.5;
        }
        
        .workers-list {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
        }
        
        .worker-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .worker-item.available-worker {
            background-color: #f8fff8;
            border-color: #28a745;
        }
        
        .worker-item.unavailable-worker {
            background-color: #fff8f8;
            border-color: #dc3545;
        }
        
        .worker-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .worker-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 12px;
        }
        
        .worker-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        .worker-info {
            flex: 1;
        }
        
        .worker-details {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
            line-height: 1.4;
        }

        .btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
            /* display: none; */
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Availability Interface Styles */
        .day-availability-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e1e5e9;
        }

        .slots-container {
            min-height: 50px;
        }

        .time-slot {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .time-slot:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .time-slot-info {
            flex: 1;
        }

        .time-slot-time {
            font-weight: bold;
            color: #333;
        }

        .time-slot-day {
            font-size: 0.8rem;
            color: #666;
        }

        .remove-slot-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .remove-slot-btn:hover {
            background: #c82333;
        }

        .empty-slot-message {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .hours-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .day-hours {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .day-hours h5 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* Simplified Hours Management Styles */
        .simplified-hours-container {
            max-width: 100%;
        }

        .hours-instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .hours-instructions ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .hours-instructions li {
            margin-bottom: 0.25rem;
        }

        .days-checkboxes {
            margin-bottom: 2rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-checkbox:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .day-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .day-checkbox label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .time-blocks-container {
            margin-bottom: 2rem;
        }

        .day-time-blocks {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .day-time-blocks h5 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .time-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 120px;
        }

        .time-input label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
            margin: 0;
        }

        .time-input input[type="time"] {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .hours-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .schedule-display {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-header {
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Scheduler Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-badge {
            background: #28a745;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .user-badge {
            background: #17a2b8;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: none;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .workplace-section, .admin-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .admin-section {
            border: 2px solid #28a745;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .admin-title {
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .workplace-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
        }

        .workplace-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .workplace-card.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .workplace-card h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .workplace-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .schedule-content {
            display: none;
        }

        .action-buttons, .admin-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-admin { background: #28a745; color: white; }

        .btn:hover:not(:disabled) { 
            transform: translateY(-1px); 
            filter: brightness(1.1);
        }
        
        /* Enhanced worker list styling */
        .available-worker {
            background-color: #f8fff8;
            border-color: #28a745 !important;
        }
        
        .unavailable-worker {
            background-color: #fff8f8;
            border-color: #dc3545 !important;
        }
        
        .available-worker:hover {
            background-color: #e8f5e8;
        }
        
        .unavailable-worker:hover {
            background-color: #f5e8e8;
        }
        
        /* Clean Add Shift Modal Styling */
        .add-shift-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            height: 80vh;
        }
        
        .add-shift-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 280px;
        }
        
        .add-shift-form .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .add-shift-form .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        .form-actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-actions .btn {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .add-shift-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .schedule-info {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #007bff;
            line-height: 1.5;
        }
        
        .workers-list {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
        }
        
        .worker-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .worker-item.available-worker {
            background-color: #f8fff8;
            border-color: #28a745;
        }
        
        .worker-item.unavailable-worker {
            background-color: #fff8f8;
            border-color: #dc3545;
        }
        
        .worker-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .worker-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 12px;
        }
        
        .worker-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }
        
        .worker-info {
            flex: 1;
        }
        
        .worker-details {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
            line-height: 1.4;
        }

        .btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
            /* display: none; */
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Availability Interface Styles */
        .day-availability-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e1e5e9;
        }

        .slots-container {
            min-height: 50px;
        }

        .time-slot {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .time-slot:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .time-slot-info {
            flex: 1;
        }

        .time-slot-time {
            font-weight: bold;
            color: #333;
        }

        .time-slot-day {
            font-size: 0.8rem;
            color: #666;
        }

        .remove-slot-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .remove-slot-btn:hover {
            background: #c82333;
        }

        .empty-slot-message {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .hours-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .day-hours {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .day-hours h5 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* Simplified Hours Management Styles */
        .simplified-hours-container {
            max-width: 100%;
        }

        .hours-instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .hours-instructions ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .hours-instructions li {
            margin-bottom: 0.25rem;
        }

        .days-checkboxes {
            margin-bottom: 2rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-checkbox:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .day-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .day-checkbox label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .time-blocks-container {
            margin-bottom: 2rem;
        }

        .day-time-blocks {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .day-time-blocks h5 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .time-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 120px;
        }

        .time-input label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
            margin: 0;
        }

        .time-input input[type="time"] {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .hours-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .schedule-display {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            text-align: center;
        }

        .shift {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift.work-study {
            border-color: #ffc107;
            background: #fff8e1;
        }

        .shift.unfilled {
            border-color: #dc3545;
            background: #ffebee;
        }

        .shift.coverage-gap {
            border-color: #ff5722;
            background: #ffebee;
            animation: pulse 2s infinite;
        }

        .shift.multiple-workers {
            border-left: 4px solid #007bff;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .shift.multiple-workers:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 87, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
        }

        .shift-actions {
            display: flex;
            gap: 0.5rem;
        }

        .shift-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .worker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .worker-table th, .worker-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .worker-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .worker-table tr:hover {
            background: #f8f9fa;
        }

        .worker-actions {
            display: flex;
            gap: 0.5rem;
        }

        .worker-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
        }

        /* Announcements Styling */
        .announcements-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .announcement-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .announcement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .announcement-card.high-priority {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        }

        .announcement-card.medium-priority {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .announcement-card.low-priority {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .announcement-subject {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .announcement-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.high {
            background: #dc3545;
            color: white;
        }

        .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }

        .priority-badge.low {
            background: #28a745;
            color: white;
        }

        .announcement-message {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .announcement-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .announcement-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 98%;
            max-width: none;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .print-only {
            display: none;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .schedule-display { box-shadow: none; }
            .btn { display: none !important; }
            .shift-actions { display: none !important; }
            body { background: white; }
            .header { background: #333 !important; }
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .workplace-grid { grid-template-columns: 1fr; }
            .action-buttons, .admin-buttons { flex-direction: column; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
            .modal-content { margin: 10% auto; width: 95%; }
        }

        .shift.forced-shift {
            border: 2.5px solid #e53935 !important;
            box-shadow: 0 0 0 2px #e5393533 !important;
            position: relative;
        }
        .shift.forced-shift::after {
            content: "!";
            color: #e53935;
            font-weight: bold;
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.2rem;
            background: #fff;
            border-radius: 50%;
            border: 1.5px solid #e53935;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        /* Shift Swap Request Cards */
        .swap-request-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .swap-request-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .swap-request-card.pending {
            border-left: 4px solid #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .swap-request-card.approved {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
        }

        .swap-request-card.denied {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .swap-request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .swap-request-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .swap-request-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .status-badge.approved {
            background: #28a745;
            color: white;
        }

        .status-badge.denied {
            background: #dc3545;
            color: white;
        }

        .swap-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .swap-detail {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .swap-detail-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .swap-detail-value {
            font-weight: 600;
            color: #333;
        }

        .swap-reason {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .swap-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .swap-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üè¢ Workplace Scheduler</h1>
        <div class="user-info">
            <span id="userEmail"></span>
            <span id="adminBadge" class="admin-badge">ADMIN</span>
            <span id="userBadge" class="user-badge">USER</span>
            <button class="btn" id="myAccountBtn" style="background:#eee;color:#333;margin-right:0.5rem;">üë§ My Account</button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Admin Controls -->
        <div id="adminSection" class="admin-section" style="display: none;">
            <h2 class="section-title admin-title">üîß Admin Controls</h2>
            <div class="admin-buttons">
                <button class="btn btn-admin" onclick="showManageHours()">‚è∞ Manage Hours</button>
                <button class="btn btn-admin" onclick="showManageWorkers()">üë• Manage Workers</button>
                <button class="btn btn-admin" onclick="showAddWorker()">‚ûï Add Worker</button>
                <button class="btn btn-admin" onclick="showImportWorkers()">üì• Import Workers</button>
                <button class="btn btn-warning" id="hourRequestsBtn" style="position:relative;">‚è∞ Hour Requests <span id="hourRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-info" id="viewMessagesBtn" style="position:relative;">üì• View Messages <span id="messagesBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-warning" id="timeOffRequestsBtn" style="position:relative;">üèñÔ∏è Time Off Requests <span id="timeOffRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-info" id="shiftSwapRequestsBtn" style="position:relative;">üîÑ Shift Swap Requests <span id="shiftSwapRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-warning" id="emailChangeRequestsBtn" style="position:relative;">üìß Email Change Requests <span id="emailChangeRequestsBadge" style="display:none;position:absolute;top:-8px;right:-8px;background:#dc3545;color:white;border-radius:50%;padding:2px 7px;font-size:0.8em;">!</span></button>
                <button class="btn btn-danger" id="removeAllWorkersBtn">üóëÔ∏è Remove All Workers</button>
                <button class="btn btn-danger" id="cleanupSchedulesBtn">üßπ Clean Up Old Schedules</button>
            </div>
        </div>

        <!-- Workplace Selection -->
        <div class="workplace-section">
            <h2 class="section-title">Select Workplace</h2>
            <div class="workplace-grid" id="workplaceGrid">
                <div class="workplace-card" onclick="selectWorkplace('esports_lounge')">
                    <h4>üéÆ eSports Lounge</h4>
                    <p>esports_lounge</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('esports_arena')">
                    <h4>üèüÔ∏è eSports Arena</h4>
                    <p>esports_arena</p>
                </div>
                <div class="workplace-card" onclick="selectWorkplace('it_service_center')">
                    <h4>üíª IT Service Center</h4>
                    <p>it_service_center</p>
                </div>
            </div>
        </div>

        <!-- Schedule Management -->
        <div class="schedule-content" id="scheduleContent">
            <div class="workplace-section">
                <h2 class="section-title">Schedule Management</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showGenerateForm()" id="generateBtn">üìÖ Generate New Schedule</button>
                    <button class="btn btn-success" onclick="viewCurrentSchedule()">üëÅÔ∏è View Current Schedule</button>
                    <button class="btn btn-info" onclick="viewHistory()">üìö Schedule History</button>
                    <button class="btn btn-warning" onclick="checkAvailability()">üîç Check Availability</button>
                    <button class="btn btn-secondary" onclick="viewWorkers()" id="viewWorkersBtn">üë• View Workers</button>
                    <button class="btn btn-info" onclick="showWhosWorkingNow()" id="whosWorkingNowBtn" style="display:none;">üïí Who's Working Now?</button>
                </div>

                <!-- Generate Schedule Form -->
                <div class="form-section" id="generateForm">
                    <h3>Generate New Schedule</h3>
                    <div class="info">
                        <strong>üí° Schedule Generation Tips:</strong><br>
                        ‚Ä¢ Work study students automatically get exactly 5 hours<br>
                        ‚Ä¢ Algorithm ensures all operating hours are covered<br>
                        ‚Ä¢ Fair distribution based on worker availability<br>
                        ‚Ä¢ Unfilled shifts will be highlighted for attention
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maxHours">Max Hours per Worker</label>
                            <input type="number" id="maxHours" value="20" min="5" max="40">
                        </div>
                        <div class="form-group">
                            <label for="workersPerShift">Workers per Shift</label>
                            <input type="number" id="workersPerShift" value="2" min="1" max="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="minHours">Min Hours per Worker</label>
                            <input type="number" id="minHours" value="3" min="0" max="20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="ensureFullCoverage" checked>
                            Ensure complete coverage of all operating hours
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="generateSchedule()" id="generateScheduleBtn">üöÄ Generate Schedule</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Check Availability Form -->
                <div class="form-section" id="availabilityForm">
                    <h3>Check Worker Availability</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availDay">Day</label>
                            <select id="availDay">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="availStart">Start Time</label>
                            <input type="time" id="availStart">
                        </div>
                        <div class="form-group">
                            <label for="availEnd">End Time</label>
                            <input type="time" id="availEnd">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="findAvailable()">üîç Find Available Workers</button>
                    <button class="btn btn-secondary" onclick="hideAllForms()">Cancel</button>
                </div>

                <!-- Schedule Display -->
                <div id="scheduleDisplay">
                    <div class="loading">Select an option above to get started.</div>
                </div>
            </div>
        </div>

        <!-- User Dashboard (non-admin) -->
        <div id="userDashboard" class="workplace-section" style="display:none; margin-bottom:2rem;">
            <h2 class="section-title">üë§ User Dashboard</h2>
            <div id="userWelcome" style="font-size:1.1rem; margin-bottom:1.5rem;"></div>
            <!-- Request Availability Change Button -->
            <button class="btn btn-info" id="requestAvailabilityBtn" style="margin-bottom:1.5rem;">‚úèÔ∏è Request Availability Change</button>
            <!-- Request Time Off Button -->
            <button class="btn btn-warning" id="requestTimeOffBtn" style="margin-bottom:1.5rem;">üèñÔ∏è Request Time Off</button>
            <!-- Request Shift Swap Button -->
            <button class="btn btn-info" id="requestShiftSwapBtn" style="margin-bottom:1.5rem;">üîÑ Request Shift Swap</button>
            <!-- My Shift Swap Requests Button -->
            <button class="btn btn-info" id="myShiftSwapRequestsBtn" style="margin-bottom:1.5rem;">üìã My Swap Requests</button>
            <!-- Removed My Account section from here -->
            <div class="form-section" style="margin-bottom:1.5rem;">
                <h3>üìÖ My Assigned Shifts</h3>
                <div id="userShiftsPlaceholder" style="color:#888;">(Your assigned shifts will appear here.)</div>
            </div>
            <div class="form-section" style="margin-bottom:1.5rem;">
                <h3>‚è∞ Total Hours This Week</h3>
                <div id="userHoursPlaceholder" style="color:#888;">(Your total hours will appear here.)</div>
            </div>
            <div class="form-section" style="margin-bottom:1.5rem;">
                <h3>üóìÔ∏è My Availability</h3>
                <div id="userAvailabilityPlaceholder" style="color:#888;">(Your availability will appear here.)</div>
            </div>
            <div class="form-section">
                <h3>‚úâÔ∏è Send a Message to Admins</h3>
                <textarea id="userMessageInput" rows="3" style="width:100%;border-radius:8px;padding:1rem;" placeholder="Type your message or question here..."></textarea>
                <button class="btn btn-info" id="sendUserMessageBtn" style="margin-top:0.5rem;">Send Message</button>
            </div>
        </div>
        <!-- Modal for Request Availability Change -->
        <div id="availabilityRequestModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>‚úèÔ∏è Request Availability Change</h3>
                    <span class="close" onclick="closeModal('availabilityRequestModal')">&times;</span>
                </div>
                <form id="availabilityRequestForm">
                    <div class="form-group">
                        <label for="requestName">Name</label>
                        <input type="text" id="requestName" required>
                    </div>
                    <div class="form-group">
                        <label for="requestEmail">Email</label>
                        <input type="email" id="requestEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="requestAvailability">Requested Availability</label>
                        <textarea id="requestAvailability" rows="3" required placeholder="e.g. Monday 9am-2pm, Tuesday 1pm-5pm"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success" id="submitAvailabilityRequestBtn">Submit Request</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('availabilityRequestModal')" style="margin-top:0.5rem;">Cancel</button>
                </form>
            </div>
        </div>
        <!-- Modal for Admin Hour Requests -->
        <div id="hourRequestsModal" class="modal">
            <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                <div class="modal-header">
                    <h3>‚è∞ Hour Change Requests</h3>
                    <span class="close" onclick="closeModal('hourRequestsModal')">&times;</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-info" onclick="filterRequests('all')" id="filterAllBtn">All Requests</button>
                    <button class="btn btn-warning" onclick="filterRequests('pending')" id="filterPendingBtn">Pending</button>
                    <button class="btn btn-success" onclick="filterRequests('resolved')" id="filterResolvedBtn">Resolved</button>
                </div>
                <div id="hourRequestsList" style="max-height: 60vh; overflow-y: auto;">
                    <div class="loading">Loading requests...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Hours -->
    <div id="hoursModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>‚è∞ Manage Hours of Operation</h3>
                <span class="close" onclick="closeModal('hoursModal')">&times;</span>
            </div>
            <div id="hoursModalContent">
                <div class="loading">Loading hours...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Manage Workers -->
    <div id="workersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• Manage Workers</h3>
                <span class="close" onclick="closeModal('workersModal')">&times;</span>
            </div>
            <div id="workersModalContent">
                <div class="loading">Loading workers...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Worker -->
    <div id="workerFormModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 id="workerFormTitle">‚ûï Add Worker</h3>
                <span class="close" onclick="closeModal('workerFormModal')">&times;</span>
            </div>
            <form id="workerForm">
                <!-- Basic Information Section -->
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #333;">üë§ Basic Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workerFirstName">First Name</label>
                            <input type="text" id="workerFirstName" required style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label for="workerLastName">Last Name</label>
                            <input type="text" id="workerLastName" required style="width: 100%;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workerEmail">Email</label>
                            <input type="email" id="workerEmail" required style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label for="workerWorkStudy">Work Study</label>
                            <select id="workerWorkStudy" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Availability Section -->
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #333;">üìÖ Weekly Availability</h4>
                    <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.9rem;">
                        Click the ‚ûï button next to each day to add availability slots. You can add multiple time slots per day.
                    </p>
                    
                    <div id="availabilityContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        <!-- Sunday -->
                        <div class="day-availability-card" data-day="Sun">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #e74c3c;">Sunday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Sun')" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Sun"></div>
                        </div>

                        <!-- Monday -->
                        <div class="day-availability-card" data-day="Mon">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #3498db;">Monday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Mon')" style="background: #3498db; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Mon"></div>
                        </div>

                        <!-- Tuesday -->
                        <div class="day-availability-card" data-day="Tue">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #9b59b6;">Tuesday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Tue')" style="background: #9b59b6; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Tue"></div>
                        </div>

                        <!-- Wednesday -->
                        <div class="day-availability-card" data-day="Wed">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #f39c12;">Wednesday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Wed')" style="background: #f39c12; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Wed"></div>
                        </div>

                        <!-- Thursday -->
                        <div class="day-availability-card" data-day="Thu">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #27ae60;">Thursday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Thu')" style="background: #27ae60; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Thu"></div>
                        </div>

                        <!-- Friday -->
                        <div class="day-availability-card" data-day="Fri">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #e67e22;">Friday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Fri')" style="background: #e67e22; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Fri"></div>
                        </div>

                        <!-- Saturday -->
                        <div class="day-availability-card" data-day="Sat">
                            <div class="day-header">
                                <h5 style="margin: 0; color: #34495e;">Saturday</h5>
                                <button type="button" class="add-slot-btn" onclick="addAvailabilitySlot('Sat')" style="background: #34495e; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">‚ûï</button>
                            </div>
                            <div class="slots-container" id="slots-Sat"></div>
                        </div>
                    </div>

                    <!-- Hidden field to store the formatted availability -->
                    <input type="hidden" id="workerAvailability" name="workerAvailability">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-success" onclick="submitWorkerForm()">üíæ Save Worker</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('workerFormModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Time Slot -->
    <div id="timeSlotModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="timeSlotModalTitle">‚è∞ Add Time Slot</h3>
                <span class="close" onclick="closeModal('timeSlotModal')">&times;</span>
            </div>
            <form id="timeSlotForm">
                <div class="form-group">
                    <label for="slotStartTime">Start Time</label>
                    <input type="time" id="slotStartTime" required>
                </div>
                <div class="form-group">
                    <label for="slotEndTime">End Time</label>
                    <input type="time" id="slotEndTime" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-success" onclick="submitTimeSlotForm()">‚ûï Add Slot</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('timeSlotModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add a minimal modal to the HTML if not present -->
    <div id="editShiftModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Edit Shift</h3>
                <span class="close" onclick="closeModal('editShiftModal')">&times;</span>
            </div>
            <div id="editShiftModalBody"></div>
        </div>
    </div>

    <!-- Add modal for import feedback -->
    <div id="importWorkersModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3>Import Workers</h3>
          <span class="close" onclick="closeModal('importWorkersModal')">&times;</span>
        </div>
        <div id="importWorkersModalBody"></div>
      </div>
    </div>

    <!-- Add modal for Add Shift if not present -->
    <div id="addShiftModal" class="modal">
        <div class="modal-content" style="max-width: none; width: 98%;">
            <div class="modal-header">
                <h3>Add New Shift</h3>
                <span class="close" onclick="closeModal('addShiftModal')">&times;</span>
            </div>
            <div id="addShiftModalBody"></div>
        </div>
    </div>

    <!-- Add Workplace Notes section below Schedule Management -->
    <div id="workplaceNotesSection" class="form-section" style="margin-top:1.5rem; display:none;">
        <h3>ÔøΩÔøΩ Workplace Notes</h3>
        <div id="workplaceNotesContent"></div>
    </div>

    <!-- Enhanced Announcements Board -->
    <div id="announcementsSection" class="workplace-section" style="margin-top:1.5rem; display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>üì¢ Workplace Announcements</h3>
            <button class="btn btn-success" id="addAnnouncementBtn" style="display: none;">‚ûï Add Announcement</button>
        </div>
        <div id="announcementsContent">
            <div class="loading">Loading announcements...</div>
        </div>
    </div>

    <!-- My Account Modal (for all users) -->
    <div id="myAccountModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚öôÔ∏è My Account</h3>
                <span class="close" onclick="closeModal('myAccountModal')">&times;</span>
            </div>
            <form id="userAccountFormModal" style="max-width: 500px; margin: 0 auto;">
                <div class="form-group">
                    <label for="accountFirstNameModal">First Name</label>
                    <input type="text" id="accountFirstNameModal" required>
                </div>
                <div class="form-group">
                    <label for="accountLastNameModal">Last Name</label>
                    <input type="text" id="accountLastNameModal" required>
                </div>
                <div class="form-group">
                    <label for="accountEmailModal">Email</label>
                    <input type="email" id="accountEmailModal" disabled style="background:#f1f3f4;">
                </div>
                <div class="form-group">
                    <label for="accountPhoneModal">Phone Number <span style="color:#888;">(optional)</span></label>
                    <input type="tel" id="accountPhoneModal" pattern="[0-9\-\+\(\) ]*">
                </div>
                <button type="button" class="btn btn-success" id="saveAccountBtnModal" style="margin-top:0.5rem;">Save Changes</button>
            </form>
            <hr style="margin:2rem 0;">
            <form id="userPasswordFormModal" style="max-width: 500px; margin: 0 auto;">
                <h4 style="margin-bottom:1rem;">üîí Change Password</h4>
                <div class="form-group">
                    <label for="oldPasswordModal">Current Password</label>
                    <input type="password" id="oldPasswordModal" required>
                </div>
                <div class="form-group">
                    <label for="newPasswordModal">New Password</label>
                    <input type="password" id="newPasswordModal" required>
                </div>
                <div class="form-group">
                    <label for="confirmNewPasswordModal">Confirm New Password</label>
                    <input type="password" id="confirmNewPasswordModal" required>
                </div>
                <button type="button" class="btn btn-info" id="changePasswordBtnModal" style="margin-top:0.5rem;">Change Password</button>
            </form>
            
            <hr style="margin:2rem 0;">
            
            <form id="emailChangeRequestFormModal" style="max-width: 500px; margin: 0 auto;">
                <h4 style="margin-bottom:1rem;">üìß Request Email Change</h4>
                <div class="info" style="margin-bottom:1rem; font-size:0.9rem;">
                    <strong>Note:</strong> Email change requests require admin approval. You can have up to 2 pending requests at a time.
                </div>
                <div class="form-group">
                    <label for="currentEmailModal">Current Email</label>
                    <input type="email" id="currentEmailModal" disabled style="background:#f1f3f4;">
                </div>
                <div class="form-group">
                    <label for="newEmailModal">New Email Address</label>
                    <input type="email" id="newEmailModal" required placeholder="Enter your new email address">
                </div>
                <div class="form-group">
                    <label for="emailChangeReasonModal">Reason for Change <span style="color:#888;">(optional)</span></label>
                    <textarea id="emailChangeReasonModal" rows="3" placeholder="Briefly explain why you need to change your email address..."></textarea>
                </div>
                <button type="button" class="btn btn-warning" id="submitEmailChangeRequestBtn" style="margin-top:0.5rem;">Submit Email Change Request</button>
            </form>
            
            <hr style="margin:2rem 0;">
            
            <div id="emailChangeRequestsHistoryModal" style="max-width: 500px; margin: 0 auto;">
                <h4 style="margin-bottom:1rem;">üìã Email Change Request History</h4>
                <div id="emailChangeRequestsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 1rem;">
                    <div class="loading">Loading your email change requests...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Admin Messages -->
    <div id="adminMessagesModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>üì• Messages to Admins</h3>
                <span class="close" onclick="closeModal('adminMessagesModal')">&times;</span>
            </div>
            <div id="adminMessagesList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading messages...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Request Time Off -->
    <div id="timeOffRequestModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>üèñÔ∏è Request Time Off</h3>
                <span class="close" onclick="closeModal('timeOffRequestModal')">&times;</span>
            </div>
            <form id="timeOffRequestForm">
                <div class="form-group">
                    <label for="timeOffStartDate">Start Date</label>
                    <input type="date" id="timeOffStartDate" required>
                </div>
                <div class="form-group">
                    <label for="timeOffEndDate">End Date <span style="color:#888;">(optional)</span></label>
                    <input type="date" id="timeOffEndDate">
                    <small style="color: #666; font-style: italic;">Leave blank if requesting single day off</small>
                </div>
                <div class="form-group">
                    <label for="timeOffReason">Reason <span style="color:#888;">(optional)</span></label>
                    <textarea id="timeOffReason" rows="3" placeholder="Brief reason for time off request..."></textarea>
                </div>
                <button type="submit" class="btn btn-success" id="submitTimeOffRequestBtn">Submit Request</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('timeOffRequestModal')" style="margin-top:0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Modal for Admin Time Off Requests -->
    <div id="timeOffRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>üèñÔ∏è Time Off Requests</h3>
                <span class="close" onclick="closeModal('timeOffRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterTimeOffRequests('all')" id="filterTimeOffAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterTimeOffRequests('pending')" id="filterTimeOffPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterTimeOffRequests('approved')" id="filterTimeOffApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterTimeOffRequests('denied')" id="filterTimeOffDeniedBtn">Denied</button>
            </div>
            <div id="timeOffRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading time off requests...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Announcement -->
    <div id="announcementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="announcementModalTitle">üì¢ Add Announcement</h3>
                <span class="close" onclick="closeModal('announcementModal')">&times;</span>
            </div>
            <form id="announcementForm">
                <div class="form-group">
                    <label for="announcementSubject">Subject</label>
                    <input type="text" id="announcementSubject" required placeholder="Enter announcement subject...">
                </div>
                <div class="form-group">
                    <label for="announcementMessage">Message</label>
                    <textarea id="announcementMessage" rows="6" required placeholder="Enter announcement message..."></textarea>
                </div>
                <div class="form-group">
                    <label for="announcementPriority">Priority</label>
                    <select id="announcementPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" id="saveAnnouncementBtn">üíæ Save Announcement</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('announcementModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Request Shift Swap -->
    <div id="shiftSwapRequestModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üîÑ Request Shift Swap</h3>
                <span class="close" onclick="closeModal('shiftSwapRequestModal')">&times;</span>
            </div>
            <form id="shiftSwapRequestForm">
                <div class="form-group">
                    <label for="swapRequesterShiftDate">Your Shift Date</label>
                    <input type="date" id="swapRequesterShiftDate" required>
                </div>
                <div class="form-group">
                    <label for="swapRequesterShiftTime">Your Shift Time</label>
                    <select id="swapRequesterShiftTime" required>
                        <option value="">Select your shift time...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="swapTargetWorker">Swap with Worker</label>
                    <select id="swapTargetWorker" required>
                        <option value="">Select worker to swap with...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="swapTargetShiftDate">Their Shift Date</label>
                    <input type="date" id="swapTargetShiftDate" required>
                </div>
                <div class="form-group">
                    <label for="swapTargetShiftTime">Their Shift Time</label>
                    <select id="swapTargetShiftTime" required>
                        <option value="">Select their shift time...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="swapReason">Reason for Swap <span style="color:#888;">(optional)</span></label>
                    <textarea id="swapReason" rows="3" placeholder="Brief reason for the shift swap request..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" id="submitShiftSwapRequestBtn">üîÑ Submit Swap Request</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('shiftSwapRequestModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Admin Shift Swap Requests -->
    <div id="shiftSwapRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>üîÑ Shift Swap Requests</h3>
                <span class="close" onclick="closeModal('shiftSwapRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterShiftSwapRequests('all')" id="filterSwapAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterShiftSwapRequests('pending')" id="filterSwapPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterShiftSwapRequests('approved')" id="filterSwapApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterShiftSwapRequests('denied')" id="filterSwapDeniedBtn">Denied</button>
            </div>
            <div id="shiftSwapRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading shift swap requests...</div>
            </div>
        </div>
    </div>

    <!-- Modal for User Shift Swap Requests -->
    <div id="userShiftSwapRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3>üìã My Shift Swap Requests</h3>
                <span class="close" onclick="closeModal('userShiftSwapRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterUserShiftSwapRequests('all')" id="filterUserSwapAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterUserShiftSwapRequests('pending')" id="filterUserSwapPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterUserShiftSwapRequests('approved')" id="filterUserSwapApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterUserShiftSwapRequests('denied')" id="filterUserSwapDeniedBtn">Denied</button>
            </div>
            <div id="userShiftSwapRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading your shift swap requests...</div>
            </div>
        </div>
    </div>

    <!-- Modal for Admin Email Change Requests -->
    <div id="adminEmailChangeRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 80vh;">
            <div class="modal-header">
                <h3>üìß Email Change Requests</h3>
                <span class="close" onclick="closeModal('adminEmailChangeRequestsModal')">&times;</span>
            </div>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-info" onclick="filterEmailChangeRequests('all')" id="filterEmailAllBtn">All Requests</button>
                <button class="btn btn-warning" onclick="filterEmailChangeRequests('pending')" id="filterEmailPendingBtn">Pending</button>
                <button class="btn btn-success" onclick="filterEmailChangeRequests('approved')" id="filterEmailApprovedBtn">Approved</button>
                <button class="btn btn-danger" onclick="filterEmailChangeRequests('denied')" id="filterEmailDeniedBtn">Denied</button>
                <button class="btn btn-secondary" onclick="exportEmailChangeRequests()" style="float: right;">üì§ Export</button>
            </div>
            <div id="adminEmailChangeRequestsList" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">Loading email change requests...</div>
            </div>
        </div>
    </div>

    <!-- Add zod for schema validation -->
    <script src="https://cdn.jsdelivr.net/npm/zod@3.22.4/lib/index.umd.min.js"></script>

    <!-- Modal for Availability Format Error -->
    <div id="availabilityFormatModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3>‚ö†Ô∏è Invalid Availability Format</h3>
          <span class="close" onclick="closeModal('availabilityFormatModal')">&times;</span>
        </div>
        <div id="availabilityFormatModalBody">
          <div style="margin-bottom:1rem;">
            <strong>Please enter availability in the correct format:</strong><br>
            <span style="color:#333;">Day HH:MM-HH:MM, Day HH:MM-HH:MM</span><br>
            <span style="color:#888;">Examples: <br>Mon 09:00-17:00, Tue 10:00-16:00<br>Monday 08:00-12:00, Wednesday 13:00-17:00</span>
          </div>
          <textarea id="availabilityFormatModalInput" rows="3" style="width:100%;border-radius:8px;padding:1rem;"></textarea>
          <div id="availabilityFormatModalError" style="color:#c33;margin-top:0.5rem;"></div>
          <div style="margin-top:1rem;display:flex;gap:1rem;">
            <button class="btn btn-success" id="availabilityFormatModalTryBtn">Try Again</button>
            <button class="btn btn-secondary" onclick="closeModal('availabilityFormatModal')">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
        // Enhanced auth check and setup
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'index.html';
        }
        
        document.getElementById('userEmail').textContent = user.email;
        if (user.isAdmin) {
            document.getElementById('adminBadge').style.display = 'inline';
            document.getElementById('adminSection').style.display = 'block';
            document.getElementById('userBadge').style.display = 'none';
        } else {
            document.getElementById('adminBadge').style.display = 'none';
            document.getElementById('userBadge').style.display = 'inline';
            // Hide admin-only buttons for non-admin users
            document.getElementById('generateBtn').style.display = 'none';
        }

        // Firebase setup
        import { initializeApp, getApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, setDoc, where
        } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

        const workplaceConfig = {
            apiKey: "AIzaSyBkkq4nPnmyfSOKtVLsO95rpAUsMDA1o0A",
            authDomain: "workplace-scheduler-ace38.firebaseapp.com", 
            projectId: "workplace-scheduler-ace38",
            storageBucket: "workplace-scheduler-ace38.firebasestorage.app",
            messagingSenderId: "153631302747",
            appId: "1:153631302747:web:2c731351893dca19510b7e"
        };

        const workplaceApp = initializeApp(workplaceConfig);
        const db = getFirestore(workplaceApp);

        // Global state
        let selectedWorkplace = null;
        let workers = [];
        let hours = {};
        let editingWorkerId = null;
        let schedule = {};
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let currentScheduleId = null; // <-- Track the current schedule doc ID

        // Enhanced utility functions
        const timeToHour = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            // Convert to 24-hour format for internal calculations
            return h + (m / 60);
        };

        const hourToTime = (hour) => {
            const h = Math.floor(hour);
            const m = Math.round((hour - h) * 60);
            // Handle hours >= 24 (overnight shifts)
            const adjustedHour = h >= 24 ? h - 24 : h;
            return `${adjustedHour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        };

        const formatTime = (timeStr) => {
            if (!timeStr) return '';
            let [h, m] = timeStr.split(':').map(Number);
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m.toString().padStart(2, '0')} ${period}`;
        };

        // Enhanced availability parsing
        const parseAvailability = (availabilityText) => {
            const availability = {};
            if (!availabilityText) return availability;
            
            const dayMap = {
                'sunday': 'Sunday', 'sun': 'Sunday',
                'monday': 'Monday', 'mon': 'Monday',
                'tuesday': 'Tuesday', 'tue': 'Tuesday',
                'wednesday': 'Wednesday', 'wed': 'Wednesday',
                'thursday': 'Thursday', 'thu': 'Thursday',
                'friday': 'Friday', 'fri': 'Friday',
                'saturday': 'Saturday', 'sat': 'Saturday'
            };
            
            const blocks = availabilityText.split(',').map(s => s.trim());
            blocks.forEach(block => {
                const match = block.match(/(\w+)\s+(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/i);
                if (match) {
                    const [, dayRaw, start, end] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    
                    if (day) {
                        let startHour = timeToHour(start);
                        let endHour = timeToHour(end);
                        
                        if (endHour <= startHour) {
                            endHour += 24.0;
                        }
                        
                        if (!availability[day]) availability[day] = [];
                        
                        availability[day].push({
                            start: start,
                            end: end,
                            start_hour: startHour,
                            end_hour: endHour
                        });
                    }
                }
            });
            
            return availability;
        };

        const isWorkerAvailable = (worker, day, startHour, endHour) => {
            const dayAvail = worker.availability[day] || [];
            return dayAvail.some(slot => slot.start_hour <= startHour && endHour <= slot.end_hour);
        };

        // Enhanced loading state management
        const setLoading = (elementId, isLoading, originalText = '') => {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (isLoading) {
                element.classList.add('loading');
                element.disabled = true;
                element.setAttribute('data-original-text', element.textContent);
                element.textContent = 'üîÑ Loading...';
            } else {
                element.classList.remove('loading');
                element.disabled = false;
                const original = element.getAttribute('data-original-text') || originalText;
                if (original) element.textContent = original;
            }
        };

        // Enhanced error handling
        const showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            notification.className = `${type} notification`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        };

        // Enhanced schedule validation
        const validateScheduleCoverage = (schedule, hoursOfOperation) => {
            const coverageGaps = [];
            const warnings = [];
            
            for (const [day, hours] of Object.entries(hoursOfOperation)) {
                for (const hour of hours) {
                    let opStart = timeToHour(hour.start);
                    let opEnd = timeToHour(hour.end);
                    if (opEnd === 0 && hour.end === '00:00') opEnd = 24;
                    
                    // Check if this time period is covered by any shift
                    const dayShifts = schedule[day] || [];
                    const coveredPeriods = [];
                    
                    dayShifts.forEach(shift => {
                        if (!shift.assigned.includes('Unfilled')) {
                            let shiftStart = timeToHour(shift.start);
                            let shiftEnd = timeToHour(shift.end);
                            if (shiftEnd === 0 && shift.end === '00:00') shiftEnd = 24;
                            coveredPeriods.push([shiftStart, shiftEnd]);
                        }
                    });
                    
                    // Sort covered periods
                    coveredPeriods.sort((a, b) => a[0] - b[0]);
                    
                    // Find gaps
                    let currentTime = opStart;
                    for (const [start, end] of coveredPeriods) {
                        if (start > currentTime) {
                            // There's a gap
                            coverageGaps.push({
                                day,
                                start: hourToTime(currentTime),
                                end: hourToTime(start),
                                duration: start - currentTime
                            });
                        }
                        currentTime = Math.max(currentTime, end);
                    }
                    
                    // Check if there's a gap at the end
                    if (currentTime < opEnd) {
                        coverageGaps.push({
                            day,
                            start: hourToTime(currentTime),
                            end: hourToTime(opEnd),
                            duration: opEnd - currentTime
                        });
                    }
                }
            }
            
            return { coverageGaps, warnings };
        };

        // Utility functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        const calculateAvailabilityHours = (worker) => {
            let totalHours = 0;
            for (const daySlots of Object.values(worker.availability || {})) {
                for (const slot of daySlots) {
                    totalHours += slot.end_hour - slot.start_hour;
                }
            }
            return totalHours;
        };

        const findOptimalShiftSplit = (windows, remainingHours, preferSplit = true) => {
            if (!windows || remainingHours <= 0) {
                return [];
            }
            
            const totalAvailable = windows.reduce((sum, [day, start, end]) => sum + (end - start), 0);
            if (totalAvailable < remainingHours) {
                return windows.map(([day, start, end]) => [day, start, end, end - start]);
            }
            
            if (preferSplit && remainingHours === 5.0) {
                for (let i = 0; i < windows.length; i++) {
                    const [day1, s1, e1] = windows[i];
                    if (2.8 <= (e1 - s1) && (e1 - s1) <= 3.2) {
                        for (let j = 0; j < windows.length; j++) {
                            if (i !== j) {
                                const [day2, s2, e2] = windows[j];
                                if (1.8 <= (e2 - s2) && (e2 - s2) <= 2.2) {
                                    return [
                                        [day1, s1, s1 + 3.0, 3.0],
                                        [day2, s2, s2 + 2.0, 2.0]
                                    ];
                                }
                            }
                        }
                    }
                }
            }
            
            const result = [];
            let remaining = remainingHours;
            const sortedWindows = [...windows].sort((a, b) => (a[2] - a[1]) - (b[2] - b[1]));
            
            for (const [day, start, end] of sortedWindows) {
                if (remaining <= 0) break;
                
                const windowDuration = end - start;
                const take = Math.min(windowDuration, remaining);
                result.push([day, start, start + take, take]);
                remaining -= take;
            }
            
            return result;
        };

        const checkWorkStudyAvailability = (wsWorkers, hoursOfOperation) => {
            const issues = [];
            
            for (const worker of wsWorkers) {
                let matchingHours = 0;
                
                for (const [day, ops] of Object.entries(hoursOfOperation)) {
                    for (const op of ops) {
                        let opStart = timeToHour(op.start);
                        let opEnd = timeToHour(op.end);
                        if (opEnd <= opStart) opEnd += 24;
                        
                        for (const a of worker.availability[day] || []) {
                            const overlapStart = Math.max(opStart, a.start_hour);
                            const overlapEnd = Math.min(opEnd, a.end_hour);
                            if (overlapEnd > overlapStart) {
                                matchingHours += (overlapEnd - overlapStart);
                            }
                        }
                    }
                }
                
                if (matchingHours < 5) {
                    issues.push([
                        worker,
                        `Only ${matchingHours.toFixed(1)} hours available during operating hours (needs 5)`
                    ]);
                }
            }
            
            return issues;
        };

        // Logout function
        window.logout = function() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        };

        // PRODUCTION-READY: Comprehensive validation and safety functions
        const validateScheduleInputs = (hoursOfOperation, workersData, maxHoursPerWorker, maxWorkersPerShift, minHoursPerWorker) => {
            const errors = [];
            const warnings = [];
            
            // Validate hours of operation
            if (!hoursOfOperation || typeof hoursOfOperation !== 'object') {
                errors.push('Hours of operation must be a valid object');
            } else {
                for (const [day, hours] of Object.entries(hoursOfOperation)) {
                    if (!Array.isArray(hours)) {
                        errors.push(`Invalid hours format for ${day}`);
                        continue;
                    }
                    for (const hour of hours) {
                        if (!hour.start || !hour.end) {
                            errors.push(`Missing start/end time for ${day}`);
                            continue;
                        }
                        const start = timeToHour(hour.start);
                        const end = timeToHour(hour.end);
                        if (isNaN(start) || isNaN(end)) {
                            errors.push(`Invalid time format for ${day}: ${hour.start}-${hour.end}`);
                        }
                    }
                }
            }
            
            // Validate workers data
            if (!Array.isArray(workersData) || workersData.length === 0) {
                errors.push('Workers data must be a non-empty array');
            } else {
                for (const worker of workersData) {
                    if (!worker.email || !worker.first_name || !worker.last_name) {
                        errors.push(`Worker missing required fields: ${worker.email || 'no email'}`);
                    }
                    if (!worker.availability || typeof worker.availability !== 'object') {
                        errors.push(`Worker ${worker.email} has invalid availability data`);
                    }
                }
            }
            
            // Validate parameters
            if (maxHoursPerWorker < 1 || maxHoursPerWorker > 40) {
                errors.push('Max hours per worker must be between 1 and 40');
            }
            if (maxWorkersPerShift < 1 || maxWorkersPerShift > 10) {
                errors.push('Max workers per shift must be between 1 and 10');
            }
            if (minHoursPerWorker < 0 || minHoursPerWorker > maxHoursPerWorker) {
                errors.push('Min hours per worker must be between 0 and max hours');
            }
            
            return { errors, warnings };
        };
        
        const validateShiftAssignment = (worker, day, start, end, assignedHours, maxHoursPerWorker, shiftAssignments, maxWorkersPerShift) => {
            const errors = [];
            const warnings = [];
            
            // Validate worker exists
            if (!worker || !worker.email) {
                errors.push('Invalid worker data');
                return { valid: false, errors, warnings };
            }
            
            // Validate time format
            const startHour = timeToHour(start);
            const endHour = timeToHour(end);
            if (isNaN(startHour) || isNaN(endHour)) {
                errors.push(`Invalid time format: ${start}-${end}`);
                return { valid: false, errors, warnings };
            }
            
            // Validate shift duration
            let duration = endHour - startHour;
            if (duration <= 0) {
                duration += 24; // Handle overnight shifts
            }
            if (duration < 0.5 || duration > 12) {
                errors.push(`Invalid shift duration: ${duration.toFixed(1)} hours`);
                return { valid: false, errors, warnings };
            }
            
            // Check worker availability
            if (!isWorkerAvailable(worker, day, startHour, endHour)) {
                errors.push(`Worker ${worker.first_name} ${worker.last_name} not available on ${day} from ${start} to ${end}`);
                return { valid: false, errors, warnings };
            }
            
            // Check hours limit
            const currentHours = assignedHours[worker.email] || 0;
            if (currentHours + duration > maxHoursPerWorker) {
                errors.push(`Worker ${worker.first_name} ${worker.last_name} would exceed max hours (${currentHours + duration} > ${maxHoursPerWorker})`);
                return { valid: false, errors, warnings };
            }
            
            // Check duplicate assignment
            const shiftKey = `${day}_${start}_${end}`;
            if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(worker.email)) {
                errors.push(`Worker ${worker.first_name} ${worker.last_name} already assigned to ${day} ${start}-${end}`);
                return { valid: false, errors, warnings };
            }
            
            // Check shift capacity
            const currentWorkers = shiftAssignments.get(shiftKey) || new Set();
            if (currentWorkers.size >= maxWorkersPerShift) {
                errors.push(`Shift ${day} ${start}-${end} is at capacity (${currentWorkers.size}/${maxWorkersPerShift})`);
                return { valid: false, errors, warnings };
            }
            
            return { valid: true, errors, warnings, duration };
        };
        
        const validateWorkStudyRequirements = (wsWorkers, assignedHours) => {
            const issues = [];
            const violations = [];
            
            for (const worker of wsWorkers) {
                const hours = assignedHours[worker.email] || 0;
                if (hours < 5) {
                    issues.push(`${worker.first_name} ${worker.last_name}: Only ${hours.toFixed(1)} hours assigned (needs 5)`);
                    violations.push({ worker, hours, required: 5 });
                } else if (hours > 5.1) {
                    issues.push(`${worker.first_name} ${worker.last_name}: ${hours.toFixed(1)} hours assigned (should be exactly 5)`);
                    violations.push({ worker, hours, required: 5 });
                }
            }
            
            return { issues, violations };
        };
        
        const validateScheduleCoverageComprehensive = (schedule, hoursOfOperation) => {
            const gaps = [];
            const warnings = [];
            
            for (const [day, hours] of Object.entries(hoursOfOperation)) {
                for (const hour of hours) {
                    let opStart = timeToHour(hour.start);
                    let opEnd = timeToHour(hour.end);
                    if (opEnd === 0 && hour.end === '00:00') opEnd = 24;
                    
                    const dayShifts = schedule[day] || [];
                    const coveredPeriods = [];
                    
                    dayShifts.forEach(shift => {
                        if (shift.assigned && shift.assigned.length > 0 && !shift.assigned.includes('Unfilled')) {
                            let shiftStart = timeToHour(shift.start);
                            let shiftEnd = timeToHour(shift.end);
                            if (shiftEnd === 0 && shift.end === '00:00') shiftEnd = 24;
                            coveredPeriods.push([shiftStart, shiftEnd]);
                        }
                    });
                    
                    // Sort and merge overlapping periods
                    coveredPeriods.sort((a, b) => a[0] - b[0]);
                    const merged = [];
                    for (const [start, end] of coveredPeriods) {
                        if (merged.length === 0 || merged[merged.length - 1][1] < start) {
                            merged.push([start, end]);
                        } else {
                            merged[merged.length - 1][1] = Math.max(merged[merged.length - 1][1], end);
                        }
                    }
                    
                    // Find gaps
                    let currentTime = opStart;
                    for (const [start, end] of merged) {
                        if (start > currentTime) {
                            gaps.push({
                                day,
                                start: hourToTime(currentTime),
                                end: hourToTime(start),
                                duration: start - currentTime
                            });
                        }
                        currentTime = Math.max(currentTime, end);
                    }
                    
                    if (currentTime < opEnd) {
                        gaps.push({
                            day,
                            start: hourToTime(currentTime),
                            end: hourToTime(opEnd),
                            duration: opEnd - currentTime
                        });
                    }
                }
            }
            
            return { gaps, warnings };
        };
        
        const safeAssignWorkerToShift = (worker, day, start, end, schedule, assignedHours, shiftAssignments, maxWorkersPerShift) => {
            try {
                // Validate the assignment
                const validation = validateShiftAssignment(
                    worker, day, start, end, assignedHours, 
                    assignedHours.maxHours || 20, shiftAssignments, maxWorkersPerShift
                );
                
                if (!validation.valid) {
                    console.error('‚ùå Assignment validation failed:', validation.errors);
                    return { success: false, errors: validation.errors };
                }
                
                const { duration } = validation;
                const shiftKey = `${day}_${start}_${end}`;
                
                // Update tracking
                if (!shiftAssignments.has(shiftKey)) {
                    shiftAssignments.set(shiftKey, new Set());
                }
                shiftAssignments.get(shiftKey).add(worker.email);
                
                // Update hours
                assignedHours[worker.email] = (assignedHours[worker.email] || 0) + duration;
                
                // Create or update shift
                if (!schedule[day]) schedule[day] = [];
                
                const existingShift = schedule[day].find(s => s.start === start && s.end === end);
                if (existingShift) {
                    existingShift.assigned.push(`${worker.first_name} ${worker.last_name}`);
                    existingShift.raw_assigned.push(worker.email);
                    existingShift.all_available.push(worker);
                } else {
                    schedule[day].push({
                        start,
                        end,
                        assigned: [`${worker.first_name} ${worker.last_name}`],
                        available: [`${worker.first_name} ${worker.last_name}`],
                        raw_assigned: [worker.email],
                        all_available: [worker],
                        is_work_study: worker.work_study || false
                    });
                }
                
                console.log(`‚úÖ Safe assignment: ${worker.first_name} ${worker.last_name} to ${day} ${start}-${end} (${duration.toFixed(1)}h)`);
                return { success: true, duration };
                
            } catch (error) {
                console.error('‚ùå Error in safe assignment:', error);
                return { success: false, errors: [error.message] };
            }
        };

        // Enhanced scheduling algorithm with guaranteed coverage and work study protection
        const createShiftsFromAvailability = (hoursOfOperation, workersData, maxHoursPerWorker = 20, maxWorkersPerShift = 2, minHoursPerWorker = 3, ensureFullCoverage = true) => {
            console.log('üöÄ PRODUCTION: Starting enhanced schedule generation with comprehensive validation');
            
            // PRODUCTION-READY: Comprehensive input validation
            const inputValidation = validateScheduleInputs(hoursOfOperation, workersData, maxHoursPerWorker, maxWorkersPerShift, minHoursPerWorker);
            if (inputValidation.errors.length > 0) {
                console.error('‚ùå PRODUCTION: Input validation failed:', inputValidation.errors);
                return { 
                    schedule: {}, 
                    assignedHours: {}, 
                    lowHours: [], 
                    unassigned: [], 
                    altSols: {}, 
                    unfilledShifts: [], 
                    wsIssues: inputValidation.errors, 
                    minHoursIssues: [], 
                    coverageGaps: [],
                    validationErrors: inputValidation.errors
                };
            }
            
            if (inputValidation.warnings.length > 0) {
                console.warn('‚ö†Ô∏è PRODUCTION: Input validation warnings:', inputValidation.warnings);
            }
            
            if (!hoursOfOperation || !workersData || workersData.length === 0) {
                console.warn('Missing data for schedule generation');
                return { schedule: {}, assignedHours: {}, lowHours: [], unassigned: [], altSols: {}, unfilledShifts: [], wsIssues: [], minHoursIssues: [], coverageGaps: [] };
            }

            // CRITICAL FIX: Initialize empty schedule and tracking
            const schedule = {};
            const unfilledShifts = [];
            const shiftLengths = [2, 3, 4, 5];
            const shuffledLengths = shuffleArray(shiftLengths);
            const assignedHours = {};
            const wsStatus = {};
            const availabilityHours = {};
            const forcedAssignments = [];
            
            // CRITICAL FIX: Initialize all workers with 0 hours
            workersData.forEach(w => {
                assignedHours[w.email] = 0;
                wsStatus[w.email] = w.work_study || false;
                availabilityHours[w.email] = calculateAvailabilityHours(w);
            });
            
            // CRITICAL FIX: Track which workers are already assigned to prevent double assignment
            const assignedWorkers = new Set();
            
            // CRITICAL FIX: Track shift assignments to prevent duplicates
            const shiftAssignments = new Map(); // key: `${day}_${start}_${end}`, value: Set of worker emails

            const wsWorkers = workersData.filter(w => wsStatus[w.email]);
            wsWorkers.sort((a, b) => availabilityHours[a.email] - availabilityHours[b.email]);

            const wsAvailabilityIssues = checkWorkStudyAvailability(wsWorkers, hoursOfOperation);
            const initialWsIssues = wsAvailabilityIssues.map(([w, issue]) => 
                `${w.first_name} ${w.last_name}: ${issue}`
            );

            // REMOVED: The early return logic that bypassed work study priority
            // Work study students MUST be prioritized regardless of other conditions

            // Phase 1: Work Study Allocation (exactly 5 hours each) - ENHANCED
            for (const w of wsWorkers) {
                const email = w.email;
                let remaining = 5.0;

                // Find all available windows for this work study student
                const windows = [];
                for (const [day, ops] of Object.entries(hoursOfOperation)) {
                    for (const op of ops) {
                        let opStart = timeToHour(op.start);
                        let opEnd = timeToHour(op.end);
                        if (opEnd <= opStart) opEnd += 24;

                        for (const a of w.availability[day] || []) {
                            const s = Math.max(opStart, a.start_hour);
                            const e = Math.min(opEnd, a.end_hour);
                            if (e > s) {
                                windows.push([day, s, e]);
                            }
                        }
                    }
                }

                // Enhanced algorithm to find exactly 5 hours
                const findWorkStudyShifts = (windows) => {
                    const shifts = [];
                    let totalAssigned = 0;
                    
                    // Sort windows by duration (longest first) to prefer longer shifts
                    const sortedWindows = [...windows].sort((a, b) => (b[1] - b[0]) - (a[1] - a[0]));
                    
                    // Try to find a single 5-hour window first
                    for (const [day, s, e] of sortedWindows) {
                        if (e - s >= 5 && totalAssigned === 0) {
                            return [[day, s, s + 5, 5]];
                        }
                    }
                    
                    // Try combinations to get exactly 5 hours
                    const combinations = [
                        [3, 2], [2, 3], [2.5, 2.5], [4, 1], [1, 4],
                        [2, 2, 1], [1, 2, 2], [2, 1, 2],
                        [1.5, 1.5, 2], [2, 1.5, 1.5], [1.5, 2, 1.5]
                    ];
                    
                    for (const combo of combinations) {
                        const tempShifts = [];
                        let tempTotal = 0;
                        const usedWindows = new Set();
                        
                        for (const targetHours of combo) {
                            let found = false;
                            for (let i = 0; i < sortedWindows.length; i++) {
                                if (usedWindows.has(i)) continue;
                                const [day, s, e] = sortedWindows[i];
                                const availableHours = e - s;
                                
                                if (availableHours >= targetHours) {
                                    tempShifts.push([day, s, s + targetHours, targetHours]);
                                    tempTotal += targetHours;
                                    usedWindows.add(i);
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) break;
                        }
                        
                        if (Math.abs(tempTotal - 5) < 0.1) {
                            return tempShifts;
                        }
                    }
                    
                    // If we can't get exactly 5, get as close as possible
                    let bestShifts = [];
                    let bestTotal = 0;
                    
                    for (const [day, s, e] of sortedWindows) {
                        const availableHours = e - s;
                        if (totalAssigned + availableHours <= 5) {
                            bestShifts.push([day, s, e, availableHours]);
                            totalAssigned += availableHours;
                        } else if (totalAssigned < 5) {
                            const remaining = 5 - totalAssigned;
                            if (availableHours >= remaining) {
                                bestShifts.push([day, s, s + remaining, remaining]);
                                totalAssigned = 5;
                            }
                        }
                        if (totalAssigned >= 5) break;
                    }
                    
                    return bestShifts;
                };

                const optimalShifts = findWorkStudyShifts(windows);

                // CRITICAL FIX: Assign the shifts found with proper tracking
                let assignedAny = false;
                for (const [day, start, end, duration] of optimalShifts) {
                    // CRITICAL FIX: Check if worker is already assigned to this time slot
                    const slotStart = hourToTime(start);
                    const slotEnd = hourToTime(end);
                    const shiftKey = `${day}_${slotStart}_${slotEnd}`;
                    
                    // Check if this worker is already assigned to this exact time slot
                    if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(email)) {
                        console.warn(`‚ö†Ô∏è Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping duplicate assignment`);
                        continue;
                    }
                    
                    // Check if this slot is already full with other workers
                    const currentWorkers = shiftAssignments.get(shiftKey) || new Set();
                    if (currentWorkers.size >= maxWorkersPerShift) {
                        console.warn(`Work study student ${w.first_name} ${w.last_name} could not be assigned to ${slotStart}-${slotEnd} (slot full), looking for alternatives...`);
                        continue;
                    }
                    
                    // ENHANCED: Check if there's already a shift at this time that can accommodate this worker
                    const existingShift = schedule[day]?.find(s => s.start === slotStart && s.end === slotEnd);
                    
                    if (existingShift && existingShift.raw_assigned.length < maxWorkersPerShift) {
                        // Add worker to existing shift
                        existingShift.assigned.push(`${w.first_name} ${w.last_name}`);
                        existingShift.raw_assigned.push(email);
                        existingShift.all_available.push(w);
                        existingShift.is_work_study = true;
                        
                        // Add worker to shift tracking
                        if (!shiftAssignments.has(shiftKey)) {
                            shiftAssignments.set(shiftKey, new Set());
                        }
                        shiftAssignments.get(shiftKey).add(email);
                        
                        console.log(`‚úÖ Work study assignment: ${w.first_name} ${w.last_name} added to existing shift ${slotStart}-${slotEnd} on ${day}`);
                    } else {
                        // Create new shift
                        if (!shiftAssignments.has(shiftKey)) {
                            shiftAssignments.set(shiftKey, new Set());
                        }
                        shiftAssignments.get(shiftKey).add(email);
                        
                        if (!schedule[day]) schedule[day] = [];
                        
                        schedule[day].push({
                            start: slotStart,
                            end: slotEnd,
                            assigned: [`${w.first_name} ${w.last_name}`],
                            available: [`${w.first_name} ${w.last_name}`],
                            raw_assigned: [email],
                            all_available: [w],
                            is_work_study: true,
                            forced_shift: true // Mark as forced to ensure it's not overridden
                        });
                        
                        console.log(`‚úÖ Work study assignment: ${w.first_name} ${w.last_name} created new shift ${slotStart}-${slotEnd} on ${day}`);
                    }
                    
                    // CRITICAL FIX: Add hours only once
                    assignedHours[email] += duration;
                    console.log(`‚úÖ Work study assignment: ${w.first_name} ${w.last_name} assigned ${duration}h at ${slotStart}-${slotEnd} on ${day}`);
                    remaining -= duration;
                    assignedAny = true;
                }
                
                // If we couldn't assign any shifts from optimal solution, try fallback assignment
                if (!assignedAny && remaining > 0.1) {
                    console.warn(`Work study student ${w.first_name} ${w.last_name} needs fallback assignment for ${remaining.toFixed(1)} hours`);
                    
                    // Find any available slots that can accommodate the remaining hours
                    for (const [day, ops] of Object.entries(hoursOfOperation)) {
                        if (remaining <= 0.1) break;
                        
                        for (const op of ops) {
                            if (remaining <= 0.1) break;
                            
                            let opStart = timeToHour(op.start);
                            let opEnd = timeToHour(op.end);
                            if (opEnd <= opStart) opEnd += 24;

                            for (const a of w.availability[day] || []) {
                                if (remaining <= 0.1) break;
                                
                                const s = Math.max(opStart, a.start_hour);
                                const e = Math.min(opEnd, a.end_hour);
                                if (e > s) {
                                    const availableDuration = e - s;
                                    const assignDuration = Math.min(availableDuration, remaining);
                                    
                                    // Check if this slot is available
                                    const slotStart = hourToTime(s);
                                    const slotEnd = hourToTime(s + assignDuration);
                                    const existingShifts = (schedule[day] || []).filter(shift => 
                                        shift.start === slotStart && shift.end === slotEnd
                                    );
                                    
                                    // CRITICAL FIX: Check for duplicate assignment using new tracking
                                    const shiftKey = `${day}_${slotStart}_${slotEnd}`;
                                    if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(email)) {
                                        console.warn(`‚ö†Ô∏è Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping fallback assignment`);
                                        continue;
                                    }
                                    
                                    const currentWorkers = shiftAssignments.get(shiftKey) || new Set();
                                    if (currentWorkers.size < maxWorkersPerShift) {
                                        // ENHANCED: Check if there's already a shift at this time
                                        const existingShift = schedule[day]?.find(s => s.start === slotStart && s.end === slotEnd);
                                        
                                        if (existingShift && existingShift.raw_assigned.length < maxWorkersPerShift) {
                                            // Add worker to existing shift
                                            existingShift.assigned.push(`${w.first_name} ${w.last_name}`);
                                            existingShift.raw_assigned.push(email);
                                            existingShift.all_available.push(w);
                                            existingShift.is_work_study = true;
                                            existingShift.fallback_assignment = true;
                                            
                                            // Add worker to shift tracking
                                            if (!shiftAssignments.has(shiftKey)) {
                                                shiftAssignments.set(shiftKey, new Set());
                                            }
                                            shiftAssignments.get(shiftKey).add(email);
                                            
                                            console.log(`Fallback assignment: ${w.first_name} ${w.last_name} added to existing shift ${slotStart}-${slotEnd}`);
                                        } else {
                                            // Create new shift
                                            if (!shiftAssignments.has(shiftKey)) {
                                                shiftAssignments.set(shiftKey, new Set());
                                            }
                                            shiftAssignments.get(shiftKey).add(email);
                                            
                                            if (!schedule[day]) schedule[day] = [];
                                            
                                            schedule[day].push({
                                                start: slotStart,
                                                end: slotEnd,
                                                assigned: [`${w.first_name} ${w.last_name}`],
                                                available: [`${w.first_name} ${w.last_name}`],
                                                raw_assigned: [email],
                                                all_available: [w],
                                                is_work_study: true,
                                                forced_shift: true,
                                                fallback_assignment: true
                                            });
                                            
                                            console.log(`Fallback assignment: ${w.first_name} ${w.last_name} created new shift ${slotStart}-${slotEnd}`);
                                        }
                                        
                                        // CRITICAL FIX: Add hours only once
                                        assignedHours[email] += assignDuration;
                                        console.log(`Fallback assignment: ${w.first_name} ${w.last_name} assigned ${assignDuration.toFixed(1)}h at ${slotStart}-${slotEnd}`);
                                        remaining -= assignDuration;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Log if we couldn't assign exactly 5 hours
                if (Math.abs(remaining) > 0.1) {
                    console.error(`üö® CRITICAL: Work study student ${w.first_name} ${w.last_name} assigned ${(5 - remaining).toFixed(1)} hours instead of 5 - INSUFFICIENT AVAILABILITY`);
                    
                    // LAST RESORT: Force assignment even if it means going over limits
                    console.warn(`üîÑ LAST RESORT: Attempting forced assignment for ${w.first_name} ${w.last_name}`);
                    
                    for (const [day, ops] of Object.entries(hoursOfOperation)) {
                        if (remaining <= 0.1) break;
                        
                        for (const op of ops) {
                            if (remaining <= 0.1) break;
                            
                            let opStart = timeToHour(op.start);
                            let opEnd = timeToHour(op.end);
                            if (opEnd <= opStart) opEnd += 24;

                            for (const a of w.availability[day] || []) {
                                if (remaining <= 0.1) break;
                                
                                const s = Math.max(opStart, a.start_hour);
                                const e = Math.min(opEnd, a.end_hour);
                                if (e > s) {
                                    const availableDuration = e - s;
                                    const assignDuration = Math.min(availableDuration, remaining);
                                    
                                    // CRITICAL FIX: Force assignment with duplicate checking
                                    const slotStart = hourToTime(s);
                                    const slotEnd = hourToTime(s + assignDuration);
                                    
                                    // CRITICAL FIX: Check for duplicate assignment using new tracking
                                    const shiftKey = `${day}_${slotStart}_${slotEnd}`;
                                    if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(email)) {
                                        console.warn(`‚ö†Ô∏è Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping last resort assignment`);
                                        continue;
                                    }
                                    
                                    // ENHANCED: Check if there's already a shift at this time
                                    const existingShift = schedule[day]?.find(s => s.start === slotStart && s.end === slotEnd);
                                    
                                    if (existingShift && existingShift.raw_assigned.length < maxWorkersPerShift) {
                                        // Add worker to existing shift
                                        existingShift.assigned.push(`${w.first_name} ${w.last_name}`);
                                        existingShift.raw_assigned.push(email);
                                        existingShift.all_available.push(w);
                                        existingShift.is_work_study = true;
                                        existingShift.last_resort_assignment = true;
                                        
                                        // Add worker to shift tracking
                                        if (!shiftAssignments.has(shiftKey)) {
                                            shiftAssignments.set(shiftKey, new Set());
                                        }
                                        shiftAssignments.get(shiftKey).add(email);
                                        
                                        console.log(`LAST RESORT assignment: ${w.first_name} ${w.last_name} added to existing shift ${slotStart}-${slotEnd}`);
                                    } else {
                                        // Create new shift
                                        if (!shiftAssignments.has(shiftKey)) {
                                            shiftAssignments.set(shiftKey, new Set());
                                        }
                                        shiftAssignments.get(shiftKey).add(email);
                                        
                                        if (!schedule[day]) schedule[day] = [];
                                        
                                        schedule[day].push({
                                            start: slotStart,
                                            end: slotEnd,
                                            assigned: [`${w.first_name} ${w.last_name}`],
                                            available: [`${w.first_name} ${w.last_name}`],
                                            raw_assigned: [email],
                                            all_available: [w],
                                            is_work_study: true,
                                            forced_shift: true,
                                            last_resort_assignment: true
                                        });
                                        
                                        console.log(`LAST RESORT assignment: ${w.first_name} ${w.last_name} created new shift ${slotStart}-${slotEnd}`);
                                    }
                                    
                                    // CRITICAL FIX: Add hours only once
                                    assignedHours[email] += assignDuration;
                                    console.log(`LAST RESORT assignment: ${w.first_name} ${w.last_name} forced assigned ${assignDuration.toFixed(1)}h at ${slotStart}-${slotEnd}`);
                                    remaining -= assignDuration;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (Math.abs(remaining) > 0.1) {
                        console.error(`üö® FAILED: Work study student ${w.first_name} ${w.last_name} still has ${remaining.toFixed(1)} unassigned hours after last resort attempt`);
                    } else {
                        console.log(`‚úÖ SUCCESS: Work study student ${w.first_name} ${w.last_name} got exactly 5 hours after last resort assignment`);
                    }
                } else {
                    console.log(`‚úÖ Work study student ${w.first_name} ${w.last_name} successfully assigned exactly 5 hours`);
                }
            }

            // Phase 2: Enhanced Coverage Algorithm - Fill ALL operating hours
            const orderedDays = [...DAYS].sort();
            
            for (const day of orderedDays) {
                const ops = hoursOfOperation[day] || [];
                if (ops.length === 0) continue;
                
                if (!schedule[day]) schedule[day] = [];

                for (const op of ops) {
                    let opStart = timeToHour(op.start);
                    let opEnd = timeToHour(op.end);
                    if (opEnd <= opStart) opEnd += 24;

                    console.log(`Processing ${day}: ${op.start}-${op.end} (${opStart}-${opEnd} hours)`);
                    
                    // CRITICAL: Validate operating hours
                    if (opStart < 0 || opStart > 24 || opEnd < 0 || opEnd > 48) {
                        console.error(`‚ùå Invalid operating hours for ${day}: ${opStart}-${opEnd}`);
                        continue;
                    }

                    // Create continuous coverage for entire operating period
                    if (ensureFullCoverage) {
                        // Calculate existing coverage
                        const existingShifts = schedule[day].map(s => ({
                            start: timeToHour(s.start),
                            end: timeToHour(s.end)
                        })).sort((a, b) => a.start - b.start);

                        // Merge overlapping shifts
                        const mergedShifts = [];
                        for (const shift of existingShifts) {
                            if (mergedShifts.length === 0 || mergedShifts[mergedShifts.length - 1].end < shift.start) {
                                mergedShifts.push(shift);
                            } else {
                                mergedShifts[mergedShifts.length - 1].end = Math.max(mergedShifts[mergedShifts.length - 1].end, shift.end);
                            }
                        }

                        // Find gaps that need to be filled
                        const gaps = [];
                        let currentTime = opStart;
                        
                        for (const shift of mergedShifts) {
                            if (shift.start > currentTime) {
                                gaps.push([currentTime, shift.start]);
                            }
                            currentTime = Math.max(currentTime, shift.end);
                        }
                        
                        if (currentTime < opEnd) {
                            gaps.push([currentTime, opEnd]);
                        }

                        // CRITICAL FIX: Filter out gaps where no workers are available at all
                        const validGaps = [];
                        for (const [gapStart, gapEnd] of gaps) {
                            // Check if any workers are available during this gap
                            let hasAvailableWorkers = false;
                            for (const worker of workersData) {
                                if (isWorkerAvailable(worker, day, gapStart, gapEnd)) {
                                    hasAvailableWorkers = true;
                                    break;
                                }
                            }
                            
                            if (hasAvailableWorkers) {
                                validGaps.push([gapStart, gapEnd]);
                                console.log(`‚úÖ Valid gap: ${hourToTime(gapStart)}-${hourToTime(gapEnd)} - workers available`);
                            } else {
                                console.log(`‚ùå Invalid gap: ${hourToTime(gapStart)}-${hourToTime(gapEnd)} - no workers available, skipping`);
                            }
                        }

                        // Fill each gap
                        for (const [gapStart, gapEnd] of validGaps) {
                            console.log(`Filling gap: ${hourToTime(gapStart)}-${hourToTime(gapEnd)} (${gapStart}-${gapEnd} hours)`);
                            let cur = gapStart;
                            while (cur < gapEnd) {
                                const remainingTime = gapEnd - cur;
                                if (remainingTime < 2) {
                                    // Leave as a coverage gap, do not create a shift
                                    break;
                                }
                                const shiftLength = Math.min(Math.max(2, remainingTime), 4); // 2-4 hour shifts
                                const endShift = Math.min(cur + shiftLength, gapEnd);
                                const shiftDuration = endShift - cur;

                                // CRITICAL: Ensure shift stays within operating hours
                                let finalEndShift = endShift;
                                let finalDuration = shiftDuration;
                                
                                if (endShift > opEnd) {
                                    console.log(`‚ö†Ô∏è Shift would exceed operating hours (${hourToTime(endShift)} > ${hourToTime(opEnd)}), adjusting...`);
                                    finalEndShift = opEnd;
                                    finalDuration = finalEndShift - cur;
                                    
                                    if (finalDuration < 2) {
                                        console.log(`‚ö†Ô∏è Adjusted shift too short (${finalDuration.toFixed(1)}h), skipping`);
                                        break;
                                    }
                                }

                                // Find available workers for this gap
                                const availableWorkers = [];
                                
                                for (const x of workersData) {
                                    const xEmail = x.email;
                                    
                                    // Skip work study students who already have 5 hours
                                    if (wsStatus[xEmail] && assignedHours[xEmail] >= 5) continue;
                                    
                                    // CRITICAL: Never skip work study students with 0 hours - they MUST be assigned first
                                    if (wsStatus[xEmail] && assignedHours[xEmail] === 0) {
                                        console.warn(`üö® CRITICAL: Work study student ${x.first_name} ${x.last_name} has 0 hours but is being considered for regular assignment - this should not happen!`);
                                        // Continue to include them in regular assignment as fallback
                                    }
                                    
                                    if (isWorkerAvailable(x, day, cur, finalEndShift) && 
                                        assignedHours[xEmail] + finalDuration <= maxHoursPerWorker) {
                                        availableWorkers.push(x);
                                    }
                                }

                                // CRITICAL FIX: Only create shifts if workers are actually available
                                if (availableWorkers.length === 0) {
                                    console.log(`‚ö†Ô∏è No workers available for ${hourToTime(cur)}-${hourToTime(endShift)}, skipping shift creation`);
                                    cur = endShift;
                                    continue;
                                }

                                // Sort by priority: work study students with 0 hours get absolute priority
                                availableWorkers.sort((a, b) => {
                                    const aIsWS = wsStatus[a.email];
                                    const bIsWS = wsStatus[b.email];
                                    const aHours = assignedHours[a.email] || 0;
                                    const bHours = assignedHours[b.email] || 0;
                                    
                                    // Work study students with 0 hours get absolute priority
                                    if (aIsWS && aHours === 0 && !bIsWS) return -1;
                                    if (bIsWS && bHours === 0 && !aIsWS) return 1;
                                    if (aIsWS && aHours === 0 && bIsWS && bHours === 0) {
                                        // Among work study students with 0 hours, sort by availability
                                        const ratioA = aHours / Math.max(availabilityHours[a.email], 1);
                                        const ratioB = bHours / Math.max(availabilityHours[b.email], 1);
                                        return ratioA - ratioB;
                                    }
                                    
                                    // Then work study students with less than 5 hours
                                    if (aIsWS && aHours < 5 && !bIsWS) return -1;
                                    if (bIsWS && bHours < 5 && !aIsWS) return 1;
                                    if (aIsWS && aHours < 5 && bIsWS && bHours < 5) {
                                        return aHours - bHours; // Fewer hours first
                                    }
                                    
                                    // Then regular workers with 0 hours
                                    if (!aIsWS && aHours === 0 && bIsWS) return -1;
                                    if (!bIsWS && bHours === 0 && aIsWS) return 1;
                                    if (!aIsWS && aHours === 0 && !bIsWS && bHours === 0) {
                                        const ratioA = aHours / Math.max(availabilityHours[a.email], 1);
                                        const ratioB = bHours / Math.max(availabilityHours[b.email], 1);
                                        return ratioA - ratioB;
                                    }
                                    
                                    // Finally, sort by fairness ratio
                                    const ratioA = assignedHours[a.email] / Math.max(availabilityHours[a.email], 1);
                                    const ratioB = assignedHours[b.email] / Math.max(availabilityHours[b.email], 1);
                                    return ratioA - ratioB;
                                });

                                const chosen = availableWorkers.slice(0, maxWorkersPerShift);

                                // ENHANCED: Create a single consolidated shift for multiple workers
                                if (chosen.length > 0) {
                                    const shiftStart = hourToTime(cur);
                                    const shiftEnd = hourToTime(finalEndShift);
                                    const shiftKey = `${day}_${shiftStart}_${shiftEnd}`;
                                    
                                    // Collect all workers for this shift
                                    const assignedWorkers = [];
                                    const rawAssigned = [];
                                    
                                    for (const x of chosen) {
                                        // CRITICAL FIX: Check for duplicate assignment
                                        if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(x.email)) {
                                            console.warn(`‚ö†Ô∏è Worker ${x.first_name} ${x.last_name} already assigned to ${shiftStart}-${shiftEnd}, skipping assignment`);
                                            continue;
                                        }
                                        
                                        // Add worker to shift tracking
                                        if (!shiftAssignments.has(shiftKey)) {
                                            shiftAssignments.set(shiftKey, new Set());
                                        }
                                        shiftAssignments.get(shiftKey).add(x.email);
                                        
                                        // CRITICAL FIX: Add hours only once
                                        assignedHours[x.email] += finalDuration;
                                        console.log(`Adding ${x.first_name} ${x.last_name} to shift: ${shiftStart}-${shiftEnd}`);
                                        
                                        assignedWorkers.push(`${x.first_name} ${x.last_name}`);
                                        rawAssigned.push(x.email);
                                    }
                                    
                                    // Create a single consolidated shift with all workers
                                    if (assignedWorkers.length > 0) {
                                        schedule[day].push({
                                            start: shiftStart,
                                            end: shiftEnd,
                                            assigned: assignedWorkers,
                                            available: availableWorkers.map(y => `${y.first_name} ${y.last_name}`),
                                            raw_assigned: rawAssigned,
                                            all_available: availableWorkers,
                                            workers_count: assignedWorkers.length
                                        });
                                    }
                                }

                                // Mark unfilled if we couldn't fill all positions
                                for (let i = 0; i < maxWorkersPerShift - chosen.length; i++) {
                                    unfilledShifts.push({
                                        day: day,
                                        start: hourToTime(cur),
                                        end: hourToTime(finalEndShift),
                                        start_hour: cur,
                                        end_hour: finalEndShift,
                                        isGap: true
                                    });
                                    
                                    schedule[day].push({
                                        start: hourToTime(cur),
                                        end: hourToTime(finalEndShift),
                                        assigned: ["‚ö†Ô∏è COVERAGE GAP"],
                                        available: availableWorkers.map(y => `${y.first_name} ${y.last_name}`),
                                        raw_assigned: [],
                                        all_available: availableWorkers,
                                        isGap: true
                                    });
                                }

                                cur = finalEndShift;
                            }
                        }
                    }
                }
            }

            // Validate coverage and generate reports
            const { coverageGaps } = validateScheduleCoverage(schedule, hoursOfOperation);

            // Build summaries
            const lowHours = workersData
                .filter(w => !wsStatus[w.email] && assignedHours[w.email] < 4)
                .map(w => `${w.first_name} ${w.last_name}`);
                
            const unassigned = workersData
                .filter(w => assignedHours[w.email] === 0)
                .map(w => `${w.first_name} ${w.last_name}`);

            // Enhanced work study validation and reporting
            const wsIssues = [
                ...initialWsIssues,
                ...workersData
                    .filter(w => wsStatus[w.email] && Math.abs(assignedHours[w.email] - 5) > 0.1)
                    .filter(w => !initialWsIssues.some(issue => 
                        issue.startsWith(`${w.first_name} ${w.last_name}:`)))
                    .map(w => {
                        const hours = assignedHours[w.email];
                        if (hours < 5) {
                            return `${w.first_name} ${w.last_name} (${hours.toFixed(1)}h) - INSUFFICIENT HOURS - Work study students MUST have exactly 5 hours`;
                        } else {
                            return `${w.first_name} ${w.last_name} (${hours.toFixed(1)}h) - OVER ASSIGNED - Work study students should have exactly 5 hours`;
                        }
                    })
            ];
            
            // Log work study assignment summary
            const wsSummary = workersData
                .filter(w => wsStatus[w.email])
                .map(w => `${w.first_name} ${w.last_name}: ${assignedHours[w.email].toFixed(1)}h`);
            
            console.log('Work Study Assignment Summary:', wsSummary);
            
            // Critical warning if any work study students don't have exactly 5 hours
            const wsWithIssues = workersData.filter(w => wsStatus[w.email] && Math.abs(assignedHours[w.email] - 5) > 0.1);
            if (wsWithIssues.length > 0) {
                console.error('üö® CRITICAL: Work study students without exactly 5 hours:', 
                    wsWithIssues.map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`));
            }

            const minHoursIssues = workersData
                .filter(w => !wsStatus[w.email] && assignedHours[w.email] < minHoursPerWorker && assignedHours[w.email] > 0)
                .map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`);

            // Alternative solutions
            const altSols = {};
            for (const us of unfilledShifts) {
                const key = `${us.day} ${us.start}-${us.end}`;
                const sols = workersData.filter(w => {
                    return isWorkerAvailable(w, us.day, us.start_hour, us.end_hour) &&
                           assignedHours[w.email] + (us.end_hour - us.start_hour) <= maxHoursPerWorker * 1.2;
                });
                
                if (sols.length > 0) {
                    altSols[key] = sols.map(w => `${w.first_name} ${w.last_name}`);
                }
            }

            // After normal assignment and before validation/reporting:
            // Attempt to fill every unfilled shift with the closest available worker (least hours, prioritize zero hours)
            for (const us of unfilledShifts) {
                // Find eligible workers: have availability for this shift, not double-booked, not over max hours
                const eligible = workersData.filter(w => {
                    // Must have availability for this shift
                    if (!isWorkerAvailable(w, us.day, us.start_hour, us.end_hour)) return false;
                    
                    // Skip work study students who already have 5 hours (they should not be forced into additional shifts)
                    if (wsStatus[w.email] && assignedHours[w.email] >= 5) return false;
                    
                    // Not already assigned to an overlapping or adjacent shift
                    const assignedShifts = Object.values(schedule).flat().filter(s => (s.raw_assigned||[]).includes(w.email));
                    for (const s of assignedShifts) {
                        const sDay = s.day || Object.keys(schedule).find(d => schedule[d].includes(s));
                        if (sDay !== us.day) continue;
                        const sStart = timeToHour(s.start);
                        const sEnd = timeToHour(s.end);
                        // Overlap or adjacent
                        if (!(us.end_hour <= sStart || us.start_hour >= sEnd)) return false;
                        if (Math.abs(us.start_hour - sEnd) < 0.01 || Math.abs(us.end_hour - sStart) < 0.01) return false;
                    }
                    // Not over max hours
                    if ((assignedHours[w.email] || 0) + (us.end_hour - us.start_hour) > maxHoursPerWorker) return false;
                    return true;
                });
                
                // Enhanced prioritization: work study students with less than 5 hours get highest priority
                eligible.sort((a, b) => {
                    const aHours = assignedHours[a.email] || 0;
                    const bHours = assignedHours[b.email] || 0;
                    const aIsWS = wsStatus[a.email];
                    const bIsWS = wsStatus[b.email];
                    
                    // Work study students with less than 5 hours get highest priority
                    if (aIsWS && aHours < 5 && !bIsWS) return -1;
                    if (bIsWS && bHours < 5 && !aIsWS) return 1;
                    if (aIsWS && aHours < 5 && bIsWS && bHours < 5) {
                        // Among work study students, prioritize those with fewer hours
                        return aHours - bHours;
                    }
                    
                    // Then prioritize workers with zero hours
                    if (aHours === 0 && bHours > 0) return -1;
                    if (bHours === 0 && aHours > 0) return 1;
                    
                    // Finally, prioritize by least hours
                    return aHours - bHours;
                });
                
                if (eligible.length > 0) {
                    const chosen = eligible[0];
                    const shiftStart = hourToTime(us.start_hour);
                    const shiftEnd = hourToTime(us.end_hour);
                    
                    // CRITICAL FIX: Check for duplicate assignment using new tracking
                    const shiftKey = `${us.day}_${shiftStart}_${shiftEnd}`;
                    if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(chosen.email)) {
                        console.warn(`‚ö†Ô∏è Worker ${chosen.first_name} ${chosen.last_name} already assigned to ${shiftStart}-${shiftEnd}, skipping unfilled shift assignment`);
                        continue;
                    }
                    
                    // ENHANCED: Check if there's already a shift at this time that can accommodate this worker
                    const existingShift = schedule[us.day]?.find(s => s.start === us.start && s.end === us.end);
                    
                    if (existingShift && existingShift.raw_assigned.length < maxWorkersPerShift) {
                        // Add worker to existing shift
                        existingShift.assigned.push(`${chosen.first_name} ${chosen.last_name}`);
                        existingShift.raw_assigned.push(chosen.email);
                        existingShift.all_available.push(chosen);
                        existingShift.forced = true;
                        
                        // Add worker to shift tracking
                        if (!shiftAssignments.has(shiftKey)) {
                            shiftAssignments.set(shiftKey, new Set());
                        }
                        shiftAssignments.get(shiftKey).add(chosen.email);
                        
                        console.log(`Forced assignment: ${chosen.first_name} ${chosen.last_name} added to existing shift ${us.start}-${us.end}`);
                    } else {
                        // Create new shift
                        if (!shiftAssignments.has(shiftKey)) {
                            shiftAssignments.set(shiftKey, new Set());
                        }
                        shiftAssignments.get(shiftKey).add(chosen.email);
                        
                        // CRITICAL FIX: Add hours only once
                        assignedHours[chosen.email] = (assignedHours[chosen.email] || 0) + (us.end_hour - us.start_hour);
                        
                        if (!schedule[us.day]) schedule[us.day] = [];
                        schedule[us.day].push({
                            start: us.start,
                            end: us.end,
                            assigned: [`${chosen.first_name} ${chosen.last_name}`],
                            available: eligible.map(w => `${w.first_name} ${w.last_name}`),
                            raw_assigned: [chosen.email],
                            all_available: eligible,
                            forced: true
                        });
                        
                        console.log(`Forced assignment: ${chosen.first_name} ${chosen.last_name} created new shift ${us.start}-${us.end}`);
                    }
                    forcedAssignments.push({
                        day: us.day,
                        start: us.start,
                        end: us.end,
                        worker: `${chosen.first_name} ${chosen.last_name}`,
                        email: chosen.email
                    });
                }
            }

            // Final validation: Ensure work study students have exactly 5 hours
            const finalWsValidation = workersData
                .filter(w => wsStatus[w.email])
                .map(w => {
                    const hours = assignedHours[w.email];
                    if (Math.abs(hours - 5) > 0.1) {
                        console.error(`üö® FINAL VALIDATION FAILED: ${w.first_name} ${w.last_name} has ${hours.toFixed(1)} hours instead of 5`);
                        return w;
                    }
                    return null;
                })
                .filter(Boolean);
            
            // EMERGENCY FIX: Force assign any work study students who still have 0 hours
            const unassignedWorkStudy = workersData.filter(w => wsStatus[w.email] && assignedHours[w.email] === 0);
            if (unassignedWorkStudy.length > 0) {
                console.error(`üö® EMERGENCY: ${unassignedWorkStudy.length} work study students still have 0 hours! Force assigning...`);
                
                for (const w of unassignedWorkStudy) {
                    console.warn(`üîÑ EMERGENCY: Force assigning ${w.first_name} ${w.last_name} to any available slot`);
                    
                    // Find ANY available slot and force assign
                    for (const [day, ops] of Object.entries(hoursOfOperation)) {
                        if (assignedHours[w.email] >= 5) break;
                        
                        for (const op of ops) {
                            if (assignedHours[w.email] >= 5) break;
                            
                            let opStart = timeToHour(op.start);
                            let opEnd = timeToHour(op.end);
                            if (opEnd <= opStart) opEnd += 24;

                            for (const a of w.availability[day] || []) {
                                if (assignedHours[w.email] >= 5) break;
                                
                                const s = Math.max(opStart, a.start_hour);
                                const e = Math.min(opEnd, a.end_hour);
                                if (e > s) {
                                    const availableDuration = e - s;
                                    const remainingNeeded = 5 - assignedHours[w.email];
                                    const assignDuration = Math.min(availableDuration, remainingNeeded);
                                    
                                    // Force create a shift regardless of existing coverage
                                    const slotStart = hourToTime(s);
                                    const slotEnd = hourToTime(s + assignDuration);
                                    const shiftKey = `${day}_${slotStart}_${slotEnd}`;
                                    
                                    // Check for duplicate assignment
                                    if (shiftAssignments.has(shiftKey) && shiftAssignments.get(shiftKey).has(w.email)) {
                                        console.warn(`‚ö†Ô∏è Worker ${w.first_name} ${w.last_name} already assigned to ${slotStart}-${slotEnd}, skipping emergency assignment`);
                                        continue;
                                    }
                                    
                                    // ENHANCED: Check if there's already a shift at this time
                                    const existingShift = schedule[day]?.find(s => s.start === slotStart && s.end === slotEnd);
                                    
                                    if (existingShift && existingShift.raw_assigned.length < maxWorkersPerShift) {
                                        // Add worker to existing shift
                                        existingShift.assigned.push(`${w.first_name} ${w.last_name}`);
                                        existingShift.raw_assigned.push(w.email);
                                        existingShift.all_available.push(w);
                                        existingShift.is_work_study = true;
                                        existingShift.emergency_assignment = true;
                                        
                                        // Add worker to shift tracking
                                        if (!shiftAssignments.has(shiftKey)) {
                                            shiftAssignments.set(shiftKey, new Set());
                                        }
                                        shiftAssignments.get(shiftKey).add(w.email);
                                        
                                        console.log(`EMERGENCY assignment: ${w.first_name} ${w.last_name} added to existing shift ${slotStart}-${slotEnd}`);
                                    } else {
                                        // Create new shift
                                        if (!shiftAssignments.has(shiftKey)) {
                                            shiftAssignments.set(shiftKey, new Set());
                                        }
                                        shiftAssignments.get(shiftKey).add(w.email);
                                        
                                        if (!schedule[day]) schedule[day] = [];
                                        
                                        schedule[day].push({
                                            start: slotStart,
                                            end: slotEnd,
                                            assigned: [`${w.first_name} ${w.last_name}`],
                                            available: [`${w.first_name} ${w.last_name}`],
                                            raw_assigned: [w.email],
                                            all_available: [w],
                                            is_work_study: true,
                                            forced_shift: true,
                                            emergency_assignment: true
                                        });
                                        
                                        console.log(`EMERGENCY assignment: ${w.first_name} ${w.last_name} created new shift ${slotStart}-${slotEnd}`);
                                    }
                                    
                                    assignedHours[w.email] += assignDuration;
                                    console.log(`EMERGENCY assignment: ${w.first_name} ${w.last_name} force assigned ${assignDuration.toFixed(1)}h at ${slotStart}-${slotEnd}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (assignedHours[w.email] === 0) {
                        console.error(`üö® FAILED: Could not assign ANY hours to work study student ${w.first_name} ${w.last_name} - NO AVAILABILITY MATCHES OPERATING HOURS`);
                    } else {
                        console.log(`‚úÖ SUCCESS: Emergency assignment gave ${w.first_name} ${w.last_name} ${assignedHours[w.email].toFixed(1)} hours`);
                    }
                }
            }
            
            if (finalWsValidation.length > 0) {
                console.error('üö® CRITICAL: Work study validation failed. The following students do not have exactly 5 hours:', 
                    finalWsValidation.map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`));
            } else {
                console.log('‚úÖ Work study validation passed: All work study students have exactly 5 hours');
            }
            
            // CRITICAL FIX: Final validation to ensure no negative or excessive hours
            console.log('üîç Performing final schedule validation...');
            const finalValidation = calculateAssignedHours(schedule);
            
            // Check for any critical issues
            const criticalIssues = [];
            Object.entries(finalValidation).forEach(([email, hours]) => {
                if (hours < 0) {
                    criticalIssues.push(`${email}: ${hours} hours (NEGATIVE!)`);
                } else if (hours > 25) {
                    criticalIssues.push(`${email}: ${hours} hours (EXCESSIVE!)`);
                }
            });
            
            if (criticalIssues.length > 0) {
                console.error('üö® CRITICAL VALIDATION FAILED:', criticalIssues);
                console.error('üö® SCHEDULE GENERATION FAILED - CRITICAL ISSUES DETECTED');
                
                // Return empty schedule to prevent saving corrupted data
                return {
                    schedule: {},
                    assignedHours: {},
                    lowHours: [],
                    unassigned: workersData.map(w => `${w.first_name} ${w.last_name}`),
                    altSols: {},
                    unfilledShifts: [],
                    wsIssues: ['CRITICAL: Schedule generation failed due to validation errors'],
                    minHoursIssues: [],
                    coverageGaps: [],
                    forcedAssignments: []
                };
            }
            
            // Additional validation: Check if schedule is actually empty
            const totalShifts = Object.values(schedule).flat().length;
            if (totalShifts === 0) {
                console.error('üö® CRITICAL: Generated schedule is empty - no shifts were created');
                return {
                    schedule: {},
                    assignedHours: {},
                    lowHours: [],
                    unassigned: workersData.map(w => `${w.first_name} ${w.last_name}`),
                    altSols: {},
                    unfilledShifts: [],
                    wsIssues: ['CRITICAL: No shifts were generated - check worker availability and operating hours'],
                    minHoursIssues: [],
                    coverageGaps: [],
                    forcedAssignments: []
                };
            }
            
            console.log('‚úÖ Final validation passed - no critical issues detected');
            
            // PRODUCTION-READY: Comprehensive final validation
            console.log('üîç PRODUCTION: Performing comprehensive final validation...');
            
            // 1. Validate Work Study Requirements
            const wsValidation = validateWorkStudyRequirements(wsWorkers, assignedHours);
            if (wsValidation.violations.length > 0) {
                console.error('üö® PRODUCTION: Work study validation failed:', wsValidation.issues);
            }
            
            // 2. Validate Schedule Coverage
            const coverageValidation = validateScheduleCoverageComprehensive(schedule, hoursOfOperation);
            if (coverageValidation.gaps.length > 0) {
                console.warn('‚ö†Ô∏è PRODUCTION: Coverage gaps detected:', coverageValidation.gaps.length);
            }
            
            // 3. Validate Assignment Tracking
            const assignmentErrors = [];
            for (const [shiftKey, workers] of shiftAssignments.entries()) {
                const [day, start, end] = shiftKey.split('_');
                const shift = schedule[day]?.find(s => s.start === start && s.end === end);
                if (!shift) {
                    assignmentErrors.push(`Shift tracking mismatch: ${shiftKey}`);
                    continue;
                }
                
                const trackedWorkers = Array.from(workers);
                const shiftWorkers = shift.raw_assigned || [];
                
                if (trackedWorkers.length !== shiftWorkers.length) {
                    assignmentErrors.push(`Worker count mismatch for ${shiftKey}: tracked=${trackedWorkers.length}, shift=${shiftWorkers.length}`);
                }
                
                for (const worker of trackedWorkers) {
                    if (!shiftWorkers.includes(worker)) {
                        assignmentErrors.push(`Worker ${worker} tracked but not in shift ${shiftKey}`);
                    }
                }
            }
            
            if (assignmentErrors.length > 0) {
                console.error('üö® PRODUCTION: Assignment tracking errors:', assignmentErrors);
            }
            
            // 4. Validate Hour Calculations
            const hourErrors = [];
            for (const [email, hours] of Object.entries(assignedHours)) {
                if (hours < 0) {
                    hourErrors.push(`${email}: Negative hours (${hours})`);
                } else if (hours > maxHoursPerWorker * 1.2) {
                    hourErrors.push(`${email}: Excessive hours (${hours} > ${maxHoursPerWorker * 1.2})`);
                }
                
                // Validate overnight shift handling
                const workerShifts = Object.values(schedule).flat().filter(s => 
                    (s.raw_assigned || []).includes(email)
                );
                
                for (const shift of workerShifts) {
                    const startHour = timeToHour(shift.start);
                    const endHour = timeToHour(shift.end);
                    let duration = endHour - startHour;
                    if (duration <= 0) duration += 24;
                    
                    if (duration < 0.5 || duration > 12) {
                        hourErrors.push(`${email}: Invalid shift duration ${duration.toFixed(1)}h (${shift.start}-${shift.end})`);
                    }
                }
            }
            
            if (hourErrors.length > 0) {
                console.error('üö® PRODUCTION: Hour calculation errors:', hourErrors);
            }
            
            // 5. Production Success Summary
            const totalShiftsCount = Object.values(schedule).flat().length;
            const totalWorkersCount = workersData.length;
            const assignedWorkersCount = Object.values(assignedHours).filter(h => h > 0).length;
            const wsAssigned = wsWorkers.filter(w => (assignedHours[w.email] || 0) > 0).length;
            
            console.log('üìä PRODUCTION: Schedule Generation Summary:');
            console.log(`   ‚Ä¢ Total Shifts: ${totalShiftsCount}`);
            console.log(`   ‚Ä¢ Total Workers: ${totalWorkersCount}`);
            console.log(`   ‚Ä¢ Assigned Workers: ${assignedWorkersCount}/${totalWorkersCount}`);
            console.log(`   ‚Ä¢ Work Study Assigned: ${wsAssigned}/${wsWorkers.length}`);
            console.log(`   ‚Ä¢ Coverage Gaps: ${coverageValidation.gaps.length}`);
            console.log(`   ‚Ä¢ Work Study Issues: ${wsValidation.issues.length}`);
            console.log(`   ‚Ä¢ Assignment Errors: ${assignmentErrors.length}`);
            console.log(`   ‚Ä¢ Hour Errors: ${hourErrors.length}`);
            
            // 6. Final Production Check
            const productionIssues = [
                ...wsValidation.issues,
                ...assignmentErrors,
                ...hourErrors
            ];
            
            if (productionIssues.length > 0) {
                console.error('üö® PRODUCTION: Critical issues detected - schedule may be unreliable');
                console.error('Issues:', productionIssues);
            } else {
                console.log('‚úÖ PRODUCTION: All validation checks passed - schedule is production-ready');
            }
            
            console.log('Enhanced schedule generation complete with comprehensive validation');
            
            return {
                schedule,
                assignedHours: finalValidation, // Use the validated hours
                lowHours,
                unassigned,
                altSols,
                unfilledShifts,
                wsIssues: [...wsIssues, ...wsValidation.issues],
                minHoursIssues,
                coverageGaps: [...coverageGaps, ...coverageValidation.gaps],
                forcedAssignments,
                productionIssues,
                validationSummary: {
                    totalShifts: totalShiftsCount,
                    totalWorkers: totalWorkersCount,
                    assignedWorkers: assignedWorkersCount,
                    wsAssigned,
                    coverageGaps: coverageValidation.gaps.length,
                    wsIssues: wsValidation.issues.length,
                    assignmentErrors: assignmentErrors.length,
                    hourErrors: hourErrors.length
                }
            };
        };

        // Initialize workplaces with enhanced error handling
        async function initializeDefaultWorkplaces() {
            const workplaces = [
                { 
                    id: 'esports_lounge', 
                    name: 'üéÆ eSports Lounge',
                    hours: {
                        Monday: [{ start: "09:00", end: "17:00" }],
                        Tuesday: [{ start: "09:00", end: "17:00" }],
                        Wednesday: [{ start: "09:00", end: "17:00" }],
                        Thursday: [{ start: "09:00", end: "17:00" }],
                        Friday: [{ start: "09:00", end: "17:00" }],
                        Saturday: [{ start: "10:00", end: "16:00" }],
                        Sunday: [{ start: "12:00", end: "18:00" }]
                    }
                },
                { 
                    id: 'esports_arena', 
                    name: 'üèüÔ∏è eSports Arena',
                    hours: {
                        Monday: [{ start: "10:00", end: "20:00" }],
                        Tuesday: [{ start: "10:00", end: "20:00" }],
                        Wednesday: [{ start: "10:00", end: "20:00" }],
                        Thursday: [{ start: "10:00", end: "20:00" }],
                        Friday: [{ start: "10:00", end: "22:00" }],
                        Saturday: [{ start: "09:00", end: "22:00" }],
                        Sunday: [{ start: "11:00", end: "19:00" }]
                    }
                },
                { 
                    id: 'it_service_center', 
                    name: 'üíª IT Service Center',
                    hours: {
                        Monday: [{ start: "08:00", end: "16:00" }],
                        Tuesday: [{ start: "08:00", end: "16:00" }],
                        Wednesday: [{ start: "08:00", end: "16:00" }],
                        Thursday: [{ start: "08:00", end: "16:00" }],
                        Friday: [{ start: "08:00", end: "16:00" }],
                        Saturday: [{ start: "09:00", end: "15:00" }],
                        Sunday: [{ start: "10:00", end: "14:00" }]
                    }
                }
            ];

            for (const workplace of workplaces) {
                try {
                    const docRef = doc(db, 'workplaces', workplace.id);
                    const docSnap = await getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        // Only create with default hours if workplace doesn't exist
                        await setDoc(docRef, {
                            name: workplace.name,
                            hours_of_operation: workplace.hours,
                            created_at: new Date().toISOString()
                        });
                        console.log(`Created workplace: ${workplace.id} with default hours`);
                    } else {
                        // Workplace exists - log the current hours for debugging
                        const currentData = docSnap.data();
                        console.log(`Workplace ${workplace.id} exists with hours:`, currentData.hours_of_operation);
                    }
                } catch (error) {
                    console.error(`Error checking ${workplace.id}:`, error);
                }
            }
        }

        initializeDefaultWorkplaces();

        // Enhanced workplace selection
        window.selectWorkplace = async function(id) {
            selectedWorkplace = id;
            
            document.querySelectorAll('.workplace-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.workplace-card').classList.add('selected');
            
            document.getElementById('scheduleContent').style.display = 'block';
            
            // Show loading state
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">üîÑ Loading workplace data...</div>';
            
            try {
                await loadWorkplaceData();
                // await loadWorkplaceNotes(); // OLD NOTES FUNCTION REMOVED
                await loadAnnouncements(); // Load announcements
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">‚úÖ Ready! Select an option above to get started.</div>';
                hideAllForms();
                // document.getElementById('workplaceNotesSection').style.display = 'block'; // OLD NOTES SECTION REMOVED
                document.getElementById('announcementsSection').style.display = 'block'; // Show announcements section
            } catch (error) {
                console.error('Error loading workplace:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">‚ùå Error loading workplace data. Please try again.</div>';
            }

            // At the end of selectWorkplace, after loading data and notes:
            if (!user.isAdmin) {
                await loadUserDashboard();
            }
        };

        // Enhanced data loading with better error handling
        async function loadWorkplaceData() {
            try {
                console.log(`Loading data for ${selectedWorkplace}`);
                
                setLoading('scheduleDisplay', true);
                
                // Load workers with timeout
                const workersPromise = getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                const workersSnapshot = await Promise.race([
                    workersPromise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                ]);
                
                workers = [];
                workersSnapshot.forEach(doc => {
                    try {
                        // Skip the _metadata document - it's not a real worker
                        if (doc.id === '_metadata') {
                            return;
                        }
                        
                        const data = doc.data();
                        const availability = parseAvailability(data['Days & Times Available'] || '');
                        
                        workers.push({
                            id: doc.id,
                            first_name: data['First Name'] || 'Unknown',
                            last_name: data['Last Name'] || 'Worker',
                            email: data['Email'] || 'no-email',
                            work_study: data['Work Study'] === 'Yes',
                            availability,
                            availability_text: data['Days & Times Available'] || ''
                        });
                    } catch (error) {
                        console.error('Error parsing worker data:', error);
                    }
                });

                // Load operating hours
                const workplaceDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace));
                if (workplaceDoc.exists()) {
                    hours = workplaceDoc.data().hours_of_operation || {};
                    console.log(`Loaded hours from database for ${selectedWorkplace}:`, hours);
                } else {
                    hours = {};
                    console.warn(`No workplace document found for ${selectedWorkplace}, using empty hours`);
                }

                console.log(`Loaded ${workers.length} workers and operating hours for ${selectedWorkplace}`);
                showNotification(`‚úÖ Loaded ${workers.length} workers for ${selectedWorkplace}`, 'success');
                
            } catch (error) {
                console.error('Error loading workplace data:', error);
                workers = [];
                hours = {};
                showNotification('‚ùå Error loading workplace data', 'error');
                throw error;
            }
        }

        // OLD NOTES FUNCTION - REMOVED IN FAVOR OF ANNOUNCEMENTS
        // async function loadWorkplaceNotes() {
        //     const notesDiv = document.getElementById('workplaceNotesContent');
        //     if (!selectedWorkplace) {
        //         notesDiv.innerHTML = '<div class="info">No workplace selected.</div>';
        //         return;
        //     }
        //     const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace));
        //     const notes = docSnap.exists() && docSnap.data().notes ? docSnap.data().notes : '';
        //     if (user.isAdmin) {
        //         notesDiv.innerHTML = `<textarea id='workplaceNotesTextarea' rows='4' style='width:100%;border-radius:8px;padding:1rem;'>${notes}</textarea><button class='btn btn-success' id='saveNotesBtn' style='margin-top:0.5rem;'>üíæ Save Notes</button>`;
        //         document.getElementById('saveNotesBtn').onclick = async function() {
        //             const newNotes = document.getElementById('workplaceNotesTextarea').value;
        //             await updateDoc(doc(db, 'workplaces', selectedWorkplace), 'notes', newNotes);
        //             showNotification('‚úÖ Notes updated!', 'success');
        //         };
        //     } else {
        //         notesDiv.innerHTML = `<div style='background:#f8f9fa;padding:1rem;border-radius:8px;'>${notes ? notes.replace(/\n/g, '<br>') : '<span style="color:#888;">No notes for this workplace.</span>'}</div>`;
        //     }
        // }

        // --- ENHANCED ANNOUNCEMENTS SYSTEM ---
        // Load and display announcements
        async function loadAnnouncements() {
            const announcementsDiv = document.getElementById('announcementsContent');
            const addBtn = document.getElementById('addAnnouncementBtn');
            
            if (!selectedWorkplace) {
                announcementsDiv.innerHTML = '<div class="info">No workplace selected.</div>';
                return;
            }

            try {
                // Show/hide add button for admins
                if (user.isAdmin) {
                    addBtn.style.display = 'inline-block';
                } else {
                    addBtn.style.display = 'none';
                }

                // Load announcements from Firestore
                const announcementsSnapshot = await getDocs(
                    collection(db, 'workplaces', selectedWorkplace, 'announcements')
                );

                if (announcementsSnapshot.empty) {
                    announcementsDiv.innerHTML = '<div class="info">No announcements yet.</div>';
                    return;
                }

                // Convert to array and sort by creation date (newest first)
                const announcements = [];
                announcementsSnapshot.forEach(doc => {
                    announcements.push({ id: doc.id, ...doc.data() });
                });
                announcements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Build announcements display
                let html = '<div class="announcements-grid">';
                
                announcements.forEach(announcement => {
                    const createdDate = new Date(announcement.createdAt).toLocaleDateString();
                    const priorityClass = announcement.priority || 'medium';
                    const priorityBadge = announcement.priority || 'medium';
                    
                    html += `
                        <div class="announcement-card ${priorityClass}-priority">
                            <div class="announcement-header">
                                <h4 class="announcement-subject">${announcement.subject}</h4>
                                <div class="announcement-meta">
                                    <span class="priority-badge ${priorityBadge}">${priorityBadge}</span>
                                    <span>${createdDate}</span>
                                    ${user.isAdmin ? `<span>by ${announcement.createdBy}</span>` : ''}
                                </div>
                            </div>
                            <div class="announcement-message">${announcement.message.replace(/\n/g, '<br>')}</div>
                            ${user.isAdmin ? `
                                <div class="announcement-actions">
                                    <button class="btn btn-info" onclick="editAnnouncement('${announcement.id}')">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-danger" onclick="deleteAnnouncement('${announcement.id}')">üóëÔ∏è Delete</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                announcementsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcementsDiv.innerHTML = '<div class="error">Failed to load announcements.</div>';
            }
        }

        // Add announcement button handler
        if (user.isAdmin) {
            document.getElementById('addAnnouncementBtn').onclick = function() {
                document.getElementById('announcementModalTitle').textContent = 'üì¢ Add Announcement';
                document.getElementById('announcementSubject').value = '';
                document.getElementById('announcementMessage').value = '';
                document.getElementById('announcementPriority').value = 'medium';
                document.getElementById('announcementModal').style.display = 'block';
            };
        }

        // Announcement form submission
        const announcementForm = document.getElementById('announcementForm');
        announcementForm.onsubmit = async function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('announcementSubject').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const priority = document.getElementById('announcementPriority').value;
            
            if (!selectedWorkplace) {
                showNotification('‚ùå Please select a workplace first', 'error');
                return;
            }
            
            if (!subject || !message) {
                showNotification('‚ùå Subject and message are required', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'announcements'), {
                    subject,
                    message,
                    priority,
                    createdBy: user.email,
                    createdAt: new Date().toISOString(),
                    isActive: true
                });
                
                showNotification('‚úÖ Announcement created successfully!', 'success');
                closeModal('announcementModal');
                loadAnnouncements(); // Reload the announcements
                
            } catch (error) {
                console.error('Error creating announcement:', error);
                showNotification('‚ùå Failed to create announcement', 'error');
            }
        };

        // Edit announcement
        window.editAnnouncement = async function(announcementId) {
            try {
                const announcementDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'announcements', announcementId));
                if (!announcementDoc.exists()) {
                    showNotification('‚ùå Announcement not found', 'error');
                    return;
                }
                
                const announcement = announcementDoc.data();
                
                document.getElementById('announcementModalTitle').textContent = 'üì¢ Edit Announcement';
                document.getElementById('announcementSubject').value = announcement.subject;
                document.getElementById('announcementMessage').value = announcement.message;
                document.getElementById('announcementPriority').value = announcement.priority || 'medium';
                
                // Store the announcement ID for updating
                document.getElementById('announcementModal').setAttribute('data-edit-id', announcementId);
                document.getElementById('announcementModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading announcement for edit:', error);
                showNotification('‚ùå Failed to load announcement', 'error');
            }
        };

        // Delete announcement
        window.deleteAnnouncement = async function(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement? This cannot be undone.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'announcements', announcementId));
                showNotification('‚úÖ Announcement deleted successfully!', 'success');
                loadAnnouncements(); // Reload the announcements
                
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showNotification('‚ùå Failed to delete announcement', 'error');
            }
        };

        // Enhanced admin functions with permission checks
        window.showManageHours = async function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }

            if (!selectedWorkplace) {
                showNotification('‚ö†Ô∏è Please select a workplace first', 'warning');
                return;
            }

            await loadWorkplaceData();
            
            let html = `
                <div class="simplified-hours-container">
                    <div class="hours-instructions">
                        <p><strong>üìã Instructions:</strong></p>
                        <ul>
                            <li>‚úÖ Check the days you want to set hours for</li>
                            <li>‚è∞ Use the time inputs to set start and end times</li>
                            <li>‚ûï Click "Add Time Block" to add multiple time periods per day</li>
                            <li>üóëÔ∏è Use the trash icon to remove time blocks</li>
                        </ul>
                    </div>
                    
                    <div class="days-checkboxes">
                        <h4>üìÖ Select Days</h4>
                        <div class="checkbox-grid">
            `;
            
            DAYS.forEach(day => {
                const dayHours = hours[day] || [];
                const isChecked = dayHours.length > 0 ? 'checked' : '';
                html += `
                    <div class="day-checkbox">
                        <input type="checkbox" id="day_${day}" ${isChecked} onchange="toggleDayHours('${day}')">
                        <label for="day_${day}">${day}</label>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="time-blocks-container">
                        <h4>‚è∞ Time Blocks</h4>
                        <div id="timeBlocksContainer">
            `;
            
            DAYS.forEach(day => {
                const dayHours = hours[day] || [];
                html += `<div id="timeBlocks_${day}" class="day-time-blocks" style="display: ${dayHours.length > 0 ? 'block' : 'none'};">`;
                html += `<h5>${day}</h5>`;
                
                if (dayHours.length === 0) {
                    html += `
                        <div class="time-block" data-day="${day}" data-index="0">
                            <div class="time-inputs">
                                <div class="time-input">
                                    <label>Start:</label>
                                    <input type="time" class="start-time" value="09:00">
                                    <small style="color: #666; font-size: 0.8rem;">9:00 AM</small>
                                </div>
                                <div class="time-input">
                                    <label>End:</label>
                                    <input type="time" class="end-time" value="17:00">
                                    <small style="color: #666; font-size: 0.8rem;">5:00 PM</small>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="removeTimeBlock('${day}', 0)" style="display: none;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                } else {
                    dayHours.forEach((hourBlock, index) => {
                        html += `
                            <div class="time-block" data-day="${day}" data-index="${index}">
                                <div class="time-inputs">
                                    <div class="time-input">
                                        <label>Start:</label>
                                        <input type="time" class="start-time" value="${hourBlock.start}">
                                        <small style="color: #666; font-size: 0.8rem;">${formatTime(hourBlock.start)}</small>
                                    </div>
                                    <div class="time-input">
                                        <label>End:</label>
                                        <input type="time" class="end-time" value="${hourBlock.end}">
                                        <small style="color: #666; font-size: 0.8rem;">${formatTime(hourBlock.end)}</small>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="removeTimeBlock('${day}', ${index})">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                    <button class="btn btn-info btn-sm" onclick="addTimeBlock('${day}')">‚ûï Add Time Block</button>
                </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="hours-actions">
                        <button class="btn btn-success" onclick="saveHours()" id="saveHoursBtn">üíæ Save Hours</button>
                        <button class="btn btn-secondary" onclick="closeModal('hoursModal')">Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('hoursModalContent').innerHTML = html;
            document.getElementById('hoursModal').style.display = 'block';
            
            // Add real-time AM/PM display updates
            addTimeDisplayListeners();
        };

        // Add real-time AM/PM display updates
        function addTimeDisplayListeners() {
            const timeInputs = document.querySelectorAll('.time-input input[type="time"]');
            timeInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const timeBlock = this.closest('.time-block');
                    const timeInput = this.closest('.time-input');
                    const smallElement = timeInput.querySelector('small');
                    if (smallElement) {
                        smallElement.textContent = formatTime(this.value);
                    }
                });
            });
        }

        // New simplified hours management functions
        window.toggleDayHours = function(day) {
            const checkbox = document.getElementById(`day_${day}`);
            const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
            
            if (checkbox.checked) {
                timeBlocksDiv.style.display = 'block';
            } else {
                timeBlocksDiv.style.display = 'none';
            }
        };

        window.addTimeBlock = function(day) {
            const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
            const existingBlocks = timeBlocksDiv.querySelectorAll('.time-block');
            const newIndex = existingBlocks.length;
            
            const newBlock = document.createElement('div');
            newBlock.className = 'time-block';
            newBlock.setAttribute('data-day', day);
            newBlock.setAttribute('data-index', newIndex);
            
            newBlock.innerHTML = `
                <div class="time-inputs">
                    <div class="time-input">
                        <label>Start:</label>
                        <input type="time" class="start-time" value="09:00">
                        <small style="color: #666; font-size: 0.8rem;">9:00 AM</small>
                    </div>
                    <div class="time-input">
                        <label>End:</label>
                        <input type="time" class="end-time" value="17:00">
                        <small style="color: #666; font-size: 0.8rem;">5:00 PM</small>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeTimeBlock('${day}', ${newIndex})">üóëÔ∏è</button>
                </div>
            `;
            
            // Insert before the "Add Time Block" button
            const addButton = timeBlocksDiv.querySelector('button[onclick*="addTimeBlock"]');
            timeBlocksDiv.insertBefore(newBlock, addButton);
            
            // Add listeners to the new block
            const newInputs = newBlock.querySelectorAll('input[type="time"]');
            newInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const timeInput = this.closest('.time-input');
                    const smallElement = timeInput.querySelector('small');
                    if (smallElement) {
                        smallElement.textContent = formatTime(this.value);
                    }
                });
            });
        };

        window.removeTimeBlock = function(day, index) {
            const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
            const blocks = timeBlocksDiv.querySelectorAll('.time-block');
            
            if (blocks.length <= 1) {
                // Don't remove the last block, just hide the delete button
                const deleteBtn = timeBlocksDiv.querySelector(`[data-index="${index}"] .btn-danger`);
                if (deleteBtn) deleteBtn.style.display = 'none';
                return;
            }
            
            const blockToRemove = timeBlocksDiv.querySelector(`[data-index="${index}"]`);
            if (blockToRemove) {
                blockToRemove.remove();
            }
            
            // Reindex remaining blocks
            const remainingBlocks = timeBlocksDiv.querySelectorAll('.time-block');
            remainingBlocks.forEach((block, newIndex) => {
                block.setAttribute('data-index', newIndex);
                const deleteBtn = block.querySelector('.btn-danger');
                if (deleteBtn) {
                    deleteBtn.onclick = () => removeTimeBlock(day, newIndex);
                }
            });
        };

        window.saveHours = async function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }

            setLoading('saveHoursBtn', true);
            
            try {
                const newHours = {};
                let hasErrors = false;
                
                DAYS.forEach(day => {
                    const checkbox = document.getElementById(`day_${day}`);
                    if (!checkbox.checked) {
                        // Day not selected, skip
                        return;
                    }
                    
                    const timeBlocksDiv = document.getElementById(`timeBlocks_${day}`);
                    const timeBlocks = timeBlocksDiv.querySelectorAll('.time-block');
                    const dayHours = [];
                    
                    timeBlocks.forEach(block => {
                        const startInput = block.querySelector('.start-time');
                        const endInput = block.querySelector('.end-time');
                        
                        if (startInput && endInput && startInput.value && endInput.value) {
                            const start = startInput.value;
                            const end = endInput.value;
                            
                            // Handle overnight shifts properly
                            let startHour = timeToHour(start);
                            let endHour = timeToHour(end);
                            
                            // If end time is earlier than start time, it's an overnight shift
                            if (endHour <= startHour) {
                                // This is valid for overnight shifts (e.g., 2 PM to 12 AM)
                                // The system will handle this correctly in scheduling
                                console.log(`‚úÖ Valid overnight shift for ${day}: ${start} to ${end}`);
                            }
                            
                            dayHours.push({ start, end });
                        }
                    });
                    
                    if (dayHours.length > 0) {
                        newHours[day] = dayHours;
                    }
                });
                
                if (hasErrors) {
                    setLoading('saveHoursBtn', false);
                    return;
                }
                
                await updateDoc(doc(db, 'workplaces', selectedWorkplace), {
                    hours_of_operation: newHours,
                    updated_at: new Date().toISOString(),
                    updated_by: user.email
                });
                
                hours = newHours;
                console.log(`Updated hours for ${selectedWorkplace}:`, newHours);
                showNotification('‚úÖ Hours updated successfully!', 'success');
                closeModal('hoursModal');
                
            } catch (error) {
                console.error('Error saving hours:', error);
                showNotification('‚ùå Error saving hours', 'error');
            } finally {
                setLoading('saveHoursBtn', false);
            }
        };

        window.showManageWorkers = async function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }

            if (!selectedWorkplace) {
                showNotification('‚ö†Ô∏è Please select a workplace first', 'warning');
                return;
            }

            document.getElementById('workersModalContent').innerHTML = '<div class="loading">Loading enhanced worker management...</div>';
            document.getElementById('workersModal').style.display = 'block';
            
            await loadWorkplaceData();
            await displayEnhancedWorkersInModal();
        };

        async function displayEnhancedWorkersInModal() {
            try {
                // Load users from authentication database
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };

                // Check if auth app already exists
                let authApp;
                try {
                    authApp = getApp('authApp');
                } catch (error) {
                    authApp = initializeApp(authConfig, 'authApp');
                }
                const authDb = getFirestore(authApp);
                
                const usersRef = collection(authDb, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const authUsers = [];
                usersSnapshot.forEach((doc) => {
                    authUsers.push({ id: doc.id, ...doc.data() });
                });

                // Create a map of workplace workers by email for quick lookup
                const workplaceWorkersMap = new Map();
                workers.forEach(worker => {
                    workplaceWorkersMap.set(worker.email.toLowerCase(), worker);
                });

                // Create a map of auth users by email for quick lookup
                const authUsersMap = new Map();
                authUsers.forEach(user => {
                    authUsersMap.set(user.email.toLowerCase(), user);
                });

                // Combine and analyze data
                const allEmails = new Set([
                    ...workers.map(w => w.email.toLowerCase()),
                    ...authUsers.map(u => u.email.toLowerCase())
                ]);

                const combinedData = Array.from(allEmails).map(email => {
                    const workplaceWorker = workplaceWorkersMap.get(email);
                    const authUser = authUsersMap.get(email);
                    
                    return {
                        email: email,
                        workplaceWorker: workplaceWorker,
                        authUser: authUser,
                        authStatus: authUser ? 'HAS_ACCOUNT' : 'NO_ACCOUNT',
                        workplaceStatus: workplaceWorker ? 'IN_SCHEDULER' : 'NOT_IN_SCHEDULER',
                        role: authUser?.isAdmin ? 'ADMIN' : 'USER'
                    };
                });

                // Statistics
                const totalUsers = combinedData.length;
                const admins = combinedData.filter(d => d.role === 'ADMIN').length;
                const regularUsers = combinedData.filter(d => d.role === 'USER').length;
                const usersWithAccounts = combinedData.filter(d => d.authStatus === 'HAS_ACCOUNT').length;
                const usersInScheduler = combinedData.filter(d => d.workplaceStatus === 'IN_SCHEDULER').length;

                let html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">üë§</span>
                            <h3 style="margin: 0; font-size: 1.3rem;">User Account Management</h3>
                        </div>
                        <p style="margin: 0; opacity: 0.9;">Manage user accounts and permissions</p>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-success" onclick="showAddUser()" style="background: #28a745; border: none; padding: 0.5rem 1rem; border-radius: 6px; color: white; cursor: pointer;">
                                <span style="margin-right: 0.5rem;">‚ûï</span>Add User
                            </button>
                            <button class="btn btn-info" onclick="exportUserData()" style="background: #17a2b8; border: none; padding: 0.5rem 1rem; border-radius: 6px; color: white; cursor: pointer;">
                                <span style="margin-right: 0.5rem;">üì§</span>Export
                            </button>

                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${totalUsers}</div>
                            <div style="color: #666; font-size: 0.9rem;">Total Users</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${admins}</div>
                            <div style="color: #666; font-size: 0.9rem;">Admins</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">${regularUsers}</div>
                            <div style="color: #666; font-size: 0.9rem;">Regular Users</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; font-weight: bold; color: #17a2b8;">${usersWithAccounts}</div>
                            <div style="color: #666; font-size: 0.9rem;">With Login Accounts</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${usersInScheduler}</div>
                            <div style="color: #666; font-size: 0.9rem;">In Scheduler</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                        <div style="flex: 1; position: relative;">
                            <input type="text" id="userSearchInput" placeholder="Search users by name or email..." 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999;">üîç</span>
                        </div>
                        <select id="userFilterRole" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="all">All Users</option>
                            <option value="admin">Admins</option>
                            <option value="user">Regular Users</option>
                        </select>
                        <select id="userFilterStatus" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="all">All Status</option>
                            <option value="connected">Fully Connected (Both)</option>
                            <option value="auth_only">Has Account Only</option>
                            <option value="scheduler_only">In Scheduler Only</option>
                            <option value="neither">No Account & Not In Scheduler</option>
                            <option value="suspended">Suspended Accounts</option>
                            <option value="active">Active Accounts</option>
                            <option value="never_logged_in">Never Logged In</option>
                            <option value="recent_login">Logged In Recently (7 days)</option>
                        </select>
                    </div>
                `;

                if (combinedData.length === 0) {
                    html += '<div class="warning">No users found. Add your first user to get started!</div>';
                } else {
                    html += `
                        <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">
                                            <input type="checkbox" id="selectAllUsers" style="margin-right: 0.5rem;">
                                        </th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Name</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Email</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Role</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Login Account</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">In Scheduler</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Phone</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Last Login</th>
                                        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    combinedData.forEach(data => {
                        const name = data.authUser ? `${data.authUser.firstName} ${data.authUser.lastName}` : 
                                   (data.workplaceWorker ? `${data.workplaceWorker.first_name} ${data.workplaceWorker.last_name}` : 'Unknown');
                        const phone = data.authUser?.phone || '-';
                        const lastLogin = data.authUser?.loginTime ? 
                            new Date(data.authUser.loginTime).toLocaleString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : 'Never';
                        
                        const roleBadge = data.role === 'ADMIN' ? 
                            '<span style="background: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">ADMIN</span>' :
                            '<span style="background: #ffc107; color: #212529; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">USER</span>';
                        
                        const authStatusBadge = data.authStatus === 'HAS_ACCOUNT' ?
                            '<span style="background: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">‚úÖ HAS ACCOUNT</span>' :
                            '<span style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">‚ùå NO ACCOUNT</span>';
                        
                        const schedulerStatusBadge = data.workplaceStatus === 'IN_SCHEDULER' ?
                            '<span style="background: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">‚úÖ IN SCHEDULER</span>' :
                            '<span style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">‚ùå NOT IN SCHEDULER</span>';
                        
                        // Get suspension status from auth user data
                        const isSuspended = data.authUser?.suspended || false;
                        const suspendButtonText = isSuspended ? 'üîÑ Unsuspend' : '‚è∏Ô∏è Suspend';
                        const suspendButtonClass = isSuspended ? 'btn-success' : 'btn-secondary';
                        const suspendButtonDisabled = data.role === 'ADMIN' || data.email === user.email ? 'disabled' : '';

                        html += `
                            <tr style="border-bottom: 1px solid #dee2e6; ${isSuspended ? 'background-color: #fff5f5; opacity: 0.7;' : ''}">
                                <td style="padding: 1rem;">
                                    <input type="checkbox" class="user-checkbox" data-email="${data.email}">
                                </td>
                                <td style="padding: 1rem; font-weight: 600;">
                                    ${name}
                                    ${isSuspended ? '<br><small style="color: #dc3545; font-weight: normal;">üö´ SUSPENDED</small>' : ''}
                                </td>
                                <td style="padding: 1rem;">${data.email}</td>
                                <td style="padding: 1rem;">${roleBadge}</td>
                                <td style="padding: 1rem;">${authStatusBadge}</td>
                                <td style="padding: 1rem;">${schedulerStatusBadge}</td>
                                <td style="padding: 1rem;">${phone}</td>
                                <td style="padding: 1rem;">${lastLogin}</td>
                                <td style="padding: 1rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-info" onclick="viewUser('${data.email}')" style="background: #17a2b8; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">üëÅÔ∏è View</button>
                                        <button class="btn btn-warning" onclick="editUser('${data.email}')" style="background: #ffc107; color: #212529; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">‚úèÔ∏è Edit</button>
                                        <button class="btn ${suspendButtonClass}" onclick="suspendUser('${data.email}')" style="background: ${isSuspended ? '#28a745' : '#6c757d'}; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;" ${suspendButtonDisabled}>${suspendButtonText}</button>
                                        <button class="btn btn-danger" onclick="deleteUser('${data.email}')" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">üóëÔ∏è Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                // Structure the modal content to maintain tab navigation
                const modalContent = document.getElementById('workersModalContent');
                modalContent.innerHTML = `
                    <div class="enhanced-worker-management">
                        <div class="tab-navigation">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem;">üë•</span>
                                <h3 style="margin: 0; font-size: 1.3rem;">Enhanced Worker & User Management</h3>
                                <div style="margin-left: auto;">
                                    <span style="cursor: pointer; font-size: 1.5rem; color: #999;" onclick="closeModal('workersModal')">√ó</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 1.5rem;">
                                <button class="tab-btn" data-tab="workers" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                                    Workers (${workers.length})
                                </button>
                                <button class="tab-btn active" data-tab="users" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #667eea; color: #667eea; font-weight: bold;">
                                    Users (${totalUsers})
                                </button>
                                <button class="tab-btn" data-tab="import" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                                    Import/Export
                                </button>
                                <button class="tab-btn" data-tab="analytics" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                                    Analytics
                                </button>
                            </div>
                        </div>
                        <div class="tab-content">
                            ${html}
                        </div>
                    </div>
                `;
                
                // Add event listeners for search and filter
                setupUserSearchAndFilter();
                
            } catch (error) {
                console.error('Error loading enhanced worker data:', error);
                document.getElementById('workersModalContent').innerHTML = `
                    <div class="error">Error loading worker data: ${error.message}</div>
                `;
            }
        }

        function setupUserSearchAndFilter() {
            const searchInput = document.getElementById('userSearchInput');
            const roleFilter = document.getElementById('userFilterRole');
            const statusFilter = document.getElementById('userFilterStatus');
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterUsers);
            }
            if (roleFilter) {
                roleFilter.addEventListener('change', filterUsers);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', filterUsers);
            }
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', toggleSelectAllUsers);
            }

            // Add tab switching functionality with proper event delegation
            setTimeout(() => {
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabName = button.getAttribute('data-tab');
                        console.log('Tab clicked:', tabName);
                        switchTab(tabName);
                    });
                });
            }, 100);
        }

        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Update tab button styles
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottom = '2px solid transparent';
                btn.style.color = '#666';
                btn.style.fontWeight = 'normal';
            });

            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.style.borderBottom = '2px solid #667eea';
                activeButton.style.color = '#667eea';
                activeButton.style.fontWeight = 'bold';
            }

            // Get the content container within the enhanced worker management structure
            const contentContainer = document.querySelector('#workersModalContent .tab-content') || 
                                   document.querySelector('#workersModalContent');

            // Handle different tab content
            switch(tabName) {
                case 'workers':
                    displayWorkersTab(contentContainer);
                    break;
                case 'users':
                    displayUsersTab(contentContainer);
                    break;
                case 'import':
                    displayImportExportTab(contentContainer);
                    break;
                case 'analytics':
                    displayAnalyticsTab(contentContainer);
                    break;
            }
        }

        function displayWorkersTab(contentContainer) {
            // Show the original workers table but maintain tab structure
            let html = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-success" onclick="showAddWorker()">‚ûï Add New Worker</button>
                    <span style="margin-left: 1rem; color: #666;">Total: ${workers.length} workers</span>
                </div>
            `;
            
            if (workers.length === 0) {
                html += '<div class="warning">No workers found. Add your first worker to get started!</div>';
            } else {
                html += `
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Work Study</th>
                                <th>Availability</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                workers.forEach(worker => {
                    html += `
                        <tr>
                            <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                            <td>${worker.email}</td>
                            <td>${worker.work_study ? '‚úÖ Yes' : '‚ùå No'}</td>
                            <td><small>${worker.availability_text || 'No availability set'}</small></td>
                            <td>
                                <div class="worker-actions">
                                    <button class="btn btn-warning" onclick="editWorker('${worker.id}')">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">üóëÔ∏è Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            if (contentContainer) {
                contentContainer.innerHTML = html;
            }
        }

        function displayUsersTab(contentContainer) {
            // Re-display the users tab content
            displayEnhancedWorkersInModal();
        }

        function displayImportExportTab(contentContainer) {
            const content = `
                <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem;">üì• Import/Export Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4>üì§ Export Data</h4>
                            <p style="color: #666; margin-bottom: 1rem;">Export user and worker data for backup or analysis.</p>
                            <button class="btn btn-success" onclick="exportAllData()">Export All Data</button>
                            <button class="btn btn-info" onclick="exportUsersOnly()">Export Users Only</button>
                            <button class="btn btn-warning" onclick="exportWorkersOnly()">Export Workers Only</button>
                        </div>
                        <div>
                            <h4>üì• Import Data</h4>
                            <p style="color: #666; margin-bottom: 1rem;">Import user and worker data from CSV files.</p>
                            <input type="file" id="importFile" accept=".csv" style="margin-bottom: 1rem;">
                            <button class="btn btn-primary" onclick="importData()">Import Data</button>
                        </div>
                    </div>
                </div>
            `;
            
            if (contentContainer) {
                contentContainer.innerHTML = content;
            }
        }

        function displayAnalyticsTab(contentContainer) {
            const content = `
                <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="margin: 0;">üìä Advanced Analytics & Logging Dashboard</h3>
                                            <div style="display: flex; gap: 0.5rem;">
                        <button onclick="refreshAnalytics()" class="btn btn-info" style="background: #17a2b8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                            üîÑ Refresh Data
                        </button>
                        <button onclick="clearAllLogs()" class="btn btn-danger" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                            üóëÔ∏è Clear Logs
                        </button>
                        <button onclick="testAvailabilityLoading()" class="btn btn-warning" style="background: #ffc107; color: #212529; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                            üß™ Test Availability
                        </button>
                    </div>
                    </div>
                    
                    <!-- Key Metrics Section -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${workers.length}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Workers</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${workers.filter(w => w.work_study).length}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Work Study Students</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;">${workers.filter(w => !w.work_study).length}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Regular Workers</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;" id="totalLogs">0</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Log Entries</div>
                        </div>
                    </div>
                    
                    <!-- Navigation Tabs for Analytics -->
                    <div style="display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 1.5rem;">
                        <button class="analytics-tab-btn active" data-tab="activity" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #667eea; color: #667eea; font-weight: bold;">
                            üìà Activity Logs
                        </button>
                        <button class="analytics-tab-btn" data-tab="security" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                            üîí Security Logs
                        </button>
                        <button class="analytics-tab-btn" data-tab="insights" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                            üí° Insights
                        </button>
                        <button class="analytics-tab-btn" data-tab="reports" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                            üìã Reports
                        </button>
                    </div>
                    
                    <!-- Activity Logs Tab Content -->
                    <div id="analytics-activity" class="analytics-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">üìà Recent Activity Logs</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="activityFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <option value="all">All Activities</option>
                                    <option value="login">Logins</option>
                                    <option value="edit">Edits</option>
                                    <option value="view">Views</option>
                                    <option value="suspend">Suspensions</option>
                                    <option value="delete">Deletions</option>
                                </select>
                                <button onclick="exportActivityLogs()" class="btn btn-success" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                    üì• Export
                                </button>
                            </div>
                        </div>
                        <div id="activityLogsContainer" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                                <div>Loading activity logs...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Logs Tab Content -->
                    <div id="analytics-security" class="analytics-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">üîí Security & Access Logs</h4>
                            <button onclick="exportSecurityLogs()" class="btn btn-warning" style="background: #ffc107; color: #212529; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 14px; cursor: pointer;">
                                üì• Export
                            </button>
                        </div>
                        <div id="securityLogsContainer" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üîí</div>
                                <div>Loading security logs...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insights Tab Content -->
                    <div id="analytics-insights" class="analytics-content" style="display: none;">
                        <h4 style="margin-bottom: 1rem;">üí° System Insights</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                <h5 style="margin: 0 0 1rem 0; color: #333;">üë• User Engagement</h5>
                                <div id="userEngagementInsights">
                                    <div style="text-align: center; color: #666;">Loading insights...</div>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                <h5 style="margin: 0 0 1rem 0; color: #333;">üîê Security Alerts</h5>
                                <div id="securityInsights">
                                    <div style="text-align: center; color: #666;">Loading insights...</div>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                <h5 style="margin: 0 0 1rem 0; color: #333;">üìä Database Health</h5>
                                <div id="databaseInsights">
                                    <div style="text-align: center; color: #666;">Loading insights...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports Tab Content -->
                    <div id="analytics-reports" class="analytics-content" style="display: none;">
                        <h4 style="margin-bottom: 1rem;">üìã Generate Reports</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <button onclick="generateReport('user_activity')" class="btn btn-info" style="background: #17a2b8; color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">üìà User Activity Report</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Login patterns and user engagement</div>
                            </button>
                            <button onclick="generateReport('security_audit')" class="btn btn-warning" style="background: #ffc107; color: #212529; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">üîí Security Audit Report</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Suspicious activities and access logs</div>
                            </button>
                            <button onclick="generateReport('database_health')" class="btn btn-success" style="background: #28a745; color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">üíæ Database Health Report</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Data integrity and connection status</div>
                            </button>
                            <button onclick="generateReport('admin_actions')" class="btn btn-danger" style="background: #dc3545; color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; text-align: left;">
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">‚ö° Admin Actions Report</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">All admin modifications and changes</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            if (contentContainer) {
                contentContainer.innerHTML = content;
            }
            
            // Initialize analytics tabs
            setupAnalyticsTabs();
            
            // Load initial data
            loadActivityLogs();
            loadSecurityLogs();
            loadInsights();
        }

        // Helper function to check if login was recent (within 7 days)
        function isRecentLogin(loginText) {
            if (!loginText || loginText === 'Never') return false;
            
            try {
                // Parse the login text (format: "Dec 15, 2024, 02:30 PM")
                const loginDate = new Date(loginText);
                const now = new Date();
                const diffTime = Math.abs(now - loginDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays <= 7;
            } catch (error) {
                return false;
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('userFilterRole')?.value || 'all';
            const statusFilter = document.getElementById('userFilterStatus')?.value || 'all';
            
            const rows = document.querySelectorAll('#workersModalContent tbody tr');
            
            rows.forEach(row => {
                const name = row.cells[1]?.textContent.toLowerCase() || '';
                const email = row.cells[2]?.textContent.toLowerCase() || '';
                const role = row.cells[3]?.textContent.toLowerCase() || '';
                const authStatus = row.cells[4]?.textContent.toLowerCase() || '';
                const schedulerStatus = row.cells[5]?.textContent.toLowerCase() || '';
                
                const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
                const matchesRole = roleFilter === 'all' || role.includes(roleFilter);
                
                // Enhanced status filtering with more specific options
                const matchesStatus = statusFilter === 'all' || 
                    (statusFilter === 'connected' && authStatus.includes('has account') && schedulerStatus.includes('‚úÖ in scheduler')) ||
                    (statusFilter === 'auth_only' && authStatus.includes('has account') && schedulerStatus.includes('‚ùå not in scheduler')) ||
                    (statusFilter === 'scheduler_only' && authStatus.includes('‚ùå no account') && schedulerStatus.includes('‚úÖ in scheduler')) ||
                    (statusFilter === 'neither' && authStatus.includes('‚ùå no account') && schedulerStatus.includes('‚ùå not in scheduler')) ||
                    (statusFilter === 'suspended' && authStatus.includes('has account') && row.querySelector('small')?.textContent?.includes('SUSPENDED')) ||
                    (statusFilter === 'active' && authStatus.includes('has account') && !row.querySelector('small')?.textContent?.includes('SUSPENDED')) ||
                    (statusFilter === 'never_logged_in' && row.cells[7]?.textContent === 'Never') ||
                    (statusFilter === 'recent_login' && row.cells[7]?.textContent !== 'Never' && isRecentLogin(row.cells[7]?.textContent));
                
                row.style.display = matchesSearch && matchesRole && matchesStatus ? '' : 'none';
            });
        }

        function toggleSelectAllUsers() {
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // Enhanced user management functions
        window.viewUser = async function(email) {
            try {
                // Log the view action
                logActivity('view', `Viewed user details for ${email}`, user.email);
                
                // Get user data from both databases
                const authApp = getApp('authApp');
                const authDb = getFirestore(authApp);
                
                const usersRef = collection(authDb, 'users');
                const q = query(usersRef, where('email', '==', email));
                const querySnapshot = await getDocs(q);
                
                let userData = null;
                querySnapshot.forEach((doc) => {
                    userData = { id: doc.id, ...doc.data() };
                });
                
                if (!userData) {
                    showNotification('‚ùå User not found', 'error');
                    return;
                }
                
                // Find workplace worker data
                const workplaceWorker = workers.find(w => w.email.toLowerCase() === email.toLowerCase());
                
                // Create detailed user view
                const lastLogin = userData.loginTime ? 
                    new Date(userData.loginTime).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Never';
                
                const suspendedStatus = userData.suspended ? 
                    '<span style="color: #dc3545; font-weight: bold;">SUSPENDED</span>' : 
                    '<span style="color: #28a745; font-weight: bold;">ACTIVE</span>';
                
                const modalContent = `
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; margin: 2rem auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0; color: #333;">üë§ User Details</h2>
                            <button onclick="closeModal('userViewModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">√ó</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div>
                                <strong>Name:</strong><br>
                                ${userData.firstName} ${userData.lastName}
                            </div>
                            <div>
                                <strong>Email:</strong><br>
                                ${userData.email}
                            </div>
                            <div>
                                <strong>Role:</strong><br>
                                ${userData.isAdmin ? 'ADMIN' : 'USER'}
                            </div>
                            <div>
                                <strong>Status:</strong><br>
                                ${suspendedStatus}
                            </div>
                            <div>
                                <strong>Phone:</strong><br>
                                ${userData.phone || '-'}
                            </div>
                            <div>
                                <strong>Last Login:</strong><br>
                                ${lastLogin}
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #333;">Database Status</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <strong>Auth Database:</strong><br>
                                    <span style="color: #28a745;">‚úÖ Account Exists</span>
                                </div>
                                <div>
                                    <strong>Workplace Database:</strong><br>
                                    ${workplaceWorker ? 
                                        '<span style="color: #28a745;">‚úÖ In Scheduler</span>' : 
                                        '<span style="color: #dc3545;">‚ùå Not In Scheduler</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        ${workplaceWorker ? `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #333;">Workplace Information</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <strong>Work Study:</strong><br>
                                    ${workplaceWorker.work_study ? 'Yes' : 'No'}
                                </div>
                                <div>
                                    <strong>Availability:</strong><br>
                                    <small>${workplaceWorker.availability_text || 'No availability set'}</small>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="editUser('${email}')" class="btn btn-warning">‚úèÔ∏è Edit User</button>
                            <button onclick="closeModal('userViewModal')" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                `;
                
                // Create modal if it doesn't exist
                let modal = document.getElementById('userViewModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'userViewModal';
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.5); z-index: 10000; display: none;
                    `;
                    document.body.appendChild(modal);
                }
                
                modal.innerHTML = modalContent;
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error viewing user:', error);
                showNotification('‚ùå Error loading user details', 'error');
            }
        };

        window.editUser = async function(email) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            
            try {
                // Log the edit action
                logActivity('edit', `Opened edit form for user ${email}`, user.email);
                
                // Get user data from auth database
                const authApp = getApp('authApp');
                const authDb = getFirestore(authApp);
                
                const usersRef = collection(authDb, 'users');
                const q = query(usersRef, where('email', '==', email));
                const querySnapshot = await getDocs(q);
                
                let userData = null;
                querySnapshot.forEach((doc) => {
                    userData = { id: doc.id, ...doc.data() };
                });
                
                if (!userData) {
                    showNotification('‚ùå User not found', 'error');
                    return;
                }
                
                // Prevent editing own account
                if (userData.email === user.email) {
                    showNotification('‚ùå Cannot edit your own account', 'error');
                    return;
                }
                
                // Create edit modal
                const modalContent = `
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; margin: 2rem auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0; color: #333;">‚úèÔ∏è Edit User</h2>
                            <button onclick="closeModal('userEditModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">√ó</button>
                        </div>
                        
                        <form id="editUserForm">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Name:</label>
                                <input type="text" id="editFirstName" value="${userData.firstName || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-right: 0.5rem;" placeholder="First Name">
                                <input type="text" id="editLastName" value="${userData.lastName || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem;" placeholder="Last Name">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email:</label>
                                <input type="email" id="editEmail" value="${userData.email}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" readonly>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Phone:</label>
                                <input type="tel" id="editPhone" value="${userData.phone || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="Phone Number">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Role:</label>
                                <select id="editIsAdmin" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="0" ${!userData.isAdmin ? 'selected' : ''}>USER</option>
                                    <option value="1" ${userData.isAdmin ? 'selected' : ''}>ADMIN</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status:</label>
                                <select id="editSuspended" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="false" ${!userData.suspended ? 'selected' : ''}>ACTIVE</option>
                                    <option value="true" ${userData.suspended ? 'selected' : ''}>SUSPENDED</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                                <button type="button" onclick="closeModal('userEditModal')" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                            </div>
                        </form>
                    </div>
                `;
                
                // Create modal if it doesn't exist
                let modal = document.getElementById('userEditModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'userEditModal';
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.5); z-index: 10000; display: none;
                    `;
                    document.body.appendChild(modal);
                }
                
                modal.innerHTML = modalContent;
                modal.style.display = 'block';
                
                // Handle form submission
                document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const firstName = document.getElementById('editFirstName').value.trim();
                    const lastName = document.getElementById('editLastName').value.trim();
                    const phone = document.getElementById('editPhone').value.trim();
                    const isAdmin = parseInt(document.getElementById('editIsAdmin').value);
                    const suspended = document.getElementById('editSuspended').value === 'true';
                    
                    if (!firstName || !lastName) {
                        showNotification('‚ùå First and last name are required', 'error');
                        return;
                    }
                    
                    try {
                        // Update user in database
                        const userDocRef = doc(authDb, 'users', userData.id);
                        await updateDoc(userDocRef, {
                            firstName,
                            lastName,
                            phone,
                            isAdmin,
                            suspended
                        });
                        
                        // Log the successful edit
                        logActivity('edit', `Successfully updated user ${email}`, user.email);
                        logSecurityEvent('user_updated', `Admin updated user ${email}`, 'info');
                        
                        showNotification('‚úÖ User updated successfully!', 'success');
                        closeModal('userEditModal');
                        
                        // Refresh the user list
                        await displayEnhancedWorkersInModal();
                        
                    } catch (error) {
                        console.error('Error updating user:', error);
                        showNotification('‚ùå Error updating user', 'error');
                    }
                });
                
            } catch (error) {
                console.error('Error editing user:', error);
                showNotification('‚ùå Error loading user details', 'error');
            }
        };

        window.suspendUser = async function(email) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            
            try {
                // Log the suspend action attempt
                logActivity('suspend', `Attempted to suspend/unsuspend user ${email}`, user.email);
                
                // Get user data from auth database
                const authApp = getApp('authApp');
                const authDb = getFirestore(authApp);
                
                const usersRef = collection(authDb, 'users');
                const q = query(usersRef, where('email', '==', email));
                const querySnapshot = await getDocs(q);
                
                let userData = null;
                querySnapshot.forEach((doc) => {
                    userData = { id: doc.id, ...doc.data() };
                });
                
                if (!userData) {
                    showNotification('‚ùå User not found', 'error');
                    return;
                }
                
                // Prevent suspending own account
                if (userData.email === user.email) {
                    showNotification('‚ùå Cannot suspend your own account', 'error');
                    return;
                }
                
                // Prevent suspending other admins
                if (userData.isAdmin) {
                    showNotification('‚ùå Cannot suspend admin accounts', 'error');
                    return;
                }
                
                const action = userData.suspended ? 'unsuspend' : 'suspend';
                const confirmMessage = userData.suspended ? 
                    `Are you sure you want to unsuspend ${userData.firstName} ${userData.lastName}?` :
                    `Are you sure you want to suspend ${userData.firstName} ${userData.lastName}?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // Update suspension status
                const userDocRef = doc(authDb, 'users', userData.id);
                await updateDoc(userDocRef, {
                    suspended: !userData.suspended
                });
                
                // Log the suspension action
                const suspendAction = userData.suspended ? 'unsuspend' : 'suspend';
                logActivity('suspend', `Successfully ${suspendAction}ed user ${email}`, user.email);
                logSecurityEvent(`user_${suspendAction}ed`, `Admin ${suspendAction}ed user ${email}`, 'warning');
                
                const successMessage = userData.suspended ? 
                    `‚úÖ ${userData.firstName} ${userData.lastName} has been unsuspended` :
                    `‚ö†Ô∏è ${userData.firstName} ${userData.lastName} has been suspended`;
                
                showNotification(successMessage, userData.suspended ? 'success' : 'warning');
                
                // Refresh the user list
                await displayEnhancedWorkersInModal();
                
            } catch (error) {
                console.error('Error suspending user:', error);
                showNotification('‚ùå Error updating user status', 'error');
            }
        };

        // Advanced Logging System
        const activityLogs = [];
        const securityLogs = [];
        
        // Log activity function
        function logActivity(action, details, userId = null, ipAddress = null) {
            // Get current user info safely
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            
            const logEntry = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                userId: userId || currentUser.email || 'Unknown',
                userRole: currentUser.isAdmin ? 'ADMIN' : 'USER',
                ipAddress: ipAddress || 'Unknown',
                userAgent: navigator.userAgent,
                sessionId: sessionStorage.getItem('sessionId') || 'Unknown'
            };
            
            activityLogs.unshift(logEntry);
            
            // Keep only last 1000 entries
            if (activityLogs.length > 1000) {
                activityLogs.pop();
            }
            
            // Store in localStorage for persistence
            localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
            
            // Log to console for debugging
            console.log('üìä Activity Log:', logEntry);
        }
        
        // Log security events
        function logSecurityEvent(event, details, severity = 'info', ipAddress = null) {
            // Get current user info safely
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            
            const securityEntry = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                event: event,
                details: details,
                severity: severity, // 'info', 'warning', 'error', 'critical'
                userId: currentUser.email || 'Unknown',
                userRole: currentUser.isAdmin ? 'ADMIN' : 'USER',
                ipAddress: ipAddress || 'Unknown',
                userAgent: navigator.userAgent,
                sessionId: sessionStorage.getItem('sessionId') || 'Unknown'
            };
            
            securityLogs.unshift(securityEntry);
            
            // Keep only last 500 security entries
            if (securityLogs.length > 500) {
                securityLogs.pop();
            }
            
            // Store in localStorage
            localStorage.setItem('securityLogs', JSON.stringify(securityLogs));
            
            // Log to console
            console.log(`üîí Security Log [${severity.toUpperCase()}]:`, securityEntry);
            
            // Show notification for critical events
            if (severity === 'critical') {
                showNotification(`üö® Critical Security Event: ${event}`, 'error');
            }
        }
        
        // Get IP address (simplified - in production, use a proper IP service)
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Unknown';
            }
        }
        
        // Initialize session tracking
        function initializeSessionTracking() {
            if (!sessionStorage.getItem('sessionId')) {
                sessionStorage.setItem('sessionId', Date.now() + Math.random());
            }
            
            // Get current user info safely
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Log session start
            logActivity('session_start', 'User session started', currentUser.email);
            logSecurityEvent('session_start', 'User session initiated', 'info');
        }
        
        // Analytics tab functionality
        function setupAnalyticsTabs() {
            const tabButtons = document.querySelectorAll('.analytics-tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    switchAnalyticsTab(tabName);
                });
            });
            
            // Add filter change listener
            const activityFilter = document.getElementById('activityFilter');
            if (activityFilter) {
                activityFilter.addEventListener('change', () => {
                    loadActivityLogs();
                });
            }
        }
        
        function switchAnalyticsTab(tabName) {
            // Update tab button styles
            const tabButtons = document.querySelectorAll('.analytics-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottom = '2px solid transparent';
                btn.style.color = '#666';
                btn.style.fontWeight = 'normal';
            });
            
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.style.borderBottom = '2px solid #667eea';
                activeButton.style.color = '#667eea';
                activeButton.style.fontWeight = 'bold';
            }
            
            // Show/hide content
            const contentDivs = document.querySelectorAll('.analytics-content');
            contentDivs.forEach(div => {
                div.style.display = 'none';
            });
            
            const activeContent = document.getElementById(`analytics-${tabName}`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }
        
        // Load activity logs
        async function loadActivityLogs() {
            const container = document.getElementById('activityLogsContainer');
            if (!container) return;
            
            // Load from localStorage
            const storedLogs = localStorage.getItem('activityLogs');
            const logs = storedLogs ? JSON.parse(storedLogs) : [];
            
            // Also load login data from index.html
            const loginAttempts = JSON.parse(localStorage.getItem('loginAttempts') || '[]');
            const successfulLogins = JSON.parse(localStorage.getItem('successfulLogins') || '[]');
            const failedLogins = JSON.parse(localStorage.getItem('failedLogins') || '[]');
            const registrations = JSON.parse(localStorage.getItem('registrations') || '[]');
            
            // Combine all activity data
            const allActivityLogs = [
                ...logs,
                ...loginAttempts.map(log => ({ 
                    ...log, 
                    action: 'login_attempt',
                    userId: log.email || 'Unknown',
                    userRole: 'USER',
                    details: `Login attempt for ${log.email || 'Unknown'}`
                })),
                ...successfulLogins.map(log => ({ 
                    ...log, 
                    action: 'login_success',
                    userId: log.email || 'Unknown',
                    userRole: log.isAdmin ? 'ADMIN' : 'USER',
                    details: `Successful login for ${log.email || 'Unknown'}`
                })),
                ...failedLogins.map(log => ({ 
                    ...log, 
                    action: 'login_failed',
                    userId: log.email || 'Unknown',
                    userRole: 'USER',
                    details: `Failed login for ${log.email || 'Unknown'} - ${log.error || 'Unknown error'}`
                })),
                ...registrations.map(log => ({ 
                    ...log, 
                    action: 'registration_success',
                    userId: log.email || 'Unknown',
                    userRole: 'USER',
                    details: `New user registration: ${log.firstName || ''} ${log.lastName || ''} (${log.email || 'Unknown'})`
                }))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Update total logs count
            const totalLogsElement = document.getElementById('totalLogs');
            if (totalLogsElement) {
                totalLogsElement.textContent = allActivityLogs.length;
            }
            
            if (allActivityLogs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                        <div>No activity logs found</div>
                    </div>
                `;
                return;
            }
            
            const filter = document.getElementById('activityFilter')?.value || 'all';
            const filteredLogs = filter === 'all' ? allActivityLogs : allActivityLogs.filter(log => log.action === filter);
            
            let html = '';
            filteredLogs.slice(0, 50).forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const actionIcon = getActionIcon(log.action);
                const actionColor = getActionColor(log.action);
                
                html += `
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${actionColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">${actionIcon}</span>
                                <strong style="color: ${actionColor};">${log.action.toUpperCase()}</strong>
                            </div>
                            <small style="color: #666;">${timestamp}</small>
                        </div>
                        <div style="color: #333; margin-bottom: 0.5rem;">${log.details}</div>
                        <div style="font-size: 0.8rem; color: #666;">
                            User: ${log.userId} (${log.userRole}) | IP: ${log.ipAddress}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Load security logs
        async function loadSecurityLogs() {
            const container = document.getElementById('securityLogsContainer');
            if (!container) return;
            
            const storedLogs = localStorage.getItem('securityLogs');
            const logs = storedLogs ? JSON.parse(storedLogs) : [];
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîí</div>
                        <div>No security logs found</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            logs.slice(0, 50).forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const severityColor = getSeverityColor(log.severity);
                
                html += `
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${severityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üîí</span>
                                <strong style="color: ${severityColor};">${log.event.toUpperCase()}</strong>
                                <span style="background: ${severityColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">${log.severity.toUpperCase()}</span>
                            </div>
                            <small style="color: #666;">${timestamp}</small>
                        </div>
                        <div style="color: #333; margin-bottom: 0.5rem;">${log.details}</div>
                        <div style="font-size: 0.8rem; color: #666;">
                            User: ${log.userId} (${log.userRole}) | IP: ${log.ipAddress}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Load insights
        async function loadInsights() {
            // User Engagement Insights
            const engagementContainer = document.getElementById('userEngagementInsights');
            if (engagementContainer) {
                const storedLogs = localStorage.getItem('activityLogs');
                const logs = storedLogs ? JSON.parse(storedLogs) : [];
                
                // Also get login data
                const successfulLogins = JSON.parse(localStorage.getItem('successfulLogins') || '[]');
                const loginAttempts = JSON.parse(localStorage.getItem('loginAttempts') || '[]');
                
                const loginCount = successfulLogins.length;
                const activeUsers = new Set(successfulLogins.map(log => log.email)).size;
                const recentActivity = logs.filter(log => {
                    const logDate = new Date(log.timestamp);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return logDate > weekAgo;
                }).length + loginAttempts.filter(log => {
                    const logDate = new Date(log.timestamp);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return logDate > weekAgo;
                }).length;
                
                engagementContainer.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: bold; color: #667eea;">${loginCount}</div>
                        <div style="font-size: 0.9rem; color: #666;">Total Logins</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: bold; color: #28a745;">${activeUsers}</div>
                        <div style="font-size: 0.9rem; color: #666;">Active Users</div>
                    </div>
                    <div>
                        <div style="font-weight: bold; color: #ffc107;">${recentActivity}</div>
                        <div style="font-size: 0.9rem; color: #666;">Activities (7 days)</div>
                    </div>
                `;
            }
            
            // Security Insights
            const securityContainer = document.getElementById('securityInsights');
            if (securityContainer) {
                const storedLogs = localStorage.getItem('securityLogs');
                const logs = storedLogs ? JSON.parse(storedLogs) : [];
                
                // Also get failed login data
                const failedLogins = JSON.parse(localStorage.getItem('failedLogins') || '[]');
                
                const criticalEvents = logs.filter(log => log.severity === 'critical').length;
                const warnings = logs.filter(log => log.severity === 'warning').length + failedLogins.length;
                const suspiciousIPs = new Set([
                    ...logs.filter(log => log.ipAddress !== 'Unknown').map(log => log.ipAddress),
                    ...failedLogins.filter(log => log.ipAddress !== 'Unknown').map(log => log.ipAddress)
                ]).size;
                
                securityContainer.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: bold; color: #dc3545;">${criticalEvents}</div>
                        <div style="font-size: 0.9rem; color: #666;">Critical Events</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: bold; color: #ffc107;">${warnings}</div>
                        <div style="font-size: 0.9rem; color: #666;">Security Warnings</div>
                    </div>
                    <div>
                        <div style="font-weight: bold; color: #17a2b8;">${suspiciousIPs}</div>
                        <div style="font-size: 0.9rem; color: #666;">Unique IPs</div>
                    </div>
                `;
            }
            
            // Database Insights
            const databaseContainer = document.getElementById('databaseInsights');
            if (databaseContainer) {
                const authUsers = workers.length; // This would be actual auth users count
                const workplaceUsers = workers.length;
                const connectedUsers = workers.filter(w => w.email).length;
                
                databaseContainer.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: bold; color: #28a745;">${authUsers}</div>
                        <div style="font-size: 0.9rem; color: #666;">Auth Users</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: bold; color: #17a2b8;">${workplaceUsers}</div>
                        <div style="font-size: 0.9rem; color: #666;">Workplace Users</div>
                    </div>
                    <div>
                        <div style="font-weight: bold; color: #ffc107;">${connectedUsers}</div>
                        <div style="font-size: 0.9rem; color: #666;">Connected Users</div>
                    </div>
                `;
            }
        }
        
        // Helper functions
        function getActionIcon(action) {
            const icons = {
                'login': 'üîë',
                'login_attempt': 'üîë',
                'login_success': '‚úÖ',
                'login_failed': '‚ùå',
                'registration_success': 'üìù',
                'logout': 'üö™',
                'edit': '‚úèÔ∏è',
                'view': 'üëÅÔ∏è',
                'suspend': '‚è∏Ô∏è',
                'delete': 'üóëÔ∏è',
                'session_start': 'üöÄ',
                'session_end': '‚èπÔ∏è'
            };
            return icons[action] || 'üìä';
        }
        
        function getActionColor(action) {
            const colors = {
                'login': '#28a745',
                'login_attempt': '#17a2b8',
                'login_success': '#28a745',
                'login_failed': '#dc3545',
                'registration_success': '#20c997',
                'logout': '#6c757d',
                'edit': '#ffc107',
                'view': '#17a2b8',
                'suspend': '#dc3545',
                'delete': '#dc3545',
                'session_start': '#28a745',
                'session_end': '#6c757d'
            };
            return colors[action] || '#667eea';
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'info': '#17a2b8',
                'warning': '#ffc107',
                'error': '#dc3545',
                'critical': '#dc3545'
            };
            return colors[severity] || '#17a2b8';
        }
        
        // Export functions
        window.exportActivityLogs = function() {
            const storedLogs = localStorage.getItem('activityLogs');
            const logs = storedLogs ? JSON.parse(storedLogs) : [];
            
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Timestamp,Action,Details,User,Role,IP Address\n" +
                logs.map(log => 
                    `${log.timestamp},${log.action},${log.details},${log.userId},${log.userRole},${log.ipAddress}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `activity_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('‚úÖ Activity logs exported successfully!', 'success');
        };
        
        window.exportSecurityLogs = function() {
            const storedLogs = localStorage.getItem('securityLogs');
            const logs = storedLogs ? JSON.parse(storedLogs) : [];
            
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Timestamp,Event,Details,Severity,User,Role,IP Address\n" +
                logs.map(log => 
                    `${log.timestamp},${log.event},${log.details},${log.severity},${log.userId},${log.userRole},${log.ipAddress}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `security_logs_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('‚úÖ Security logs exported successfully!', 'success');
        };
        
        window.refreshAnalytics = function() {
            loadActivityLogs();
            loadSecurityLogs();
            loadInsights();
            showNotification('üîÑ Analytics data refreshed!', 'success');
        };
        
        window.generateReport = function(reportType) {
            showNotification(`üìã Generating ${reportType} report...`, 'info');
            
            // In a real implementation, this would generate comprehensive reports
            setTimeout(() => {
                showNotification(`‚úÖ ${reportType} report generated! Check downloads.`, 'success');
            }, 2000);
        };
        
        // Function to clear all logs (for testing)
        window.clearAllLogs = function() {
            if (confirm('Are you sure you want to clear all logs? This cannot be undone.')) {
                localStorage.removeItem('activityLogs');
                localStorage.removeItem('securityLogs');
                localStorage.removeItem('loginAttempts');
                localStorage.removeItem('successfulLogins');
                localStorage.removeItem('failedLogins');
                localStorage.removeItem('registrations');
                
                showNotification('üóëÔ∏è All logs cleared!', 'success');
                
                // Refresh the analytics
                setTimeout(() => {
                    loadActivityLogs();
                    loadSecurityLogs();
                    loadInsights();
                }, 500);
            }
        };
        
        // Test availability loading function
        window.testAvailabilityLoading = function() {
            console.log('=== AVAILABILITY TEST ===');
            console.log('All workers:', workers);
            
            workers.forEach((worker, index) => {
                console.log(`Worker ${index + 1}:`, {
                    name: `${worker.first_name} ${worker.last_name}`,
                    email: worker.email,
                    availability_text: worker.availability_text,
                    raw_data: worker
                });
                
                if (worker.availability_text) {
                    console.log(`Testing availability parsing for ${worker.first_name}:`);
                    loadWorkerAvailability(worker.availability_text);
                }
            });
            
            showNotification('üß™ Check console for availability test results', 'info');
        };
        
        // Initialize session tracking when dashboard loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSessionTracking();
            
            // Generate some sample data if no logs exist (for testing)
            generateSampleData();
        });
        
        // Generate sample data for testing
        function generateSampleData() {
            const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Only generate sample data if no logs exist
            const existingLogs = localStorage.getItem('activityLogs');
            if (existingLogs && JSON.parse(existingLogs).length > 0) {
                return; // Don't generate if logs already exist
            }
            
            // Generate sample activity logs
            const sampleLogs = [
                {
                    id: Date.now() + 1,
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2 hours ago
                    action: 'view',
                    details: 'Viewed user management dashboard',
                    userId: currentUser.email || 'admin@test.com',
                    userRole: 'ADMIN',
                    ipAddress: '192.168.1.100',
                    userAgent: navigator.userAgent,
                    sessionId: sessionStorage.getItem('sessionId') || 'Unknown'
                },
                {
                    id: Date.now() + 2,
                    timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(), // 1 hour ago
                    action: 'edit',
                    details: 'Edited user profile settings',
                    userId: currentUser.email || 'admin@test.com',
                    userRole: 'ADMIN',
                    ipAddress: '192.168.1.100',
                    userAgent: navigator.userAgent,
                    sessionId: sessionStorage.getItem('sessionId') || 'Unknown'
                }
            ];
            
            localStorage.setItem('activityLogs', JSON.stringify(sampleLogs));
            
            // Generate sample security logs
            const sampleSecurityLogs = [
                {
                    id: Date.now() + 3,
                    timestamp: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(), // 3 hours ago
                    event: 'session_start',
                    details: 'User session initiated',
                    severity: 'info',
                    userId: currentUser.email || 'admin@test.com',
                    userRole: 'ADMIN',
                    ipAddress: '192.168.1.100',
                    userAgent: navigator.userAgent,
                    sessionId: sessionStorage.getItem('sessionId') || 'Unknown'
                }
            ];
            
            localStorage.setItem('securityLogs', JSON.stringify(sampleSecurityLogs));
            
            console.log('üìä Sample data generated for testing');
        }

        window.deleteUser = async function(email) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            
            try {
                // Log the delete action attempt
                logActivity('delete', `Attempted to delete user ${email}`, user.email);
                logSecurityEvent('user_deletion_attempt', `Admin attempted to delete user ${email}`, 'warning');
                
                // Get user data from auth database
                const authApp = getApp('authApp');
                const authDb = getFirestore(authApp);
                
                const usersRef = collection(authDb, 'users');
                const q = query(usersRef, where('email', '==', email));
                const querySnapshot = await getDocs(q);
                
                let userData = null;
                querySnapshot.forEach((doc) => {
                    userData = { id: doc.id, ...doc.data() };
                });
                
                if (!userData) {
                    showNotification('‚ùå User not found', 'error');
                    return;
                }
                
                // Prevent deleting own account
                if (userData.email === user.email) {
                    showNotification('‚ùå Cannot delete your own account', 'error');
                    return;
                }
                
                // Prevent deleting other admins
                if (userData.isAdmin) {
                    showNotification('‚ùå Cannot delete admin accounts', 'error');
                    return;
                }
                
                const confirmMessage = `Are you sure you want to delete ${userData.firstName} ${userData.lastName} (${userData.email})? This action cannot be undone and will remove the user from the authentication database.`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // Delete user from auth database
                const userDocRef = doc(authDb, 'users', userData.id);
                await deleteDoc(userDocRef);
                
                // Log the successful deletion
                logActivity('delete', `Successfully deleted user ${email}`, user.email);
                logSecurityEvent('user_deleted', `Admin deleted user ${email}`, 'critical');
                
                showNotification(`üóëÔ∏è ${userData.firstName} ${userData.lastName} has been deleted`, 'error');
                
                // Refresh the user list
                await displayEnhancedWorkersInModal();
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('‚ùå Error deleting user', 'error');
            }
        };

        window.exportUserData = function() {
            showNotification('Exporting user data...', 'info');
            // TODO: Implement data export functionality
        };

        window.exportAllData = function() {
            showNotification('Exporting all data...', 'info');
            // TODO: Implement comprehensive data export
        };

        window.exportUsersOnly = function() {
            showNotification('Exporting users only...', 'info');
            // TODO: Implement users-only export
        };

        window.exportWorkersOnly = function() {
            showNotification('Exporting workers only...', 'info');
            // TODO: Implement workers-only export
        };

        window.importData = function() {
            const fileInput = document.getElementById('importFile');
            if (fileInput && fileInput.files.length > 0) {
                showNotification('Importing data...', 'info');
                // TODO: Implement data import functionality
            } else {
                showNotification('Please select a file to import', 'warning');
            }
        };



        function displayWorkersInModal() {
            let html = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-success" onclick="showAddWorker()">‚ûï Add New Worker</button>
                    <span style="margin-left: 1rem; color: #666;">Total: ${workers.length} workers</span>
                </div>
            `;
            
            if (workers.length === 0) {
                html += '<div class="warning">No workers found. Add your first worker to get started!</div>';
            } else {
                html += `
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Work Study</th>
                                <th>Availability</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                workers.forEach(worker => {
                    html += `
                        <tr>
                            <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                            <td>${worker.email}</td>
                            <td>${worker.work_study ? '‚úÖ Yes' : '‚ùå No'}</td>
                            <td><small>${worker.availability_text || 'No availability set'}</small></td>
                            <td>
                                <div class="worker-actions">
                                    <button class="btn btn-warning" onclick="editWorker('${worker.id}')">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-danger" onclick="deleteWorker('${worker.id}')">üóëÔ∏è Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('workersModalContent').innerHTML = html;
        }

        // Modal functions
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Enhanced worker management with validation
        window.showAddWorker = function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }

            editingWorkerId = null;
            document.getElementById('workerFormTitle').textContent = '‚ûï Add Worker';
            document.getElementById('workerForm').reset();
            
            // Clear all availability slots
            clearAllAvailabilitySlots();
            
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        window.editWorker = function(workerId) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }

            const worker = workers.find(w => w.id === workerId);
            if (!worker) {
                showNotification('‚ùå Worker not found', 'error');
                return;
            }

            console.log('Editing worker:', worker);
            console.log('Worker availability:', worker.availability_text);

            editingWorkerId = workerId;
            document.getElementById('workerFormTitle').textContent = '‚úèÔ∏è Edit Worker';
            
            document.getElementById('workerFirstName').value = worker.first_name;
            document.getElementById('workerLastName').value = worker.last_name;
            document.getElementById('workerEmail').value = worker.email;
            document.getElementById('workerWorkStudy').value = worker.work_study ? 'Yes' : 'No';
            
            // Clear existing slots and load worker's availability
            clearAllAvailabilitySlots();
            loadWorkerAvailability(worker.availability_text);
            
            closeModal('workersModal');
            document.getElementById('workerFormModal').style.display = 'block';
        };

        // Availability Management Functions
        let currentEditingDay = null;
        let availabilitySlots = {};

        // Initialize availability slots object
        function initializeAvailabilitySlots() {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                availabilitySlots[day] = [];
            });
        }

        // Clear all availability slots
        function clearAllAvailabilitySlots() {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const container = document.getElementById(`slots-${day}`);
                if (container) {
                    container.innerHTML = '<div class="empty-slot-message">No time slots added</div>';
                }
                availabilitySlots[day] = [];
            });
        }

        // Add availability slot
        window.addAvailabilitySlot = function(day) {
            currentEditingDay = day;
            const dayNames = {
                'Sun': 'Sunday',
                'Mon': 'Monday',
                'Tue': 'Tuesday',
                'Wed': 'Wednesday',
                'Thu': 'Thursday',
                'Fri': 'Friday',
                'Sat': 'Saturday'
            };
            
            document.getElementById('timeSlotModalTitle').textContent = `‚è∞ Add Time Slot - ${dayNames[day]}`;
            document.getElementById('timeSlotForm').reset();
            document.getElementById('timeSlotModal').style.display = 'block';
        };

        // Initialize availability slots on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - initializing availability slots');
            initializeAvailabilitySlots();
        });
        
        // Manual submission function for time slot form
        window.submitTimeSlotForm = function() {
            console.log('Time slot form submitted manually');
            
            try {
                const startTime = document.getElementById('slotStartTime').value;
                const endTime = document.getElementById('slotEndTime').value;
                
                console.log('Form values:', { startTime, endTime, currentEditingDay });
                
                if (!startTime || !endTime) {
                    showNotification('‚ùå Please select both start and end times', 'error');
                    return;
                }
                
                if (startTime >= endTime) {
                    showNotification('‚ùå End time must be after start time', 'error');
                    return;
                }
                
                if (!currentEditingDay) {
                    console.error('currentEditingDay is not set');
                    showNotification('‚ùå Error: No day selected', 'error');
                    return;
                }
                
                addTimeSlot(currentEditingDay, startTime, endTime);
                closeModal('timeSlotModal');
            } catch (error) {
                console.error('Error in time slot form submission:', error);
                showNotification('‚ùå Error adding time slot', 'error');
            }
        };

        // Add time slot to the specified day
        function addTimeSlot(day, startTime, endTime) {
            try {
                console.log('Adding time slot:', { day, startTime, endTime });
                console.log('Current availabilitySlots:', availabilitySlots);
                
                if (!availabilitySlots[day]) {
                    console.error('Day not found in availabilitySlots:', day);
                    availabilitySlots[day] = [];
                }
                
                const slot = {
                    id: Date.now() + Math.random(),
                    day: day,
                    startTime: startTime,
                    endTime: endTime
                };
                
                console.log('Created slot:', slot);
                
                availabilitySlots[day].push(slot);
                console.log('Updated availabilitySlots:', availabilitySlots);
                
                renderTimeSlot(day, slot);
                updateAvailabilityField();
                
                console.log('Time slot added successfully');
            } catch (error) {
                console.error('Error in addTimeSlot:', error);
                showNotification('‚ùå Error adding time slot', 'error');
            }
        }

        // Render a time slot in the UI
        function renderTimeSlot(day, slot) {
            try {
                console.log('Rendering time slot:', { day, slot });
                
                const container = document.getElementById(`slots-${day}`);
                if (!container) {
                    console.error('Container not found for day:', day);
                    return;
                }
                
                // Remove empty message if it exists
                const emptyMessage = container.querySelector('.empty-slot-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
                
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.dataset.slotId = slot.id;
                
                const startTimeFormatted = formatTimeForDisplay(slot.startTime);
                const endTimeFormatted = formatTimeForDisplay(slot.endTime);
                
                slotElement.innerHTML = `
                    <div class="time-slot-info">
                        <div class="time-slot-time">${startTimeFormatted} - ${endTimeFormatted}</div>
                        <div class="time-slot-day">${getDayName(day)}</div>
                    </div>
                    <button type="button" class="remove-slot-btn" onclick="removeTimeSlot('${day}', '${slot.id}')" title="Remove time slot">√ó</button>
                `;
                
                container.appendChild(slotElement);
                console.log('Time slot rendered successfully');
            } catch (error) {
                console.error('Error in renderTimeSlot:', error);
                showNotification('‚ùå Error rendering time slot', 'error');
            }
        }

        // Remove time slot
        window.removeTimeSlot = function(day, slotId) {
            availabilitySlots[day] = availabilitySlots[day].filter(slot => slot.id !== slotId);
            
            const container = document.getElementById(`slots-${day}`);
            const slotElement = container.querySelector(`[data-slot-id="${slotId}"]`);
            if (slotElement) {
                slotElement.remove();
            }
            
            // Show empty message if no slots remain
            if (availabilitySlots[day].length === 0) {
                container.innerHTML = '<div class="empty-slot-message">No time slots added</div>';
            }
            
            updateAvailabilityField();
        };

        // Format time for display (convert 24h to 12h with AM/PM)
        function formatTimeForDisplay(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Get day name
        function getDayName(dayCode) {
            const dayNames = {
                'Sun': 'Sunday',
                'Mon': 'Monday',
                'Tue': 'Tuesday',
                'Wed': 'Wednesday',
                'Thu': 'Thursday',
                'Fri': 'Friday',
                'Sat': 'Saturday'
            };
            return dayNames[dayCode] || dayCode;
        }

        // Update the hidden availability field with formatted data
        function updateAvailabilityField() {
            const availabilityParts = [];
            
            Object.keys(availabilitySlots).forEach(day => {
                availabilitySlots[day].forEach(slot => {
                    availabilityParts.push(`${day} ${slot.startTime}-${slot.endTime}`);
                });
            });
            
            document.getElementById('workerAvailability').value = availabilityParts.join(', ');
        }

        // Load worker availability from existing data
        function loadWorkerAvailability(availabilityText) {
            if (!availabilityText) {
                console.log('No availability text provided');
                return;
            }
            
            console.log('Loading availability:', availabilityText);
            
            // Clear existing slots first
            clearAllAvailabilitySlots();
            
            // Parse the existing availability format: "Mon 09:00-17:00, Tue 10:00-16:00"
            const slots = availabilityText.split(',').map(slot => slot.trim()).filter(slot => slot.length > 0);
            
            console.log('Parsed slots:', slots);
            
            slots.forEach(slot => {
                // More flexible regex to handle various formats
                // This regex will match: "Mon 09:00-17:00", "Monday 9:00-5:00", etc.
                const match = slot.match(/^(\w{3,})\s+(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})$/i);
                if (match) {
                    const [, dayRaw, startHour, startMin, endHour, endMin] = match;
                    
                    // Convert day to 3-letter format
                    const day = convertDayToShort(dayRaw);
                    if (!day) {
                        console.log('Invalid day:', dayRaw);
                        return;
                    }
                    
                    const startTime = `${startHour.padStart(2, '0')}:${startMin}`;
                    const endTime = `${endHour.padStart(2, '0')}:${endMin}`;
                    
                    console.log('Adding slot:', day, startTime, endTime);
                    addTimeSlot(day, startTime, endTime);
                } else {
                    console.log('Could not parse slot:', slot);
                    console.log('Slot format should be: "Day HH:MM-HH:MM"');
                }
            });
        }
        
        // Convert day name to 3-letter format
        function convertDayToShort(dayRaw) {
            const dayMap = {
                'sun': 'Sun', 'sunday': 'Sun',
                'mon': 'Mon', 'monday': 'Mon',
                'tue': 'Tue', 'tuesday': 'Tue',
                'wed': 'Wed', 'wednesday': 'Wed',
                'thu': 'Thu', 'thursday': 'Thu',
                'fri': 'Fri', 'friday': 'Fri',
                'sat': 'Sat', 'saturday': 'Sat'
            };
            
            return dayMap[dayRaw.toLowerCase()];
        }
        
        // Format time to 24-hour format with leading zeros
        function formatTimeTo24Hour(time) {
            // Handle times like "9:00" or "09:00"
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const minute = parseInt(minutes);
            
            // Ensure 24-hour format
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }

        window.deleteWorker = async function(workerId) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }

            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;

            if (!confirm(`Are you sure you want to delete ${worker.first_name} ${worker.last_name}? This cannot be undone.`)) return;

            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId));
                showNotification('‚úÖ Worker deleted successfully!', 'success');
                await loadWorkplaceData();
                displayWorkersInModal();
            } catch (error) {
                console.error('Error deleting worker:', error);
                showNotification('‚ùå Error deleting worker', 'error');
            }
        };

        // Manual submission function for worker form
        window.submitWorkerForm = async function() {
            console.log('Worker form submitted manually');
            
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return false;
            }
            
            const firstName = document.getElementById('workerFirstName').value.trim();
            const lastName = document.getElementById('workerLastName').value.trim();
            const email = document.getElementById('workerEmail').value.trim();
            const workStudy = document.getElementById('workerWorkStudy').value;
            let availability = document.getElementById('workerAvailability').value.trim();
            
            console.log('Form data:', { firstName, lastName, email, workStudy, availability });
            
            // Enhanced validation
            if (!firstName || !lastName) {
                showNotification('‚ùå First and last name are required', 'error');
                return;
            }
            if (!email || !email.includes('@')) {
                showNotification('‚ùå Valid email address is required', 'error');
                return;
            }
            // Check for duplicate email (excluding current worker if editing)
            const duplicateWorker = workers.find(w => 
                w.email.toLowerCase() === email.toLowerCase() && 
                w.id !== editingWorkerId
            );
            if (duplicateWorker) {
                showNotification('‚ùå A worker with this email already exists', 'error');
                return;
            }
            // Validate availability format if provided
            if (availability) {
                // Split and check each block
                const blocks = availability.split(',').map(s => s.trim()).filter(Boolean);
                let errorMsg = '';
                const dayMap = {
                    'sunday': 'Sunday', 'sun': 'Sunday',
                    'monday': 'Monday', 'mon': 'Monday',
                    'tuesday': 'Tuesday', 'tue': 'Tuesday',
                    'wednesday': 'Wednesday', 'wed': 'Wednesday',
                    'thursday': 'Thursday', 'thu': 'Thursday',
                    'friday': 'Friday', 'fri': 'Friday',
                    'saturday': 'Saturday', 'sat': 'Saturday'
                };
                for (const block of blocks) {
                    const match = block.match(/(\w+)\s+(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/i);
                    if (!match) {
                        errorMsg = `Block "${block}" is not in the format Day HH:MM-HH:MM.`;
                        break;
                    }
                    const [, dayRaw, sh, sm, eh, em] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    if (!day) {
                        errorMsg = `Block "${block}" has an invalid day.`;
                        break;
                    }
                    const startHour = parseInt(sh, 10), startMin = parseInt(sm, 10);
                    let endHour = parseInt(eh, 10), endMin = parseInt(em, 10);
                    if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 || startMin < 0 || startMin > 59 || endMin < 0 || endMin > 59) {
                        errorMsg = `Block "${block}" has invalid hour or minute values.`;
                        break;
                    }
                    const startTotal = startHour * 60 + startMin;
                    let endTotal = endHour * 60 + endMin;
                    if (endHour === 0 && endMin === 0) endTotal = 24 * 60; // Treat 00:00 as 24:00
                    if (endTotal <= startTotal) {
                        errorMsg = `Block "${block}": end time must be after start time.`;
                        break;
                    }
                }
                if (errorMsg) {
                    showAvailabilityFormatModal(availability, (newVal) => {
                        document.getElementById('workerAvailability').value = newVal;
                        submitWorkerForm();
                    }, errorMsg);
                    return;
                }
            }
            
            const submitBtn = document.querySelector('#workerForm button[type="button"]');
            setLoading(submitBtn.id || 'submitBtn', true);
            
            const workerData = {
                'First Name': firstName,
                'Last Name': lastName,
                'Email': email,
                'Work Study': workStudy,
                'Days & Times Available': availability,
                'updated_at': new Date().toISOString(),
                'updated_by': user.email
            };
            
            console.log('Saving worker data:', workerData);
            
            try {
                if (editingWorkerId) {
                    await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', editingWorkerId), workerData);
                    showNotification('‚úÖ Worker updated successfully!', 'success');
                } else {
                    workerData.created_at = new Date().toISOString();
                    workerData.created_by = user.email;
                    await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), workerData);
                    showNotification('‚úÖ Worker added successfully!', 'success');
                }
                closeModal('workerFormModal');
                await loadWorkplaceData();
            } catch (error) {
                console.error('Error saving worker:', error);
                showNotification('‚ùå Error saving worker', 'error');
            } finally {
                setLoading(submitBtn.id || 'submitBtn', false);
            }
        };
        // Modal logic for availability format error
        function showAvailabilityFormatModal(lastAttempt, onSuccess, errorMsg) {
            const modal = document.getElementById('availabilityFormatModal');
            const input = document.getElementById('availabilityFormatModalInput');
            const errorDiv = document.getElementById('availabilityFormatModalError');
            input.value = lastAttempt || '';
            errorDiv.textContent = errorMsg || '';
            modal.style.display = 'block';
            input.focus();
            document.getElementById('availabilityFormatModalTryBtn').onclick = function() {
                const val = input.value.trim();
                // Repeat the same validation as above
                const blocks = val.split(',').map(s => s.trim()).filter(Boolean);
                let errorMsg2 = '';
                const dayMap = {
                    'sunday': 'Sunday', 'sun': 'Sunday',
                    'monday': 'Monday', 'mon': 'Monday',
                    'tuesday': 'Tuesday', 'tue': 'Tuesday',
                    'wednesday': 'Wednesday', 'wed': 'Wednesday',
                    'thursday': 'Thursday', 'thu': 'Thursday',
                    'friday': 'Friday', 'fri': 'Friday',
                    'saturday': 'Saturday', 'sat': 'Saturday'
                };
                for (const block of blocks) {
                    const match = block.match(/(\w+)\s+(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/i);
                    if (!match) {
                        errorMsg2 = `Block "${block}" is not in the format Day HH:MM-HH:MM.`;
                        break;
                    }
                    const [, dayRaw, sh, sm, eh, em] = match;
                    const day = dayMap[dayRaw.toLowerCase()];
                    if (!day) {
                        errorMsg2 = `Block "${block}" has an invalid day.`;
                        break;
                    }
                    const startHour = parseInt(sh, 10), startMin = parseInt(sm, 10);
                    let endHour = parseInt(eh, 10), endMin = parseInt(em, 10);
                    if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 || startMin < 0 || startMin > 59 || endMin < 0 || endMin > 59) {
                        errorMsg2 = `Block "${block}" has invalid hour or minute values.`;
                        break;
                    }
                    const startTotal = startHour * 60 + startMin;
                    let endTotal = endHour * 60 + endMin;
                    if (endHour === 0 && endMin === 0) endTotal = 24 * 60; // Treat 00:00 as 24:00
                    if (endTotal <= startTotal) {
                        errorMsg2 = `Block "${block}": end time must be after start time.`;
                        break;
                    }
                }
                if (errorMsg2) {
                    errorDiv.textContent = errorMsg2;
                    input.focus();
                    return;
                }
                modal.style.display = 'none';
                onSuccess(val);
            };
        }

        // Form display functions
        window.showGenerateForm = function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            hideAllForms();
            document.getElementById('generateForm').style.display = 'block';
        };

        window.checkAvailability = function() {
            hideAllForms();
            document.getElementById('availabilityForm').style.display = 'block';
        };

        window.hideAllForms = function() {
            document.querySelectorAll('#scheduleContent .form-section').forEach(form => {
                form.style.display = 'none';
            });
        };

        // Enhanced worker viewing
        window.viewWorkers = function() {
            if (workers.length === 0) {
                let html = `
                    <div class="schedule-display">
                        <h3>üë• Workers for ${selectedWorkplace}</h3>
                        <div class="warning">
                            <strong>No workers found for this workplace.</strong><br>
                            Workers are required to generate schedules and check availability.
                        </div>
                `;
                
                if (user.isAdmin) {
                    html += '<button class="btn btn-success" onclick="showAddWorker()">‚ûï Add First Worker</button>';
                } else {
                    html += '<div class="info">Contact an administrator to add workers.</div>';
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
                return;
            }

            const wsCount = workers.filter(w => w.work_study).length;
            const regularCount = workers.filter(w => !w.work_study).length;
            const workersWithAvailability = workers.filter(w => w.availability_text).length;

            let html = `
                <div class="schedule-display">
                    <h3>üë• Workers for ${selectedWorkplace}</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${workers.length}</div>
                            <div class="stat-label">Total Workers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${wsCount}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regularCount}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workersWithAvailability}</div>
                            <div class="stat-label">With Availability</div>
                        </div>
                    </div>
            `;

            // Show warning if workers don't have availability
            if (workersWithAvailability < workers.length) {
                const missingCount = workers.length - workersWithAvailability;
                html += `
                    <div class="warning">
                        <strong>‚ö†Ô∏è ${missingCount} worker(s) don't have availability set.</strong><br>
                        Workers without availability cannot be scheduled. ${user.isAdmin ? 'Edit workers to add their availability.' : 'Contact an administrator to update worker availability.'}
                    </div>
                `;
            }

            html += `
                <table class="worker-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Work Study</th>
                            <th>Availability Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            workers.forEach(worker => {
                const availabilityStatus = worker.availability_text ? 
                    '‚úÖ Set' : 
                    '<span style="color: #dc3545;">‚ùå Missing</span>';
                    
                html += `
                    <tr>
                        <td><strong>${worker.first_name} ${worker.last_name}</strong></td>
                        <td>${worker.email}</td>
                        <td>${worker.work_study ? '<span style="color: #28a745;">‚úÖ Yes</span>' : '‚ùå No'}</td>
                        <td>${availabilityStatus}</td>
                        <td>
                            <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            ${user.isAdmin ? `<button class="btn btn-warning" onclick="editWorker('${worker.id}')" style="margin-left: 0.5rem;">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="removeWorker('${worker.id}')" style="margin-left: 0.5rem;">üóëÔ∏è Remove</button>` : ''}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            // Admin action buttons
            if (user.isAdmin) {
                html += `
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showAddWorker()">‚ûï Add Worker</button>
                        <button class="btn btn-warning" onclick="showLastMinuteCheck()">üö® Last Minute Check</button>
                        <button class="btn btn-info" onclick="showManageWorkers()">üë• Manage Workers</button>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Enhanced schedule generation with comprehensive validation
        window.generateSchedule = async function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            if (!selectedWorkplace) {
                showNotification('‚ö†Ô∏è Please select a workplace first', 'warning');
                return;
            }
            if (workers.length === 0) {
                showNotification('‚ùå No workers found. Add workers before generating a schedule.', 'error');
                return;
            }
            if (Object.keys(hours).length === 0) {
                showNotification('‚ùå No operating hours configured. Set up hours of operation first.', 'error');
                return;
            }
            // Validate worker availability
            const workersWithAvailability = workers.filter(w => w.availability_text && Object.keys(w.availability).length > 0);
            if (workersWithAvailability.length === 0) {
                showNotification('‚ùå No workers have availability set. Add worker availability before generating schedules.', 'error');
                return;
            }
            const maxHours = parseInt(document.getElementById('maxHours').value);
            const workersPerShift = parseInt(document.getElementById('workersPerShift').value);
            const minHours = parseInt(document.getElementById('minHours').value);
            const ensureFullCoverage = document.getElementById('ensureFullCoverage').checked;
            // Validation
            if (maxHours < 5 || maxHours > 40) {
                showNotification('‚ùå Max hours must be between 5 and 40', 'error');
                return;
            }
            if (workersPerShift < 1 || workersPerShift > 5) {
                showNotification('‚ùå Workers per shift must be between 1 and 5', 'error');
                return;
            }
            setLoading('generateScheduleBtn', true);
            document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">üîÑ Generating optimized schedule...</div>';
            try {
                // Always use the best/fair logic: shuffle, prioritize work study, fair distribution
                let processedWorkers = shuffleArray([...workersWithAvailability]);
                processedWorkers.sort((a, b) => {
                    if (a.work_study && !b.work_study) return -1;
                    if (!a.work_study && b.work_study) return 1;
                    return calculateAvailabilityHours(a) - calculateAvailabilityHours(b);
                });
                // Generate schedule
                const result = createShiftsFromAvailability(
                    hours, 
                    processedWorkers,
                    maxHours,
                    workersPerShift,
                    minHours,
                    ensureFullCoverage
                );
                const {
                    schedule: generatedSchedule,
                    assignedHours,
                    lowHours,
                    unassigned,
                    altSols,
                    unfilledShifts,
                    wsIssues,
                    minHoursIssues,
                    coverageGaps,
                    forcedAssignments
                } = result;
                
                // PRODUCTION-READY: Enhanced schedule validation
                if (Object.keys(generatedSchedule).length === 0) {
                    console.error('üö® PRODUCTION: Schedule generation failed - no schedule was created');
                    document.getElementById('scheduleDisplay').innerHTML = '<div class="error">‚ùå Schedule generation failed. Check the console for details.</div>';
                    showNotification('‚ùå Schedule generation failed - check worker availability and operating hours', 'error');
                    setLoading('generateScheduleBtn', false);
                    return;
                }
                
                // Check for production issues
                if (result.productionIssues && result.productionIssues.length > 0) {
                    console.warn('‚ö†Ô∏è PRODUCTION: Schedule generated with issues:', result.productionIssues);
                    showNotification(`‚ö†Ô∏è Schedule generated with ${result.productionIssues.length} issues - review carefully`, 'warning');
                }
                
                // Log validation summary
                if (result.validationSummary) {
                    console.log('üìä PRODUCTION: Final validation summary:', result.validationSummary);
                }
                
                // Validate all shifts before saving
                for (const day of DAYS) {
                    for (const shift of (generatedSchedule[day] || [])) {
                        if (!validateShift(shift)) {
                            setLoading('generateScheduleBtn', false);
                            return;
                        }
                    }
                }
                
                schedule = generatedSchedule;
                
                // CRITICAL FIX: Only save if schedule is valid
                try {
                    await saveSchedule(schedule, 'default', {
                        maxHours,
                        workersPerShift,
                        minHours,
                        ensureFullCoverage,
                        workersCount: processedWorkers.length
                    });
                } catch (error) {
                    console.error('Failed to save schedule:', error);
                    showNotification('‚ùå Failed to save schedule to database', 'error');
                    setLoading('generateScheduleBtn', false);
                    return;
                }
                if (unfilledShifts.length > 0 || wsIssues.length > 0 || minHoursIssues.length > 0 || coverageGaps.length > 0) {
                    showEnhancedIssuesDialog({
                        unfilledShifts,
                        wsIssues,
                        minHoursIssues,
                        coverageGaps,
                        altSols,
                        forcedAssignments
                    });
                }
                displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, false, coverageGaps);
                hideAllForms();
                showNotification('‚úÖ Schedule generated successfully! Use "Schedule History" to set it as current for workers.', 'success');
            } catch (error) {
                console.error('Error generating schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = `<div class="error">‚ùå Error generating schedule: ${error.message}</div>`;
                showNotification('‚ùå Failed to generate schedule', 'error');
            } finally {
                setLoading('generateScheduleBtn', false);
            }
        };

        // Enhanced schedule saving with metadata
        async function saveSchedule(schedule, variation, metadata = {}) {
            try {
                const scheduleData = {
                    days: schedule,
                    createdAt: new Date().toISOString(),
                    workplaceId: selectedWorkplace,
                    name: `${selectedWorkplace} Schedule ${new Date().toLocaleDateString()}`,
                    variation: variation,
                    generatedBy: user.email,
                    isCurrent: false, // New schedules are not automatically set as current
                    metadata: {
                        ...metadata,
                        version: '2.0',
                        totalShifts: Object.values(schedule).flat().length,
                        workersUsed: Object.values(schedule).flat()
                            .map(s => s.raw_assigned || [])
                            .flat()
                            .filter((email, index, arr) => arr.indexOf(email) === index).length
                    }
                };
                
                const docRef = await addDoc(collection(db, 'workplaces', selectedWorkplace, 'schedules'), scheduleData);
                currentScheduleId = docRef.id; // Set the current schedule ID to the newly created document
                console.log('Enhanced schedule saved to Firebase with ID:', currentScheduleId);
                return docRef.id;
            } catch (error) {
                console.error('Error saving schedule:', error);
                throw error;
            }
        }

        // Enhanced issues dialog with coverage gaps
        function showEnhancedIssuesDialog(issues) {
            const { unfilledShifts, wsIssues, minHoursIssues, coverageGaps, altSols, forcedAssignments } = issues;
            
            let html = '<div class="modal-content"><div class="modal-header"><h3>‚ö†Ô∏è Schedule Analysis & Issues</h3><span class="close" onclick="closeIssuesDialog()">&times;</span></div>';
            
            // Coverage gaps (critical)
            if (coverageGaps && coverageGaps.length > 0) {
                html += '<div class="error"><h4>üö® Critical Coverage Gaps:</h4><ul>';
                coverageGaps.forEach(gap => {
                    html += `<li><strong>${gap.day}</strong> ${formatTime(gap.start)} - ${formatTime(gap.end)} (${gap.duration.toFixed(1)} hours uncovered)</li>`;
                });
                html += '</ul><p><strong>Action needed:</strong> These time periods have no worker coverage during operating hours.</p></div>';
            }
            
            // Forced assignments section
            if (forcedAssignments && forcedAssignments.length > 0) {
                html += '<div class="error"><h4>‚ùó Forced Assignments (Closest Worker Assigned):</h4><ul>';
                forcedAssignments.forEach(fa => {
                    html += `<li><strong>${fa.day}</strong> ${formatTime(fa.start)} - ${formatTime(fa.end)}: ${fa.worker} <span style=\"color:#e53935;font-weight:bold;\">(FORCED)</span></li>`;
                });
                html += '</ul><p><strong>Warning:</strong> These shifts were filled by assigning the closest available worker (least hours, prioritized for fairness). Please review these assignments as they may not match worker preferences or may be less ideal.</p></div>';
            }
            
            // Work study issues
            if (wsIssues.length > 0) {
                html += '<div class="warning"><h4>üéì Work Study Issues:</h4><ul>';
                wsIssues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul><p><strong>Note:</strong> Work study students must have exactly 5 hours per week.</p></div>';
            }
            
            // Low hours issues
            if (minHoursIssues.length > 0) {
                html += '<div class="warning"><h4>‚è∞ Workers with Insufficient Hours:</h4><ul>';
                minHoursIssues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Unfilled shifts
            if (unfilledShifts.length > 0) {
                html += '<div class="error"><h4>‚ùå Unfilled Shifts:</h4><ul>';
                unfilledShifts.forEach(shift => {
                    const key = `${shift.day} ${shift.start}-${shift.end}`;
                    html += `<li><strong>${key}</strong>`;
                    if (altSols[key] && altSols[key].length > 0) {
                        html += ` - <em>Potential alternatives:</em> ${altSols[key].join(', ')}`;
                    } else {
                        html += ' - <em>No available alternatives found</em>';
                    }
                    html += '</li>';
                });
                html += '</ul></div>';
            }
            
            // Success message if no major issues
            if (!coverageGaps?.length && !unfilledShifts.length && !wsIssues.length) {
                html += '<div class="success"><h4>‚úÖ Schedule Quality: Excellent</h4><p>No critical issues found. The schedule provides complete coverage with proper work study allocation.</p></div>';
            }
            
            html += '<div style="margin-top: 1rem;"><button class="btn btn-secondary" onclick="closeIssuesDialog()">Close Analysis</button></div></div>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.id = 'issuesModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            window.closeIssuesDialog = function() {
                document.body.removeChild(modal);
                delete window.closeIssuesDialog;
            };
        }

        // Enhanced schedule display with coverage analysis and real-time updates
        function displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, isCurrent = false, coverageGaps = []) {
            // Update the global schedule variable for real-time analysis
            window.currentSchedule = schedule;
            window.currentAssignedHours = assignedHours;
            
            // Store analysis data for real-time updates
            window.scheduleAnalysisData = {
                coverageGaps,
                lowHours,
                unassigned,
                isCurrent
            };
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledShifts = Object.values(schedule).flat().filter(s => s.assigned.includes('Unfilled') || s.assigned.includes('COVERAGE GAP')).length;
            const filledShifts = totalShifts - unfilledShifts;
            const coveragePercentage = totalShifts > 0 ? ((filledShifts / totalShifts) * 100).toFixed(1) : 0;
            const multipleWorkerShifts = Object.values(schedule).flat().filter(s => s.assigned.length > 1).length;
            
            let html = '<div class="schedule-display">';
            
            // Print header for print view
            html += '<div class="print-only"><h2>üìÖ Schedule for ' + selectedWorkplace.replace('_', ' ').toUpperCase() + '</h2><p>Generated: ' + new Date().toLocaleDateString() + '</p></div>';
            
            if (isCurrent) {
                html += '<div class="success">‚úÖ This is the current active schedule that workers can see</div>';
            } else {
                html += '<div class="info">‚ÑπÔ∏è This is a historical schedule. Use "Schedule History" to set a schedule as current for workers.</div>';
            }
            
            // Enhanced stats
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card" style="background: ${coveragePercentage >= 90 ? '#28a745' : coveragePercentage >= 75 ? '#ffc107' : '#dc3545'};">
                        <div class="stat-number">${coveragePercentage}%</div>
                        <div class="stat-label">Coverage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(assignedHours).length}</div>
                        <div class="stat-label">Workers Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${coverageGaps.length}</div>
                        <div class="stat-label">Coverage Gaps</div>
                    </div>
                    <div class="stat-card" style="background: #007bff;">
                        <div class="stat-number">${multipleWorkerShifts}</div>
                        <div class="stat-label">Team Shifts</div>
                    </div>
                </div>
            `;
            
            // Show critical warnings
            if (coverageGaps.length > 0) {
                html += `<div class="error"><strong>üö® ${coverageGaps.length} Critical Coverage Gap(s) Found!</strong><br>Some operating hours have no worker assigned. Check the schedule analysis for details.</div>`;
            }
            
            if (lowHours.length > 0) {
                html += `<div class="warning"><strong>Workers with less than minimum hours:</strong> ${lowHours.join(', ')}</div>`;
            }
            if (unassigned.length > 0) {
                html += `<div class="error"><strong>Workers with no hours:</strong> ${unassigned.join(', ')}</div>`;
            }
            
            // Display schedule by day with enhanced shift marking
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                html += `<div class="day-header">${day}</div>`;
                shifts.forEach((shift, index) => {
                    const unfilled = shift.assigned.includes('Unfilled');
                    const isGap = shift.assigned.includes('COVERAGE GAP') || shift.isGap;
                    const workStudy = shift.is_work_study || false;
                    const isForced = shift.forced === true;
                    
                    let shiftClass = 'shift';
                    if (isGap) shiftClass += ' coverage-gap';
                    else if (unfilled) shiftClass += ' unfilled';
                    else if (workStudy) shiftClass += ' work-study';
                    if (isForced) shiftClass += ' forced-shift';
                    if (shift.assigned.length > 1) shiftClass += ' multiple-workers';
                    
                    html += `
                        <div class="${shiftClass}">
                            <div>
                                <strong>${formatTime(shift.start)} - ${formatTime(shift.end)}</strong>
                                ${workStudy ? '<span style="color: #ffc107; margin-left: 0.5rem;">(Work Study)</span>' : ''}
                                ${isGap ? '<span style="color: #ff5722; margin-left: 0.5rem;">(CRITICAL GAP)</span>' : ''}
                                ${isForced ? '<span style="color: #e53935; margin-left: 0.5rem; font-weight: bold;">(FORCED)</span>' : ''}
                                <div style="margin-top: 0.25rem; font-size: 0.9rem;">
                                    ${shift.assigned.length > 1 ? 
                                        `<span style="color: #007bff; font-weight: 600;">üë• ${shift.assigned.length} Workers:</span> ${shift.assigned.join(', ')}` :
                                        shift.assigned.join(', ')
                                    }
                                </div>
                            </div>
                            ${user.isAdmin ? `
                            <div class="shift-actions no-print">
                                <button class="btn btn-warning" onclick="editShift('${day}', ${index})">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="removeShift('${day}', ${index})">üóëÔ∏è Remove</button>
                                ${(unfilled || isGap) ? '<button class="btn btn-info" onclick="suggestAlternatives(\'' + day + '\', ' + index + ')">üí° Fix</button>' : ''}
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            });
            
            // Enhanced worker hours summary
            html += '<div style="margin-top: 2rem;"><h4>üìä Worker Hours Summary</h4>';
            html += '<table class="worker-table"><thead><tr><th>Worker</th><th>Hours Assigned</th><th>Status</th><th class="no-print">Actions</th></tr></thead><tbody>';
            
            const sortedWorkers = Object.entries(assignedHours).sort((a, b) => b[1] - a[1]);
            
            workers.forEach(w => {
                if (!(w.email in assignedHours)) {
                    sortedWorkers.push([w.email, 0]);
                }
            });
            
            sortedWorkers.forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (!worker) return;
                
                const name = `${worker.first_name} ${worker.last_name}`;
                const isWS = worker.work_study;
                let status = '‚úÖ Good';
                let statusColor = 'color: #28a745;';
                
                if (isWS && Math.abs(hours - 5) > 0.1) {
                    status = `‚ùå WS Issue (${hours.toFixed(1)}h/5h)`;
                    statusColor = 'color: #dc3545;';
                } else if (!isWS && hours < 3 && hours > 0) {
                    status = '‚ö†Ô∏è Low Hours';
                    statusColor = 'color: #ffc107;';
                } else if (hours === 0) {
                    status = '‚ùå Unassigned';
                    statusColor = 'color: #dc3545;';
                } else if (isWS && hours === 5) {
                    status = '‚úÖ Perfect (WS)';
                    statusColor = 'color: #28a745;';
                }
                
                html += `
                    <tr>
                        <td><strong>${name}</strong> ${isWS ? '<small style="color: #ffc107;">(WS)</small>' : ''}</td>
                        <td>${hours.toFixed(1)} hours</td>
                        <td style="${statusColor}">${status}</td>
                        <td class="no-print"><button class="btn btn-primary" onclick="contactWorker('${email}')">üìß Contact</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // Action buttons (admin vs user)
            if (user.isAdmin) {
                html += `
                    <div class="no-print" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="addNewShift()">‚ûï Add Shift</button>
                        <button class="btn btn-info" onclick="emailSchedule()">üìß Email Schedule</button>
                        <button class="btn btn-secondary" onclick="printSchedule()">üñ®Ô∏è Print Schedule</button>
                        <button class="btn btn-warning" onclick="exportScheduleToExcel()">üì§ Export Excel</button>
                        <button class="btn btn-info" onclick="analyzeSchedule()">üìä Detailed Analysis</button>
                    </div>
                `;
            } else {
                html += `
                    <div class="no-print" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="printSchedule()">üñ®Ô∏è Print Schedule</button>
                        <button class="btn btn-info" onclick="emailSchedule()">üìß Email Schedule</button>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
        }

        // Enhanced utility functions - Email, Export, Print, Analysis
        window.emailSchedule = function() {
            const scheduleElement = document.querySelector('.schedule-display');
            if (!scheduleElement) {
                showNotification('‚ùå No schedule to email', 'error');
                return;
            }

            // Generate email content
            let emailBody = `Schedule for ${selectedWorkplace.replace('_', ' ').toUpperCase()}\n`;
            emailBody += `Generated: ${new Date().toLocaleDateString()}\n`;
            emailBody += `Generated by: ${user.email}\n\n`;
            
            // Add schedule by day
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                if (shifts.length === 0) return;
                
                emailBody += `${day}:\n`;
                shifts.forEach(shift => {
                    const timeRange = `${formatTime(shift.start)} - ${formatTime(shift.end)}`;
                    const workers = shift.assigned.join(', ');
                    emailBody += `  ${timeRange}: ${workers}\n`;
                });
                emailBody += '\n';
            });
            
            // Add worker summary
            emailBody += 'Worker Hours Summary:\n';
            const assignedHours = calculateAssignedHours(schedule);
            Object.entries(assignedHours).forEach(([email, hours]) => {
                const worker = workers.find(w => w.email === email);
                if (worker) {
                    emailBody += `  ${worker.first_name} ${worker.last_name}: ${hours.toFixed(1)} hours\n`;
                }
            });

            const subject = `Work Schedule - ${selectedWorkplace.replace('_', ' ')} - ${new Date().toLocaleDateString()}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            window.open(mailtoLink);
            showNotification('üìß Email client opened with schedule', 'success');
        };

        window.exportScheduleToExcel = function() {
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('‚ùå No schedule to export', 'error');
                return;
            }

            // Create CSV content
            let csvContent = 'Day,Start Time,End Time,Worker(s),Work Study,Duration\n';
            
            DAYS.forEach(day => {
                const shifts = schedule[day] || [];
                shifts.forEach(shift => {
                    const startTime = formatTime(shift.start);
                    const endTime = formatTime(shift.end);
                    const workers = shift.assigned.join(' & ');
                    const isWorkStudy = shift.is_work_study ? 'Yes' : 'No';
                    const duration = (timeToHour(shift.end) - timeToHour(shift.start)).toFixed(1);
                    
                    csvContent += `"${day}","${startTime}","${endTime}","${workers}","${isWorkStudy}","${duration}"\n`;
                });
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${selectedWorkplace}_schedule_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üìÑ Schedule exported to CSV file', 'success');
        };

        window.printSchedule = function() {
            // Add print-specific styles
            const printStyle = document.createElement('style');
            printStyle.textContent = `
                @media print {
                    body * { visibility: hidden; }
                    .schedule-display, .schedule-display * { visibility: visible; }
                    .schedule-display { position: absolute; left: 0; top: 0; width: 100%; }
                    .no-print { display: none !important; }
                    .print-only { display: block !important; }
                }
            `;
            document.head.appendChild(printStyle);
            
            window.print();
            
            // Remove print styles after printing
            setTimeout(() => {
                document.head.removeChild(printStyle);
            }, 1000);
        };

        window.analyzeSchedule = function() {
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('‚ùå No schedule to analyze', 'error');
                return;
            }

            const assignedHours = calculateAssignedHours(schedule);
            const totalShifts = Object.values(schedule).flat().length;
            const unfilledCount = Object.values(schedule).flat().filter(s => 
                s.assigned.includes('Unfilled') || s.assigned.includes('COVERAGE GAP')
            ).length;
            
            // Calculate metrics
            const coverage = ((totalShifts - unfilledCount) / totalShifts * 100).toFixed(1);
            const avgHoursPerWorker = Object.values(assignedHours).length > 0 ? 
                (Object.values(assignedHours).reduce((a, b) => a + b, 0) / Object.values(assignedHours).length).toFixed(1) : 0;
            
            const wsWorkers = workers.filter(w => w.work_study);
            const wsWithCorrectHours = wsWorkers.filter(w => Math.abs(assignedHours[w.email] - 5) < 0.1).length;
            const wsCompliance = wsWorkers.length > 0 ? (wsWithCorrectHours / wsWorkers.length * 100).toFixed(1) : 100;

            // Enhanced validation and error detection
            const { coverageGaps } = validateScheduleCoverage(schedule, hours);
            const wsIssues = wsWorkers
                .filter(w => Math.abs(assignedHours[w.email] - 5) > 0.1)
                .map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`);
            
            const lowHoursWorkers = workers
                .filter(w => !w.work_study && assignedHours[w.email] < 3)
                .map(w => `${w.first_name} ${w.last_name} (${assignedHours[w.email].toFixed(1)}h)`);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>üìä Schedule Analysis</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div style="padding: 1rem;">
                        <h4>Coverage Metrics</h4>
                        <div class="stats" style="margin-bottom: 1.5rem;">
                            <div class="stat-card">
                                <div class="stat-number">${coverage}%</div>
                                <div class="stat-label">Coverage Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${avgHoursPerWorker}</div>
                                <div class="stat-label">Avg Hours/Worker</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${wsCompliance}%</div>
                                <div class="stat-label">WS Compliance</div>
                            </div>
                        </div>
                        
                        ${coverageGaps.length > 0 ? `
                        <div class="error" style="background: #ffebee; border: 1px solid #ffcdd2; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="color: #d32f2f; margin: 0 0 0.5rem 0;">üö® Critical Coverage Gaps</h4>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${coverageGaps.map(gap => 
                                    `<li><strong>${gap.day}</strong> ${formatTime(gap.start)} - ${formatTime(gap.end)} (${gap.duration.toFixed(1)} hours uncovered)</li>`
                                ).join('')}
                            </ul>
                            <p style="margin: 0.5rem 0 0 0; font-weight: 600; color: #d32f2f;">Action needed: These time periods have no worker coverage during operating hours.</p>
                        </div>
                        ` : ''}
                        
                        ${wsIssues.length > 0 ? `
                        <div class="warning" style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="color: #f57c00; margin: 0 0 0.5rem 0;">üéì Work Study Issues</h4>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${wsIssues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                            <p style="margin: 0.5rem 0 0 0; font-weight: 600; color: #f57c00;">Note: Work study students must have exactly 5 hours per week.</p>
                        </div>
                        ` : ''}
                        
                        ${lowHoursWorkers.length > 0 ? `
                        <div class="warning" style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="color: #f57c00; margin: 0 0 0.5rem 0;">‚è∞ Workers with Insufficient Hours</h4>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${lowHoursWorkers.map(worker => `<li>${worker}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        <h4>Overall Assessment</h4>
                        <div style="background: ${coverage >= 90 && wsCompliance == 100 && coverageGaps.length == 0 && wsIssues.length == 0 && lowHoursWorkers.length == 0 ? '#e8f5e8' : '#fff3e0'}; border: 1px solid ${coverage >= 90 && wsCompliance == 100 && coverageGaps.length == 0 && wsIssues.length == 0 && lowHoursWorkers.length == 0 ? '#4caf50' : '#ffcc02'}; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            ${coverage >= 90 && wsCompliance == 100 && coverageGaps.length == 0 && wsIssues.length == 0 && lowHoursWorkers.length == 0 ? 
                                '<p style="margin: 0; color: #2e7d32; font-weight: 600;">‚úÖ Excellent: Schedule meets all requirements!</p>' :
                                '<p style="margin: 0; color: #f57c00; font-weight: 600;">‚ö†Ô∏è Schedule needs attention. Review the issues above.</p>'
                            }
                        </div>
                        
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Real-time analysis update function
        window.updateScheduleAnalysis = function() {
            // Check if analysis modal is currently open
            const existingModal = document.querySelector('.modal');
            if (existingModal && existingModal.querySelector('h3')?.textContent.includes('Schedule Analysis')) {
                // Close the existing modal and reopen with updated data
                existingModal.remove();
                setTimeout(() => analyzeSchedule(), 100);
            }
        };

        // Enhanced current schedule viewing
        window.viewCurrentSchedule = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading current schedule...</div>';
                
                // First try to find a schedule marked as current
                const currentSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    where('isCurrent', '==', true)
                ));
                
                let currentDoc = null;
                if (!currentSnapshot.empty) {
                    currentDoc = currentSnapshot.docs[0];
                } else {
                    // Fallback to most recent schedule if no current is set
                    const snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        orderBy('createdAt', 'desc')
                    ));
                    
                    if (!snapshot.empty) {
                        currentDoc = snapshot.docs[0];
                    }
                }
                
                if (currentDoc) {
                    currentScheduleId = currentDoc.id; // <-- Track the ID
                    const scheduleData = currentDoc.data();
                    schedule = scheduleData.days;
                    
                    const assignedHours = calculateAssignedHours(schedule);
                    const lowHours = workers
                        .filter(w => !w.work_study && assignedHours[w.email] < 4)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    const unassigned = workers
                        .filter(w => assignedHours[w.email] === 0)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    
                    const { coverageGaps } = validateScheduleCoverage(schedule, hours);
                    displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, true, coverageGaps);
                } else {
                    document.getElementById('scheduleDisplay').innerHTML = `
                        <div class="schedule-display">
                            <div class="warning">
                                <h3>üìÖ No Current Schedule Found</h3>
                                <p>No schedules have been generated for this workplace yet.</p>
                                ${user.isAdmin ? '<button class="btn btn-primary" onclick="showGenerateForm()">üìÖ Generate First Schedule</button>' : '<p>Contact an administrator to generate a schedule.</p>'}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading current schedule:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">‚ùå Error loading schedule. Please try again.</div>';
            }
        };

        // Enhanced time conversion validation
        function validateTimeConversion(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') {
                console.error('Invalid time string:', timeStr);
                return false;
            }
            
            const timeRegex = /^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/;
            if (!timeRegex.test(timeStr)) {
                console.error('Invalid time format:', timeStr);
                return false;
            }
            
            return true;
        }
        
        // Calculate assigned hours helper - FIXED VERSION
        function calculateAssignedHours(schedule) {
            const assignedHours = {};
            
            // Initialize all workers with 0 hours
            workers.forEach(w => {
                assignedHours[w.email] = 0;
            });
            
            // Calculate hours from schedule with proper validation
            Object.values(schedule).forEach(shifts => {
                shifts.forEach(shift => {
                    // Skip invalid shifts
                    if (!shift.start || !shift.end || !shift.raw_assigned) {
                        console.warn('Skipping invalid shift:', shift);
                        return;
                    }
                    
                    // Validate time strings before conversion
                    if (!validateTimeConversion(shift.start) || !validateTimeConversion(shift.end)) {
                        console.error('Invalid time format in shift:', shift);
                        return;
                    }
                    
                    // Calculate duration with proper time handling
                    let startHour = timeToHour(shift.start);
                    let endHour = timeToHour(shift.end);
                    
                    // Handle overnight shifts properly
                    if (endHour <= startHour) {
                        endHour += 24;
                    }
                    
                    const duration = endHour - startHour;
                    
                    // Validate duration
                    if (duration <= 0 || duration > 24) {
                        console.error('Invalid shift duration:', duration, 'for shift:', shift);
                        return;
                    }
                    
                    // Add hours to each assigned worker
                    shift.raw_assigned.forEach(email => {
                        if (assignedHours.hasOwnProperty(email)) {
                            assignedHours[email] += duration;
                        } else {
                            console.warn('Worker email not found in assignedHours:', email);
                        }
                    });
                });
            });
            
            // Validate final hours
            Object.entries(assignedHours).forEach(([email, hours]) => {
                if (hours < 0) {
                    console.error('CRITICAL: Negative hours detected for', email, ':', hours);
                    assignedHours[email] = 0; // Reset to 0 to prevent negative display
                }
                if (hours > 40) {
                    console.warn('Excessive hours detected for', email, ':', hours);
                }
            });
            
            return assignedHours;
        }

        // Enhanced history viewing
        window.viewHistory = async function() {
            try {
                document.getElementById('scheduleDisplay').innerHTML = '<div class="loading">Loading schedule history...</div>';
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc')
                ));
                
                let html = '<div class="schedule-display"><h3>üìö Schedule History</h3>';
                
                if (snapshot.empty) {
                    html += `
                        <div class="info">
                            <h4>No Schedules Found</h4>
                            <p>No schedules have been generated for this workplace yet.</p>
                            ${user.isAdmin ? '<button class="btn btn-primary" onclick="showGenerateForm()">üìÖ Generate First Schedule</button>' : ''}
                        </div>
                    `;
                } else {
                    html += `<div class="info">Found ${snapshot.size} schedule(s)</div>`;
                    
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = new Date(data.createdAt).toLocaleDateString();
                        const time = new Date(data.createdAt).toLocaleTimeString();
                        const totalShifts = data.metadata?.totalShifts || 'Unknown';
                        const workersUsed = data.metadata?.workersUsed || 'Unknown';
                        
                        const actionButtons = user.isAdmin ? `
                            <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">üëÅÔ∏è View</button>
                            <button class="btn btn-success" onclick="setAsCurrentSchedule('${doc.id}')" ${data.isCurrent ? 'disabled' : ''}>${data.isCurrent ? '‚úÖ Current' : 'üéØ Set as Current'}</button>
                            <button class="btn btn-danger" onclick="deleteSchedule('${doc.id}')">üóëÔ∏è Delete</button>
                        ` : `
                            <button class="btn btn-secondary" onclick="viewScheduleById('${doc.id}')">üëÅÔ∏è View</button>
                        `;
                        
                        html += `
                            <div style="padding: 1rem; border: 1px solid #dee2e6; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${data.name || 'Schedule'}</strong>
                                    ${data.isCurrent ? '<span style="color: #28a745; font-weight: bold;"> (Current)</span>' : ''}<br>
                                    <small>üìÖ ${date} at ${time} | üë§ ${data.generatedBy || 'Unknown'}</small><br>
                                    <small>üìä ${totalShifts} shifts | üë• ${workersUsed} workers | üîÑ ${data.variation || 'balanced'}</small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    ${actionButtons}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                document.getElementById('scheduleDisplay').innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('scheduleDisplay').innerHTML = '<div class="error">‚ùå Error loading schedule history.</div>';
            }
        };

        // View schedule by ID
        window.viewScheduleById = async function(scheduleId) {
            try {
                const docSnap = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                if (docSnap.exists()) {
                    currentScheduleId = docSnap.id; // <-- Track the ID
                    const scheduleData = docSnap.data();
                    schedule = scheduleData.days;
                    
                    const assignedHours = calculateAssignedHours(schedule);
                    const lowHours = workers
                        .filter(w => !w.work_study && assignedHours[w.email] < 4)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    const unassigned = workers
                        .filter(w => assignedHours[w.email] === 0)
                        .map(w => `${w.first_name} ${w.last_name}`);
                    
                    const { coverageGaps } = validateScheduleCoverage(schedule, hours);
                    displayEnhancedSchedule(schedule, assignedHours, lowHours, unassigned, scheduleData.isCurrent || false, coverageGaps);
                }
            } catch (error) {
                console.error('Error viewing schedule:', error);
                showNotification('‚ùå Error loading schedule', 'error');
            }
        };

        // Delete schedule (admin only)
        window.deleteSchedule = async function(scheduleId) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            
            if (confirm('Delete this schedule? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId));
                    showNotification('‚úÖ Schedule deleted', 'success');
                    viewHistory();
                } catch (error) {
                    console.error('Error deleting schedule:', error);
                    showNotification('‚ùå Error deleting schedule', 'error');
                }
            }
        };

        // Set schedule as current (admin only)
        window.setAsCurrentSchedule = async function(scheduleId) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            
            if (confirm('Set this schedule as the current schedule for workers? This will replace any existing current schedule.')) {
                try {
                    // First, unset any existing current schedules
                    const existingCurrentSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        where('isCurrent', '==', true)
                    ));
                    
                    const batch = [];
                    existingCurrentSnapshot.forEach(doc => {
                        batch.push(updateDoc(doc.ref, { isCurrent: false }));
                    });
                    
                    // Set the new schedule as current
                    batch.push(updateDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleId), {
                        isCurrent: true,
                        setAsCurrentAt: new Date().toISOString(),
                        setAsCurrentBy: user.email
                    }));
                    
                    await Promise.all(batch);
                    
                    showNotification('‚úÖ Schedule set as current successfully!', 'success');
                    viewHistory(); // Refresh the history view
                } catch (error) {
                    console.error('Error setting schedule as current:', error);
                    showNotification('‚ùå Error setting schedule as current', 'error');
                }
            }
        };

        // Enhanced availability checking
        window.findAvailable = function() {
            const day = document.getElementById('availDay').value;
            const start = document.getElementById('availStart').value;
            const end = document.getElementById('availEnd').value;
            
            if (!start || !end) {
                showNotification('‚ö†Ô∏è Please enter both start and end times', 'warning');
                return;
            }
            
            const startHour = timeToHour(start);
            const endHour = timeToHour(end);
            
            // Handle overnight shifts properly (when end time is midnight or earlier than start time)
            if (endHour <= startHour && endHour !== 0) {
                showNotification('‚ùå End time must be after start time', 'error');
                return;
            }
            
            // For overnight shifts (end time is midnight), we need to add 24 hours to end time for comparison
            const adjustedEndHour = endHour === 0 ? 24 : endHour;
            if (adjustedEndHour <= startHour) {
                showNotification('‚ùå End time must be after start time', 'error');
                return;
            }
            
            const available = workers.filter(worker => {
                return isWorkerAvailable(worker, day, startHour, endHour);
            });
            
            const workStudy = available.filter(w => w.work_study);
            const regular = available.filter(w => !w.work_study);
            
            let html = `
                <div class="schedule-display">
                    <h3>üîç Available Workers</h3>
                    <div class="info">
                        <strong>Search Criteria:</strong> ${day} ${formatTime(start)} - ${formatTime(end)}<br>
                        <strong>Duration:</strong> ${(endHour - startHour).toFixed(1)} hours
                    </div>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${available.length}</div>
                            <div class="stat-label">Total Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${workStudy.length}</div>
                            <div class="stat-label">Work Study</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${regular.length}</div>
                            <div class="stat-label">Regular Workers</div>
                        </div>
                    </div>
            `;
            
            if (available.length === 0) {
                html += '<div class="warning">‚ùå No workers are available during this time period.</div>';
            } else {
                if (workStudy.length > 0) {
                    html += '<h4>üéì Available Work Study Students</h4>';
                    workStudy.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #28a745; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>üìß ${worker.email}</small>
                                </div>
                                <button class="btn btn-success" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
                
                if (regular.length > 0) {
                    html += '<h4>üë• Available Regular Workers</h4>';
                    regular.forEach(worker => {
                        html += `
                            <div style="padding: 0.75rem; border: 1px solid #007bff; margin-bottom: 0.5rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${worker.first_name} ${worker.last_name}</strong><br>
                                    <small>üìß ${worker.email}</small>
                                </div>
                                <button class="btn btn-primary" onclick="contactWorker('${worker.email}')">üìß Contact</button>
                            </div>
                        `;
                    });
                }
            }
            
            html += '</div>';
            document.getElementById('scheduleDisplay').innerHTML = html;
            hideAllForms();
        };

        // Enhanced contact worker function
        window.contactWorker = function(email) {
            const subject = `Work Schedule - ${selectedWorkplace.replace('_', ' ')}`;
            const body = `Hello!\n\nI'm reaching out regarding the work schedule for ${selectedWorkplace.replace('_', ' ')}.\n\nBest regards,\n${user.email}`;
            window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        };

        // Placeholder implementations for remaining features
        window.showLastMinuteCheck = function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            showNotification('üö® Last minute check feature - Enhanced implementation coming soon!', 'info');
        };

        window.addNewShift = function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            
            // Build day options
            let dayOptions = DAYS.map(day => `<option value='${day}'>${day}</option>`).join('');
            
            // Clean, professional HTML layout
            let html = `
                <div class="add-shift-container">
                    <div class="add-shift-form">
                        <div class='form-group'>
                            <label><strong>Day</strong></label>
                            <select id='addShiftDay' class='form-control'>
                                <option value=''>Select Day</option>${dayOptions}
                            </select>
                        </div>
                        <div class='form-group'>
                            <label><strong>Start Time</strong></label>
                            <input type='time' id='addShiftStart' class='form-control'>
                        </div>
                        <div class='form-group'>
                            <label><strong>End Time</strong></label>
                            <input type='time' id='addShiftEnd' class='form-control'>
                        </div>
                        <div class='form-group'>
                            <label class="checkbox-label">
                                <input type='checkbox' id='addShiftShowUnavailable' checked> 
                                <strong>Show unavailable workers</strong>
                            </label>
                        </div>
                        <div class="form-actions">
                            <button class='btn btn-success' id='saveAddShiftBtn'>Add Shift</button> 
                            <button class='btn btn-secondary' onclick="closeModal('addShiftModal')">Cancel</button>
                        </div>
                    </div>
                    
                    <div class="add-shift-content">
                        <div class='form-group' id='addShiftWorkersGroup' style='display:none;'>
                            <label><strong>Current Schedule</strong></label>
                            <div id='addShiftCurrentSchedule' class="schedule-info"></div>
                            <label><strong>Assign Worker(s)</strong></label>
                            <div id='addShiftWorkersList' class="workers-list"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('addShiftModalBody').innerHTML = html;
            document.getElementById('addShiftModal').style.display = 'block';
            
            // Enhanced helper to update worker list
            function updateWorkerList() {
                const day = document.getElementById('addShiftDay').value;
                const start = document.getElementById('addShiftStart').value;
                const end = document.getElementById('addShiftEnd').value;
                const showUnavailable = document.getElementById('addShiftShowUnavailable').checked;
                const group = document.getElementById('addShiftWorkersGroup');
                const workersList = document.getElementById('addShiftWorkersList');
                const currentScheduleDiv = document.getElementById('addShiftCurrentSchedule');
                
                if (!day || !start || !end) {
                    group.style.display = 'none';
                    workersList.innerHTML = '';
                    currentScheduleDiv.innerHTML = '';
                    return;
                }
                
                // Update the label to show the selected day
                const scheduleLabel = document.querySelector('#addShiftWorkersGroup label strong');
                if (scheduleLabel) {
                    scheduleLabel.textContent = `Current Schedule for ${day}`;
                }
                
                // Show current schedule and operating hours for this day
                const dayShifts = schedule[day] || [];
                const dayHours = hours[day] || [];
                
                let scheduleHtml = '';
                
                // Show operating hours
                if (dayHours.length > 0) {
                    scheduleHtml += `<strong>Operating Hours:</strong> ${dayHours.map(h => `${formatTime(h.start)}-${formatTime(h.end)}`).join(', ')}<br>`;
                }
                
                // Show existing shifts
                if (dayShifts.length > 0) {
                    scheduleHtml += '<strong>Existing Shifts:</strong><br>';
                    dayShifts.forEach((shift, index) => {
                        const workers = shift.assigned.join(', ');
                        scheduleHtml += `‚Ä¢ ${formatTime(shift.start)}-${formatTime(shift.end)}: ${workers}<br>`;
                    });
                } else {
                    scheduleHtml += '<em>No shifts scheduled for this day yet.</em>';
                }
                
                currentScheduleDiv.innerHTML = scheduleHtml;
                
                // Convert time strings to hours for comparison
                const startHour = timeToHour(start);
                const endHour = timeToHour(end);
                
                // Build worker list with availability information
                let workersHtml = '';
                
                workers.forEach(w => {
                    const available = isWorkerAvailable(w, day, startHour, endHour);
                    const isWorkStudy = w.work_study;
                    
                    // Skip unavailable workers if the checkbox is not checked
                    if (!available && !showUnavailable) {
                        return;
                    }
                    
                    // Format availability for this specific day
                    let dayAvailability = 'No availability';
                    if (w.availability[day] && w.availability[day].length > 0) {
                        dayAvailability = w.availability[day].map(slot => 
                            `${formatTime(slot.start)}-${formatTime(slot.end)}`
                        ).join(', ');
                    }
                    
                    // Check if worker has any shifts on this day
                    const existingShifts = (schedule[day] || []).filter(shift => 
                        shift.raw_assigned && shift.raw_assigned.includes(w.email)
                    );
                    
                    let shiftInfo = '';
                    if (existingShifts.length > 0) {
                        shiftInfo = existingShifts.map(shift => 
                            `${formatTime(shift.start)}-${formatTime(shift.end)}`
                        ).join(', ');
                    }
                    
                    const workerClass = available ? 'available-worker' : 'unavailable-worker';
                    const statusText = available ? '‚úÖ Available' : '‚ùå Unavailable';
                    const workStudyBadge = isWorkStudy ? ' <span style="color: #ffc107; font-weight: bold;">(WS)</span>' : '';
                    
                    workersHtml += `
                        <div class="worker-item ${workerClass}">
                            <label class="worker-label">
                                <input type="checkbox" name="addShiftWorker" value="${w.email}">
                                <div class="worker-info">
                                    <strong>${w.first_name} ${w.last_name}${workStudyBadge}</strong>
                                    <div class="worker-details">
                                        <div><strong>Status:</strong> ${statusText}</div>
                                        <div><strong>${day} Availability:</strong> ${dayAvailability}</div>
                                        ${shiftInfo ? `<div><strong>Existing Shifts:</strong> ${shiftInfo}</div>` : ''}
                                    </div>
                                </div>
                            </label>
                        </div>
                    `;
                });
                
                if (workersHtml === '') {
                    workersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No workers found for the selected criteria.</div>';
                } else {
                    workersList.innerHTML = workersHtml;
                }
                group.style.display = 'block';
            }
            // Set up event listeners
            document.getElementById('addShiftDay').onchange = updateWorkerList;
            document.getElementById('addShiftStart').oninput = updateWorkerList;
            document.getElementById('addShiftEnd').oninput = updateWorkerList;
            document.getElementById('addShiftShowUnavailable').onchange = updateWorkerList;
            
            // Save logic (updated for checkbox selection)
            document.getElementById('saveAddShiftBtn').onclick = async function() {
                const day = document.getElementById('addShiftDay').value;
                const start = document.getElementById('addShiftStart').value;
                const end = document.getElementById('addShiftEnd').value;
                const selected = Array.from(document.querySelectorAll('#addShiftModal input[name="addShiftWorker"]:checked')).map(cb => cb.value);
                if (!day || !start || !end) {
                    showNotification('‚ùå All fields are required', 'error');
                    return;
                }
                // Handle overnight shifts properly (when end time is midnight or earlier than start time)
                const startHour = timeToHour(start);
                const endHour = timeToHour(end);
                
                // If end time is midnight (00:00) or earlier than start time, it's an overnight shift
                if (endHour <= startHour && endHour !== 0) {
                    showNotification('‚ùå End time must be after start time', 'error');
                    return;
                }
                
                // For overnight shifts (end time is midnight), we need to add 24 hours to end time for comparison
                const adjustedEndHour = (endHour === 0 && end === '00:00') ? 24 : endHour;
                if (adjustedEndHour <= startHour) {
                    showNotification('‚ùå End time must be after start time', 'error');
                    return;
                }
                if (selected.length === 0) {
                    showNotification('‚ùå At least one worker must be assigned', 'error');
                    return;
                }
                // Validate within operating hours (handle overnight shifts)
                const opHours = (hours[day] && hours[day][0]) ? hours[day][0] : { start: '00:00', end: '23:59' };
                const opStartHour = timeToHour(opHours.start);
                const opEndHour = timeToHour(opHours.end);
                const shiftStartHour = timeToHour(start);
                const shiftEndHour = timeToHour(end);
                
                // For overnight shifts, adjust the end time
                const adjustedShiftEndHour = (shiftEndHour === 0 && end === '00:00') ? 24 : shiftEndHour;
                const adjustedOpEndHour = (opEndHour === 0 && opHours.end === '00:00') ? 24 : opEndHour;
                
                if (shiftStartHour < opStartHour || adjustedShiftEndHour > adjustedOpEndHour) {
                    showNotification(`‚ùå Shift must be within operating hours: ${formatTime(opHours.start)} - ${formatTime(opHours.end)}`, 'error');
                    return;
                }
                // Add to in-memory schedule
                if (!schedule[day]) schedule[day] = [];
                const newAssigned = selected.map(email => {
                    const w = workers.find(x => x.email === email);
                    return w ? `${w.first_name} ${w.last_name}` : email;
                });
                schedule[day].push({
                    start,
                    end,
                    assigned: newAssigned,
                    available: newAssigned,
                    raw_assigned: selected,
                    all_available: workers.filter(w => selected.includes(w.email))
                });
                showNotification('‚úÖ Shift added (not yet saved to database)', 'success');
                closeModal('addShiftModal');
                displayEnhancedSchedule(schedule, calculateAssignedHours(schedule), [], [], false, []);
                // Update analysis in real-time if modal is open
                updateScheduleAnalysis();
                // Save to Firestore
                if (currentScheduleId) {
                    const scheduleRef = doc(db, 'workplaces', selectedWorkplace, 'schedules', currentScheduleId);
                    await updateDoc(scheduleRef, {
                        days: schedule,
                        updated_at: new Date().toISOString(),
                        updated_by: user.email
                    });
                    showNotification('‚úÖ Shift added and saved to database!', 'success');
                    // Update analysis in real-time if modal is open
                    updateScheduleAnalysis();
                } else {
                    showNotification('‚ö†Ô∏è Could not save to database: schedule ID not found', 'warning');
                }
            };
        };

        window.editShift = function(day, shiftIndex) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            // Find the shift
            const shift = (schedule[day] || [])[shiftIndex];
            if (!shift) {
                showNotification('‚ùå Shift not found', 'error');
                return;
            }
            const maxWorkers = shift.raw_assigned ? shift.raw_assigned.length : 1;
            const assignedEmails = new Set(shift.raw_assigned || []);
            // Editable time fields
            const startVal = shift.start;
            const endVal = shift.end;
            // Get workplace operating hours for this day
            const opHours = (hours[day] && hours[day][0]) ? hours[day][0] : { start: '00:00', end: '23:59' };
            // Build worker lists
            const availableWorkers = workers.filter(w => isWorkerAvailable(w, day, timeToHour(startVal), timeToHour(endVal)));
            const unavailableWorkers = workers.filter(w => !isWorkerAvailable(w, day, timeToHour(startVal), timeToHour(endVal)));
            // Format availability in AM/PM
            function formatAvail(w) {
                return Object.entries(w.availability).map(([d, slots]) => `${d}: ${slots.map(s => formatTime(s.start) + '-' + formatTime(s.end)).join(', ')}`).join('; ');
            }
            let html = `<div><strong>Shift:</strong> ${day} <input type='time' id='editShiftStart' value='${startVal}'> - <input type='time' id='editShiftEnd' value='${endVal}'> <span style='font-size:0.9em;color:#888;'>(AM/PM shown below)</span></div>`;
            html += `<div style='margin: 1rem 0;'><strong>Assigned:</strong> <span id='editShiftAssignedCount'></span> / ${maxWorkers}</div>`;
            html += `<div><strong>Available Workers</strong></div><div>`;
            availableWorkers.forEach(w => {
                const checked = assignedEmails.has(w.email) ? 'checked' : '';
                html += `<label><input type='checkbox' name='editShiftWorker' value='${w.email}' ${checked}> ${w.first_name} ${w.last_name} <small>(${formatAvail(w)})</small></label><br>`;
            });
            html += `</div><div style='margin-top:0.5rem;'><strong>Unavailable Workers</strong></div><div>`;
            unavailableWorkers.forEach(w => {
                const checked = assignedEmails.has(w.email) ? 'checked' : '';
                html += `<label><input type='checkbox' name='editShiftWorker' value='${w.email}' ${checked}> ${w.first_name} ${w.last_name} <small>(${formatAvail(w)})</small></label><br>`;
            });
            html += `</div><div style='margin-top:1rem;'>
                <button class='btn btn-success' id='saveEditShiftBtn'>Save</button>
                <button class='btn btn-secondary' onclick="closeModal('editShiftModal')">Cancel</button>
            </div>`;
            document.getElementById('editShiftModalBody').innerHTML = html;
            document.getElementById('editShiftModal').style.display = 'block';
            // Selection logic
            function updateAssignedCount() {
                const checked = document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]:checked');
                document.getElementById('editShiftAssignedCount').textContent = checked.length;
                // Enforce max
                document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]').forEach(input => {
                    if (!input.checked && checked.length >= maxWorkers) input.disabled = true;
                    else input.disabled = false;
                });
            }
            document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]').forEach(input => {
                input.addEventListener('change', updateAssignedCount);
            });
            updateAssignedCount();
            // Save logic
            document.getElementById('saveEditShiftBtn').onclick = function() {
                const checked = Array.from(document.querySelectorAll('#editShiftModal input[name="editShiftWorker"]:checked')).map(i => i.value);
                if (checked.length === 0) {
                    showNotification('‚ùå At least one worker must be assigned', 'error');
                    return;
                }
                // Get new times
                const newStart = document.getElementById('editShiftStart').value;
                const newEnd = document.getElementById('editShiftEnd').value;
                if (!newStart || !newEnd) {
                    showNotification('‚ùå Start and end times are required', 'error');
                    return;
                }
                // Handle overnight shifts properly (when end time is midnight or earlier than start time)
                const startHour = timeToHour(newStart);
                const endHour = timeToHour(newEnd);
                
                // If end time is midnight (00:00) or earlier than start time, it's an overnight shift
                if (endHour <= startHour && endHour !== 0) {
                    showNotification('‚ùå End time must be after start time', 'error');
                    return;
                }
                
                // For overnight shifts (end time is midnight), we need to add 24 hours to end time for comparison
                const adjustedEndHour = (endHour === 0 && newEnd === '00:00') ? 24 : endHour;
                if (adjustedEndHour <= startHour) {
                    showNotification('‚ùå End time must be after start time', 'error');
                    return;
                }
                // Validate within operating hours (handle overnight shifts)
                const opStartHour = timeToHour(opHours.start);
                const opEndHour = timeToHour(opHours.end);
                const shiftStartHour = timeToHour(newStart);
                const shiftEndHour = timeToHour(newEnd);
                
                // For overnight shifts, adjust the end time
                const adjustedShiftEndHour = (shiftEndHour === 0 && newEnd === '00:00') ? 24 : shiftEndHour;
                const adjustedOpEndHour = (opEndHour === 0 && opHours.end === '00:00') ? 24 : opEndHour;
                
                if (shiftStartHour < opStartHour || adjustedShiftEndHour > adjustedOpEndHour) {
                    showNotification(`‚ùå Shift must be within operating hours: ${formatTime(opHours.start)} - ${formatTime(opHours.end)}`, 'error');
                    return;
                }
                // Update in-memory schedule
                const newAssigned = checked.map(email => {
                    const w = workers.find(x => x.email === email);
                    return w ? `${w.first_name} ${w.last_name}` : email;
                });
                shift.assigned = newAssigned;
                shift.raw_assigned = checked;
                shift.all_available = workers.filter(w => checked.includes(w.email));
                shift.start = newStart;
                shift.end = newEnd;
                showNotification('‚úÖ Shift updated (not yet saved to database)', 'success');
                closeModal('editShiftModal');
                displayEnhancedSchedule(schedule, calculateAssignedHours(schedule), [], [], false, []);
                // Update analysis in real-time if modal is open
                updateScheduleAnalysis();
                // Save to Firestore
                if (currentScheduleId) {
                    const scheduleRef = doc(db, 'workplaces', selectedWorkplace, 'schedules', currentScheduleId);
                    updateDoc(scheduleRef, {
                        days: schedule,
                        updated_at: new Date().toISOString(),
                        updated_by: user.email
                    }).then(() => {
                        showNotification('‚úÖ Shift changes saved to database!', 'success');
                        // Update analysis in real-time if modal is open
                        updateScheduleAnalysis();
                    }).catch((err) => {
                        showNotification('‚ùå Failed to save shift changes to database', 'error');
                        console.error('Error saving shift edit:', err);
                    });
                } else {
                    showNotification('‚ö†Ô∏è Could not save to database: schedule ID not found', 'warning');
                }
            };
        };

        window.suggestAlternatives = function(day, shiftIndex) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            showNotification('üí° Alternative suggestions feature - Enhanced implementation coming soon!', 'info');
        };

        // Test Firebase connection
        async function testConnection() {
            try {
                console.log('Testing Firestore connection...');
                const workplacesSnapshot = await getDocs(collection(db, 'workplaces'));
                console.log(`‚úÖ Connected! Found ${workplacesSnapshot.size} workplaces in database.`);
                showNotification('‚úÖ Database connection successful', 'success');
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                showNotification('‚ùå Database connection failed', 'error');
            }
        }

        testConnection();

        // Debug function to check current hours
        window.debugHours = function() {
            console.log('=== CURRENT HOURS DEBUG ===');
            console.log('Selected workplace:', selectedWorkplace);
            console.log('Current hours object:', hours);
            console.log('Sunday hours:', hours.Sunday);
            if (hours.Sunday && hours.Sunday[0]) {
                console.log('Sunday start:', hours.Sunday[0].start);
                console.log('Sunday end:', hours.Sunday[0].end);
            }
            console.log('==========================');
        };

        // Add SheetJS via CDN
        if (!window.XLSX) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
          document.head.appendChild(script);
        }

        window.showImportWorkers = function() {
          if (!user.isAdmin) {
            showNotification('‚ùå Admin access required', 'error');
            return;
          }
          if (!selectedWorkplace) {
            showNotification('‚ö†Ô∏è Please select a workplace first', 'warning');
            return;
          }
          document.getElementById('importWorkersModalBody').innerHTML = `
            <div style='margin-bottom:1rem;'>
              <strong>Select an Excel file (.xlsx) with columns: First Name, Last Name, Email, Work Study, Days & Time Available.</strong>
            </div>
            <input type='file' id='importWorkersFile' accept='.xlsx,.xls,.csv'>
            <div id='importWorkersProgress' style='margin-top:1rem;'></div>
          `;
          document.getElementById('importWorkersModal').style.display = 'block';
          document.getElementById('importWorkersFile').onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('importWorkersProgress').innerHTML = 'üîÑ Reading file...';
            // Wait for SheetJS to load
            function waitForSheetJS() {
              return new Promise(resolve => {
                if (window.XLSX) resolve();
                else setTimeout(() => resolve(waitForSheetJS()), 100);
              });
            }
            await waitForSheetJS();
            const reader = new FileReader();
            reader.onload = async function(evt) {
              const data = evt.target.result;
              let workbook;
              try {
                workbook = XLSX.read(data, { type: 'binary' });
              } catch (err) {
                document.getElementById('importWorkersProgress').innerHTML = '‚ùå Failed to read file.';
                return;
              }
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
              if (!rows.length) {
                document.getElementById('importWorkersProgress').innerHTML = '‚ùå No data found in file.';
                return;
              }
              document.getElementById('importWorkersProgress').innerHTML = 'üîÑ Checking for duplicates...';
              // Get existing worker emails
              const existingSnapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
              const existingEmails = new Set();
              existingSnapshot.forEach(doc => {
                // Skip the _metadata document - it's not a real worker
                if (doc.id === '_metadata') {
                  return;
                }
                const data = doc.data();
                if (data['Email']) existingEmails.add(data['Email'].toLowerCase());
              });
              // Prepare new workers
              const newWorkers = [];
              const skipped = [];
              for (const row of rows) {
                const email = (row['Email'] || '').toLowerCase();
                if (!email || existingEmails.has(email)) {
                  skipped.push(email);
                  continue;
                }
                newWorkers.push({
                  'First Name': row['First Name'] || '',
                  'Last Name': row['Last Name'] || '',
                  'Email': row['Email'] || '',
                  'Work Study': (row['Work Study'] || '').toUpperCase() === 'Y' ? 'Yes' : 'No',
                  'Days & Times Available': row['Days & Time Available'] || '',
                  created_at: new Date().toISOString(),
                  created_by: user.email
                });
              }
              document.getElementById('importWorkersProgress').innerHTML = `Found ${newWorkers.length} new workers, ${skipped.length} duplicates.`;
              if (newWorkers.length === 0) {
                document.getElementById('importWorkersProgress').innerHTML += '<br>Nothing to import.';
                return;
              }
              document.getElementById('importWorkersProgress').innerHTML += '<br>Importing...';
              // Add to Firestore
              let added = 0;
              for (const worker of newWorkers) {
                try {
                  await addDoc(collection(db, 'workplaces', selectedWorkplace, 'workers'), worker);
                  added++;
                } catch (err) {
                  // skip
                }
              }
              document.getElementById('importWorkersProgress').innerHTML += `<br>‚úÖ Imported ${added} workers!`;
              showNotification(`‚úÖ Imported ${added} workers, skipped ${skipped.length} duplicates.`, 'success');
              await loadWorkplaceData();
            };
            reader.readAsBinaryString(file);
          };
        };

        // Add removeShift function
        window.removeShift = async function(day, shiftIndex) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            const shift = (schedule[day] || [])[shiftIndex];
            if (!shift) {
                showNotification('‚ùå Shift not found', 'error');
                return;
            }
            const confirmMsg = `Are you sure you want to delete the shift on ${day} from ${formatTime(shift.start)} to ${formatTime(shift.end)}?`;
            if (!confirm(confirmMsg)) return;
            // Remove from in-memory schedule
            schedule[day].splice(shiftIndex, 1);
            showNotification('üóëÔ∏è Shift removed (not yet saved to database)', 'success');
            displayEnhancedSchedule(schedule, calculateAssignedHours(schedule), [], [], false, []);
            // Update analysis in real-time if modal is open
            updateScheduleAnalysis();
            // Save to Firestore
            if (currentScheduleId) {
                const scheduleRef = doc(db, 'workplaces', selectedWorkplace, 'schedules', currentScheduleId);
                await updateDoc(scheduleRef, {
                    days: schedule,
                    updated_at: new Date().toISOString(),
                    updated_by: user.email
                });
                showNotification('üóëÔ∏è Shift removed and saved to database!', 'success');
                // Update analysis in real-time if modal is open
                updateScheduleAnalysis();
            } else {
                showNotification('‚ö†Ô∏è Could not save to database: schedule ID not found', 'warning');
            }
        };

        // On page load or user check, hide View Workers for non-admins
        if (!user.isAdmin) {
            document.getElementById('viewWorkersBtn').style.display = 'none';
        }

        // Add removeWorker function
        window.removeWorker = async function(workerId) {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;
            if (!confirm(`Are you sure you want to delete ${worker.first_name} ${worker.last_name} (${worker.email})? This cannot be undone.`)) return;
            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', workerId));
                showNotification('‚úÖ Worker deleted successfully!', 'success');
                await loadWorkplaceData();
                viewWorkers();
            } catch (error) {
                console.error('Error deleting worker:', error);
                showNotification('‚ùå Error deleting worker', 'error');
            }
        };

        // Show/hide Who's Working Now button for admins
        if (user.isAdmin) {
            document.getElementById('whosWorkingNowBtn').style.display = 'inline-block';
        }

        // Add showWhosWorkingNow function
        window.showWhosWorkingNow = function() {
            if (!user.isAdmin) {
                showNotification('‚ùå Admin access required', 'error');
                return;
            }
            if (!schedule || Object.keys(schedule).length === 0) {
                showNotification('‚ùå No schedule loaded. View the current schedule first.', 'error');
                return;
            }
            // Get current day and time
            const now = new Date();
            const day = DAYS[now.getDay() === 0 ? 6 : now.getDay() - 1]; // JS: 0=Sunday, our DAYS: 0=Monday
            const curHour = now.getHours() + now.getMinutes() / 60;
            const shifts = (schedule[day] || []).filter(shift => {
                const start = timeToHour(shift.start);
                const end = timeToHour(shift.end);
                return start <= curHour && curHour < end && shift.assigned && shift.assigned.length > 0 && !shift.assigned.includes('Unfilled') && !shift.assigned.includes('COVERAGE GAP');
            });
            let html = `<div class='modal-content'><div class='modal-header'><h3>üïí Who's Working Now?</h3><span class='close' onclick="closeModal('whosWorkingNowModal')">&times;</span></div>`;
            if (shifts.length === 0) {
                html += `<div class='info'>No one is currently scheduled to work right now (${day}, ${formatTime(hourToTime(curHour))}).</div>`;
            } else {
                html += `<table class='worker-table'><thead><tr><th>Name</th><th>Shift Time</th><th>Actions</th></tr></thead><tbody>`;
                shifts.forEach(shift => {
                    shift.assigned.forEach(name => {
                        // Find worker email for contact button
                        const email = (workers.find(w => `${w.first_name} ${w.last_name}` === name) || {}).email || '';
                        html += `<tr><td><strong>${name}</strong></td><td>${formatTime(shift.start)} - ${formatTime(shift.end)}</td><td><button class='btn btn-primary' onclick="contactWorker('${email}')">üìß Contact</button></td></tr>`;
                    });
                });
                html += `</tbody></table>`;
            }
            html += `<div style='margin-top:1rem;'><button class='btn btn-secondary' onclick="closeModal('whosWorkingNowModal')">Close</button></div></div>`;
            // Show modal
            let modal = document.getElementById('whosWorkingNowModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'whosWorkingNowModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = html;
            modal.style.display = 'block';
            window.closeModal = function(id) {
                const m = document.getElementById(id);
                if (m) m.style.display = 'none';
            };
        };

        // In the script, show/hide user dashboard for non-admins
        if (!user.isAdmin) {
            document.getElementById('userDashboard').style.display = 'block';
            document.getElementById('adminSection').style.display = 'none';
            // Set welcome message
            let welcomeName = '';
            if (user.firstName && user.lastName) {
                welcomeName = `${user.firstName} ${user.lastName}`;
            } else if (user.firstName) {
                welcomeName = user.firstName;
            } else {
                welcomeName = user.email || 'User';
            }
            document.getElementById('userWelcome').textContent = `Welcome, ${welcomeName}!`;
            // Removed pre-fill of old account form fields (no longer present)
        }

        // My Account modal logic for all users
        document.getElementById('myAccountBtn').onclick = function() {
            // Pre-fill modal fields with user info
            document.getElementById('accountFirstNameModal').value = user.firstName || '';
            document.getElementById('accountLastNameModal').value = user.lastName || '';
            document.getElementById('accountEmailModal').value = user.email || '';
            document.getElementById('accountPhoneModal').value = user.phone || '';
            document.getElementById('currentEmailModal').value = user.email || '';
            document.getElementById('myAccountModal').style.display = 'block';
            
            // Load email change requests history
            loadEmailChangeRequestsHistory();
        };
        
        // Save account changes handler
        document.getElementById('saveAccountBtnModal').onclick = async function() {
            const firstName = document.getElementById('accountFirstNameModal').value.trim();
            const lastName = document.getElementById('accountLastNameModal').value.trim();
            const phone = document.getElementById('accountPhoneModal').value.trim();
            
            // Validation
            if (!firstName || !lastName) {
                showNotification('‚ùå First name and last name are required', 'error');
                return;
            }
            
            try {
                // Update user document in Firestore
                const userDocRef = doc(db, 'users', user.uid);
                await updateDoc(userDocRef, {
                    firstName: firstName,
                    lastName: lastName,
                    phone: phone
                });
                
                // Update local user object
                user.firstName = firstName;
                user.lastName = lastName;
                user.phone = phone;
                
                // Update localStorage
                localStorage.setItem('user', JSON.stringify(user));
                
                // Update welcome message if user is non-admin
                if (!user.isAdmin) {
                    let welcomeName = '';
                    if (user.firstName && user.lastName) {
                        welcomeName = `${user.firstName} ${user.lastName}`;
                    } else if (user.firstName) {
                        welcomeName = user.firstName;
                    } else {
                        welcomeName = user.email || 'User';
                    }
                    document.getElementById('userWelcome').textContent = `Welcome, ${welcomeName}!`;
                }
                
                showNotification('‚úÖ Account information updated successfully', 'success');
                document.getElementById('myAccountModal').style.display = 'none';
            } catch (error) {
                console.error('Error updating account:', error);
                showNotification('‚ùå Failed to update account information', 'error');
            }
        };
        
        // Change password handler
        document.getElementById('changePasswordBtnModal').onclick = async function() {
            const oldPassword = document.getElementById('oldPasswordModal').value;
            const newPassword = document.getElementById('newPasswordModal').value;
            const confirmNewPassword = document.getElementById('confirmNewPasswordModal').value;
            
            // Validation
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showNotification('‚ùå All password fields are required', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showNotification('‚ùå New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('‚ùå New password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                // First verify the old password by checking against stored password
                if (oldPassword !== user.password) {
                    showNotification('‚ùå Current password is incorrect', 'error');
                    return;
                }
                
                // Import the auth database configuration using dynamic imports
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                // Use the AUTH database config (where user accounts are stored)
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                // Update password in AUTH database using correct document ID
                const userDocRef = doc(authDb, 'users', user.uid);
                await updateDoc(userDocRef, {
                    password: newPassword
                });
                
                // Update local user object
                user.password = newPassword;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Clear password fields
                document.getElementById('oldPasswordModal').value = '';
                document.getElementById('newPasswordModal').value = '';
                document.getElementById('confirmNewPasswordModal').value = '';
                
                showNotification('‚úÖ Password changed successfully', 'success');
                document.getElementById('myAccountModal').style.display = 'none';
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('‚ùå Failed to change password', 'error');
            }
        };

        // --- EMAIL CHANGE REQUEST SYSTEM ---
        
        // Submit email change request handler
        document.getElementById('submitEmailChangeRequestBtn').onclick = async function() {
            const newEmail = document.getElementById('newEmailModal').value.trim();
            const reason = document.getElementById('emailChangeReasonModal').value.trim();
            
            // Validation
            if (!newEmail) {
                showNotification('‚ùå New email address is required', 'error');
                return;
            }
            
            if (newEmail === user.email) {
                showNotification('‚ùå New email must be different from current email', 'error');
                return;
            }
            
            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showNotification('‚ùå Please enter a valid email address', 'error');
                return;
            }
            
            try {
                // Import auth database
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, collection, addDoc, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                // Check if user already has 2 pending requests
                const pendingRequestsQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    where('userId', '==', user.uid),
                    where('status', '==', 'pending')
                );
                const pendingSnapshot = await getDocs(pendingRequestsQuery);
                
                if (pendingSnapshot.size >= 2) {
                    showNotification('‚ùå You already have 2 pending email change requests. Please wait for admin approval.', 'error');
                    return;
                }
                
                // Check if this exact request already exists
                const existingRequestQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    where('userId', '==', user.uid),
                    where('requestedEmail', '==', newEmail),
                    where('status', '==', 'pending')
                );
                const existingSnapshot = await getDocs(existingRequestQuery);
                
                if (!existingSnapshot.empty) {
                    showNotification('‚ùå You already have a pending request for this email address', 'error');
                    return;
                }
                
                // Create email change request
                await addDoc(collection(authDb, 'emailChangeRequests'), {
                    userId: user.uid,
                    currentEmail: user.email,
                    requestedEmail: newEmail,
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    reviewedBy: null,
                    reviewedAt: null,
                    adminNotes: null
                });
                
                // Clear form
                document.getElementById('newEmailModal').value = '';
                document.getElementById('emailChangeReasonModal').value = '';
                
                showNotification('‚úÖ Email change request submitted successfully! Admin approval required.', 'success');
                
                // Reload history
                loadEmailChangeRequestsHistory();
                
            } catch (error) {
                console.error('Error submitting email change request:', error);
                showNotification('‚ùå Failed to submit email change request', 'error');
            }
        };
        
        // Load email change requests history
        async function loadEmailChangeRequestsHistory() {
            const listDiv = document.getElementById('emailChangeRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading your email change requests...</div>';
            
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, collection, query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                const requestsQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    where('userId', '==', user.uid),
                    orderBy('createdAt', 'desc')
                );
                const snapshot = await getDocs(requestsQuery);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No email change requests found.</div>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong>${data.requestedEmail}</strong>
                                <span class="status-badge ${statusBadgeClass}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                    ${data.status}
                                </span>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                                Requested: ${new Date(data.createdAt).toLocaleDateString()}
                            </div>
                            ${data.reason ? `<div style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Reason:</strong> ${data.reason}</div>` : ''}
                            ${data.status !== 'pending' ? `
                                <div style="font-size: 0.9rem; color: #666;">
                                    ${data.status === 'approved' ? '‚úÖ Approved' : '‚ùå Denied'} by ${data.reviewedBy || 'Admin'} on ${data.reviewedAt ? new Date(data.reviewedAt).toLocaleDateString() : 'Unknown'}
                                </div>
                                ${data.adminNotes ? `<div style="font-size: 0.9rem; margin-top: 0.5rem;"><strong>Admin Notes:</strong> ${data.adminNotes}</div>` : ''}
                            ` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading email change requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load email change requests.</div>';
            }
        }

        // --- AVAILABILITY REQUESTS FEATURE ---
        // User: Open modal
        if (!user.isAdmin) {
            document.getElementById('requestAvailabilityBtn').onclick = function() {
                document.getElementById('requestName').value = user.firstName || '';
                document.getElementById('requestEmail').value = user.email || '';
                document.getElementById('requestAvailability').value = '';
                document.getElementById('availabilityRequestModal').style.display = 'block';
            };
            
            // User: Open time off request modal
            document.getElementById('requestTimeOffBtn').onclick = function() {
                // Set default start date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('timeOffStartDate').value = today;
                document.getElementById('timeOffEndDate').value = '';
                document.getElementById('timeOffReason').value = '';
                document.getElementById('timeOffRequestModal').style.display = 'block';
            };
            
            // User: Open shift swap request modal
            document.getElementById('requestShiftSwapBtn').onclick = function() {
                console.log('Shift swap button clicked!');
                console.log('Selected workplace:', selectedWorkplace);
                console.log('User:', user);
                
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                openShiftSwapRequestModal();
            };
        }
        // User: Submit request
        const availabilityRequestForm = document.getElementById('availabilityRequestForm');
        availabilityRequestForm.onsubmit = async function(e) {
            e.preventDefault();
            const name = document.getElementById('requestName').value.trim();
            const email = document.getElementById('requestEmail').value.trim();
            const requestedAvailability = document.getElementById('requestAvailability').value.trim();
            if (!selectedWorkplace) {
                showNotification('‚ùå Please select a workplace first', 'error');
                return;
            }
            if (!name || !email || !requestedAvailability) {
                showNotification('‚ùå All fields are required', 'error');
                return;
            }
            try {
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'availability_requests'), {
                    name,
                    email,
                    requestedAvailability,
                    status: 'pending',
                    submittedAt: new Date().toISOString(),
                });
                showNotification('‚úÖ Request submitted! Admins will review your request.', 'success');
                closeModal('availabilityRequestModal');
            } catch (error) {
                showNotification('‚ùå Failed to submit request', 'error');
            }
        };
        
        // User: Submit time off request
        const timeOffRequestForm = document.getElementById('timeOffRequestForm');
        timeOffRequestForm.onsubmit = async function(e) {
            e.preventDefault();
            const startDate = document.getElementById('timeOffStartDate').value;
            const endDate = document.getElementById('timeOffEndDate').value;
            const reason = document.getElementById('timeOffReason').value.trim();
            
            if (!selectedWorkplace) {
                showNotification('‚ùå Please select a workplace first', 'error');
                return;
            }
            if (!startDate) {
                showNotification('‚ùå Start date is required', 'error');
                return;
            }
            
            // If no end date provided, use start date
            const finalEndDate = endDate || startDate;
            
            // Validate dates
            if (new Date(finalEndDate) < new Date(startDate)) {
                showNotification('‚ùå End date cannot be before start date', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'), {
                    fromEmail: user.email,
                    fromName: `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email,
                    startDate,
                    endDate: finalEndDate,
                    reason,
                    status: 'pending',
                    submittedAt: new Date().toISOString(),
                });
                showNotification('‚úÖ Time off request submitted! Admins will review your request.', 'success');
                closeModal('timeOffRequestModal');
            } catch (error) {
                console.error('Error submitting time off request:', error);
                showNotification('‚ùå Failed to submit time off request', 'error');
            }
        };
        
        // Admin: Hour Requests button logic
        if (user.isAdmin) {
            document.getElementById('hourRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('hourRequestsModal').style.display = 'block';
                loadHourRequests('all'); // Start with all requests
            };
            
            // Admin: Time Off Requests button logic
            document.getElementById('timeOffRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('timeOffRequestsModal').style.display = 'block';
                loadTimeOffRequests('all'); // Start with all requests
            };
            
            // Admin: Shift Swap Requests button logic
            document.getElementById('shiftSwapRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('shiftSwapRequestsModal').style.display = 'block';
                loadShiftSwapRequests();
            };
        }
        // Function to load hour requests for admin
        async function loadHourRequests(filter = 'all') {
            const listDiv = document.getElementById('hourRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading requests...</div>';
            
            try {
                let snapshot;
                if (filter === 'pending') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                        where('status', '==', 'pending')
                    ));
                } else if (filter === 'resolved') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                        where('status', '==', 'resolved')
                    ));
                } else {
                    // Load all requests
                    snapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'availability_requests'));
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="info">No ${filter} requests found.</div>`;
                    if (filter === 'all' || filter === 'pending') {
                        document.getElementById('hourRequestsBadge').style.display = 'none';
                    }
                    return;
                }
                
                // Sort by submitted date (newest first)
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                
                let html = `
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Requested Availability</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Reviewed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                requests.forEach(request => {
                    const submittedDate = new Date(request.submittedAt).toLocaleString();
                    const reviewedDate = request.reviewedAt ? new Date(request.reviewedAt).toLocaleString() : '-';
                    const statusBadge = request.status === 'pending' ? 
                        '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:0.8em;">Pending</span>' :
                        '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Resolved</span>';
                    
                    const actions = request.status === 'pending' ? 
                        `<button class='btn btn-success' onclick='markRequestReviewed("${request.id}")' style='margin-right:0.5rem;'>Mark as Reviewed</button>
                         <button class='btn btn-danger' onclick='deleteRequest("${request.id}")'>Delete</button>` :
                        `<button class='btn btn-danger' onclick='deleteRequest("${request.id}")'>Delete</button>`;
                    
                    html += `
                        <tr>
                            <td><strong>${request.name}</strong></td>
                            <td>${request.email}</td>
                            <td style="max-width: 300px; word-wrap: break-word;">${request.requestedAvailability}</td>
                            <td>${statusBadge}</td>
                            <td><small>${submittedDate}</small></td>
                            <td><small>${reviewedDate}</small></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                
                // Update badge based on pending requests
                if (filter === 'all' || filter === 'pending') {
                    const pendingSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                        where('status', '==', 'pending')
                    ));
                    document.getElementById('hourRequestsBadge').style.display = pendingSnapshot.empty ? 'none' : 'inline-block';
                }
                
            } catch (error) {
                console.error('Error loading requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load requests.</div>';
            }
        }
        // Mark request as reviewed
        window.markRequestReviewed = async function(requestId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'availability_requests', requestId), { status: 'resolved', reviewedAt: new Date().toISOString(), reviewedBy: user.email });
                showNotification('‚úÖ Request marked as reviewed.', 'success');
                loadHourRequests('all'); // Reload with current filter
            } catch (error) {
                showNotification('‚ùå Failed to update request', 'error');
            }
        };

        // Delete request
        window.deleteRequest = async function(requestId) {
            if (confirm('Are you sure you want to delete this request? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'availability_requests', requestId));
                    showNotification('‚úÖ Request deleted.', 'success');
                    loadHourRequests('all'); // Reload with current filter
                } catch (error) {
                    showNotification('‚ùå Failed to delete request', 'error');
                }
            }
        };

        // Filter requests
        window.filterRequests = function(filter) {
            // Update button styles
            document.getElementById('filterAllBtn').className = filter === 'all' ? 'btn btn-info active' : 'btn btn-info';
            document.getElementById('filterPendingBtn').className = filter === 'pending' ? 'btn btn-warning active' : 'btn btn-warning';
            document.getElementById('filterResolvedBtn').className = filter === 'resolved' ? 'btn btn-success active' : 'btn btn-success';
            
            loadHourRequests(filter);
        };
        // Badge update on workplace select
        async function updateHourRequestsBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'availability_requests'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('hourRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }
        // Call badge update on workplace select
        const origSelectWorkplace = window.selectWorkplace;
        window.selectWorkplace = async function(id) {
            await origSelectWorkplace(id);
            updateHourRequestsBadge();
            updateTimeOffRequestsBadge();
        };

        // --- TIME OFF REQUESTS FEATURE ---
        // Function to load time off requests for admin
        async function loadTimeOffRequests(filter = 'all') {
            const listDiv = document.getElementById('timeOffRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading time off requests...</div>';
            
            try {
                let snapshot;
                if (filter === 'pending') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'pending')
                    ));
                } else if (filter === 'approved') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'approved')
                    ));
                } else if (filter === 'denied') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'denied')
                    ));
                } else {
                    // Load all requests
                    snapshot = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'));
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="info">No ${filter} time off requests found.</div>`;
                    if (filter === 'all' || filter === 'pending') {
                        document.getElementById('timeOffRequestsBadge').style.display = 'none';
                    }
                    return;
                }
                
                // Sort by submitted date (newest first)
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                requests.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                
                let html = `
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Worker Name/Email</th>
                                <th>Time Off Period</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Reviewed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                requests.forEach(request => {
                    const submittedDate = new Date(request.submittedAt).toLocaleString();
                    const reviewedDate = request.reviewedAt ? new Date(request.reviewedAt).toLocaleString() : '-';
                    
                    // Format time off period
                    const startDate = new Date(request.startDate).toLocaleDateString();
                    const endDate = new Date(request.endDate).toLocaleDateString();
                    const timeOffPeriod = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
                    
                    // Status badge
                    let statusBadge;
                    if (request.status === 'pending') {
                        statusBadge = '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:0.8em;">Pending</span>';
                    } else if (request.status === 'approved') {
                        statusBadge = '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Approved</span>';
                    } else {
                        statusBadge = '<span style="background:#dc3545;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Denied</span>';
                    }
                    
                    // Actions
                    let actions = '';
                    if (request.status === 'pending') {
                        actions = `
                            <button class='btn btn-success' onclick='approveTimeOffRequest("${request.id}")' style='margin-right:0.5rem;'>Approve</button>
                            <button class='btn btn-danger' onclick='denyTimeOffRequest("${request.id}")' style='margin-right:0.5rem;'>Deny</button>
                            <button class='btn btn-secondary' onclick='deleteTimeOffRequest("${request.id}")'>Delete</button>
                        `;
                    } else {
                        actions = `<button class='btn btn-secondary' onclick='deleteTimeOffRequest("${request.id}")'>Delete</button>`;
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${request.fromName}</strong><br><small>${request.fromEmail}</small></td>
                            <td><strong>${timeOffPeriod}</strong></td>
                            <td style="max-width: 200px; word-wrap: break-word;">${request.reason || '<em>No reason provided</em>'}</td>
                            <td>${statusBadge}</td>
                            <td><small>${submittedDate}</small></td>
                            <td><small>${reviewedDate}</small></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                
                // Update badge based on pending requests
                if (filter === 'all' || filter === 'pending') {
                    const pendingSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                        where('status', '==', 'pending')
                    ));
                    document.getElementById('timeOffRequestsBadge').style.display = pendingSnapshot.empty ? 'none' : 'inline-block';
                }
                
            } catch (error) {
                console.error('Error loading time off requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load time off requests.</div>';
            }
        }

        // Approve time off request
        window.approveTimeOffRequest = async function(requestId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'time_off_requests', requestId), { 
                    status: 'approved', 
                    reviewedAt: new Date().toISOString(), 
                    reviewedBy: user.email 
                });
                showNotification('‚úÖ Time off request approved.', 'success');
                loadTimeOffRequests('all'); // Reload with current filter
            } catch (error) {
                showNotification('‚ùå Failed to approve request', 'error');
            }
        };

        // Deny time off request
        window.denyTimeOffRequest = async function(requestId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'time_off_requests', requestId), { 
                    status: 'denied', 
                    reviewedAt: new Date().toISOString(), 
                    reviewedBy: user.email 
                });
                showNotification('‚ùå Time off request denied.', 'success');
                loadTimeOffRequests('all'); // Reload with current filter
            } catch (error) {
                showNotification('‚ùå Failed to deny request', 'error');
            }
        };

        // Delete time off request
        window.deleteTimeOffRequest = async function(requestId) {
            if (confirm('Are you sure you want to delete this time off request? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'time_off_requests', requestId));
                    showNotification('‚úÖ Time off request deleted.', 'success');
                    loadTimeOffRequests('all'); // Reload with current filter
                } catch (error) {
                    showNotification('‚ùå Failed to delete request', 'error');
                }
            }
        };

        // Filter time off requests
        window.filterTimeOffRequests = function(filter) {
            // Update button styles
            document.getElementById('filterTimeOffAllBtn').className = filter === 'all' ? 'btn btn-info active' : 'btn btn-info';
            document.getElementById('filterTimeOffPendingBtn').className = filter === 'pending' ? 'btn btn-warning active' : 'btn btn-warning';
            document.getElementById('filterTimeOffApprovedBtn').className = filter === 'approved' ? 'btn btn-success active' : 'btn btn-success';
            document.getElementById('filterTimeOffDeniedBtn').className = filter === 'denied' ? 'btn btn-danger active' : 'btn btn-danger';
            
            loadTimeOffRequests(filter);
        };

        // Badge update for time off requests
        async function updateTimeOffRequestsBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'time_off_requests'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('timeOffRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }

        // Open shift swap request modal and populate data
        async function openShiftSwapRequestModal() {
            console.log('openShiftSwapRequestModal called');
            console.log('selectedWorkplace:', selectedWorkplace);
            
            if (!selectedWorkplace) return;
            
            try {
                // Load current schedule to get available shifts (same approach as loadUserDashboard)
                let currentSchedule = null;
                let currentScheduleId = null;
                
                const currentSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    where('isCurrent', '==', true)
                ));
                
                if (!currentSnapshot.empty) {
                    currentSchedule = currentSnapshot.docs[0].data();
                    currentScheduleId = currentSnapshot.docs[0].id;
                } else {
                    // Fallback to most recent schedule
                    const recentSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        orderBy('createdAt', 'desc')
                    ));
                    if (!recentSnapshot.empty) {
                        currentSchedule = recentSnapshot.docs[0].data();
                        currentScheduleId = recentSnapshot.docs[0].id;
                    }
                }
                
                if (!currentSchedule) {
                    showNotification('‚ùå No schedule found. Please generate a schedule first.', 'error');
                    return;
                }
                
                console.log('DEBUG: Found schedule:', currentSchedule);
                console.log('DEBUG: Schedule ID:', currentScheduleId);
                
                // Populate requester's shifts (shifts assigned to current user)
                const requesterShifts = [];
                for (const [day, shifts] of Object.entries(currentSchedule.days)) {
                    shifts.forEach((shift, index) => {
                        if (shift.raw_assigned && shift.raw_assigned.includes(user.email)) {
                            requesterShifts.push({
                                day,
                                date: getDateForDay(day),
                                time: `${shift.start}-${shift.end}`,
                                shiftIndex: index
                            });
                        }
                    });
                }
                
                // Populate target workers (all workers except current user)
                const targetWorkers = workers.filter(w => w.email !== user.email);
                
                // Populate form dropdowns
                const requesterTimeSelect = document.getElementById('swapRequesterShiftTime');
                const targetWorkerSelect = document.getElementById('swapTargetWorker');
                
                requesterTimeSelect.innerHTML = '<option value="">Select your shift time...</option>';
                requesterShifts.forEach(shift => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(shift);
                    option.textContent = `${shift.day} ${shift.date} - ${shift.time}`;
                    requesterTimeSelect.appendChild(option);
                });
                
                targetWorkerSelect.innerHTML = '<option value="">Select worker to swap with...</option>';
                targetWorkers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.email;
                    option.textContent = `${worker.first_name} ${worker.last_name} (${worker.email})`;
                    targetWorkerSelect.appendChild(option);
                });
                
                // Add event listener to populate target worker's shifts when selected
                targetWorkerSelect.addEventListener('change', function() {
                    const selectedWorkerEmail = this.value;
                    const targetShiftTimeSelect = document.getElementById('swapTargetShiftTime');
                    
                    if (!selectedWorkerEmail) {
                        targetShiftTimeSelect.innerHTML = '<option value="">Select their shift time...</option>';
                        return;
                    }
                    
                    // Find shifts for the selected worker
                    const targetWorkerShifts = [];
                    for (const [day, shifts] of Object.entries(currentSchedule.days)) {
                        shifts.forEach((shift, index) => {
                            if (shift.raw_assigned && shift.raw_assigned.includes(selectedWorkerEmail)) {
                                targetWorkerShifts.push({
                                    day,
                                    date: getDateForDay(day),
                                    time: `${shift.start}-${shift.end}`,
                                    shiftIndex: index
                                });
                            }
                        });
                    }
                    
                    // Populate the target shift time dropdown
                    targetShiftTimeSelect.innerHTML = '<option value="">Select their shift time...</option>';
                    targetWorkerShifts.forEach(shift => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(shift);
                        option.textContent = `${shift.day} ${shift.date} - ${shift.time}`;
                        targetShiftTimeSelect.appendChild(option);
                    });
                    
                    console.log('DEBUG: Found shifts for', selectedWorkerEmail, ':', targetWorkerShifts);
                });
                
                // Set default dates
                const today = new Date();
                document.getElementById('swapRequesterShiftDate').value = today.toISOString().split('T')[0];
                document.getElementById('swapTargetShiftDate').value = today.toISOString().split('T')[0];
                
                document.getElementById('shiftSwapRequestModal').style.display = 'block';
                
            } catch (error) {
                showNotification('‚ùå Failed to load schedule data', 'error');
            }
        }

        // Helper function to get date for a day of the week
        function getDateForDay(dayName) {
            const today = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const targetDay = days.indexOf(dayName);
            const currentDay = today.getDay();
            const daysToAdd = (targetDay - currentDay + 7) % 7;
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysToAdd);
            return targetDate.toISOString().split('T')[0];
        }

        // Helper function to get day name from date
        function getDayFromDate(dateString) {
            const date = new Date(dateString);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        // After loadWorkplaceData, add:
        async function loadUserDashboard() {
            if (user.isAdmin || !selectedWorkplace) return;
            const userEmail = user.email.trim().toLowerCase();
            console.log('DEBUG: userEmail:', userEmail);
            console.log('DEBUG: selectedWorkplace:', selectedWorkplace);
            try {
                // Find current schedule
                let scheduleData = null;
                const currentSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    where('isCurrent', '==', true)
                ));
                if (!currentSnapshot.empty) {
                    scheduleData = currentSnapshot.docs[0].data();
                } else {
                    // Fallback to most recent
                    const recentSnapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                        orderBy('createdAt', 'desc')
                    ));
                    if (!recentSnapshot.empty) {
                        scheduleData = recentSnapshot.docs[0].data();
                    }
                }
                console.log('DEBUG: scheduleData:', scheduleData);
                let myShiftsByDay = {};
                let totalHours = 0;
                if (scheduleData && scheduleData.days) {
                    // Find user's shifts
                    for (const day of DAYS) {
                        const shifts = scheduleData.days[day] || [];
                        myShiftsByDay[day] = shifts.filter(shift => {
                            if (!shift.raw_assigned || !Array.isArray(shift.raw_assigned)) return false;
                            return shift.raw_assigned.some(email => 
                                email && email.trim().toLowerCase() === userEmail
                            );
                        });
                        // Calculate hours for this day
                        myShiftsByDay[day].forEach(shift => {
                            if (shift.start && shift.end) {
                                const startHour = timeToHour(shift.start);
                                const endHour = timeToHour(shift.end);
                                totalHours += (endHour - startHour);
                            }
                        });
                    }
                }
                console.log('DEBUG: myShiftsByDay:', myShiftsByDay);
                console.log('DEBUG: totalHours:', totalHours);
                // Build shifts display
                let shiftsHtml = '';
                let hasShifts = false;
                for (const day of DAYS) {
                    const shifts = myShiftsByDay[day] || [];
                    if (shifts.length > 0) {
                        hasShifts = true;
                        shiftsHtml += `<div style='margin-bottom:0.5rem;'><strong>${day}</strong><ul style='margin:0.5em 0 0 1.5em;padding:0;'>`;
                        shifts.forEach(shift => {
                            shiftsHtml += `<li>${formatTime(shift.start)} - ${formatTime(shift.end)}</li>`;
                        });
                        shiftsHtml += '</ul></div>';
                    }
                }
                if (!hasShifts) {
                    shiftsHtml = '<div style="color:#888;">You have no assigned shifts for the current schedule.</div>';
                }
                // Update display
                document.getElementById('userShiftsPlaceholder').innerHTML = shiftsHtml;
                document.getElementById('userHoursPlaceholder').innerHTML = `<strong>${totalHours.toFixed(1)}</strong> hours assigned this week.`;
                // Show the dashboard
                document.getElementById('userDashboard').style.display = 'block';
                console.log('User dashboard should now be visible');
            } catch (error) {
                console.error('Error loading user dashboard:', error);
                document.getElementById('userShiftsPlaceholder').innerHTML = '<div style="color:#888;">Error loading your shifts.</div>';
                document.getElementById('userHoursPlaceholder').innerHTML = '<div style="color:#888;">Error calculating hours.</div>';
                document.getElementById('userDashboard').style.display = 'block';
                console.log('User dashboard shown due to error');
            }
        }

        // 3. Send message to admins (non-admins only)
        if (!user.isAdmin) {
            document.getElementById('sendUserMessageBtn').onclick = async function() {
                const message = document.getElementById('userMessageInput').value.trim();
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                if (!message) {
                    showNotification('‚ùå Please enter a message', 'error');
                    return;
                }
                try {
                    await addDoc(collection(db, 'workplaces', selectedWorkplace, 'admin_messages'), {
                        fromEmail: user.email,
                        fromName: (user.firstName && user.lastName) ? `${user.firstName} ${user.lastName}` : user.email,
                        message,
                        sentAt: new Date().toISOString(),
                        status: 'unread'
                    });
                    showNotification('‚úÖ Message sent to admins!', 'success');
                    document.getElementById('userMessageInput').value = '';
                } catch (error) {
                    showNotification('‚ùå Failed to send message', 'error');
                }
            };
        }
        // 4. Admin: View Messages button logic
        if (user.isAdmin) {
            document.getElementById('viewMessagesBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('adminMessagesModal').style.display = 'block';
                loadAdminMessages();
            };
        }
        // 5. Load admin messages for admin
        async function loadAdminMessages() {
            const listDiv = document.getElementById('adminMessagesList');
            listDiv.innerHTML = '<div class="loading">Loading messages...</div>';
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'admin_messages'),
                    orderBy('sentAt', 'desc')
                ));
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No messages found.</div>';
                    document.getElementById('messagesBadge').style.display = 'none';
                    return;
                }
                let html = `<table class="worker-table"><thead><tr><th>From</th><th>Email</th><th>Message</th><th>Sent</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const sentDate = new Date(data.sentAt).toLocaleString();
                    const statusBadge = data.status === 'unread' ? '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:0.8em;">Unread</span>' : '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8em;">Read</span>';
                    if (data.status === 'unread') unreadCount++;
                    html += `<tr><td><strong>${data.fromName || ''}</strong></td><td>${data.fromEmail || ''}</td><td style="max-width: 350px; word-wrap: break-word;">${data.message || ''}</td><td><small>${sentDate}</small></td><td>${statusBadge}</td><td>`;
                    if (data.status === 'unread') {
                        html += `<button class='btn btn-success' onclick='markMessageRead("${doc.id}")' style='margin-right:0.5rem;'>Mark as Read</button>`;
                    }
                    html += `<button class='btn btn-danger' onclick='deleteAdminMessage("${doc.id}")'>Delete</button></td></tr>`;
                });
                html += '</tbody></table>';
                listDiv.innerHTML = html;
                document.getElementById('messagesBadge').style.display = unreadCount > 0 ? 'inline-block' : 'none';
            } catch (error) {
                listDiv.innerHTML = '<div class="error">Failed to load messages.</div>';
            }
        }
        // 6. Mark message as read
        window.markMessageRead = async function(messageId) {
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'admin_messages', messageId), { status: 'read' });
                showNotification('‚úÖ Message marked as read.', 'success');
                loadAdminMessages();
            } catch (error) {
                showNotification('‚ùå Failed to update message', 'error');
            }
        };
        // 7. Delete admin message
        window.deleteAdminMessage = async function(messageId) {
            if (confirm('Are you sure you want to delete this message? This cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'admin_messages', messageId));
                    showNotification('‚úÖ Message deleted.', 'success');
                    loadAdminMessages();
                } catch (error) {
                    showNotification('‚ùå Failed to delete message', 'error');
                }
            }
        };
        // 8. Badge update on workplace select
        async function updateMessagesBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'admin_messages'),
                    where('status', '==', 'unread')
                ));
                document.getElementById('messagesBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }
        // 9. Call badge update on workplace select
        const origSelectWorkplaceMsgs = window.selectWorkplace;
        window.selectWorkplace = async function(id) {
            await origSelectWorkplaceMsgs(id);
            updateHourRequestsBadge();
            updateMessagesBadge();
            updateEmailChangeRequestsBadge();
        };

        // Remove All Workers button logic (admin only)
        if (user.isAdmin) {
            document.getElementById('removeAllWorkersBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                if (!confirm('Are you sure you want to delete ALL workers from this workplace? This cannot be undone!')) return;
                try {
                    const workersSnap = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                    let deleteCount = 0;
                    for (const docSnap of workersSnap.docs) {
                        // Skip the _metadata document - it's not a real worker
                        if (docSnap.id === '_metadata') {
                            continue;
                        }
                        await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'workers', docSnap.id));
                        deleteCount++;
                    }
                    showNotification(`‚úÖ Deleted ${deleteCount} workers from ${selectedWorkplace}.`, 'success');
                    await loadWorkplaceData();
                } catch (error) {
                    showNotification('‚ùå Failed to delete all workers', 'error');
                }
            };
        }

        // --- ADMIN EMAIL CHANGE REQUESTS MANAGEMENT ---
        
        // Email change requests button handler (admin only)
        if (user.isAdmin) {
            document.getElementById('emailChangeRequestsBtn').onclick = function() {
                document.getElementById('adminEmailChangeRequestsModal').style.display = 'block';
                loadAdminEmailChangeRequests();
            };
        }
        
        // Load admin email change requests
        async function loadAdminEmailChangeRequests(filter = 'all') {
            const listDiv = document.getElementById('adminEmailChangeRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading email change requests...</div>';
            
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, collection, query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                let requestsQuery;
                if (filter === 'all') {
                    requestsQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        orderBy('createdAt', 'desc')
                    );
                } else {
                    requestsQuery = query(
                        collection(authDb, 'emailChangeRequests'),
                        where('status', '==', filter),
                        orderBy('createdAt', 'desc')
                    );
                }
                
                const snapshot = await getDocs(requestsQuery);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No email change requests found.</div>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0;">${data.currentEmail} ‚Üí ${data.requestedEmail}</h4>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        <strong>User ID:</strong> ${data.userId}<br>
                                        <strong>Requested:</strong> ${new Date(data.createdAt).toLocaleString()}
                                    </div>
                                </div>
                                <span class="status-badge ${statusBadgeClass}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                    ${data.status}
                                </span>
                            </div>
                            ${data.reason ? `<div style="font-size: 0.9rem; margin-bottom: 1rem;"><strong>Reason:</strong> ${data.reason}</div>` : ''}
                            ${data.status !== 'pending' ? `
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                                    ${data.status === 'approved' ? '‚úÖ Approved' : '‚ùå Denied'} by ${data.reviewedBy || 'Admin'} on ${data.reviewedAt ? new Date(data.reviewedAt).toLocaleString() : 'Unknown'}
                                </div>
                                ${data.adminNotes ? `<div style="font-size: 0.9rem; margin-bottom: 1rem;"><strong>Admin Notes:</strong> ${data.adminNotes}</div>` : ''}
                            ` : ''}
                            ${data.status === 'pending' ? `
                                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                    <button class="btn btn-success" onclick="approveEmailChangeRequest('${doc.id}', '${data.userId}', '${data.currentEmail}', '${data.requestedEmail}')">‚úÖ Approve</button>
                                    <button class="btn btn-danger" onclick="denyEmailChangeRequest('${doc.id}', '${data.userId}')">‚ùå Deny</button>
                                    <button class="btn btn-info" onclick="addAdminNotes('${doc.id}')">üìù Add Notes</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading admin email change requests:', error);
                listDiv.innerHTML = '<div class="error">Failed to load email change requests.</div>';
            }
        }
        
        // Filter email change requests
        window.filterEmailChangeRequests = function(filter) {
            loadAdminEmailChangeRequests(filter);
        };
        
        // Approve email change request
        window.approveEmailChangeRequest = async function(requestId, userId, currentEmail, newEmail) {
            if (!confirm(`Are you sure you want to approve this email change from ${currentEmail} to ${newEmail}?`)) {
                return;
            }
            
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, doc, updateDoc, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                // Update the request status
                const requestRef = doc(authDb, 'emailChangeRequests', requestId);
                await updateDoc(requestRef, {
                    status: 'approved',
                    reviewedBy: user.email,
                    reviewedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // Update user email in AUTH database
                const userRef = doc(authDb, 'users', userId);
                await updateDoc(userRef, {
                    email: newEmail
                });
                
                // Update user email in all workplace databases
                const workplaces = ['esports_lounge', 'esports_arena', 'it_service_center'];
                for (const workplace of workplaces) {
                    try {
                        // Update worker records
                        const workersQuery = query(
                            collection(db, 'workplaces', workplace, 'workers'),
                            where('Email', '==', currentEmail)
                        );
                        const workersSnapshot = await getDocs(workersQuery);
                        
                        for (const workerDoc of workersSnapshot.docs) {
                            await updateDoc(workerDoc.ref, {
                                Email: newEmail
                            });
                        }
                        
                        // Update any other collections that reference the email
                        // (schedules, requests, etc.)
                        const collectionsToUpdate = ['schedules', 'hourRequests', 'timeOffRequests', 'shiftSwaps', 'admin_messages'];
                        
                        for (const collectionName of collectionsToUpdate) {
                            try {
                                const collectionRef = collection(db, 'workplaces', workplace, collectionName);
                                const snapshot = await getDocs(collectionRef);
                                
                                for (const docSnapshot of snapshot.docs) {
                                    const data = docSnapshot.data();
                                    let needsUpdate = false;
                                    const updateData = {};
                                    
                                    // Check if any field contains the old email
                                    Object.keys(data).forEach(key => {
                                        if (typeof data[key] === 'string' && data[key] === currentEmail) {
                                            updateData[key] = newEmail;
                                            needsUpdate = true;
                                        }
                                    });
                                    
                                    if (needsUpdate) {
                                        await updateDoc(docSnapshot.ref, updateData);
                                    }
                                }
                            } catch (error) {
                                console.warn(`Error updating ${collectionName} in ${workplace}:`, error);
                            }
                        }
                    } catch (error) {
                        console.warn(`Error updating workplace ${workplace}:`, error);
                    }
                }
                
                showNotification('‚úÖ Email change approved and updated across all databases', 'success');
                loadAdminEmailChangeRequests();
                
            } catch (error) {
                console.error('Error approving email change request:', error);
                showNotification('‚ùå Failed to approve email change request', 'error');
            }
        };
        
        // Deny email change request
        window.denyEmailChangeRequest = async function(requestId, userId) {
            const notes = prompt('Please provide a reason for denying this request (optional):');
            
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                // Update the request status
                const requestRef = doc(authDb, 'emailChangeRequests', requestId);
                await updateDoc(requestRef, {
                    status: 'denied',
                    reviewedBy: user.email,
                    reviewedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    adminNotes: notes || null
                });
                
                showNotification('‚ùå Email change request denied', 'success');
                loadAdminEmailChangeRequests();
                
            } catch (error) {
                console.error('Error denying email change request:', error);
                showNotification('‚ùå Failed to deny email change request', 'error');
            }
        };
        
        // Add admin notes
        window.addAdminNotes = async function(requestId) {
            const notes = prompt('Enter admin notes:');
            if (!notes) return;
            
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                const requestRef = doc(authDb, 'emailChangeRequests', requestId);
                await updateDoc(requestRef, {
                    adminNotes: notes,
                    updatedAt: new Date().toISOString()
                });
                
                showNotification('‚úÖ Admin notes added', 'success');
                loadAdminEmailChangeRequests();
                
            } catch (error) {
                console.error('Error adding admin notes:', error);
                showNotification('‚ùå Failed to add admin notes', 'error');
            }
        };
        
        // Export email change requests
        window.exportEmailChangeRequests = async function() {
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, collection, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                const requestsQuery = query(
                    collection(authDb, 'emailChangeRequests'),
                    orderBy('createdAt', 'desc')
                );
                const snapshot = await getDocs(requestsQuery);
                
                let csvContent = 'User ID,Current Email,Requested Email,Reason,Status,Created At,Reviewed By,Reviewed At,Admin Notes\n';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    csvContent += `"${data.userId}","${data.currentEmail}","${data.requestedEmail}","${data.reason || ''}","${data.status}","${data.createdAt}","${data.reviewedBy || ''}","${data.reviewedAt || ''}","${data.adminNotes || ''}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `email_change_requests_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('üìÑ Email change requests exported to CSV', 'success');
                
            } catch (error) {
                console.error('Error exporting email change requests:', error);
                showNotification('‚ùå Failed to export email change requests', 'error');
            }
        };
        
        // Update email change requests badge
        async function updateEmailChangeRequestsBadge() {
            if (!user.isAdmin) return;
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js');
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js');
                
                const authConfig = {
                    apiKey: "AIzaSyAt_HJiP_uuWC7-AqMKlfLwjQFsESjB364",
                    authDomain: "my-admin-dashboard-b9c89.firebaseapp.com",
                    projectId: "my-admin-dashboard-b9c89",
                    storageBucket: "my-admin-dashboard-b9c89.firebasestorage.app",
                    messagingSenderId: "1001105953619",
                    appId: "1:1001105953619:web:1e2cf52a9ff37aeb5207a6",
                    measurementId: "G-DGTX5YCKYF"
                };
                
                const authApp = initializeApp(authConfig, 'authApp');
                const authDb = getFirestore(authApp);
                
                const snapshot = await getDocs(query(
                    collection(authDb, 'emailChangeRequests'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('emailChangeRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }
        // Clean Up Old Schedules button logic (admin only)
        if (user.isAdmin) {
            document.getElementById('cleanupSchedulesBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                if (!confirm('WARNING: This will permanently delete all schedules older than 6 months (unless they have a retainUntil date in the future). Are you sure you want to continue?')) return;
                try {
                    const now = new Date();
                    const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                    const schedulesSnap = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'schedules'));
                    let deleteCount = 0;
                    for (const docSnap of schedulesSnap.docs) {
                        const data = docSnap.data();
                        const createdAt = data.createdAt ? new Date(data.createdAt) : null;
                        const retainUntil = data.retainUntil ? new Date(data.retainUntil) : null;
                        if (createdAt && createdAt < sixMonthsAgo && (!retainUntil || retainUntil < now)) {
                            await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', docSnap.id));
                            deleteCount++;
                        }
                    }
                    showNotification(`‚úÖ Deleted ${deleteCount} old schedules from ${selectedWorkplace}.`, 'success');
                    viewHistory();
                } catch (error) {
                    showNotification('‚ùå Failed to clean up old schedules', 'error');
                }
            };
        }

        // Simple shift validation without Zod dependency
        function validateShift(shift) {
            try {
                // Basic validation without external dependencies
                if (!shift.start || !shift.end) {
                    throw new Error('Start and end times are required');
                }
                
                // Check time format (HH:MM)
                const timeRegex = /^\d{2}:\d{2}$/;
                if (!timeRegex.test(shift.start) || !timeRegex.test(shift.end)) {
                    throw new Error('Invalid time format. Use HH:MM format');
                }
                
                // Check that end is after start
                const startHour = timeToHour(shift.start);
                let endHour = timeToHour(shift.end);
                if (endHour === 0 && shift.end === '00:00') endHour = 24;
                if (endHour <= startHour) { // Allow midnight (00:00)
                    throw new Error('End time must be after start time');
                }
                
                // Check required fields
                if (!shift.assigned || !Array.isArray(shift.assigned) || shift.assigned.length === 0) {
                    throw new Error('At least one assigned worker is required');
                }
                
                if (!shift.raw_assigned || !Array.isArray(shift.raw_assigned) || shift.raw_assigned.length === 0) {
                    throw new Error('Raw assigned data is required');
                }
                
                return true;
            } catch (err) {
                console.error('Shift validation error:', err.message);
                return false;
            }
        }

        // --- SHIFT SWAP REQUEST SYSTEM ---



        // 4. Handle shift swap request form submission
        document.getElementById('shiftSwapRequestForm').addEventListener('submit', async function(e) {
            try {
                console.log('DEBUG: Form submission started');
                e.preventDefault();
                
                console.log('DEBUG: Getting form values...');
                const requesterShiftData = JSON.parse(document.getElementById('swapRequesterShiftTime').value || '{}');
                const targetWorkerEmail = document.getElementById('swapTargetWorker').value;
                const targetShiftDate = document.getElementById('swapTargetShiftDate').value;
                const targetShiftTime = document.getElementById('swapTargetShiftTime').value;
                const reason = document.getElementById('swapReason').value.trim();
                
                console.log('DEBUG: Form values:', { requesterShiftData, targetWorkerEmail, targetShiftDate, targetShiftTime, reason });
                
                if (!requesterShiftData.day || !targetWorkerEmail || !targetShiftDate || !targetShiftTime) {
                    showNotification('‚ùå Please fill in all required fields', 'error');
                    return;
                }
            
            try {
                console.log('DEBUG: Submitting shift swap request...');
                console.log('DEBUG: Workplace:', selectedWorkplace);
                console.log('DEBUG: User:', user.email);
                
                // Get target worker data directly from Firestore
                console.log('DEBUG: Getting worker data for:', targetWorkerEmail);
                const workersSnap = await getDocs(collection(db, 'workplaces', selectedWorkplace, 'workers'));
                const targetWorker = workersSnap.docs.find(doc => {
                    // Skip the _metadata document - it's not a real worker
                    if (doc.id === '_metadata') {
                        return false;
                    }
                    return doc.data().Email === targetWorkerEmail;
                });
                const targetWorkerName = targetWorker ? 
                    `${targetWorker.data()['First Name']} ${targetWorker.data()['Last Name']}` : 
                    targetWorkerEmail;
                console.log('DEBUG: Target worker name:', targetWorkerName);
                
                // Create shift swap request
                await addDoc(collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'), {
                    requesterId: user.uid || user.email,
                    requesterName: (user.firstName && user.lastName) ? `${user.firstName} ${user.lastName}` : user.email,
                    requesterEmail: user.email,
                    requesterShift: {
                        day: requesterShiftData.day,
                        date: requesterShiftData.date,
                        time: requesterShiftData.time,
                        shiftIndex: requesterShiftData.shiftIndex
                    },
                    targetWorkerId: targetWorkerEmail,
                    targetWorkerName: targetWorkerName,
                    targetWorkerEmail: targetWorkerEmail,
                    targetWorkerShift: {
                        date: targetShiftDate,
                        time: targetShiftTime
                    },
                    reason: reason,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email
                });
                
                console.log('DEBUG: Shift swap request saved successfully!');
                showNotification('‚úÖ Shift swap request submitted successfully!', 'success');
                closeModal('shiftSwapRequestModal');
                document.getElementById('shiftSwapRequestForm').reset();
                
            } catch (error) {
                console.error('DEBUG: Error submitting shift swap request:', error);
                showNotification('‚ùå Failed to submit shift swap request', 'error');
            }
        } catch (outerError) {
            console.error('DEBUG: Outer error in form submission:', outerError);
            showNotification('‚ùå Form submission failed', 'error');
        }
        });

        // 5. Load and display shift swap requests
        async function loadShiftSwapRequests() {
            const listDiv = document.getElementById('shiftSwapRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading shift swap requests...</div>';
            
            try {
                // Clean up expired requests first
                await cleanupExpiredShiftSwapRequests();
                
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                    orderBy('createdAt', 'desc')
                ));
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<div class="info">No shift swap requests found.</div>';
                    document.getElementById('shiftSwapRequestsBadge').style.display = 'none';
                    return;
                }
                
                let html = '';
                let pendingCount = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'pending') pendingCount++;
                    
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div class="swap-request-card ${statusClass}">
                            <div class="swap-request-header">
                                <h4 class="swap-request-title">üîÑ Shift Swap Request</h4>
                                <div class="swap-request-meta">
                                    <span class="status-badge ${statusBadgeClass}">${data.status}</span>
                                    <small>${new Date(data.createdAt).toLocaleDateString()}</small>
                                </div>
                            </div>
                            
                            <div class="swap-details">
                                <div class="swap-detail">
                                    <div class="swap-detail-label">From:</div>
                                    <div class="swap-detail-value">${data.requesterName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">To:</div>
                                    <div class="swap-detail-value">${data.targetWorkerName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Requester's Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            const [start, end] = data.requesterShift.time.split('-');
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                        } catch (e) {
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${data.requesterShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Target's Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            // Check if time is a JSON string and parse it
                                            const timeData = typeof data.targetWorkerShift.time === 'string' && data.targetWorkerShift.time.startsWith('{') 
                                                ? JSON.parse(data.targetWorkerShift.time) 
                                                : data.targetWorkerShift.time;
                                            
                                            if (typeof timeData === 'object' && timeData.time) {
                                                // Format the time properly
                                                const [start, end] = timeData.time.split('-');
                                                return `${timeData.day} ${timeData.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                            } else {
                                                // Simple time string
                                                return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                            }
                                        } catch (e) {
                                            return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                            </div>
                            
                            ${data.reason ? `<div class="swap-reason">üí¨ Reason: ${data.reason}</div>` : ''}
                            
                            ${data.deleteAfter ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>üóëÔ∏è Will be deleted on ${new Date(data.deleteAfter).toLocaleDateString()}</span>
                                ${data.requesterEmail === user.email ? `<button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">üóëÔ∏è Delete Now</button>` : ''}
                            </div>` : ''}
                            
                            ${!data.deleteAfter && data.requesterEmail === user.email ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>üóëÔ∏è No automatic deletion scheduled</span>
                                <button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">üóëÔ∏è Delete Now</button>
                            </div>` : ''}
                            
                            ${user.isAdmin && data.status === 'pending' ? `
                                <div class="swap-actions">
                                    <button class="btn btn-success" onclick="approveShiftSwap('${doc.id}')">‚úÖ Approve</button>
                                    <button class="btn btn-danger" onclick="denyShiftSwap('${doc.id}')">‚ùå Deny</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                document.getElementById('shiftSwapRequestsBadge').style.display = pendingCount > 0 ? 'inline-block' : 'none';
                
            } catch (error) {
                listDiv.innerHTML = '<div class="error">Failed to load shift swap requests.</div>';
            }
        }

        // 6. Filter shift swap requests
        window.filterShiftSwapRequests = function(status) {
            const buttons = ['filterSwapAllBtn', 'filterSwapPendingBtn', 'filterSwapApprovedBtn', 'filterSwapDeniedBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.className = btn.className.replace(' btn-primary', ' btn-info');
            });
            
            document.getElementById(`filterSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className = 
                document.getElementById(`filterSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className.replace(' btn-info', ' btn-primary');
            
            loadShiftSwapRequests(status);
        };

        // 7. Approve shift swap request
        window.approveShiftSwap = async function(swapId) {
            if (!confirm('Are you sure you want to approve this shift swap? This will automatically update the schedule.')) return;
            
            try {
                // Get the swap request data
                const swapDoc = await getDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId));
                const swapData = swapDoc.data();
                
                if (!swapData) {
                    showNotification('‚ùå Swap request not found', 'error');
                    return;
                }
                
                // Get current schedule
                const scheduleSnap = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'schedules'),
                    orderBy('createdAt', 'desc'),
                    where('isCurrent', '==', true)
                ));
                
                if (scheduleSnap.empty) {
                    showNotification('‚ùå No current schedule found', 'error');
                    return;
                }
                
                const scheduleDoc = scheduleSnap.docs[0];
                const scheduleData = scheduleDoc.data();
                
                // Update the schedule by swapping the workers
                const updatedSchedule = { ...scheduleData.days };
                
                // Remove requester from their shift and add target worker
                const requesterShift = updatedSchedule[swapData.requesterShift.day][swapData.requesterShift.shiftIndex];
                requesterShift.raw_assigned = requesterShift.raw_assigned.filter(email => email !== swapData.requesterEmail);
                requesterShift.raw_assigned.push(swapData.targetWorkerEmail);
                
                // Find target worker's shift and swap them
                const targetDay = getDayFromDate(swapData.targetWorkerShift.date);
                if (targetDay && updatedSchedule[targetDay]) {
                    for (let i = 0; i < updatedSchedule[targetDay].length; i++) {
                        const shift = updatedSchedule[targetDay][i];
                        if (shift.raw_assigned && shift.raw_assigned.includes(swapData.targetWorkerEmail)) {
                            shift.raw_assigned = shift.raw_assigned.filter(email => email !== swapData.targetWorkerEmail);
                            shift.raw_assigned.push(swapData.requesterEmail);
                            break;
                        }
                    }
                }
                
                // Update the schedule in Firestore
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'schedules', scheduleDoc.id), {
                    days: updatedSchedule,
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email
                });
                
                // Update the swap request status
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId), {
                    status: 'approved',
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email,
                    deleteAfter: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // Delete in 7 days
                });
                
                showNotification('‚úÖ Shift swap approved and schedule updated! Request will be automatically deleted in 7 days.', 'success');
                loadShiftSwapRequests();
                
            } catch (error) {
                showNotification('‚ùå Failed to approve shift swap', 'error');
            }
        };

        // 8. Deny shift swap request
        window.denyShiftSwap = async function(swapId) {
            if (!confirm('Are you sure you want to deny this shift swap request?')) return;
            
            try {
                await updateDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId), {
                    status: 'denied',
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email,
                    deleteAfter: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // Delete in 7 days
                });
                
                showNotification('‚ùå Shift swap request denied. Request will be automatically deleted in 7 days.', 'info');
                loadShiftSwapRequests();
                
            } catch (error) {
                showNotification('‚ùå Failed to deny shift swap request', 'error');
            }
        };



        // 11. Update shift swap requests badge
        async function updateShiftSwapRequestsBadge() {
            if (!user.isAdmin || !selectedWorkplace) return;
            try {
                const snapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                    where('status', '==', 'pending')
                ));
                document.getElementById('shiftSwapRequestsBadge').style.display = snapshot.empty ? 'none' : 'inline-block';
            } catch {}
        }

        // 12. User: My Shift Swap Requests button logic
        if (!user.isAdmin) {
            document.getElementById('myShiftSwapRequestsBtn').onclick = async function() {
                if (!selectedWorkplace) {
                    showNotification('‚ùå Please select a workplace first', 'error');
                    return;
                }
                document.getElementById('userShiftSwapRequestsModal').style.display = 'block';
                loadUserShiftSwapRequests();
            };
        }

        // 13. Load user's own shift swap requests
        async function loadUserShiftSwapRequests(filter = 'all') {
            const listDiv = document.getElementById('userShiftSwapRequestsList');
            listDiv.innerHTML = '<div class="loading">Loading your shift swap requests...</div>';
            
            try {
                // Clean up expired requests first
                await cleanupExpiredShiftSwapRequests();
                
                let snapshot;
                if (filter === 'pending') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email),
                        where('status', '==', 'pending')
                    ));
                } else if (filter === 'approved') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email),
                        where('status', '==', 'approved')
                    ));
                } else if (filter === 'denied') {
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email),
                        where('status', '==', 'denied')
                    ));
                } else {
                    // Load all user's requests
                    snapshot = await getDocs(query(
                        collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                        where('requesterEmail', '==', user.email)
                    ));
                }
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="info">No ${filter} shift swap requests found.</div>`;
                    return;
                }
                
                let html = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const statusClass = data.status;
                    const statusBadgeClass = data.status;
                    
                    html += `
                        <div class="swap-request-card ${statusClass}">
                            <div class="swap-request-header">
                                <h4 class="swap-request-title">üîÑ Shift Swap Request</h4>
                                <div class="swap-request-meta">
                                    <span class="status-badge ${statusBadgeClass}">${data.status}</span>
                                    <small>${new Date(data.createdAt).toLocaleDateString()}</small>
                                </div>
                            </div>
                            
                            <div class="swap-details">
                                <div class="swap-detail">
                                    <div class="swap-detail-label">From:</div>
                                    <div class="swap-detail-value">${data.requesterName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">To:</div>
                                    <div class="swap-detail-value">${data.targetWorkerName}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Your Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            const [start, end] = data.requesterShift.time.split('-');
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                        } catch (e) {
                                            return `${data.requesterShift.day} ${data.requesterShift.date} - ${data.requesterShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                                <div class="swap-detail">
                                    <div class="swap-detail-label">Their Shift:</div>
                                    <div class="swap-detail-value">${(() => {
                                        try {
                                            // Check if time is a JSON string and parse it
                                            const timeData = typeof data.targetWorkerShift.time === 'string' && data.targetWorkerShift.time.startsWith('{') 
                                                ? JSON.parse(data.targetWorkerShift.time) 
                                                : data.targetWorkerShift.time;
                                            
                                            if (typeof timeData === 'object' && timeData.time) {
                                                // Format the time properly
                                                const [start, end] = timeData.time.split('-');
                                                return `${timeData.day} ${timeData.date} - ${formatTime(start)} - ${formatTime(end)}`;
                                            } else {
                                                // Simple time string
                                                return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                            }
                                        } catch (e) {
                                            return `${data.targetWorkerShift.date} - ${data.targetWorkerShift.time}`;
                                        }
                                    })()}</div>
                                </div>
                            </div>
                            
                            ${data.reason ? `<div class="swap-reason">üí¨ Reason: ${data.reason}</div>` : ''}
                            
                            ${data.deleteAfter ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>üóëÔ∏è Will be deleted on ${new Date(data.deleteAfter).toLocaleDateString()}</span>
                                ${data.requesterEmail === user.email ? `<button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">üóëÔ∏è Delete Now</button>` : ''}
                            </div>` : ''}
                            
                            ${!data.deleteAfter && data.requesterEmail === user.email ? `<div class="swap-delete-info" style="color:#888;font-size:0.9em;margin-top:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                                <span>üóëÔ∏è No automatic deletion scheduled</span>
                                <button class="btn btn-danger" style="font-size:0.8em;padding:0.25rem 0.5rem;margin-left:1rem;" onclick="deleteMyShiftSwapRequest('${doc.id}')">üóëÔ∏è Delete Now</button>
                            </div>` : ''}
                            
                            ${data.status !== 'pending' && data.updatedBy ? 
                                `<div class="swap-review">Reviewed by: ${data.updatedBy} on ${new Date(data.updatedAt).toLocaleDateString()}</div>` : ''}
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
                
            } catch (error) {
                listDiv.innerHTML = '<div class="error">Failed to load your shift swap requests.</div>';
            }
        }

        // 14. Filter user shift swap requests
        window.filterUserShiftSwapRequests = function(status) {
            const buttons = ['filterUserSwapAllBtn', 'filterUserSwapPendingBtn', 'filterUserSwapApprovedBtn', 'filterUserSwapDeniedBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.className = btn.className.replace(' btn-primary', ' btn-info');
            });
            
            document.getElementById(`filterUserSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className = 
                document.getElementById(`filterUserSwap${status.charAt(0).toUpperCase() + status.slice(1)}Btn`).className.replace(' btn-info', ' btn-primary');
            
            loadUserShiftSwapRequests(status);
        };

        // 15. Cleanup expired shift swap requests
        async function cleanupExpiredShiftSwapRequests() {
            if (!selectedWorkplace) return;
            
            try {
                const now = new Date().toISOString();
                const expiredSnapshot = await getDocs(query(
                    collection(db, 'workplaces', selectedWorkplace, 'shiftSwaps'),
                    where('deleteAfter', '<=', now)
                ));
                
                if (!expiredSnapshot.empty) {
                    const deletePromises = expiredSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    console.log(`Cleaned up ${expiredSnapshot.size} expired shift swap requests`);
                }
            } catch (error) {
                console.error('Error cleaning up expired shift swap requests:', error);
            }
        }

        // 16. Update badge when workplace is selected
        const origSelectWorkplaceSwap = window.selectWorkplace;
        window.selectWorkplace = async function(id) {
            await origSelectWorkplaceSwap(id);
            await cleanupExpiredShiftSwapRequests(); // Clean up expired requests
            updateShiftSwapRequestsBadge();
        };

        // 17. Manual delete shift swap request (for requesters)
        window.deleteMyShiftSwapRequest = async function(swapId) {
            if (!confirm('Are you sure you want to delete this shift swap request? This will permanently remove it for both you and the worker you requested to swap with. This action cannot be undone.')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'workplaces', selectedWorkplace, 'shiftSwaps', swapId));
                showNotification('‚úÖ Shift swap request deleted successfully', 'success');
                
                // Reload the appropriate list based on which modal is open
                if (document.getElementById('userShiftSwapRequestsModal').style.display === 'block') {
                    loadUserShiftSwapRequests();
                } else if (document.getElementById('shiftSwapRequestsModal').style.display === 'block') {
                    loadShiftSwapRequests();
                }
                
            } catch (error) {
                console.error('Error deleting shift swap request:', error);
                showNotification('‚ùå Failed to delete shift swap request', 'error');
            }
        };

        // 18. Set up periodic cleanup (every hour)
        setInterval(async () => {
            if (selectedWorkplace) {
                await cleanupExpiredShiftSwapRequests();
            }
        }, 60 * 60 * 1000); // Run every hour
    </script>
</body>
</html>